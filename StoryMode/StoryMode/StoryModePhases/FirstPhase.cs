using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.SceneInformationPopupTypes;
using TaleWorlds.Core;
using TaleWorlds.SaveSystem;

namespace StoryMode.StoryModePhases
{
	public class FirstPhase
	{
		internal static void AutoGeneratedStaticCollectObjectsFirstPhase(object o, List<object> collectedObjects)
		{
			((FirstPhase)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this.FirstPhaseStartTime, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueCollectedBannerPieceCount(object o)
		{
			return ((FirstPhase)o).CollectedBannerPieceCount;
		}

		internal static object AutoGeneratedGetMemberValueFirstPhaseStartTime(object o)
		{
			return ((FirstPhase)o).FirstPhaseStartTime;
		}

		public static FirstPhase Instance
		{
			get
			{
				return StoryModeManager.Current.MainStoryLine.FirstPhase;
			}
		}

		[SaveableProperty(1)]
		public int CollectedBannerPieceCount { get; private set; }

		[SaveableProperty(2)]
		public CampaignTime FirstPhaseStartTime { get; private set; }

		public CampaignTime FirstPhaseEndTime
		{
			get
			{
				return CampaignTime.Years(20f) + this.FirstPhaseStartTime;
			}
		}

		public bool AllPiecesCollected
		{
			get
			{
				return this.CollectedBannerPieceCount == 3;
			}
		}

		public FirstPhase()
		{
			this.CollectedBannerPieceCount = 0;
			this.FirstPhaseStartTime = CampaignTime.Now;
		}

		public void CollectBannerPiece()
		{
			int collectedBannerPieceCount = this.CollectedBannerPieceCount;
			this.CollectedBannerPieceCount = collectedBannerPieceCount + 1;
			ItemObject itemObject = null;
			if (this.CollectedBannerPieceCount == 1)
			{
				itemObject = Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_center");
			}
			else if (this.CollectedBannerPieceCount == 2)
			{
				itemObject = Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_dragonhead");
				MBInformationManager.ShowSceneNotification(new FindingSecondBannerPieceSceneNotificationItem(Hero.MainHero));
			}
			else if (this.CollectedBannerPieceCount == 3)
			{
				itemObject = Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_handle");
				MBInformationManager.ShowSceneNotification(new FindingThirdBannerPieceSceneNotificationItem());
			}
			if (itemObject != null)
			{
				MobileParty.MainParty.ItemRoster.AddToCounts(new EquipmentElement(itemObject, null, null, true), 1);
			}
			StoryModeEvents.Instance.OnBannerPieceCollected();
		}

		public void MergeDragonBanner()
		{
			MobileParty.MainParty.ItemRoster.AddToCounts(new EquipmentElement(Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_center"), null, null, true), -1);
			MobileParty.MainParty.ItemRoster.AddToCounts(new EquipmentElement(Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_dragonhead"), null, null, true), -1);
			MobileParty.MainParty.ItemRoster.AddToCounts(new EquipmentElement(Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner_handle"), null, null, true), -1);
			MobileParty.MainParty.ItemRoster.AddToCounts(new EquipmentElement(Campaign.Current.ObjectManager.GetObject<ItemObject>("dragon_banner"), null, null, true), 1);
		}

		public const int NeededBannerPieceCount = 3;

		public const int FirstPhaseDurationAsYears = 20;

		public const string FirstBannerPieceStringId = "dragon_banner_center";

		public const string SecondBannerPieceStringId = "dragon_banner_dragonhead";

		public const string ThirdBannerPieceStringId = "dragon_banner_handle";
	}
}
