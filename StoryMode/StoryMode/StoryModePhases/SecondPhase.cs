using System;
using System.Collections.Generic;
using System.Linq;
using StoryMode.Quests.SecondPhase;
using StoryMode.Quests.SecondPhase.ConspiracyQuests;
using StoryMode.StoryModeObjects;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.SceneInformationPopupTypes;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace StoryMode.StoryModePhases
{
	// Token: 0x0200001A RID: 26
	public class SecondPhase
	{
		// Token: 0x060000E1 RID: 225 RVA: 0x00005881 File Offset: 0x00003A81
		internal static void AutoGeneratedStaticCollectObjectsSecondPhase(object o, List<object> collectedObjects)
		{
			((SecondPhase)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060000E2 RID: 226 RVA: 0x0000588F File Offset: 0x00003A8F
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._lastConspiracyQuest);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this.LastConspiracyQuestCreationTime, collectedObjects);
		}

		// Token: 0x060000E3 RID: 227 RVA: 0x000058AE File Offset: 0x00003AAE
		internal static object AutoGeneratedGetMemberValueLastConspiracyQuestCreationTime(object o)
		{
			return ((SecondPhase)o).LastConspiracyQuestCreationTime;
		}

		// Token: 0x060000E4 RID: 228 RVA: 0x000058C0 File Offset: 0x00003AC0
		internal static object AutoGeneratedGetMemberValueConspiracyStrength(object o)
		{
			return ((SecondPhase)o).ConspiracyStrength;
		}

		// Token: 0x060000E5 RID: 229 RVA: 0x000058D2 File Offset: 0x00003AD2
		internal static object AutoGeneratedGetMemberValue_stopConspiracyAttempts(object o)
		{
			return ((SecondPhase)o)._stopConspiracyAttempts;
		}

		// Token: 0x060000E6 RID: 230 RVA: 0x000058E4 File Offset: 0x00003AE4
		internal static object AutoGeneratedGetMemberValue_lastConspiracyQuest(object o)
		{
			return ((SecondPhase)o)._lastConspiracyQuest;
		}

		// Token: 0x17000043 RID: 67
		// (get) Token: 0x060000E7 RID: 231 RVA: 0x000058F1 File Offset: 0x00003AF1
		public static SecondPhase Instance
		{
			get
			{
				return StoryModeManager.Current.MainStoryLine.SecondPhase;
			}
		}

		// Token: 0x17000044 RID: 68
		// (get) Token: 0x060000E8 RID: 232 RVA: 0x00005902 File Offset: 0x00003B02
		// (set) Token: 0x060000E9 RID: 233 RVA: 0x0000590A File Offset: 0x00003B0A
		[SaveableProperty(1)]
		public CampaignTime LastConspiracyQuestCreationTime { get; private set; }

		// Token: 0x17000045 RID: 69
		// (get) Token: 0x060000EA RID: 234 RVA: 0x00005913 File Offset: 0x00003B13
		// (set) Token: 0x060000EB RID: 235 RVA: 0x0000591B File Offset: 0x00003B1B
		[SaveableProperty(5)]
		public float ConspiracyStrength { get; private set; }

		// Token: 0x060000EC RID: 236 RVA: 0x00005924 File Offset: 0x00003B24
		public SecondPhase()
		{
			this.LastConspiracyQuestCreationTime = CampaignTime.Never;
			this.ConspiracyStrength = 1000f;
			this._stopConspiracyAttempts = 0;
			this._lastConspiracyQuest = null;
			this.InitializeConspiracyQuestTypes();
			this.SetTransferableOfConspiracyTroops();
		}

		// Token: 0x060000ED RID: 237 RVA: 0x0000595C File Offset: 0x00003B5C
		public void OnSessionLaunched()
		{
			this.InitializeConspiracyQuestTypes();
			this.SetTransferableOfConspiracyTroops();
		}

		// Token: 0x060000EE RID: 238 RVA: 0x0000596A File Offset: 0x00003B6A
		private void InitializeConspiracyQuestTypes()
		{
			MBList<Type> mblist = new MBList<Type>();
			mblist.Add(typeof(DestroyRaidersConspiracyQuest));
			mblist.Add(typeof(ConspiracyBaseOfOperationsDiscoveredConspiracyQuest));
			mblist.Add(typeof(DisruptSupplyLinesConspiracyQuest));
			this._conspiracyQuestTypes = mblist;
		}

		// Token: 0x060000EF RID: 239 RVA: 0x000059A8 File Offset: 0x00003BA8
		private void SetTransferableOfConspiracyTroops()
		{
			PartyTemplateObject @object = Campaign.Current.ObjectManager.GetObject<PartyTemplateObject>("conspiracy_anti_imperial_special_raider_party_template");
			PartyTemplateObject object2 = Campaign.Current.ObjectManager.GetObject<PartyTemplateObject>("conspiracy_imperial_special_raider_party_template");
			foreach (PartyTemplateStack partyTemplateStack in @object.Stacks.Concat(object2.Stacks))
			{
				partyTemplateStack.Character.SetTransferableInPartyScreen(false);
			}
			Game.Current.ObjectManager.GetObject<CharacterObject>("conspiracy_commander_antiempire").SetTransferableInPartyScreen(false);
			Game.Current.ObjectManager.GetObject<CharacterObject>("conspiracy_commander_empire").SetTransferableInPartyScreen(false);
		}

		// Token: 0x060000F0 RID: 240 RVA: 0x00005A60 File Offset: 0x00003C60
		public void TriggerConspiracy()
		{
			this.LastConspiracyQuestCreationTime = CampaignTime.Now;
			if (this._lastConspiracyQuest == null)
			{
				MBInformationManager.ShowSceneNotification(new EmpireConspiracyBeginsSceneNotificationItem(Hero.MainHero, StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom, StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine));
			}
		}

		// Token: 0x060000F1 RID: 241 RVA: 0x00005AAD File Offset: 0x00003CAD
		public void IncreaseConspiracyStrength()
		{
			this.ConspiracyStrength += 2.777777f;
			if (this.ConspiracyStrength > 2000f)
			{
				this.ConspiracyStrength = 2000f;
			}
			if (this.ConspiracyStrength >= 2000f)
			{
				this.ActivateConspiracy();
			}
		}

		// Token: 0x060000F2 RID: 242 RVA: 0x00005AEC File Offset: 0x00003CEC
		public void DecreaseConspiracyStrength(float amount)
		{
			this.ConspiracyStrength -= amount;
		}

		// Token: 0x060000F3 RID: 243 RVA: 0x00005AFC File Offset: 0x00003CFC
		public void ActivateConspiracy()
		{
			StoryModeManager.Current.MainStoryLine.CompleteSecondPhase();
		}

		// Token: 0x060000F4 RID: 244 RVA: 0x00005B10 File Offset: 0x00003D10
		public void CreateNextConspiracyQuest()
		{
			Type type = ((this._lastConspiracyQuest == null) ? Extensions.GetRandomElement<Type>(this._conspiracyQuestTypes) : Extensions.GetRandomElementWithPredicate<Type>(this._conspiracyQuestTypes, (Type t) => t != this._lastConspiracyQuest.GetType()));
			this._stopConspiracyAttempts++;
			object[] array = new object[]
			{
				"conspiracy_quest_" + this._stopConspiracyAttempts,
				StoryModeManager.Current.MainStoryLine.IsOnAntiImperialQuestLine ? StoryModeHeroes.AntiImperialMentor : StoryModeHeroes.ImperialMentor
			};
			this._lastConspiracyQuest = (ConspiracyQuestBase)Activator.CreateInstance(type, array);
			this._lastConspiracyQuest.StartQuest();
			this.TriggerConspiracy();
		}

		// Token: 0x0400005A RID: 90
		public const int MaxConspiracyStrength = 2000;

		// Token: 0x0400005B RID: 91
		public const float DailyConspiracyChange = 2.777777f;

		// Token: 0x0400005C RID: 92
		public const int ConspiracyQuestDurationAsWeeks = 3;

		// Token: 0x0400005E RID: 94
		[SaveableField(3)]
		private int _stopConspiracyAttempts;

		// Token: 0x0400005F RID: 95
		[SaveableField(4)]
		private ConspiracyQuestBase _lastConspiracyQuest;

		// Token: 0x04000061 RID: 97
		private MBList<Type> _conspiracyQuestTypes;
	}
}
