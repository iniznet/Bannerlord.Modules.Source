using System;
using System.Collections.Generic;
using System.Linq;
using StoryMode.Quests.SecondPhase;
using StoryMode.Quests.SecondPhase.ConspiracyQuests;
using StoryMode.StoryModeObjects;
using TaleWorlds.CampaignSystem;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.SceneInformationPopupTypes;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace StoryMode.StoryModePhases
{
	public class SecondPhase
	{
		internal static void AutoGeneratedStaticCollectObjectsSecondPhase(object o, List<object> collectedObjects)
		{
			((SecondPhase)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._lastConspiracyQuest);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this.LastConspiracyQuestCreationTime, collectedObjects);
		}

		internal static object AutoGeneratedGetMemberValueLastConspiracyQuestCreationTime(object o)
		{
			return ((SecondPhase)o).LastConspiracyQuestCreationTime;
		}

		internal static object AutoGeneratedGetMemberValueConspiracyStrength(object o)
		{
			return ((SecondPhase)o).ConspiracyStrength;
		}

		internal static object AutoGeneratedGetMemberValue_stopConspiracyAttempts(object o)
		{
			return ((SecondPhase)o)._stopConspiracyAttempts;
		}

		internal static object AutoGeneratedGetMemberValue_lastConspiracyQuest(object o)
		{
			return ((SecondPhase)o)._lastConspiracyQuest;
		}

		public static SecondPhase Instance
		{
			get
			{
				return StoryModeManager.Current.MainStoryLine.SecondPhase;
			}
		}

		[SaveableProperty(1)]
		public CampaignTime LastConspiracyQuestCreationTime { get; private set; }

		[SaveableProperty(5)]
		public float ConspiracyStrength { get; private set; }

		public SecondPhase()
		{
			this.LastConspiracyQuestCreationTime = CampaignTime.Never;
			this.ConspiracyStrength = 1000f;
			this._stopConspiracyAttempts = 0;
			this._lastConspiracyQuest = null;
			this.InitializeConspiracyQuestTypes();
			this.SetTransferableOfConspiracyTroops();
		}

		public void OnSessionLaunched()
		{
			this.InitializeConspiracyQuestTypes();
			this.SetTransferableOfConspiracyTroops();
		}

		private void InitializeConspiracyQuestTypes()
		{
			MBList<Type> mblist = new MBList<Type>();
			mblist.Add(typeof(DestroyRaidersConspiracyQuest));
			mblist.Add(typeof(ConspiracyBaseOfOperationsDiscoveredConspiracyQuest));
			mblist.Add(typeof(DisruptSupplyLinesConspiracyQuest));
			this._conspiracyQuestTypes = mblist;
		}

		private void SetTransferableOfConspiracyTroops()
		{
			PartyTemplateObject @object = Campaign.Current.ObjectManager.GetObject<PartyTemplateObject>("conspiracy_anti_imperial_special_raider_party_template");
			PartyTemplateObject object2 = Campaign.Current.ObjectManager.GetObject<PartyTemplateObject>("conspiracy_imperial_special_raider_party_template");
			foreach (PartyTemplateStack partyTemplateStack in @object.Stacks.Concat(object2.Stacks))
			{
				partyTemplateStack.Character.SetTransferableInPartyScreen(false);
			}
			Game.Current.ObjectManager.GetObject<CharacterObject>("conspiracy_commander_antiempire").SetTransferableInPartyScreen(false);
			Game.Current.ObjectManager.GetObject<CharacterObject>("conspiracy_commander_empire").SetTransferableInPartyScreen(false);
		}

		public void TriggerConspiracy()
		{
			this.LastConspiracyQuestCreationTime = CampaignTime.Now;
			if (this._lastConspiracyQuest == null)
			{
				MBInformationManager.ShowSceneNotification(new EmpireConspiracyBeginsSceneNotificationItem(Hero.MainHero, StoryModeManager.Current.MainStoryLine.PlayerSupportedKingdom, StoryModeManager.Current.MainStoryLine.IsOnImperialQuestLine));
			}
		}

		public void IncreaseConspiracyStrength()
		{
			this.ConspiracyStrength += 2.777777f;
			if (this.ConspiracyStrength > 2000f)
			{
				this.ConspiracyStrength = 2000f;
			}
			if (this.ConspiracyStrength >= 2000f)
			{
				this.ActivateConspiracy();
			}
		}

		public void DecreaseConspiracyStrength(float amount)
		{
			this.ConspiracyStrength -= amount;
		}

		public void ActivateConspiracy()
		{
			StoryModeManager.Current.MainStoryLine.CompleteSecondPhase();
		}

		public void CreateNextConspiracyQuest()
		{
			Type type = ((this._lastConspiracyQuest == null) ? Extensions.GetRandomElement<Type>(this._conspiracyQuestTypes) : Extensions.GetRandomElementWithPredicate<Type>(this._conspiracyQuestTypes, (Type t) => t != this._lastConspiracyQuest.GetType()));
			this._stopConspiracyAttempts++;
			object[] array = new object[]
			{
				"conspiracy_quest_" + this._stopConspiracyAttempts,
				StoryModeManager.Current.MainStoryLine.IsOnAntiImperialQuestLine ? StoryModeHeroes.AntiImperialMentor : StoryModeHeroes.ImperialMentor
			};
			this._lastConspiracyQuest = (ConspiracyQuestBase)Activator.CreateInstance(type, array);
			this._lastConspiracyQuest.StartQuest();
			this.TriggerConspiracy();
		}

		public const int MaxConspiracyStrength = 2000;

		public const float DailyConspiracyChange = 2.777777f;

		public const int ConspiracyQuestDurationAsWeeks = 3;

		[SaveableField(3)]
		private int _stopConspiracyAttempts;

		[SaveableField(4)]
		private ConspiracyQuestBase _lastConspiracyQuest;

		private MBList<Type> _conspiracyQuestTypes;
	}
}
