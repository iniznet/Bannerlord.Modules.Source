using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem
{
	// Token: 0x02000069 RID: 105
	public class VisualTrackerManager
	{
		// Token: 0x06000DE2 RID: 3554 RVA: 0x00041FC6 File Offset: 0x000401C6
		internal static void AutoGeneratedStaticCollectObjectsVisualTrackerManager(object o, List<object> collectedObjects)
		{
			((VisualTrackerManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06000DE3 RID: 3555 RVA: 0x00041FD4 File Offset: 0x000401D4
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._trackedObjects);
		}

		// Token: 0x06000DE4 RID: 3556 RVA: 0x00041FE2 File Offset: 0x000401E2
		internal static object AutoGeneratedGetMemberValue_trackedObjects(object o)
		{
			return ((VisualTrackerManager)o)._trackedObjects;
		}

		// Token: 0x17000360 RID: 864
		// (get) Token: 0x06000DE5 RID: 3557 RVA: 0x00041FEF File Offset: 0x000401EF
		public MBReadOnlyList<TrackedObject> TrackedObjects
		{
			get
			{
				return this._trackedObjects;
			}
		}

		// Token: 0x17000361 RID: 865
		// (get) Token: 0x06000DE6 RID: 3558 RVA: 0x00041FF7 File Offset: 0x000401F7
		// (set) Token: 0x06000DE7 RID: 3559 RVA: 0x00041FFF File Offset: 0x000401FF
		[CachedData]
		public int TrackedObjectsVersion { get; private set; }

		// Token: 0x06000DE8 RID: 3560 RVA: 0x00042008 File Offset: 0x00040208
		public VisualTrackerManager()
		{
			this._trackedObjects = new MBList<TrackedObject>();
			this.Initialize();
		}

		// Token: 0x06000DE9 RID: 3561 RVA: 0x00042021 File Offset: 0x00040221
		[LoadInitializationCallback]
		private void OnLoad(MetaData metaData)
		{
			this.Initialize();
		}

		// Token: 0x06000DEA RID: 3562 RVA: 0x00042029 File Offset: 0x00040229
		private void Initialize()
		{
			this.TrackedObjectsVersion = 0;
			this.CheckObjectValidities();
		}

		// Token: 0x06000DEB RID: 3563 RVA: 0x00042038 File Offset: 0x00040238
		private void CheckObjectValidities()
		{
			foreach (TrackedObject trackedObject in this.TrackedObjects.ToList<TrackedObject>())
			{
				if (trackedObject.Object == null)
				{
					this._trackedObjects.Remove(trackedObject);
				}
			}
			int trackedObjectsVersion = this.TrackedObjectsVersion;
			this.TrackedObjectsVersion = trackedObjectsVersion + 1;
		}

		// Token: 0x06000DEC RID: 3564 RVA: 0x000420B0 File Offset: 0x000402B0
		public void RegisterObject(ITrackableCampaignObject obj)
		{
			if (obj != null)
			{
				bool flag = false;
				foreach (TrackedObject trackedObject in this.TrackedObjects)
				{
					if (trackedObject.Object == obj)
					{
						flag = true;
						trackedObject.TrackerCount++;
					}
				}
				if (!flag)
				{
					TrackedObject trackedObject2 = new TrackedObject(obj);
					this._trackedObjects.Add(trackedObject2);
					int trackedObjectsVersion = this.TrackedObjectsVersion;
					this.TrackedObjectsVersion = trackedObjectsVersion + 1;
				}
			}
		}

		// Token: 0x06000DED RID: 3565 RVA: 0x00042144 File Offset: 0x00040344
		public bool CheckTracked(ITrackableBase obj)
		{
			using (List<TrackedObject>.Enumerator enumerator = this.TrackedObjects.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					if (enumerator.Current.Object == obj)
					{
						return true;
					}
				}
			}
			return false;
		}

		// Token: 0x06000DEE RID: 3566 RVA: 0x000421A0 File Offset: 0x000403A0
		public bool CheckTracked(BasicCharacterObject agentCharacter)
		{
			using (List<TrackedObject>.Enumerator enumerator = this._trackedObjects.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					if (enumerator.Current.Object.CheckTracked(agentCharacter))
					{
						return true;
					}
				}
			}
			return false;
		}

		// Token: 0x06000DEF RID: 3567 RVA: 0x00042200 File Offset: 0x00040400
		public void RemoveTrackedObject(ITrackableBase obj, bool forceRemove = false)
		{
			for (int i = this._trackedObjects.Count - 1; i >= 0; i--)
			{
				TrackedObject trackedObject = this._trackedObjects[i];
				if (trackedObject.Object == obj)
				{
					trackedObject.TrackerCount--;
					if (trackedObject.TrackerCount <= 0 || forceRemove)
					{
						this._trackedObjects.RemoveAt(i);
						int trackedObjectsVersion = this.TrackedObjectsVersion;
						this.TrackedObjectsVersion = trackedObjectsVersion + 1;
					}
				}
			}
		}

		// Token: 0x06000DF0 RID: 3568 RVA: 0x00042278 File Offset: 0x00040478
		private void ResetTracker()
		{
			this._trackedObjects.Clear();
			int trackedObjectsVersion = this.TrackedObjectsVersion;
			this.TrackedObjectsVersion = trackedObjectsVersion + 1;
		}

		// Token: 0x04000413 RID: 1043
		[SaveableField(0)]
		private readonly MBList<TrackedObject> _trackedObjects;
	}
}
