using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem
{
	public class VisualTrackerManager
	{
		internal static void AutoGeneratedStaticCollectObjectsVisualTrackerManager(object o, List<object> collectedObjects)
		{
			((VisualTrackerManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._trackedObjects);
		}

		internal static object AutoGeneratedGetMemberValue_trackedObjects(object o)
		{
			return ((VisualTrackerManager)o)._trackedObjects;
		}

		public MBReadOnlyList<TrackedObject> TrackedObjects
		{
			get
			{
				return this._trackedObjects;
			}
		}

		[CachedData]
		public int TrackedObjectsVersion { get; private set; }

		public VisualTrackerManager()
		{
			this._trackedObjects = new MBList<TrackedObject>();
			this.Initialize();
		}

		[LoadInitializationCallback]
		private void OnLoad(MetaData metaData)
		{
			this.Initialize();
		}

		private void Initialize()
		{
			this.TrackedObjectsVersion = 0;
			this.CheckObjectValidities();
		}

		private void CheckObjectValidities()
		{
			foreach (TrackedObject trackedObject in this.TrackedObjects.ToList<TrackedObject>())
			{
				if (trackedObject.Object == null)
				{
					this._trackedObjects.Remove(trackedObject);
				}
			}
			int trackedObjectsVersion = this.TrackedObjectsVersion;
			this.TrackedObjectsVersion = trackedObjectsVersion + 1;
		}

		public void RegisterObject(ITrackableCampaignObject obj)
		{
			if (obj != null)
			{
				bool flag = false;
				foreach (TrackedObject trackedObject in this.TrackedObjects)
				{
					if (trackedObject.Object == obj)
					{
						flag = true;
						trackedObject.TrackerCount++;
					}
				}
				if (!flag)
				{
					TrackedObject trackedObject2 = new TrackedObject(obj);
					this._trackedObjects.Add(trackedObject2);
					int trackedObjectsVersion = this.TrackedObjectsVersion;
					this.TrackedObjectsVersion = trackedObjectsVersion + 1;
				}
			}
		}

		public bool CheckTracked(ITrackableBase obj)
		{
			using (List<TrackedObject>.Enumerator enumerator = this.TrackedObjects.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					if (enumerator.Current.Object == obj)
					{
						return true;
					}
				}
			}
			return false;
		}

		public bool CheckTracked(BasicCharacterObject agentCharacter)
		{
			using (List<TrackedObject>.Enumerator enumerator = this._trackedObjects.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					if (enumerator.Current.Object.CheckTracked(agentCharacter))
					{
						return true;
					}
				}
			}
			return false;
		}

		public void RemoveTrackedObject(ITrackableBase obj, bool forceRemove = false)
		{
			for (int i = this._trackedObjects.Count - 1; i >= 0; i--)
			{
				TrackedObject trackedObject = this._trackedObjects[i];
				if (trackedObject.Object == obj)
				{
					trackedObject.TrackerCount--;
					if (trackedObject.TrackerCount <= 0 || forceRemove)
					{
						this._trackedObjects.RemoveAt(i);
						int trackedObjectsVersion = this.TrackedObjectsVersion;
						this.TrackedObjectsVersion = trackedObjectsVersion + 1;
					}
				}
			}
		}

		private void ResetTracker()
		{
			this._trackedObjects.Clear();
			int trackedObjectsVersion = this.TrackedObjectsVersion;
			this.TrackedObjectsVersion = trackedObjectsVersion + 1;
		}

		[SaveableField(0)]
		private readonly MBList<TrackedObject> _trackedObjects;
	}
}
