using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.TournamentGames
{
	// Token: 0x0200027E RID: 638
	public class TournamentManager : ITournamentManager
	{
		// Token: 0x06002169 RID: 8553 RVA: 0x0008E4ED File Offset: 0x0008C6ED
		internal static void AutoGeneratedStaticCollectObjectsTournamentManager(object o, List<object> collectedObjects)
		{
			((TournamentManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x0600216A RID: 8554 RVA: 0x0008E4FB File Offset: 0x0008C6FB
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._activeTournaments);
			collectedObjects.Add(this._worldWideTournamentLeaderboard);
		}

		// Token: 0x0600216B RID: 8555 RVA: 0x0008E515 File Offset: 0x0008C715
		internal static object AutoGeneratedGetMemberValue_activeTournaments(object o)
		{
			return ((TournamentManager)o)._activeTournaments;
		}

		// Token: 0x0600216C RID: 8556 RVA: 0x0008E522 File Offset: 0x0008C722
		internal static object AutoGeneratedGetMemberValue_worldWideTournamentLeaderboard(object o)
		{
			return ((TournamentManager)o)._worldWideTournamentLeaderboard;
		}

		// Token: 0x0600216D RID: 8557 RVA: 0x0008E52F File Offset: 0x0008C72F
		public TournamentManager()
		{
			this._worldWideTournamentLeaderboard = new Dictionary<Hero, int>();
			this._activeTournaments = new List<TournamentGame>();
		}

		// Token: 0x0600216E RID: 8558 RVA: 0x0008E54D File Offset: 0x0008C74D
		public void AddTournament(TournamentGame game)
		{
			this._activeTournaments.Add(game);
			CampaignEventDispatcher.Instance.OnTournamentStarted(game.Town);
		}

		// Token: 0x0600216F RID: 8559 RVA: 0x0008E56B File Offset: 0x0008C76B
		public void RemoveTournament(TournamentGame game)
		{
			this._activeTournaments.Remove(game);
		}

		// Token: 0x06002170 RID: 8560 RVA: 0x0008E57C File Offset: 0x0008C77C
		public TournamentGame GetTournamentGame(Town town)
		{
			return this._activeTournaments.Find((TournamentGame x) => x != null && x.Town == town);
		}

		// Token: 0x06002171 RID: 8561 RVA: 0x0008E5AD File Offset: 0x0008C7AD
		public void OnPlayerJoinMatch(Type gameType)
		{
		}

		// Token: 0x06002172 RID: 8562 RVA: 0x0008E5B0 File Offset: 0x0008C7B0
		public void OnPlayerJoinTournament(Type gameType, Settlement settlement)
		{
			CampaignEventDispatcher.Instance.OnPlayerJoinedTournament(settlement.Town, true);
			TournamentGame tournamentGame = this.GetTournamentGame(settlement.Town);
			this._activeTournaments.Remove(tournamentGame);
		}

		// Token: 0x06002173 RID: 8563 RVA: 0x0008E5E8 File Offset: 0x0008C7E8
		public void OnPlayerWatchTournament(Type gameType, Settlement settlement)
		{
			CampaignEventDispatcher.Instance.OnPlayerJoinedTournament(settlement.Town, false);
			TournamentGame tournamentGame = this.GetTournamentGame(settlement.Town);
			this._activeTournaments.Remove(tournamentGame);
		}

		// Token: 0x06002174 RID: 8564 RVA: 0x0008E620 File Offset: 0x0008C820
		public void OnPlayerWinMatch(Type gameType)
		{
		}

		// Token: 0x06002175 RID: 8565 RVA: 0x0008E622 File Offset: 0x0008C822
		public void OnPlayerWinTournament(Type gameType)
		{
		}

		// Token: 0x06002176 RID: 8566 RVA: 0x0008E624 File Offset: 0x0008C824
		public List<KeyValuePair<Hero, int>> GetLeaderboard()
		{
			return this._worldWideTournamentLeaderboard.OrderByDescending(delegate(KeyValuePair<Hero, int> pair)
			{
				KeyValuePair<Hero, int> keyValuePair = pair;
				return keyValuePair.Value;
			}).ToList<KeyValuePair<Hero, int>>();
		}

		// Token: 0x06002177 RID: 8567 RVA: 0x0008E658 File Offset: 0x0008C858
		public int GetLeaderBoardRank(Hero hero)
		{
			return this.GetLeaderboard().FindIndex((KeyValuePair<Hero, int> kvp) => kvp.Key == hero) + 1;
		}

		// Token: 0x06002178 RID: 8568 RVA: 0x0008E68C File Offset: 0x0008C88C
		public Hero GetLeaderBoardLeader()
		{
			Dictionary<Hero, int> worldWideTournamentLeaderboard = this._worldWideTournamentLeaderboard;
			Hero hero = null;
			int num = -1;
			foreach (Hero hero2 in worldWideTournamentLeaderboard.Keys)
			{
				int num2 = worldWideTournamentLeaderboard[hero2];
				if (num2 > num)
				{
					num = num2;
					hero = hero2;
				}
			}
			return hero;
		}

		// Token: 0x06002179 RID: 8569 RVA: 0x0008E6FC File Offset: 0x0008C8FC
		public void InitializeLeaderboardEntry(Hero hero, int initialVictories = 0)
		{
			this._worldWideTournamentLeaderboard[hero] = initialVictories;
		}

		// Token: 0x0600217A RID: 8570 RVA: 0x0008E70C File Offset: 0x0008C90C
		public void AddLeaderboardEntry(Hero hero)
		{
			int num;
			this._worldWideTournamentLeaderboard.TryGetValue(hero, out num);
			this._worldWideTournamentLeaderboard[hero] = num + 1;
		}

		// Token: 0x0600217B RID: 8571 RVA: 0x0008E737 File Offset: 0x0008C937
		public void DeleteLeaderboardEntry(Hero hero)
		{
			if (this._worldWideTournamentLeaderboard.ContainsKey(hero))
			{
				this._worldWideTournamentLeaderboard.Remove(hero);
			}
		}

		// Token: 0x0600217C RID: 8572 RVA: 0x0008E754 File Offset: 0x0008C954
		public void ResolveTournament(TournamentGame tournament, Town town)
		{
			if (!town.IsUnderSiege)
			{
				MBList<CharacterObject> participantCharacters = tournament.GetParticipantCharacters(tournament.Town.Settlement, false);
				CharacterObject characterObject;
				this.SimulateTournament(participantCharacters, tournament.Town, out characterObject);
				if (characterObject.IsHero)
				{
					this.AddLeaderboardEntry(characterObject.HeroObject);
					this.GivePrizeToWinner(tournament, characterObject.HeroObject, false);
				}
				CampaignEventDispatcher.Instance.OnTournamentFinished(characterObject, participantCharacters, tournament.Town, tournament.Prize);
			}
			else
			{
				CampaignEventDispatcher.Instance.OnTournamentCancelled(town);
			}
			this.RemoveTournament(tournament);
		}

		// Token: 0x0600217D RID: 8573 RVA: 0x0008E7DC File Offset: 0x0008C9DC
		private void SimulateTournament(MBList<CharacterObject> participants, Town town, out CharacterObject winner)
		{
			float num = -1f;
			winner = null;
			foreach (CharacterObject characterObject in participants)
			{
				if (characterObject.IsHero)
				{
					ValueTuple<SkillObject, int> skillXpGainFromTournament = Campaign.Current.Models.TournamentModel.GetSkillXpGainFromTournament(town);
					SkillObject item = skillXpGainFromTournament.Item1;
					int item2 = skillXpGainFromTournament.Item2;
					characterObject.HeroObject.HeroDeveloper.AddSkillXp(item, (float)item2, true, true);
				}
				float num2 = Campaign.Current.Models.TournamentModel.GetTournamentSimulationScore(characterObject) * (0.75f + 0.25f * MBRandom.RandomFloat);
				if (num2 > num)
				{
					winner = characterObject;
					num = num2;
				}
			}
		}

		// Token: 0x0600217E RID: 8574 RVA: 0x0008E8A4 File Offset: 0x0008CAA4
		public void GivePrizeToWinner(TournamentGame tournament, Hero winner, bool isPlayerParticipated)
		{
			if (!isPlayerParticipated)
			{
				tournament.UpdateTournamentPrize(isPlayerParticipated, false);
			}
			if (winner.PartyBelongedTo == MobileParty.MainParty)
			{
				winner.PartyBelongedTo.ItemRoster.AddToCounts(tournament.Prize, 1);
				return;
			}
			if (winner.Clan != null)
			{
				GiveGoldAction.ApplyBetweenCharacters(null, winner.Clan.Leader, tournament.Town.MarketData.GetPrice(tournament.Prize, null, false, null), false);
			}
		}

		// Token: 0x04000A71 RID: 2673
		[SaveableField(1)]
		private List<TournamentGame> _activeTournaments;

		// Token: 0x04000A72 RID: 2674
		[SaveableField(4)]
		private readonly Dictionary<Hero, int> _worldWideTournamentLeaderboard;
	}
}
