using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.TournamentGames
{
	public class TournamentManager : ITournamentManager
	{
		internal static void AutoGeneratedStaticCollectObjectsTournamentManager(object o, List<object> collectedObjects)
		{
			((TournamentManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._activeTournaments);
			collectedObjects.Add(this._worldWideTournamentLeaderboard);
		}

		internal static object AutoGeneratedGetMemberValue_activeTournaments(object o)
		{
			return ((TournamentManager)o)._activeTournaments;
		}

		internal static object AutoGeneratedGetMemberValue_worldWideTournamentLeaderboard(object o)
		{
			return ((TournamentManager)o)._worldWideTournamentLeaderboard;
		}

		public TournamentManager()
		{
			this._worldWideTournamentLeaderboard = new Dictionary<Hero, int>();
			this._activeTournaments = new List<TournamentGame>();
		}

		public void AddTournament(TournamentGame game)
		{
			this._activeTournaments.Add(game);
			CampaignEventDispatcher.Instance.OnTournamentStarted(game.Town);
		}

		public void RemoveTournament(TournamentGame game)
		{
			this._activeTournaments.Remove(game);
		}

		public TournamentGame GetTournamentGame(Town town)
		{
			return this._activeTournaments.Find((TournamentGame x) => x != null && x.Town == town);
		}

		public void OnPlayerJoinMatch(Type gameType)
		{
		}

		public void OnPlayerJoinTournament(Type gameType, Settlement settlement)
		{
			CampaignEventDispatcher.Instance.OnPlayerJoinedTournament(settlement.Town, true);
			TournamentGame tournamentGame = this.GetTournamentGame(settlement.Town);
			this._activeTournaments.Remove(tournamentGame);
		}

		public void OnPlayerWatchTournament(Type gameType, Settlement settlement)
		{
			CampaignEventDispatcher.Instance.OnPlayerJoinedTournament(settlement.Town, false);
			TournamentGame tournamentGame = this.GetTournamentGame(settlement.Town);
			this._activeTournaments.Remove(tournamentGame);
		}

		public void OnPlayerWinMatch(Type gameType)
		{
		}

		public void OnPlayerWinTournament(Type gameType)
		{
		}

		public List<KeyValuePair<Hero, int>> GetLeaderboard()
		{
			return this._worldWideTournamentLeaderboard.OrderByDescending(delegate(KeyValuePair<Hero, int> pair)
			{
				KeyValuePair<Hero, int> keyValuePair = pair;
				return keyValuePair.Value;
			}).ToList<KeyValuePair<Hero, int>>();
		}

		public int GetLeaderBoardRank(Hero hero)
		{
			return this.GetLeaderboard().FindIndex((KeyValuePair<Hero, int> kvp) => kvp.Key == hero) + 1;
		}

		public Hero GetLeaderBoardLeader()
		{
			Dictionary<Hero, int> worldWideTournamentLeaderboard = this._worldWideTournamentLeaderboard;
			Hero hero = null;
			int num = -1;
			foreach (Hero hero2 in worldWideTournamentLeaderboard.Keys)
			{
				int num2 = worldWideTournamentLeaderboard[hero2];
				if (num2 > num)
				{
					num = num2;
					hero = hero2;
				}
			}
			return hero;
		}

		public void InitializeLeaderboardEntry(Hero hero, int initialVictories = 0)
		{
			this._worldWideTournamentLeaderboard[hero] = initialVictories;
		}

		public void AddLeaderboardEntry(Hero hero)
		{
			int num;
			this._worldWideTournamentLeaderboard.TryGetValue(hero, out num);
			this._worldWideTournamentLeaderboard[hero] = num + 1;
		}

		public void DeleteLeaderboardEntry(Hero hero)
		{
			if (this._worldWideTournamentLeaderboard.ContainsKey(hero))
			{
				this._worldWideTournamentLeaderboard.Remove(hero);
			}
		}

		public void ResolveTournament(TournamentGame tournament, Town town)
		{
			if (!town.IsUnderSiege)
			{
				MBList<CharacterObject> participantCharacters = tournament.GetParticipantCharacters(tournament.Town.Settlement, false);
				CharacterObject characterObject;
				this.SimulateTournament(participantCharacters, tournament.Town, out characterObject);
				if (characterObject.IsHero)
				{
					this.AddLeaderboardEntry(characterObject.HeroObject);
					this.GivePrizeToWinner(tournament, characterObject.HeroObject, false);
				}
				CampaignEventDispatcher.Instance.OnTournamentFinished(characterObject, participantCharacters, tournament.Town, tournament.Prize);
			}
			else
			{
				CampaignEventDispatcher.Instance.OnTournamentCancelled(town);
			}
			this.RemoveTournament(tournament);
		}

		private void SimulateTournament(MBList<CharacterObject> participants, Town town, out CharacterObject winner)
		{
			float num = -1f;
			winner = null;
			foreach (CharacterObject characterObject in participants)
			{
				if (characterObject.IsHero)
				{
					ValueTuple<SkillObject, int> skillXpGainFromTournament = Campaign.Current.Models.TournamentModel.GetSkillXpGainFromTournament(town);
					SkillObject item = skillXpGainFromTournament.Item1;
					int item2 = skillXpGainFromTournament.Item2;
					characterObject.HeroObject.HeroDeveloper.AddSkillXp(item, (float)item2, true, true);
				}
				float num2 = Campaign.Current.Models.TournamentModel.GetTournamentSimulationScore(characterObject) * (0.75f + 0.25f * MBRandom.RandomFloat);
				if (num2 > num)
				{
					winner = characterObject;
					num = num2;
				}
			}
		}

		public void GivePrizeToWinner(TournamentGame tournament, Hero winner, bool isPlayerParticipated)
		{
			if (!isPlayerParticipated)
			{
				tournament.UpdateTournamentPrize(isPlayerParticipated, false);
			}
			if (winner.PartyBelongedTo == MobileParty.MainParty)
			{
				winner.PartyBelongedTo.ItemRoster.AddToCounts(tournament.Prize, 1);
				return;
			}
			if (winner.Clan != null)
			{
				GiveGoldAction.ApplyBetweenCharacters(null, winner.Clan.Leader, tournament.Town.MarketData.GetPrice(tournament.Prize, null, false, null), false);
			}
		}

		[SaveableField(1)]
		private List<TournamentGame> _activeTournaments;

		[SaveableField(4)]
		private readonly Dictionary<Hero, int> _worldWideTournamentLeaderboard;
	}
}
