using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.BarterSystem.Barterables;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.MapNotificationTypes;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election
{
	// Token: 0x02000279 RID: 633
	public class MakePeaceKingdomDecision : KingdomDecision
	{
		// Token: 0x060020E7 RID: 8423 RVA: 0x0008BCDA File Offset: 0x00089EDA
		internal static void AutoGeneratedStaticCollectObjectsMakePeaceKingdomDecision(object o, List<object> collectedObjects)
		{
			((MakePeaceKingdomDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060020E8 RID: 8424 RVA: 0x0008BCE8 File Offset: 0x00089EE8
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.FactionToMakePeaceWith);
		}

		// Token: 0x060020E9 RID: 8425 RVA: 0x0008BCFD File Offset: 0x00089EFD
		internal static object AutoGeneratedGetMemberValueFactionToMakePeaceWith(object o)
		{
			return ((MakePeaceKingdomDecision)o).FactionToMakePeaceWith;
		}

		// Token: 0x060020EA RID: 8426 RVA: 0x0008BD0A File Offset: 0x00089F0A
		internal static object AutoGeneratedGetMemberValueDailyTributeToBePaid(object o)
		{
			return ((MakePeaceKingdomDecision)o).DailyTributeToBePaid;
		}

		// Token: 0x060020EB RID: 8427 RVA: 0x0008BD1C File Offset: 0x00089F1C
		internal static object AutoGeneratedGetMemberValue_applyResults(object o)
		{
			return ((MakePeaceKingdomDecision)o)._applyResults;
		}

		// Token: 0x060020EC RID: 8428 RVA: 0x0008BD2E File Offset: 0x00089F2E
		public MakePeaceKingdomDecision(Clan proposerClan, IFaction kingdomToMakePeaceWith, int dailyTributeToBePaid = 0, bool applyResults = true)
			: base(proposerClan)
		{
			this.FactionToMakePeaceWith = kingdomToMakePeaceWith;
			this.DailyTributeToBePaid = dailyTributeToBePaid;
			this._applyResults = applyResults;
		}

		// Token: 0x060020ED RID: 8429 RVA: 0x0008BD50 File Offset: 0x00089F50
		public override bool IsAllowed()
		{
			TextObject textObject;
			return Campaign.Current.Models.KingdomDecisionPermissionModel.IsPeaceDecisionAllowedBetweenKingdoms(base.Kingdom, this.FactionToMakePeaceWith as Kingdom, out textObject);
		}

		// Token: 0x060020EE RID: 8430 RVA: 0x0008BD84 File Offset: 0x00089F84
		public override int GetProposalInfluenceCost()
		{
			return Campaign.Current.Models.DiplomacyModel.GetInfluenceCostOfProposingPeace();
		}

		// Token: 0x060020EF RID: 8431 RVA: 0x0008BD9A File Offset: 0x00089F9A
		public override TextObject GetGeneralTitle()
		{
			TextObject textObject = new TextObject("{=v3xdiFfD}Make Peace With {KINGDOM_NAME}", null);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToMakePeaceWith.Name);
			return textObject;
		}

		// Token: 0x060020F0 RID: 8432 RVA: 0x0008BDC0 File Offset: 0x00089FC0
		public override TextObject GetSupportTitle()
		{
			TextObject textObject;
			if (this.DailyTributeToBePaid == 0)
			{
				textObject = new TextObject("{=0aXG8dvJ}Make peace with the {KINGDOM_NAME}. No tribute will be paid.", null);
			}
			else if (this.DailyTributeToBePaid > 0)
			{
				textObject = new TextObject("{=2b1xZGaQ}Make peace with the {KINGDOM_NAME}. Our kingdom will pay {T} tribute daily.", null);
			}
			else
			{
				textObject = new TextObject("{=NjPMRWbW}Make peace with the {KINGDOM_NAME}. Our kingdom will receive {T} tribute daily.", null);
			}
			textObject.SetTextVariable("T", MathF.Abs(this.DailyTributeToBePaid));
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToMakePeaceWith.InformalName);
			return textObject;
		}

		// Token: 0x060020F1 RID: 8433 RVA: 0x0008BE35 File Offset: 0x0008A035
		public override TextObject GetChooseTitle()
		{
			TextObject textObject = new TextObject("{=4GgfFDWG}Making peace with the {KINGDOM_NAME}", null);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToMakePeaceWith.InformalName);
			return textObject;
		}

		// Token: 0x060020F2 RID: 8434 RVA: 0x0008BE5C File Offset: 0x0008A05C
		public override TextObject GetSupportDescription()
		{
			TextObject textObject = TextObject.Empty;
			if (this.DailyTributeToBePaid != 0)
			{
				textObject = new TextObject("{=BlVjIlZF}{FACTION_LEADER} will decide if the {KINGDOM_CONSIDERING_PEACE_NAME} will make peace with the {KINGDOM_NAME} by paying {TRIBUTE_PERCENTAGE} percent of the kingdom's income as tribute. You can pick your stance regarding this decision.", null);
				textObject.SetTextVariable("T", this.DailyTributeToBePaid);
			}
			else
			{
				textObject = new TextObject("{=awoeb3br}{FACTION_LEADER} will decide if the {KINGDOM_CONSIDERING_PEACE_NAME} will make peace with the {KINGDOM_NAME}. You can pick your stance regarding this decision.", null);
			}
			textObject.SetTextVariable("FACTION_LEADER", this.DetermineChooser().Leader.Name);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToMakePeaceWith.InformalName);
			textObject.SetTextVariable("KINGDOM_CONSIDERING_PEACE_NAME", base.Kingdom.InformalName);
			return textObject;
		}

		// Token: 0x060020F3 RID: 8435 RVA: 0x0008BEF0 File Offset: 0x0008A0F0
		public override TextObject GetChooseDescription()
		{
			TextObject textObject = TextObject.Empty;
			if (this.DailyTributeToBePaid != 0)
			{
				textObject = new TextObject("{=n4I3pWOn}As the ruler, you must decide if peace will be made with the {KINGDOM_NAME} by paying {TRIBUTE_PERCENTAGE} percent of the kingdom's income as tribute.", null);
				textObject.SetTextVariable("TRIBUTE_PERCENTAGE", this.DailyTributeToBePaid);
			}
			else
			{
				textObject = new TextObject("{=KFHj7ckm}As the ruler, you must decide if peace will be made with the {KINGDOM_NAME}", null);
			}
			textObject.SetTextVariable("IS_FEMALE", this.DetermineChooser().Leader.IsFemale ? 1 : 0);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToMakePeaceWith.InformalName);
			return textObject;
		}

		// Token: 0x060020F4 RID: 8436 RVA: 0x0008BF71 File Offset: 0x0008A171
		public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
		{
			yield return new MakePeaceKingdomDecision.MakePeaceDecisionOutcome(true, base.Kingdom, this.FactionToMakePeaceWith);
			yield return new MakePeaceKingdomDecision.MakePeaceDecisionOutcome(false, base.Kingdom, this.FactionToMakePeaceWith);
			yield break;
		}

		// Token: 0x060020F5 RID: 8437 RVA: 0x0008BF81 File Offset: 0x0008A181
		public override Clan DetermineChooser()
		{
			return base.Kingdom.RulingClan;
		}

		// Token: 0x060020F6 RID: 8438 RVA: 0x0008BF8E File Offset: 0x0008A18E
		protected override bool ShouldBeCancelledInternal()
		{
			return !base.Kingdom.IsAtWarWith(this.FactionToMakePeaceWith);
		}

		// Token: 0x060020F7 RID: 8439 RVA: 0x0008BFA4 File Offset: 0x0008A1A4
		public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			foreach (DecisionOutcome decisionOutcome in possibleOutcomes)
			{
				if (((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)decisionOutcome).ShouldPeaceBeDeclared)
				{
					decisionOutcome.SetSponsor(base.ProposerClan);
				}
				else
				{
					base.AssignDefaultSponsor(decisionOutcome);
				}
			}
		}

		// Token: 0x060020F8 RID: 8440 RVA: 0x0008C010 File Offset: 0x0008A210
		public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
		{
			if (this._applyResults && ((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)chosenOutcome).ShouldPeaceBeDeclared)
			{
				MakePeaceAction.ApplyByKingdomDecision(base.Kingdom, this.FactionToMakePeaceWith, this.DailyTributeToBePaid);
			}
		}

		// Token: 0x060020F9 RID: 8441 RVA: 0x0008C040 File Offset: 0x0008A240
		public override bool OnShowDecision()
		{
			if (this.FactionToMakePeaceWith == Clan.PlayerClan.Kingdom && !Hero.MainHero.Clan.IsUnderMercenaryService)
			{
				if (!Hero.MainHero.IsPrisoner)
				{
					TextObject textObject = new TextObject("{=1V8f9vRM}A courier bearing a peace offer from the {PROPOSER_HERO_FACTION} has arrived at the court of your realm.", null);
					textObject.SetTextVariable("PROPOSER_HERO_FACTION", base.ProposerClan.Leader.MapFaction.InformalName);
					Campaign.Current.CampaignInformationManager.NewMapNoticeAdded(new PeaceOfferMapNotification(base.ProposerClan.MapFaction, this.DailyTributeToBePaid, textObject));
				}
				return false;
			}
			return true;
		}

		// Token: 0x060020FA RID: 8442 RVA: 0x0008C0D2 File Offset: 0x0008A2D2
		public override TextObject GetSecondaryEffects()
		{
			return new TextObject("{=!}All supporters gains some relation with each other.", null);
		}

		// Token: 0x060020FB RID: 8443 RVA: 0x0008C0DF File Offset: 0x0008A2DF
		public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
		{
			bool applyResults = this._applyResults;
		}

		// Token: 0x060020FC RID: 8444 RVA: 0x0008C0E8 File Offset: 0x0008A2E8
		public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, KingdomDecision.SupportStatus supportStatus, bool isShortVersion = false)
		{
			TextObject textObject;
			if (((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)chosenOutcome).ShouldPeaceBeDeclared)
			{
				if (base.IsSingleClanDecision())
				{
					textObject = new TextObject("{=CswzBb02}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM}.", null);
				}
				else if (supportStatus == KingdomDecision.SupportStatus.Majority)
				{
					textObject = new TextObject("{=17A2DDgD}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM} with the support of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council.", null);
				}
				else if (supportStatus == KingdomDecision.SupportStatus.Minority)
				{
					textObject = new TextObject("{=JDfnPFsW}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM} despite the opposition of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council.", null);
				}
				else
				{
					textObject = new TextObject("{=aEt1kqxm}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided to make peace with the {KINGDOM}, with his {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council evenly divided on the matter.", null);
				}
			}
			else if (base.IsSingleClanDecision())
			{
				textObject = new TextObject("{=wsDNxArW}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM}.", null);
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Majority)
			{
				textObject = new TextObject("{=mRrYn2qm}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM} with the support of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Minority)
			{
				textObject = new TextObject("{=Ing5gFbO}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has chosen not to make peace with the {KINGDOM} over the objections of {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else
			{
				textObject = new TextObject("{=AThZtg7U}{PEACEMAKER_RULER.NAME} of the {KINGDOM_CONSIDERING_PEACE} has decided against making peace with the {KINGDOM}, with his {?PEACEMAKER_RULER.GENDER}her{?}his{\\?} council evenly divided on the matter.", null);
			}
			StringHelpers.SetCharacterProperties("PEACEMAKER_RULER", base.Kingdom.Leader.CharacterObject, textObject, false);
			textObject.SetTextVariable("KINGDOM_CONSIDERING_PEACE", base.Kingdom.InformalName);
			textObject.SetTextVariable("KINGDOM", this.FactionToMakePeaceWith.InformalName);
			return textObject;
		}

		// Token: 0x060020FD RID: 8445 RVA: 0x0008C1DC File Offset: 0x0008A3DC
		public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)t).ShouldPeaceBeDeclared);
		}

		// Token: 0x060020FE RID: 8446 RVA: 0x0008C203 File Offset: 0x0008A403
		public float CalculateSupport(Clan clan)
		{
			return this.DetermineSupport(clan, new MakePeaceKingdomDecision.MakePeaceDecisionOutcome(true, base.Kingdom, this.FactionToMakePeaceWith));
		}

		// Token: 0x060020FF RID: 8447 RVA: 0x0008C220 File Offset: 0x0008A420
		public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
		{
			MakePeaceKingdomDecision.MakePeaceDecisionOutcome makePeaceDecisionOutcome = (MakePeaceKingdomDecision.MakePeaceDecisionOutcome)possibleOutcome;
			float valueForFaction = (float)new PeaceBarterable(base.Kingdom, this.FactionToMakePeaceWith, CampaignTime.Years(1f)).GetValueForFaction(clan);
			float num = ((clan.Leader != null) ? ((clan.Leader.Gold < 50000) ? (1f + 0.5f * ((50000f - (float)clan.Leader.Gold) / 50000f)) : ((clan.Leader.Gold > 200000) ? MathF.Max(0.66f, MathF.Pow(200000f / (float)clan.Leader.Gold, 0.4f)) : 1f)) : 1f);
			int traitLevel = clan.Leader.GetTraitLevel(DefaultTraits.Generosity);
			float num2 = ((this.DailyTributeToBePaid > 0) ? (1f - 0.1f * (float)MathF.Max(-2, MathF.Min(2, traitLevel))) : 1f);
			float num3 = (valueForFaction - (float)((int)((float)Campaign.Current.Models.DiplomacyModel.GetValueOfDailyTribute(this.DailyTributeToBePaid) * num * num2))) * Campaign.Current.Models.DiplomacyModel.DenarsToInfluence();
			if (makePeaceDecisionOutcome.ShouldPeaceBeDeclared)
			{
				float num4 = num3;
				int num5 = clan.Leader.GetTraitLevel(DefaultTraits.Mercy) * 10;
				return num4 + (float)num5;
			}
			float num6 = -num3;
			int num7 = -clan.Leader.GetTraitLevel(DefaultTraits.Mercy) * 10;
			return num6 + (float)num7;
		}

		// Token: 0x04000A55 RID: 2645
		[SaveableField(101)]
		public readonly IFaction FactionToMakePeaceWith;

		// Token: 0x04000A56 RID: 2646
		[SaveableField(103)]
		private readonly bool _applyResults;

		// Token: 0x04000A57 RID: 2647
		[SaveableField(110)]
		public readonly int DailyTributeToBePaid;

		// Token: 0x02000589 RID: 1417
		public class MakePeaceDecisionOutcome : DecisionOutcome
		{
			// Token: 0x06004446 RID: 17478 RVA: 0x00138F48 File Offset: 0x00137148
			internal static void AutoGeneratedStaticCollectObjectsMakePeaceDecisionOutcome(object o, List<object> collectedObjects)
			{
				((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x06004447 RID: 17479 RVA: 0x00138F56 File Offset: 0x00137156
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this.Kingdom);
				collectedObjects.Add(this.FactionToMakePeaceWith);
			}

			// Token: 0x06004448 RID: 17480 RVA: 0x00138F77 File Offset: 0x00137177
			internal static object AutoGeneratedGetMemberValueShouldPeaceBeDeclared(object o)
			{
				return ((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)o).ShouldPeaceBeDeclared;
			}

			// Token: 0x06004449 RID: 17481 RVA: 0x00138F89 File Offset: 0x00137189
			internal static object AutoGeneratedGetMemberValueKingdom(object o)
			{
				return ((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)o).Kingdom;
			}

			// Token: 0x0600444A RID: 17482 RVA: 0x00138F96 File Offset: 0x00137196
			internal static object AutoGeneratedGetMemberValueFactionToMakePeaceWith(object o)
			{
				return ((MakePeaceKingdomDecision.MakePeaceDecisionOutcome)o).FactionToMakePeaceWith;
			}

			// Token: 0x0600444B RID: 17483 RVA: 0x00138FA3 File Offset: 0x001371A3
			public MakePeaceDecisionOutcome(bool shouldPeaceBeDeclared, Kingdom kingdom, IFaction factionToMakePeaceWith)
			{
				this.ShouldPeaceBeDeclared = shouldPeaceBeDeclared;
				this.Kingdom = kingdom;
				this.FactionToMakePeaceWith = factionToMakePeaceWith;
			}

			// Token: 0x0600444C RID: 17484 RVA: 0x00138FC0 File Offset: 0x001371C0
			public override TextObject GetDecisionTitle()
			{
				TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}", null);
				textObject.SetTextVariable("SUPPORT", this.ShouldPeaceBeDeclared ? 1 : 0);
				return textObject;
			}

			// Token: 0x0600444D RID: 17485 RVA: 0x00138FE8 File Offset: 0x001371E8
			public override TextObject GetDecisionDescription()
			{
				if (base.SponsorClan != null && this.Kingdom != null && this.FactionToMakePeaceWith != null && base.SponsorClan != Clan.PlayerClan)
				{
					TextObject empty = TextObject.Empty;
					if (this.ShouldPeaceBeDeclared)
					{
						Campaign.Current.Models.DiplomacyModel.GetScoreOfDeclaringPeace(this.Kingdom, this.FactionToMakePeaceWith, base.SponsorClan, out empty);
					}
					if (empty != TextObject.Empty)
					{
						return empty;
					}
				}
				if (this.ShouldPeaceBeDeclared)
				{
					return new TextObject("{=THz06NQD}It is time to make peace", null);
				}
				return new TextObject("{=jQpeuHIE}We oppose making peace at this time", null);
			}

			// Token: 0x0600444E RID: 17486 RVA: 0x0013907A File Offset: 0x0013727A
			public override string GetDecisionLink()
			{
				return null;
			}

			// Token: 0x0600444F RID: 17487 RVA: 0x0013907D File Offset: 0x0013727D
			public override ImageIdentifier GetDecisionImageIdentifier()
			{
				return null;
			}

			// Token: 0x04001720 RID: 5920
			[SaveableField(100)]
			public readonly bool ShouldPeaceBeDeclared;

			// Token: 0x04001721 RID: 5921
			[SaveableField(110)]
			public readonly Kingdom Kingdom;

			// Token: 0x04001722 RID: 5922
			[SaveableField(120)]
			public readonly IFaction FactionToMakePeaceWith;
		}
	}
}
