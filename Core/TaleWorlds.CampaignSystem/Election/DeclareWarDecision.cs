using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.BarterSystem.Barterables;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election
{
	// Token: 0x02000278 RID: 632
	public class DeclareWarDecision : KingdomDecision
	{
		// Token: 0x060020D1 RID: 8401 RVA: 0x0008B88B File Offset: 0x00089A8B
		internal static void AutoGeneratedStaticCollectObjectsDeclareWarDecision(object o, List<object> collectedObjects)
		{
			((DeclareWarDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060020D2 RID: 8402 RVA: 0x0008B899 File Offset: 0x00089A99
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.FactionToDeclareWarOn);
		}

		// Token: 0x060020D3 RID: 8403 RVA: 0x0008B8AE File Offset: 0x00089AAE
		internal static object AutoGeneratedGetMemberValueFactionToDeclareWarOn(object o)
		{
			return ((DeclareWarDecision)o).FactionToDeclareWarOn;
		}

		// Token: 0x060020D4 RID: 8404 RVA: 0x0008B8BB File Offset: 0x00089ABB
		public DeclareWarDecision(Clan proposerClan, IFaction factionToDeclareWarOn)
			: base(proposerClan)
		{
			this.FactionToDeclareWarOn = factionToDeclareWarOn;
		}

		// Token: 0x060020D5 RID: 8405 RVA: 0x0008B8CC File Offset: 0x00089ACC
		public override bool IsAllowed()
		{
			TextObject textObject;
			return !this.FactionToDeclareWarOn.IsKingdomFaction || Campaign.Current.Models.KingdomDecisionPermissionModel.IsWarDecisionAllowedBetweenKingdoms(base.Kingdom, this.FactionToDeclareWarOn as Kingdom, out textObject);
		}

		// Token: 0x060020D6 RID: 8406 RVA: 0x0008B90F File Offset: 0x00089B0F
		public override int GetProposalInfluenceCost()
		{
			return Campaign.Current.Models.DiplomacyModel.GetInfluenceCostOfProposingWar(base.Kingdom);
		}

		// Token: 0x060020D7 RID: 8407 RVA: 0x0008B92B File Offset: 0x00089B2B
		public override TextObject GetGeneralTitle()
		{
			TextObject textObject = new TextObject("{=rtfoywJl}Declare war on the {KINGDOM_NAME}", null);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020D8 RID: 8408 RVA: 0x0008B94F File Offset: 0x00089B4F
		public override TextObject GetSupportTitle()
		{
			TextObject textObject = new TextObject("{=xM97H0oR}Vote for declaring war on the {KINGDOM_NAME}.", null);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020D9 RID: 8409 RVA: 0x0008B973 File Offset: 0x00089B73
		public override TextObject GetChooseTitle()
		{
			TextObject textObject = new TextObject("{=aQAI99d4}Declaring War on the {KINGDOM_NAME}", null);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020DA RID: 8410 RVA: 0x0008B997 File Offset: 0x00089B97
		public override TextObject GetSupportDescription()
		{
			TextObject textObject = new TextObject("{=KSrNutEO}{FACTION_LEADER} will decide if war will be declared on the {KINGDOM_NAME}. You can pick your stance regarding this decision.", null);
			textObject.SetTextVariable("FACTION_LEADER", this.DetermineChooser().Leader.Name);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020DB RID: 8411 RVA: 0x0008B9D8 File Offset: 0x00089BD8
		public override TextObject GetChooseDescription()
		{
			TextObject textObject = new TextObject("{=4JSzHkpt}As {?IS_FEMALE}queen{?}king{\\?}, you must decide if war will be declared on the {KINGDOM_NAME}", null);
			textObject.SetTextVariable("IS_FEMALE", this.DetermineChooser().Leader.IsFemale ? 1 : 0);
			textObject.SetTextVariable("KINGDOM_NAME", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020DC RID: 8412 RVA: 0x0008BA29 File Offset: 0x00089C29
		public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
		{
			yield return new DeclareWarDecision.DeclareWarDecisionOutcome(true, base.Kingdom, this.FactionToDeclareWarOn);
			yield return new DeclareWarDecision.DeclareWarDecisionOutcome(false, base.Kingdom, this.FactionToDeclareWarOn);
			yield break;
		}

		// Token: 0x060020DD RID: 8413 RVA: 0x0008BA39 File Offset: 0x00089C39
		public override Clan DetermineChooser()
		{
			return base.Kingdom.RulingClan;
		}

		// Token: 0x060020DE RID: 8414 RVA: 0x0008BA46 File Offset: 0x00089C46
		protected override bool ShouldBeCancelledInternal()
		{
			return base.Kingdom.IsAtWarWith(this.FactionToDeclareWarOn);
		}

		// Token: 0x060020DF RID: 8415 RVA: 0x0008BA5C File Offset: 0x00089C5C
		public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			foreach (DecisionOutcome decisionOutcome in possibleOutcomes)
			{
				if (((DeclareWarDecision.DeclareWarDecisionOutcome)decisionOutcome).ShouldWarBeDeclared)
				{
					decisionOutcome.SetSponsor(base.ProposerClan);
				}
				else
				{
					base.AssignDefaultSponsor(decisionOutcome);
				}
			}
		}

		// Token: 0x060020E0 RID: 8416 RVA: 0x0008BAC8 File Offset: 0x00089CC8
		public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
		{
			if (((DeclareWarDecision.DeclareWarDecisionOutcome)chosenOutcome).ShouldWarBeDeclared)
			{
				DeclareWarAction.ApplyByKingdomDecision(base.Kingdom, this.FactionToDeclareWarOn);
			}
		}

		// Token: 0x060020E1 RID: 8417 RVA: 0x0008BAE8 File Offset: 0x00089CE8
		public override TextObject GetSecondaryEffects()
		{
			return new TextObject("{=!}All supporters gains some relation with each other.", null);
		}

		// Token: 0x060020E2 RID: 8418 RVA: 0x0008BAF5 File Offset: 0x00089CF5
		public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
		{
		}

		// Token: 0x060020E3 RID: 8419 RVA: 0x0008BAF8 File Offset: 0x00089CF8
		public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, KingdomDecision.SupportStatus supportStatus, bool isShortVersion = false)
		{
			TextObject textObject;
			if (((DeclareWarDecision.DeclareWarDecisionOutcome)chosenOutcome).ShouldWarBeDeclared)
			{
				if (base.IsSingleClanDecision())
				{
					textObject = new TextObject("{=Shk9QCDg}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} has declared war on the {KINGDOM}.", null);
				}
				else if (supportStatus == KingdomDecision.SupportStatus.Majority)
				{
					textObject = new TextObject("{=cRpsjvOM}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} has declared war on the {KINGDOM} with the support of {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council.", null);
				}
				else if (supportStatus == KingdomDecision.SupportStatus.Minority)
				{
					textObject = new TextObject("{=DphlPaF9}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} has declared war on the {KINGDOM} despite opposition from {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council.", null);
				}
				else
				{
					textObject = new TextObject("{=RH8mgLEk}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} has declared war on the {KINGDOM} with support from half of {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council.", null);
				}
			}
			else if (base.IsSingleClanDecision())
			{
				textObject = new TextObject("{=9WDK03GW}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} chose not to go to war with the {KINGDOM}.", null);
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Majority)
			{
				textObject = new TextObject("{=8RBZaQKk}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} chose not to go to war with the {KINGDOM} with the support of {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Minority)
			{
				textObject = new TextObject("{=XaZyU3Cn}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} chose not to go to war with the {KINGDOM} despite the wishes of {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else
			{
				textObject = new TextObject("{=5L0wDGhR}{AGGRESSOR_RULER.NAME} of the {AGGRESSOR_KINGDOM} chose not to go to war with the {KINGDOM}, with {?AGGRESSOR_RULER.GENDER}her{?}his{\\?} council evenly split.", null);
			}
			StringHelpers.SetCharacterProperties("AGGRESSOR_RULER", base.Kingdom.Leader.CharacterObject, textObject, false);
			textObject.SetTextVariable("AGGRESSOR_KINGDOM", base.Kingdom.EncyclopediaLinkWithName);
			textObject.SetTextVariable("KINGDOM", this.FactionToDeclareWarOn.InformalName);
			return textObject;
		}

		// Token: 0x060020E4 RID: 8420 RVA: 0x0008BBEC File Offset: 0x00089DEC
		public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((DeclareWarDecision.DeclareWarDecisionOutcome)t).ShouldWarBeDeclared);
		}

		// Token: 0x060020E5 RID: 8421 RVA: 0x0008BC13 File Offset: 0x00089E13
		public float CalculateSupport(Clan clan)
		{
			return this.DetermineSupport(clan, new DeclareWarDecision.DeclareWarDecisionOutcome(true, base.Kingdom, this.FactionToDeclareWarOn));
		}

		// Token: 0x060020E6 RID: 8422 RVA: 0x0008BC30 File Offset: 0x00089E30
		public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
		{
			Hero leader = clan.Leader;
			DeclareWarDecision.DeclareWarDecisionOutcome declareWarDecisionOutcome = (DeclareWarDecision.DeclareWarDecisionOutcome)possibleOutcome;
			float num = (float)new DeclareWarBarterable(base.Kingdom, this.FactionToDeclareWarOn).GetValueForFaction(clan) * Campaign.Current.Models.DiplomacyModel.DenarsToInfluence();
			if (declareWarDecisionOutcome.ShouldWarBeDeclared)
			{
				float num2 = num;
				int num3 = clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 20 - clan.Leader.GetTraitLevel(DefaultTraits.Mercy) * 10;
				return num2 + (float)num3;
			}
			float num4 = -num;
			int num5 = -clan.Leader.GetTraitLevel(DefaultTraits.Valor) * 20 + clan.Leader.GetTraitLevel(DefaultTraits.Mercy) * 10;
			return num4 + (float)num5;
		}

		// Token: 0x04000A54 RID: 2644
		[SaveableField(101)]
		public readonly IFaction FactionToDeclareWarOn;

		// Token: 0x02000586 RID: 1414
		public class DeclareWarDecisionOutcome : DecisionOutcome
		{
			// Token: 0x06004431 RID: 17457 RVA: 0x00138CE8 File Offset: 0x00136EE8
			internal static void AutoGeneratedStaticCollectObjectsDeclareWarDecisionOutcome(object o, List<object> collectedObjects)
			{
				((DeclareWarDecision.DeclareWarDecisionOutcome)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x06004432 RID: 17458 RVA: 0x00138CF6 File Offset: 0x00136EF6
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this.Kingdom);
				collectedObjects.Add(this.FactionToDeclareWarOn);
			}

			// Token: 0x06004433 RID: 17459 RVA: 0x00138D17 File Offset: 0x00136F17
			internal static object AutoGeneratedGetMemberValueShouldWarBeDeclared(object o)
			{
				return ((DeclareWarDecision.DeclareWarDecisionOutcome)o).ShouldWarBeDeclared;
			}

			// Token: 0x06004434 RID: 17460 RVA: 0x00138D29 File Offset: 0x00136F29
			internal static object AutoGeneratedGetMemberValueKingdom(object o)
			{
				return ((DeclareWarDecision.DeclareWarDecisionOutcome)o).Kingdom;
			}

			// Token: 0x06004435 RID: 17461 RVA: 0x00138D36 File Offset: 0x00136F36
			internal static object AutoGeneratedGetMemberValueFactionToDeclareWarOn(object o)
			{
				return ((DeclareWarDecision.DeclareWarDecisionOutcome)o).FactionToDeclareWarOn;
			}

			// Token: 0x06004436 RID: 17462 RVA: 0x00138D43 File Offset: 0x00136F43
			public DeclareWarDecisionOutcome(bool shouldWarBeDeclared, Kingdom kingdom, IFaction factionToDeclareWarOn)
			{
				this.ShouldWarBeDeclared = shouldWarBeDeclared;
				this.Kingdom = kingdom;
				this.FactionToDeclareWarOn = factionToDeclareWarOn;
			}

			// Token: 0x06004437 RID: 17463 RVA: 0x00138D60 File Offset: 0x00136F60
			public override TextObject GetDecisionTitle()
			{
				TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}", null);
				textObject.SetTextVariable("SUPPORT", this.ShouldWarBeDeclared ? 1 : 0);
				return textObject;
			}

			// Token: 0x06004438 RID: 17464 RVA: 0x00138D88 File Offset: 0x00136F88
			public override TextObject GetDecisionDescription()
			{
				if (base.SponsorClan != null && this.Kingdom != null && this.FactionToDeclareWarOn != null && base.SponsorClan != Clan.PlayerClan)
				{
					TextObject empty = TextObject.Empty;
					if (this.ShouldWarBeDeclared)
					{
						Campaign.Current.Models.DiplomacyModel.GetScoreOfDeclaringWar(this.Kingdom, this.FactionToDeclareWarOn, base.SponsorClan, out empty);
					}
					if (empty != TextObject.Empty)
					{
						return empty;
					}
				}
				if (this.ShouldWarBeDeclared)
				{
					return new TextObject("{=w9olmhv0}It is time to declare war", null);
				}
				return new TextObject("{=epnk9qIt}We oppose a declaration of war", null);
			}

			// Token: 0x06004439 RID: 17465 RVA: 0x00138E1A File Offset: 0x0013701A
			public override string GetDecisionLink()
			{
				return null;
			}

			// Token: 0x0600443A RID: 17466 RVA: 0x00138E1D File Offset: 0x0013701D
			public override ImageIdentifier GetDecisionImageIdentifier()
			{
				return null;
			}

			// Token: 0x04001717 RID: 5911
			[SaveableField(100)]
			public readonly bool ShouldWarBeDeclared;

			// Token: 0x04001718 RID: 5912
			[SaveableField(110)]
			public readonly Kingdom Kingdom;

			// Token: 0x04001719 RID: 5913
			[SaveableField(120)]
			public readonly IFaction FactionToDeclareWarOn;
		}
	}
}
