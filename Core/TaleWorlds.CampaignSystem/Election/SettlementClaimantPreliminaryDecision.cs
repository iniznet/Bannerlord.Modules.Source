using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Election
{
	// Token: 0x02000276 RID: 630
	public class SettlementClaimantPreliminaryDecision : KingdomDecision
	{
		// Token: 0x060020AD RID: 8365 RVA: 0x0008B17F File Offset: 0x0008937F
		internal static void AutoGeneratedStaticCollectObjectsSettlementClaimantPreliminaryDecision(object o, List<object> collectedObjects)
		{
			((SettlementClaimantPreliminaryDecision)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060020AE RID: 8366 RVA: 0x0008B18D File Offset: 0x0008938D
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Settlement);
			collectedObjects.Add(this._ownerClan);
		}

		// Token: 0x060020AF RID: 8367 RVA: 0x0008B1AE File Offset: 0x000893AE
		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((SettlementClaimantPreliminaryDecision)o).Settlement;
		}

		// Token: 0x060020B0 RID: 8368 RVA: 0x0008B1BB File Offset: 0x000893BB
		internal static object AutoGeneratedGetMemberValue_ownerClan(object o)
		{
			return ((SettlementClaimantPreliminaryDecision)o)._ownerClan;
		}

		// Token: 0x060020B1 RID: 8369 RVA: 0x0008B1C8 File Offset: 0x000893C8
		public SettlementClaimantPreliminaryDecision(Clan proposerClan, Settlement settlement)
			: base(proposerClan)
		{
			this.Settlement = settlement;
			this._ownerClan = settlement.OwnerClan;
		}

		// Token: 0x060020B2 RID: 8370 RVA: 0x0008B1E4 File Offset: 0x000893E4
		public override bool IsAllowed()
		{
			return Campaign.Current.Models.KingdomDecisionPermissionModel.IsAnnexationDecisionAllowed(this.Settlement);
		}

		// Token: 0x060020B3 RID: 8371 RVA: 0x0008B200 File Offset: 0x00089400
		public override int GetProposalInfluenceCost()
		{
			return Campaign.Current.Models.DiplomacyModel.GetInfluenceCostOfAnnexation(base.Kingdom);
		}

		// Token: 0x060020B4 RID: 8372 RVA: 0x0008B21C File Offset: 0x0008941C
		public override TextObject GetGeneralTitle()
		{
			TextObject textObject = new TextObject("{=XFr4IfXf} Change Owner of {SETTLEMENT}", null);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			return textObject;
		}

		// Token: 0x060020B5 RID: 8373 RVA: 0x0008B240 File Offset: 0x00089440
		public override TextObject GetSupportTitle()
		{
			TextObject textObject = new TextObject("{=a48xlNUb}Should the owner of {SETTLEMENT} change?", null);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			return textObject;
		}

		// Token: 0x060020B6 RID: 8374 RVA: 0x0008B264 File Offset: 0x00089464
		public override TextObject GetChooseTitle()
		{
			TextObject textObject = new TextObject("{=a48xlNUb}Should the owner of {SETTLEMENT} change?", null);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			return textObject;
		}

		// Token: 0x060020B7 RID: 8375 RVA: 0x0008B288 File Offset: 0x00089488
		public override TextObject GetSupportDescription()
		{
			TextObject textObject = new TextObject("{=hBJbnoDn}{FACTION_LEADER} will decide if the owner of {SETTLEMENT} will change.", null);
			textObject.SetTextVariable("FACTION_LEADER", this.DetermineChooser().Leader.Name);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			return textObject;
		}

		// Token: 0x060020B8 RID: 8376 RVA: 0x0008B2C8 File Offset: 0x000894C8
		public override TextObject GetChooseDescription()
		{
			TextObject textObject = new TextObject("{=JHR4ySCf}As {?IS_FEMALE}queen{?}king{\\?} you must decide if the owner of {SETTLEMENT} should change.", null);
			textObject.SetTextVariable("IS_FEMALE", this.DetermineChooser().Leader.IsFemale ? 1 : 0);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			return textObject;
		}

		// Token: 0x060020B9 RID: 8377 RVA: 0x0008B31C File Offset: 0x0008951C
		public override float CalculateMeritOfOutcome(DecisionOutcome candidateOutcome)
		{
			float num = 0f;
			float num2 = 50f;
			List<Clan> list = new List<Clan>();
			if (this._ownerClan.Kingdom != null)
			{
				list.AddRange(this._ownerClan.Kingdom.Clans.ToList<Clan>());
			}
			else
			{
				list.Add(this._ownerClan);
			}
			foreach (Clan clan in list)
			{
				int relation = clan.Leader.GetRelation(this._ownerClan.Leader);
				bool shouldSettlementOwnerChange = ((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)candidateOutcome).ShouldSettlementOwnerChange;
				if ((!shouldSettlementOwnerChange && relation > 0) || (shouldSettlementOwnerChange && relation <= 0))
				{
					num += num2 * (float)MathF.Abs(relation);
				}
			}
			return num;
		}

		// Token: 0x060020BA RID: 8378 RVA: 0x0008B3F0 File Offset: 0x000895F0
		public override IEnumerable<DecisionOutcome> DetermineInitialCandidates()
		{
			yield return new SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome(true);
			yield return new SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome(false);
			yield break;
		}

		// Token: 0x060020BB RID: 8379 RVA: 0x0008B3F9 File Offset: 0x000895F9
		public override Clan DetermineChooser()
		{
			return ((Kingdom)this.Settlement.MapFaction).RulingClan;
		}

		// Token: 0x060020BC RID: 8380 RVA: 0x0008B410 File Offset: 0x00089610
		protected override bool ShouldBeCancelledInternal()
		{
			return this.Settlement.MapFaction != base.Kingdom;
		}

		// Token: 0x060020BD RID: 8381 RVA: 0x0008B428 File Offset: 0x00089628
		public float CalculateSupport(Clan clan)
		{
			return this.DetermineSupport(clan, new SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome(true));
		}

		// Token: 0x060020BE RID: 8382 RVA: 0x0008B438 File Offset: 0x00089638
		public override float DetermineSupport(Clan clan, DecisionOutcome possibleOutcome)
		{
			bool shouldSettlementOwnerChange = ((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)possibleOutcome).ShouldSettlementOwnerChange;
			int num = clan.GetRelationWithClan(this._ownerClan);
			if (clan == this._ownerClan)
			{
				num = 300;
			}
			float num2 = 20f;
			if (this.Settlement.OwnerClan == clan)
			{
				num2 *= 20f;
			}
			else
			{
				num2 += (float)num * 0.7f;
				float totalStrength = this.Settlement.OwnerClan.TotalStrength;
				num2 += totalStrength * 0.01f;
			}
			float num3 = 0f;
			if (shouldSettlementOwnerChange)
			{
				num3 = -num2;
			}
			else if (!shouldSettlementOwnerChange)
			{
				num3 = num2;
			}
			return num3;
		}

		// Token: 0x060020BF RID: 8383 RVA: 0x0008B4C8 File Offset: 0x000896C8
		public override void DetermineSponsors(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			foreach (DecisionOutcome decisionOutcome in possibleOutcomes)
			{
				if (((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)decisionOutcome).ShouldSettlementOwnerChange)
				{
					decisionOutcome.SetSponsor(base.ProposerClan);
				}
				else
				{
					base.AssignDefaultSponsor(decisionOutcome);
				}
			}
		}

		// Token: 0x060020C0 RID: 8384 RVA: 0x0008B534 File Offset: 0x00089734
		protected override int GetInfluenceCostOfSupportInternal(Supporter.SupportWeights supportWeight)
		{
			if (this.Settlement.IsTown)
			{
				if (supportWeight == Supporter.SupportWeights.SlightlyFavor)
				{
					return 20;
				}
				if (supportWeight == Supporter.SupportWeights.StronglyFavor)
				{
					return 60;
				}
				if (supportWeight != Supporter.SupportWeights.FullyPush)
				{
					return 0;
				}
				return 200;
			}
			else
			{
				if (supportWeight == Supporter.SupportWeights.SlightlyFavor)
				{
					return 15;
				}
				if (supportWeight == Supporter.SupportWeights.StronglyFavor)
				{
					return 50;
				}
				if (supportWeight != Supporter.SupportWeights.FullyPush)
				{
					return 0;
				}
				return 150;
			}
		}

		// Token: 0x060020C1 RID: 8385 RVA: 0x0008B584 File Offset: 0x00089784
		public override void ApplyChosenOutcome(DecisionOutcome chosenOutcome)
		{
			if (((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)chosenOutcome).ShouldSettlementOwnerChange)
			{
				SettlementClaimantDecision settlementClaimantDecision = new SettlementClaimantDecision(base.ProposerClan, this.Settlement, null, this._ownerClan);
				settlementClaimantDecision.IsEnforced = true;
				base.ProposerClan.Kingdom.AddDecision(settlementClaimantDecision, true);
			}
		}

		// Token: 0x060020C2 RID: 8386 RVA: 0x0008B5D0 File Offset: 0x000897D0
		public override TextObject GetSecondaryEffects()
		{
			return new TextObject("{=CsZfuPOe}Voting against or in favor of the current owner of the settlement will affect your relation with that clan accordingly.", null);
		}

		// Token: 0x060020C3 RID: 8387 RVA: 0x0008B5E0 File Offset: 0x000897E0
		public override void ApplySecondaryEffects(MBReadOnlyList<DecisionOutcome> possibleOutcomes, DecisionOutcome chosenOutcome)
		{
			foreach (DecisionOutcome decisionOutcome in possibleOutcomes)
			{
				bool shouldSettlementOwnerChange = ((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)decisionOutcome).ShouldSettlementOwnerChange;
				foreach (Supporter supporter in decisionOutcome.SupporterList)
				{
					if (supporter.Clan.Leader != this._ownerClan.Leader)
					{
						ChangeRelationAction.ApplyRelationChangeBetweenHeroes(supporter.Clan.Leader, this._ownerClan.Leader, Campaign.Current.Models.DiplomacyModel.GetRelationChangeAfterVotingInSettlementOwnerPreliminaryDecision(supporter.Clan.Leader, shouldSettlementOwnerChange), true);
					}
				}
			}
		}

		// Token: 0x060020C4 RID: 8388 RVA: 0x0008B6C8 File Offset: 0x000898C8
		public override TextObject GetChosenOutcomeText(DecisionOutcome chosenOutcome, KingdomDecision.SupportStatus supportStatus, bool isShortVersion = false)
		{
			TextObject textObject = TextObject.Empty;
			if (((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)chosenOutcome).ShouldSettlementOwnerChange)
			{
				if (supportStatus == KingdomDecision.SupportStatus.Majority)
				{
					textObject = new TextObject("{=Zo65bOpH}{RULER.NAME} has decided to give {SETTLEMENT} to a new clan with the support of with {?RULER.GENDER}her{?}his{\\?} council.", null);
				}
				else if (supportStatus == KingdomDecision.SupportStatus.Minority)
				{
					textObject = new TextObject("{=w3sfcpoa}{RULER.NAME} has decided to give {SETTLEMENT} to a new clan despite the opposition of {?RULER.GENDER}her{?}his{\\?} council", null);
				}
				else
				{
					textObject = new TextObject("{=JzALLCEX}{RULER.NAME} has decided to give {SETTLEMENT} to a new clan, with {?RULER.GENDER}her{?}his{\\?} council evenly split on the matter.", null);
				}
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Majority)
			{
				textObject = new TextObject("{=vkeHpUEB}{RULER.NAME} has decided against giving {SETTLEMENT} to a new clan with the support of with {?RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else if (supportStatus == KingdomDecision.SupportStatus.Minority)
			{
				textObject = new TextObject("{=9Cbeagow}{RULER.NAME} has decided against giving {SETTLEMENT} to a new clan over the objections of {?RULER.GENDER}her{?}his{\\?} council.", null);
			}
			else
			{
				textObject = new TextObject("{=fP8NHthR}{RULER.NAME} has decided against giving {SETTLEMENT} to a new clan, with {?RULER.GENDER}her{?}his{\\?} council evenly split on the matter.", null);
			}
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.Name);
			textObject.SetTextVariable("KINGDOM", this.Settlement.MapFaction.InformalName);
			StringHelpers.SetCharacterProperties("RULER", this.Settlement.MapFaction.Leader.CharacterObject, textObject, false);
			return textObject;
		}

		// Token: 0x060020C5 RID: 8389 RVA: 0x0008B7A0 File Offset: 0x000899A0
		public override DecisionOutcome GetQueriedDecisionOutcome(MBReadOnlyList<DecisionOutcome> possibleOutcomes)
		{
			return possibleOutcomes.FirstOrDefault((DecisionOutcome t) => ((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)t).ShouldSettlementOwnerChange);
		}

		// Token: 0x04000A4F RID: 2639
		[SaveableField(400)]
		public readonly Settlement Settlement;

		// Token: 0x04000A50 RID: 2640
		[SaveableField(401)]
		private Clan _ownerClan;

		// Token: 0x02000582 RID: 1410
		public class SettlementClaimantPreliminaryOutcome : DecisionOutcome
		{
			// Token: 0x0600441E RID: 17438 RVA: 0x00138B65 File Offset: 0x00136D65
			internal static void AutoGeneratedStaticCollectObjectsSettlementClaimantPreliminaryOutcome(object o, List<object> collectedObjects)
			{
				((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x0600441F RID: 17439 RVA: 0x00138B73 File Offset: 0x00136D73
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x06004420 RID: 17440 RVA: 0x00138B7C File Offset: 0x00136D7C
			internal static object AutoGeneratedGetMemberValueShouldSettlementOwnerChange(object o)
			{
				return ((SettlementClaimantPreliminaryDecision.SettlementClaimantPreliminaryOutcome)o).ShouldSettlementOwnerChange;
			}

			// Token: 0x06004421 RID: 17441 RVA: 0x00138B8E File Offset: 0x00136D8E
			public override TextObject GetDecisionTitle()
			{
				TextObject textObject = new TextObject("{=kakxnaN5}{?SUPPORT}Yes{?}No{\\?}", null);
				textObject.SetTextVariable("SUPPORT", this.ShouldSettlementOwnerChange ? 1 : 0);
				return textObject;
			}

			// Token: 0x06004422 RID: 17442 RVA: 0x00138BB3 File Offset: 0x00136DB3
			public override TextObject GetDecisionDescription()
			{
				if (this.ShouldSettlementOwnerChange)
				{
					return new TextObject("{=1bbsq6uw}We should award this fief to a new clan", null);
				}
				return new TextObject("{=uBcEUdxu}Ownership of the fief should remain as it is", null);
			}

			// Token: 0x06004423 RID: 17443 RVA: 0x00138BD4 File Offset: 0x00136DD4
			public override string GetDecisionLink()
			{
				return null;
			}

			// Token: 0x06004424 RID: 17444 RVA: 0x00138BD7 File Offset: 0x00136DD7
			public override ImageIdentifier GetDecisionImageIdentifier()
			{
				return null;
			}

			// Token: 0x06004425 RID: 17445 RVA: 0x00138BDA File Offset: 0x00136DDA
			public SettlementClaimantPreliminaryOutcome(bool shouldSettlementOwnerChange)
			{
				this.ShouldSettlementOwnerChange = shouldSettlementOwnerChange;
			}

			// Token: 0x0400170B RID: 5899
			[SaveableField(400)]
			public bool ShouldSettlementOwnerChange;
		}
	}
}
