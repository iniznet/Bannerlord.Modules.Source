using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.GameState
{
	// Token: 0x0200032B RID: 811
	public class MenuContext : MBObjectBase
	{
		// Token: 0x06002DE3 RID: 11747 RVA: 0x000BF861 File Offset: 0x000BDA61
		internal static void AutoGeneratedStaticCollectObjectsMenuContext(object o, List<object> collectedObjects)
		{
			((MenuContext)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002DE4 RID: 11748 RVA: 0x000BF86F File Offset: 0x000BDA6F
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002DE5 RID: 11749 RVA: 0x000BF878 File Offset: 0x000BDA78
		internal static object AutoGeneratedGetMemberValue_currentState(object o)
		{
			return ((MenuContext)o)._currentState;
		}

		// Token: 0x17000AE9 RID: 2793
		// (get) Token: 0x06002DE6 RID: 11750 RVA: 0x000BF88A File Offset: 0x000BDA8A
		// (set) Token: 0x06002DE7 RID: 11751 RVA: 0x000BF892 File Offset: 0x000BDA92
		public GameMenu GameMenu { get; private set; }

		// Token: 0x17000AEA RID: 2794
		// (get) Token: 0x06002DE8 RID: 11752 RVA: 0x000BF89B File Offset: 0x000BDA9B
		// (set) Token: 0x06002DE9 RID: 11753 RVA: 0x000BF8A3 File Offset: 0x000BDAA3
		public IMenuContextHandler Handler { get; set; }

		// Token: 0x17000AEB RID: 2795
		// (get) Token: 0x06002DEA RID: 11754 RVA: 0x000BF8AC File Offset: 0x000BDAAC
		// (set) Token: 0x06002DEB RID: 11755 RVA: 0x000BF8B4 File Offset: 0x000BDAB4
		public string CurrentBackgroundMeshName { get; private set; }

		// Token: 0x17000AEC RID: 2796
		// (get) Token: 0x06002DEC RID: 11756 RVA: 0x000BF8BD File Offset: 0x000BDABD
		// (set) Token: 0x06002DED RID: 11757 RVA: 0x000BF8C5 File Offset: 0x000BDAC5
		public string CurrentAmbientSoundID { get; private set; }

		// Token: 0x17000AED RID: 2797
		// (get) Token: 0x06002DEE RID: 11758 RVA: 0x000BF8CE File Offset: 0x000BDACE
		// (set) Token: 0x06002DEF RID: 11759 RVA: 0x000BF8D6 File Offset: 0x000BDAD6
		public string CurrentPanelSoundID { get; private set; }

		// Token: 0x06002DF0 RID: 11760 RVA: 0x000BF8DF File Offset: 0x000BDADF
		public void Refresh()
		{
			this._currentState = MenuContext.MenuContextState.RequiresCreation;
			this.HandleStates();
		}

		// Token: 0x06002DF1 RID: 11761 RVA: 0x000BF8EE File Offset: 0x000BDAEE
		public void SwitchToMenu(string menuId)
		{
			Campaign.Current.GameMenuManager.SetNextMenu(menuId);
			this.HandleStates();
		}

		// Token: 0x06002DF2 RID: 11762 RVA: 0x000BF908 File Offset: 0x000BDB08
		private void HandleStates()
		{
			if (this._currentState != MenuContext.MenuContextState.Finalized)
			{
				if (!string.IsNullOrEmpty(Campaign.Current.GameMenuManager.NextGameMenuId))
				{
					this._currentState = MenuContext.MenuContextState.RequiresCreation;
				}
				while (this._currentState == MenuContext.MenuContextState.RequiresCreation)
				{
					if (this.GameMenu != null)
					{
						this.GameMenu.PreInit(this);
					}
					if (Campaign.Current.GameMenuManager.NextGameMenuId != null)
					{
						this.GameMenu = Campaign.Current.GameMenuManager.NextMenu;
						Campaign.Current.GameMenuManager.SetNextMenu(null);
						MapState mapState = Game.Current.GameStateManager.LastOrDefault<MapState>();
						if (mapState != null)
						{
							mapState.GameMenuId = this.GameMenu.StringId;
						}
					}
					if (this.GameMenu.AutoSelectFirst)
					{
						Campaign.Current.GameMenuManager.RunConsequenceOfVirtualMenuOption(this, 0);
					}
					this.GameMenu.RunOnInit(Game.Current, this);
					if (string.IsNullOrEmpty(Campaign.Current.GameMenuManager.NextGameMenuId) && this._currentState != MenuContext.MenuContextState.Finalized)
					{
						this._currentState = MenuContext.MenuContextState.RequiresInitialization;
					}
				}
				if (this._currentState == MenuContext.MenuContextState.RequiresInitialization)
				{
					this._currentState = MenuContext.MenuContextState.None;
					if (this.Handler != null)
					{
						this.Handler.OnMenuCreate();
					}
					Campaign.Current.GameMenuCallbackManager.InitializeState(this.GameMenu.StringId, this);
					if (this.Handler != null)
					{
						this.Handler.OnMenuActivate();
					}
				}
			}
		}

		// Token: 0x06002DF3 RID: 11763 RVA: 0x000BFA6C File Offset: 0x000BDC6C
		public void Destroy()
		{
			this._currentState = MenuContext.MenuContextState.Finalized;
			MapState mapState = Game.Current.GameStateManager.ActiveState as MapState;
			if (mapState != null)
			{
				mapState.GameMenuId = null;
			}
		}

		// Token: 0x06002DF4 RID: 11764 RVA: 0x000BFA9F File Offset: 0x000BDC9F
		public void OnTick(float dt)
		{
			Campaign.Current.GameMenuManager.OnFrameTick(this, dt);
		}

		// Token: 0x06002DF5 RID: 11765 RVA: 0x000BFAB2 File Offset: 0x000BDCB2
		public void OnHourlyTick()
		{
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnHourlyTick();
		}

		// Token: 0x06002DF6 RID: 11766 RVA: 0x000BFAC4 File Offset: 0x000BDCC4
		public object GetCurrentRepeatableObject()
		{
			return Campaign.Current.GameMenuManager.ObjectGetCurrentRepeatableObject(this);
		}

		// Token: 0x06002DF7 RID: 11767 RVA: 0x000BFAD6 File Offset: 0x000BDCD6
		public object GetSelectedObject()
		{
			return Campaign.Current.GameMenuManager.GetSelectedRepeatableObject(this);
		}

		// Token: 0x06002DF8 RID: 11768 RVA: 0x000BFAE8 File Offset: 0x000BDCE8
		public object GetSelectedRepeatableObject()
		{
			return Campaign.Current.GameMenuManager.GetSelectedRepeatableObject(this);
		}

		// Token: 0x06002DF9 RID: 11769 RVA: 0x000BFAFA File Offset: 0x000BDCFA
		public void SetRepeatObjectList(IEnumerable<object> list)
		{
			Campaign.Current.GameMenuManager.SetRepeatObjectList(this, list);
		}

		// Token: 0x06002DFA RID: 11770 RVA: 0x000BFB0D File Offset: 0x000BDD0D
		public void OnConsequence(GameMenuOption gameMenuOption)
		{
			if (Campaign.Current == null)
			{
				return;
			}
			Campaign.Current.GameMenuCallbackManager.OnConsequence(this.GameMenu.StringId, gameMenuOption, this);
		}

		// Token: 0x06002DFB RID: 11771 RVA: 0x000BFB33 File Offset: 0x000BDD33
		public void InvokeConsequence(int index)
		{
			if (Campaign.Current.CurrentMenuContext != this)
			{
				return;
			}
			Campaign.Current.GameMenuManager.RunConsequenceOfVirtualMenuOption(this, index);
		}

		// Token: 0x06002DFC RID: 11772 RVA: 0x000BFB54 File Offset: 0x000BDD54
		public void CloseEvent()
		{
			if (Settlement.CurrentSettlement != null)
			{
				Campaign.Current.MapEventManager.FinalizePlayerMapEvent(null);
				Campaign.Current.autoEnterTown = Settlement.CurrentSettlement.Party;
				Game.Current.GameStateManager.PopState(0);
			}
		}

		// Token: 0x06002DFD RID: 11773 RVA: 0x000BFB91 File Offset: 0x000BDD91
		public void SetBackgroundMeshName(string name)
		{
			this.CurrentBackgroundMeshName = name;
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnBackgroundMeshNameSet(name);
		}

		// Token: 0x06002DFE RID: 11774 RVA: 0x000BFBAB File Offset: 0x000BDDAB
		public void SetPanelSound(string panelSoundID)
		{
			this.CurrentPanelSoundID = panelSoundID;
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnPanelSoundIDSet(panelSoundID);
		}

		// Token: 0x06002DFF RID: 11775 RVA: 0x000BFBC5 File Offset: 0x000BDDC5
		public void SetAmbientSound(string ambientSoundID)
		{
			this.CurrentAmbientSoundID = ambientSoundID;
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnAmbientSoundIDSet(ambientSoundID);
		}

		// Token: 0x06002E00 RID: 11776 RVA: 0x000BFBDF File Offset: 0x000BDDDF
		public void OpenTownManagement()
		{
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnOpenTownManagement();
		}

		// Token: 0x06002E01 RID: 11777 RVA: 0x000BFBF1 File Offset: 0x000BDDF1
		public void OpenRecruitVolunteers()
		{
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnOpenRecruitVolunteers();
		}

		// Token: 0x06002E02 RID: 11778 RVA: 0x000BFC03 File Offset: 0x000BDE03
		public void OpenTournamentLeaderboards()
		{
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnOpenTournamentLeaderboard();
		}

		// Token: 0x06002E03 RID: 11779 RVA: 0x000BFC15 File Offset: 0x000BDE15
		public void OpenTroopSelection(TroopRoster fullRoster, TroopRoster initialSelections, Func<CharacterObject, bool> canChangeStatusOfTroop, Action<TroopRoster> onDone, int maxSelectableTroopCount, int minSelectableTroopCount = 1)
		{
			IMenuContextHandler handler = this.Handler;
			if (handler == null)
			{
				return;
			}
			handler.OnOpenTroopSelection(fullRoster, initialSelections, canChangeStatusOfTroop, onDone, maxSelectableTroopCount, minSelectableTroopCount);
		}

		// Token: 0x04000DD7 RID: 3543
		[SaveableField(102)]
		private MenuContext.MenuContextState _currentState;

		// Token: 0x02000679 RID: 1657
		internal enum MenuContextState
		{
			// Token: 0x04001B2E RID: 6958
			None,
			// Token: 0x04001B2F RID: 6959
			RequiresCreation,
			// Token: 0x04001B30 RID: 6960
			RequiresInitialization,
			// Token: 0x04001B31 RID: 6961
			Finalized
		}
	}
}
