using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.MapEvents
{
	// Token: 0x020002BD RID: 701
	public class MapEventManager
	{
		// Token: 0x06002898 RID: 10392 RVA: 0x000ACAEB File Offset: 0x000AACEB
		internal static void AutoGeneratedStaticCollectObjectsMapEventManager(object o, List<object> collectedObjects)
		{
			((MapEventManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002899 RID: 10393 RVA: 0x000ACAF9 File Offset: 0x000AACF9
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._mapEvents);
		}

		// Token: 0x0600289A RID: 10394 RVA: 0x000ACB07 File Offset: 0x000AAD07
		internal static object AutoGeneratedGetMemberValue_mapEvents(object o)
		{
			return ((MapEventManager)o)._mapEvents;
		}

		// Token: 0x0600289B RID: 10395 RVA: 0x000ACB14 File Offset: 0x000AAD14
		internal MapEventManager()
		{
			this._mapEvents = new List<MapEvent>();
		}

		// Token: 0x0600289C RID: 10396 RVA: 0x000ACB28 File Offset: 0x000AAD28
		internal void OnAfterLoad()
		{
			foreach (MapEvent mapEvent in this._mapEvents)
			{
				mapEvent.OnAfterLoad();
			}
		}

		// Token: 0x0600289D RID: 10397 RVA: 0x000ACB78 File Offset: 0x000AAD78
		public void OnMapEventCreated(MapEvent mapEvent)
		{
			this._mapEvents.Add(mapEvent);
		}

		// Token: 0x0600289E RID: 10398 RVA: 0x000ACB88 File Offset: 0x000AAD88
		internal void Tick()
		{
			for (int i = this._mapEvents.Count - 1; i >= 0; i--)
			{
				if (this._mapEvents[i].IsFinished)
				{
					this._mapEvents.RemoveAt(i);
				}
				else if (this._mapEvents[i].IsRaid || this._mapEvents[i] != MobileParty.MainParty.MapEvent)
				{
					this._mapEvents[i].Update();
				}
			}
		}

		// Token: 0x0600289F RID: 10399 RVA: 0x000ACC0C File Offset: 0x000AAE0C
		public MapEvent GetMapEvent(int attackerPartyIndex)
		{
			return this._mapEvents.FirstOrDefault((MapEvent mapEvent) => mapEvent.AttackerSide.LeaderParty.Index == attackerPartyIndex);
		}

		// Token: 0x060028A0 RID: 10400 RVA: 0x000ACC40 File Offset: 0x000AAE40
		public List<MapEvent> GetMapEventsBetweenFactions(IFaction faction1, IFaction faction2)
		{
			List<MapEvent> list = new List<MapEvent>();
			Func<MapEventParty, bool> <>9__0;
			Func<MapEventParty, bool> <>9__1;
			Func<MapEventParty, bool> <>9__2;
			Func<MapEventParty, bool> <>9__3;
			foreach (MapEvent mapEvent in this._mapEvents)
			{
				MBReadOnlyList<MapEventParty> mbreadOnlyList = mapEvent.PartiesOnSide(BattleSideEnum.Defender);
				MBReadOnlyList<MapEventParty> mbreadOnlyList2 = mapEvent.PartiesOnSide(BattleSideEnum.Attacker);
				IEnumerable<MapEventParty> enumerable = mbreadOnlyList;
				Func<MapEventParty, bool> func;
				if ((func = <>9__0) == null)
				{
					func = (<>9__0 = (MapEventParty mapEventParty) => mapEventParty.Party.MapFaction == faction1);
				}
				if (enumerable.Any(func))
				{
					IEnumerable<MapEventParty> enumerable2 = mbreadOnlyList2;
					Func<MapEventParty, bool> func2;
					if ((func2 = <>9__1) == null)
					{
						func2 = (<>9__1 = (MapEventParty mapEventParty) => mapEventParty.Party.MapFaction == faction2);
					}
					if (enumerable2.Any(func2))
					{
						goto IL_ED;
					}
				}
				IEnumerable<MapEventParty> enumerable3 = mbreadOnlyList;
				Func<MapEventParty, bool> func3;
				if ((func3 = <>9__2) == null)
				{
					func3 = (<>9__2 = (MapEventParty mapEventParty) => mapEventParty.Party.MapFaction == faction2);
				}
				if (!enumerable3.Any(func3))
				{
					continue;
				}
				IEnumerable<MapEventParty> enumerable4 = mbreadOnlyList2;
				Func<MapEventParty, bool> func4;
				if ((func4 = <>9__3) == null)
				{
					func4 = (<>9__3 = (MapEventParty mapEventParty) => mapEventParty.Party.MapFaction == faction1);
				}
				if (!enumerable4.Any(func4))
				{
					continue;
				}
				IL_ED:
				list.Add(mapEvent);
			}
			return list;
		}

		// Token: 0x060028A1 RID: 10401 RVA: 0x000ACD70 File Offset: 0x000AAF70
		public void FinalizePlayerMapEvent(MapEvent mapEvent = null)
		{
			if (MobileParty.MainParty.MapEvent == null)
			{
				throw new MBNotFoundException("Trying to finalize a non-existing map event.");
			}
			PartyBase.MainParty.MapEvent.FinalizeEvent();
			PlayerEncounter.Finish(true);
		}

		// Token: 0x060028A2 RID: 10402 RVA: 0x000ACDA0 File Offset: 0x000AAFA0
		public MapEvent StartBattleMapEvent(PartyBase attackerParty, PartyBase defenderParty)
		{
			MapEvent mapEvent = new MapEvent();
			mapEvent.Initialize(attackerParty, defenderParty, null, MapEvent.BattleTypes.FieldBattle);
			this.OnMapEventCreated(mapEvent);
			return mapEvent;
		}

		// Token: 0x060028A3 RID: 10403 RVA: 0x000ACDC8 File Offset: 0x000AAFC8
		public MapEvent StartSiegeMapEvent(PartyBase attackerParty, PartyBase defenderParty)
		{
			MapEvent mapEvent = new MapEvent();
			mapEvent.Initialize(attackerParty, defenderParty, null, MapEvent.BattleTypes.Siege);
			this.OnMapEventCreated(mapEvent);
			return mapEvent;
		}

		// Token: 0x060028A4 RID: 10404 RVA: 0x000ACDF0 File Offset: 0x000AAFF0
		public MapEvent StartHideoutMapEvent(PartyBase attackerParty, PartyBase defenderParty)
		{
			MapEvent mapEvent = new MapEvent();
			mapEvent.Initialize(attackerParty, defenderParty, null, MapEvent.BattleTypes.Hideout);
			this.OnMapEventCreated(mapEvent);
			return mapEvent;
		}

		// Token: 0x060028A5 RID: 10405 RVA: 0x000ACE18 File Offset: 0x000AB018
		public MapEvent StartSallyOutMapEvent(PartyBase attackerParty, PartyBase defenderParty)
		{
			MapEvent mapEvent = new MapEvent();
			mapEvent.Initialize(attackerParty, defenderParty, null, MapEvent.BattleTypes.SallyOut);
			this.OnMapEventCreated(mapEvent);
			return mapEvent;
		}

		// Token: 0x060028A6 RID: 10406 RVA: 0x000ACE40 File Offset: 0x000AB040
		public MapEvent StartSiegeOutsideMapEvent(PartyBase attackerParty, PartyBase defenderParty)
		{
			MapEvent mapEvent = new MapEvent();
			mapEvent.Initialize(attackerParty, defenderParty, null, MapEvent.BattleTypes.SiegeOutside);
			this.OnMapEventCreated(mapEvent);
			return mapEvent;
		}

		// Token: 0x04000C5F RID: 3167
		[SaveableField(1)]
		private List<MapEvent> _mapEvents;
	}
}
