using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Siege;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Load;

namespace TaleWorlds.CampaignSystem.MapEvents
{
	// Token: 0x020002BC RID: 700
	public sealed class MapEvent : MBObjectBase, IMapEntity
	{
		// Token: 0x0600280B RID: 10251 RVA: 0x000AA1F5 File Offset: 0x000A83F5
		internal static void AutoGeneratedStaticCollectObjectsMapEvent(object o, List<object> collectedObjects)
		{
			((MapEvent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x0600280C RID: 10252 RVA: 0x000AA204 File Offset: 0x000A8404
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.StrengthOfSide);
			collectedObjects.Add(this._sides);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this._nextSimulationTime, collectedObjects);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this._mapEventStartTime, collectedObjects);
			collectedObjects.Add(this.Component);
			collectedObjects.Add(this.MapEventSettlement);
		}

		// Token: 0x0600280D RID: 10253 RVA: 0x000AA26A File Offset: 0x000A846A
		internal static object AutoGeneratedGetMemberValueComponent(object o)
		{
			return ((MapEvent)o).Component;
		}

		// Token: 0x0600280E RID: 10254 RVA: 0x000AA277 File Offset: 0x000A8477
		internal static object AutoGeneratedGetMemberValueMapEventSettlement(object o)
		{
			return ((MapEvent)o).MapEventSettlement;
		}

		// Token: 0x0600280F RID: 10255 RVA: 0x000AA284 File Offset: 0x000A8484
		internal static object AutoGeneratedGetMemberValuePosition(object o)
		{
			return ((MapEvent)o).Position;
		}

		// Token: 0x06002810 RID: 10256 RVA: 0x000AA296 File Offset: 0x000A8496
		internal static object AutoGeneratedGetMemberValueIsInvulnerable(object o)
		{
			return ((MapEvent)o).IsInvulnerable;
		}

		// Token: 0x06002811 RID: 10257 RVA: 0x000AA2A8 File Offset: 0x000A84A8
		internal static object AutoGeneratedGetMemberValueIsPlayerSimulation(object o)
		{
			return ((MapEvent)o).IsPlayerSimulation;
		}

		// Token: 0x06002812 RID: 10258 RVA: 0x000AA2BA File Offset: 0x000A84BA
		internal static object AutoGeneratedGetMemberValueStrengthOfSide(object o)
		{
			return ((MapEvent)o).StrengthOfSide;
		}

		// Token: 0x06002813 RID: 10259 RVA: 0x000AA2C7 File Offset: 0x000A84C7
		internal static object AutoGeneratedGetMemberValue_state(object o)
		{
			return ((MapEvent)o)._state;
		}

		// Token: 0x06002814 RID: 10260 RVA: 0x000AA2D9 File Offset: 0x000A84D9
		internal static object AutoGeneratedGetMemberValue_sides(object o)
		{
			return ((MapEvent)o)._sides;
		}

		// Token: 0x06002815 RID: 10261 RVA: 0x000AA2E6 File Offset: 0x000A84E6
		internal static object AutoGeneratedGetMemberValue_mapEventUpdateCount(object o)
		{
			return ((MapEvent)o)._mapEventUpdateCount;
		}

		// Token: 0x06002816 RID: 10262 RVA: 0x000AA2F8 File Offset: 0x000A84F8
		internal static object AutoGeneratedGetMemberValue_nextSimulationTime(object o)
		{
			return ((MapEvent)o)._nextSimulationTime;
		}

		// Token: 0x06002817 RID: 10263 RVA: 0x000AA30A File Offset: 0x000A850A
		internal static object AutoGeneratedGetMemberValue_mapEventStartTime(object o)
		{
			return ((MapEvent)o)._mapEventStartTime;
		}

		// Token: 0x06002818 RID: 10264 RVA: 0x000AA31C File Offset: 0x000A851C
		internal static object AutoGeneratedGetMemberValue_mapEventType(object o)
		{
			return ((MapEvent)o)._mapEventType;
		}

		// Token: 0x06002819 RID: 10265 RVA: 0x000AA32E File Offset: 0x000A852E
		internal static object AutoGeneratedGetMemberValue_isVisible(object o)
		{
			return ((MapEvent)o)._isVisible;
		}

		// Token: 0x0600281A RID: 10266 RVA: 0x000AA340 File Offset: 0x000A8540
		internal static object AutoGeneratedGetMemberValueFirstUpdateIsDone(object o)
		{
			return ((MapEvent)o).FirstUpdateIsDone;
		}

		// Token: 0x0600281B RID: 10267 RVA: 0x000AA352 File Offset: 0x000A8552
		internal static object AutoGeneratedGetMemberValue_battleState(object o)
		{
			return ((MapEvent)o)._battleState;
		}

		// Token: 0x170009F8 RID: 2552
		// (get) Token: 0x0600281C RID: 10268 RVA: 0x000AA364 File Offset: 0x000A8564
		public static MapEvent PlayerMapEvent
		{
			get
			{
				MobileParty mainParty = MobileParty.MainParty;
				if (mainParty == null)
				{
					return null;
				}
				return mainParty.MapEvent;
			}
		}

		// Token: 0x170009F9 RID: 2553
		// (get) Token: 0x0600281D RID: 10269 RVA: 0x000AA376 File Offset: 0x000A8576
		public BattleSideEnum PlayerSide
		{
			get
			{
				return PartyBase.MainParty.Side;
			}
		}

		// Token: 0x170009FA RID: 2554
		// (get) Token: 0x0600281E RID: 10270 RVA: 0x000AA382 File Offset: 0x000A8582
		// (set) Token: 0x0600281F RID: 10271 RVA: 0x000AA38A File Offset: 0x000A858A
		internal IBattleObserver BattleObserver { get; set; }

		// Token: 0x170009FB RID: 2555
		// (get) Token: 0x06002820 RID: 10272 RVA: 0x000AA393 File Offset: 0x000A8593
		// (set) Token: 0x06002821 RID: 10273 RVA: 0x000AA39B File Offset: 0x000A859B
		[SaveableProperty(105)]
		public MapEventComponent Component { get; private set; }

		// Token: 0x170009FC RID: 2556
		// (get) Token: 0x06002822 RID: 10274 RVA: 0x000AA3A4 File Offset: 0x000A85A4
		// (set) Token: 0x06002823 RID: 10275 RVA: 0x000AA3AC File Offset: 0x000A85AC
		public MapEventState State
		{
			get
			{
				return this._state;
			}
			private set
			{
				if (this._state != value)
				{
					this._state = value;
				}
			}
		}

		// Token: 0x06002824 RID: 10276 RVA: 0x000AA3BE File Offset: 0x000A85BE
		public void BeginWait()
		{
			this.State = MapEventState.Wait;
		}

		// Token: 0x170009FD RID: 2557
		// (get) Token: 0x06002825 RID: 10277 RVA: 0x000AA3C7 File Offset: 0x000A85C7
		public MapEventSide AttackerSide
		{
			get
			{
				return this._sides[1];
			}
		}

		// Token: 0x170009FE RID: 2558
		// (get) Token: 0x06002826 RID: 10278 RVA: 0x000AA3D1 File Offset: 0x000A85D1
		public MapEventSide DefenderSide
		{
			get
			{
				return this._sides[0];
			}
		}

		// Token: 0x06002827 RID: 10279 RVA: 0x000AA3DB File Offset: 0x000A85DB
		public MapEventSide GetMapEventSide(BattleSideEnum side)
		{
			return this._sides[(int)side];
		}

		// Token: 0x06002828 RID: 10280 RVA: 0x000AA3E5 File Offset: 0x000A85E5
		internal TroopRoster GetMemberRosterReceivingLootShare(PartyBase party)
		{
			return this._sides[(int)party.Side].MemberRosterForPlayerLootShare(party);
		}

		// Token: 0x06002829 RID: 10281 RVA: 0x000AA3FA File Offset: 0x000A85FA
		internal TroopRoster GetPrisonerRosterReceivingLootShare(PartyBase party)
		{
			return this._sides[(int)party.Side].PrisonerRosterForPlayerLootShare(party);
		}

		// Token: 0x0600282A RID: 10282 RVA: 0x000AA40F File Offset: 0x000A860F
		internal ItemRoster GetItemRosterReceivingLootShare(PartyBase party)
		{
			return this._sides[(int)party.Side].ItemRosterForPlayerLootShare(party);
		}

		// Token: 0x0600282B RID: 10283 RVA: 0x000AA424 File Offset: 0x000A8624
		public MBReadOnlyList<MapEventParty> PartiesOnSide(BattleSideEnum side)
		{
			return this._sides[(int)side].Parties;
		}

		// Token: 0x170009FF RID: 2559
		// (get) Token: 0x0600282C RID: 10284 RVA: 0x000AA433 File Offset: 0x000A8633
		public IEnumerable<PartyBase> InvolvedParties
		{
			get
			{
				foreach (MapEventSide mapEventSide in this._sides)
				{
					foreach (MapEventParty mapEventParty in mapEventSide.Parties)
					{
						yield return mapEventParty.Party;
					}
					List<MapEventParty>.Enumerator enumerator = default(List<MapEventParty>.Enumerator);
				}
				MapEventSide[] array = null;
				yield break;
				yield break;
			}
		}

		// Token: 0x17000A00 RID: 2560
		// (get) Token: 0x0600282D RID: 10285 RVA: 0x000AA443 File Offset: 0x000A8643
		// (set) Token: 0x0600282E RID: 10286 RVA: 0x000AA44B File Offset: 0x000A864B
		[SaveableProperty(103)]
		public Settlement MapEventSettlement { get; private set; }

		// Token: 0x17000A01 RID: 2561
		// (get) Token: 0x0600282F RID: 10287 RVA: 0x000AA454 File Offset: 0x000A8654
		// (set) Token: 0x06002830 RID: 10288 RVA: 0x000AA45C File Offset: 0x000A865C
		internal bool AttackersRanAway { get; private set; }

		// Token: 0x06002831 RID: 10289 RVA: 0x000AA468 File Offset: 0x000A8668
		public void GetBattleRewards(PartyBase party, out float renownChange, out float influenceChange, out float moraleChange, out float goldChange, out float playerEarnedLootPercentage)
		{
			renownChange = 0f;
			influenceChange = 0f;
			moraleChange = 0f;
			goldChange = 0f;
			playerEarnedLootPercentage = 0f;
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				foreach (MapEventParty mapEventParty in sides[i].Parties)
				{
					if (party == mapEventParty.Party)
					{
						renownChange = mapEventParty.GainedRenown;
						influenceChange = mapEventParty.GainedInfluence;
						moraleChange = mapEventParty.MoraleChange;
						goldChange = (float)(mapEventParty.PlunderedGold - mapEventParty.GoldLost);
						float num = (float)this.GetMapEventSide(mapEventParty.Party.Side).CalculateTotalContribution();
						playerEarnedLootPercentage = (float)((int)(100f * ((float)mapEventParty.ContributionToBattle / num)));
					}
				}
			}
		}

		// Token: 0x17000A02 RID: 2562
		// (get) Token: 0x06002832 RID: 10290 RVA: 0x000AA558 File Offset: 0x000A8758
		// (set) Token: 0x06002833 RID: 10291 RVA: 0x000AA560 File Offset: 0x000A8760
		[SaveableProperty(111)]
		public Vec2 Position { get; private set; }

		// Token: 0x17000A03 RID: 2563
		// (get) Token: 0x06002834 RID: 10292 RVA: 0x000AA569 File Offset: 0x000A8769
		public MapEvent.BattleTypes EventType
		{
			get
			{
				return this._mapEventType;
			}
		}

		// Token: 0x17000A04 RID: 2564
		// (get) Token: 0x06002835 RID: 10293 RVA: 0x000AA571 File Offset: 0x000A8771
		// (set) Token: 0x06002836 RID: 10294 RVA: 0x000AA579 File Offset: 0x000A8779
		[SaveableProperty(113)]
		public bool IsInvulnerable { get; set; }

		// Token: 0x17000A05 RID: 2565
		// (get) Token: 0x06002837 RID: 10295 RVA: 0x000AA582 File Offset: 0x000A8782
		public bool IsFieldBattle
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.FieldBattle;
			}
		}

		// Token: 0x17000A06 RID: 2566
		// (get) Token: 0x06002838 RID: 10296 RVA: 0x000AA58D File Offset: 0x000A878D
		public bool IsRaid
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.Raid;
			}
		}

		// Token: 0x17000A07 RID: 2567
		// (get) Token: 0x06002839 RID: 10297 RVA: 0x000AA598 File Offset: 0x000A8798
		public bool IsForcingVolunteers
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.IsForcingVolunteers;
			}
		}

		// Token: 0x17000A08 RID: 2568
		// (get) Token: 0x0600283A RID: 10298 RVA: 0x000AA5A3 File Offset: 0x000A87A3
		public bool IsForcingSupplies
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.IsForcingSupplies;
			}
		}

		// Token: 0x17000A09 RID: 2569
		// (get) Token: 0x0600283B RID: 10299 RVA: 0x000AA5AE File Offset: 0x000A87AE
		public bool IsSiegeAssault
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.Siege;
			}
		}

		// Token: 0x17000A0A RID: 2570
		// (get) Token: 0x0600283C RID: 10300 RVA: 0x000AA5B9 File Offset: 0x000A87B9
		public bool IsHideoutBattle
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.Hideout;
			}
		}

		// Token: 0x17000A0B RID: 2571
		// (get) Token: 0x0600283D RID: 10301 RVA: 0x000AA5C4 File Offset: 0x000A87C4
		public bool IsSallyOut
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.SallyOut;
			}
		}

		// Token: 0x17000A0C RID: 2572
		// (get) Token: 0x0600283E RID: 10302 RVA: 0x000AA5CF File Offset: 0x000A87CF
		public bool IsSiegeOutside
		{
			get
			{
				return this._mapEventType == MapEvent.BattleTypes.SiegeOutside;
			}
		}

		// Token: 0x0600283F RID: 10303 RVA: 0x000AA5DA File Offset: 0x000A87DA
		internal MapEvent()
		{
			this.MapEventVisual = Campaign.Current.VisualCreator.CreateMapEventVisual(this);
		}

		// Token: 0x06002840 RID: 10304 RVA: 0x000AA610 File Offset: 0x000A8810
		[LateLoadInitializationCallback]
		private void OnLateLoad(MetaData metaData, ObjectLoadData objectLoadData)
		{
			if (this.Component == null && MBSaveLoad.IsUpdatingGameVersion && MBSaveLoad.LastLoadedGameVersion < ApplicationVersion.FromString("v1.1.0", 17949))
			{
				if (this._mapEventType == MapEvent.BattleTypes.Raid)
				{
					float num = (float)objectLoadData.GetMemberValueBySaveId(109);
					int num2 = (int)objectLoadData.GetMemberValueBySaveId(112);
					float num3 = (float)objectLoadData.GetMemberValueBySaveId(115);
					this.Component = RaidEventComponent.CreateComponentForOldSaves(this, num, num2, num3);
				}
				else if (this._mapEventType == MapEvent.BattleTypes.IsForcingSupplies)
				{
					this.Component = ForceSuppliesEventComponent.CreateComponentForOldSaves(this);
				}
				else if (this._mapEventType == MapEvent.BattleTypes.IsForcingVolunteers)
				{
					this.Component = ForceVolunteersEventComponent.CreateComponentForOldSaves(this);
				}
			}
			MapEventComponent component = this.Component;
			if (component == null)
			{
				return;
			}
			component.AfterLoad(this);
		}

		// Token: 0x06002841 RID: 10305 RVA: 0x000AA6D0 File Offset: 0x000A88D0
		internal void OnAfterLoad()
		{
			if (!PartyBase.IsPositionOkForTraveling(this.Position))
			{
				Vec2 vec = this.CalculateMapEventPosition(this.AttackerSide.LeaderParty, this.DefenderSide.LeaderParty);
				if (vec != this.Position)
				{
					Vec2 vec2 = vec - this.Position;
					foreach (PartyBase partyBase in this.InvolvedParties)
					{
						if (partyBase.IsMobile && partyBase.MobileParty.EventPositionAdder.IsNonZero())
						{
							partyBase.MobileParty.EventPositionAdder += vec2;
						}
					}
					this.Position = vec;
				}
			}
			if (!this.IsFinalized)
			{
				this.MapEventVisual = Campaign.Current.VisualCreator.CreateMapEventVisual(this);
				this.MapEventVisual.Initialize(this.Position, this.GetBattleSizeValue(), this.AttackerSide.LeaderParty != PartyBase.MainParty && this.DefenderSide.LeaderParty != PartyBase.MainParty, this.IsVisible);
			}
			if (this.IsRaid && this.MapEventSettlement.Party.MapEvent == null)
			{
				this.FinalizeEvent();
			}
			if (!this.AttackerSide.Parties.Any<MapEventParty>() || !this.DefenderSide.Parties.Any<MapEventParty>())
			{
				this.FinalizeEvent();
			}
		}

		// Token: 0x06002842 RID: 10306 RVA: 0x000AA84C File Offset: 0x000A8A4C
		internal void Initialize(PartyBase attackerParty, PartyBase defenderParty, MapEventComponent component = null, MapEvent.BattleTypes mapEventType = MapEvent.BattleTypes.None)
		{
			this.Component = component;
			this.FirstUpdateIsDone = false;
			this.AttackersRanAway = false;
			this.MapEventSettlement = null;
			this._mapEventType = mapEventType;
			this._mapEventUpdateCount = 0;
			this._sides[0] = new MapEventSide(this, BattleSideEnum.Defender, defenderParty);
			this._sides[1] = new MapEventSide(this, BattleSideEnum.Attacker, attackerParty);
			if (attackerParty.MobileParty != MobileParty.MainParty)
			{
				if (mapEventType == MapEvent.BattleTypes.Raid)
				{
					Debug.Print("A raid mapEvent has been started on " + defenderParty.Name + "\n", 0, Debug.DebugColor.DarkGreen, 64UL);
				}
				else if (defenderParty.IsSettlement && defenderParty.Settlement.IsFortification)
				{
					Debug.Print("A siege mapEvent has been started on " + defenderParty.Name + "\n", 0, Debug.DebugColor.DarkCyan, 64UL);
				}
			}
			if (attackerParty.IsMobile && attackerParty.MobileParty.CurrentSettlement != null)
			{
				this.MapEventSettlement = attackerParty.MobileParty.CurrentSettlement;
			}
			else if (defenderParty.IsMobile && defenderParty.MobileParty.CurrentSettlement != null)
			{
				this.MapEventSettlement = defenderParty.MobileParty.CurrentSettlement;
			}
			else if ((!attackerParty.IsMobile || attackerParty.MobileParty.BesiegedSettlement == null) && defenderParty.IsMobile)
			{
				Settlement besiegedSettlement = defenderParty.MobileParty.BesiegedSettlement;
			}
			if (attackerParty.IsSettlement)
			{
				this.MapEventSettlement = attackerParty.Settlement;
			}
			else if (defenderParty.IsSettlement)
			{
				this.MapEventSettlement = defenderParty.Settlement;
				this.MapEventSettlement.LastAttackerParty = attackerParty.MobileParty;
				this.MapEventSettlement.PassedHoursAfterLastThreat = 24;
			}
			if (this.IsFieldBattle)
			{
				this.MapEventSettlement = null;
				if (attackerParty == PartyBase.MainParty || defenderParty == PartyBase.MainParty)
				{
					Settlement settlement = SettlementHelper.FindNearestVillage((Settlement x) => x.Position2D.DistanceSquared(attackerParty.Position2D) < 9f, null);
					if (settlement != null)
					{
						this.MapEventSettlement = settlement;
					}
				}
			}
			this.Position = this.CalculateMapEventPosition(attackerParty, defenderParty);
			attackerParty.MapEventSide = this.AttackerSide;
			defenderParty.MapEventSide = this.DefenderSide;
			if (this.MapEventSettlement != null && (mapEventType == MapEvent.BattleTypes.Siege || mapEventType == MapEvent.BattleTypes.SiegeOutside || mapEventType == MapEvent.BattleTypes.SallyOut))
			{
				foreach (PartyBase partyBase in this.MapEventSettlement.SiegeEvent.BesiegerCamp.GetInvolvedPartiesForEventType(mapEventType))
				{
					if (partyBase.MapEventSide == null && (partyBase != PartyBase.MainParty || partyBase.MobileParty.Army != null) && (partyBase.MobileParty.Army == null || partyBase.MobileParty.Army.LeaderParty == partyBase.MobileParty))
					{
						partyBase.MapEventSide = ((mapEventType == MapEvent.BattleTypes.SallyOut) ? defenderParty.MapEventSide : attackerParty.MapEventSide);
					}
				}
			}
			if (defenderParty.IsMobile && defenderParty.MobileParty.BesiegedSettlement != null)
			{
				List<PartyBase> involvedPartiesForEventType = defenderParty.MobileParty.SiegeEvent.GetInvolvedPartiesForEventType(this._mapEventType);
				PartyBase partyBase2 = (this.IsSiegeAssault ? attackerParty : defenderParty);
				foreach (PartyBase partyBase3 in involvedPartiesForEventType)
				{
					if (partyBase3 != partyBase2 && partyBase3.IsMobile && partyBase3 != PartyBase.MainParty && partyBase3.MobileParty.BesiegedSettlement == defenderParty.MobileParty.BesiegedSettlement && (partyBase3.MobileParty.Army == null || partyBase3.MobileParty.Army.LeaderParty == partyBase3.MobileParty))
					{
						partyBase3.MapEventSide = this.DefenderSide;
					}
				}
			}
			this.State = MapEventState.Wait;
			this._mapEventStartTime = CampaignTime.Now;
			this._nextSimulationTime = MapEvent.CalculateNextSimulationTime();
			MapEventComponent component2 = this.Component;
			if (component2 != null)
			{
				component2.InitializeComponent();
			}
			if (this.MapEventSettlement != null)
			{
				this.AddInsideSettlementParties(this.MapEventSettlement);
			}
			this.MapEventVisual.Initialize(this.Position, this.GetBattleSizeValue(), this.AttackerSide.LeaderParty != PartyBase.MainParty && this.DefenderSide.LeaderParty != PartyBase.MainParty, this.IsVisible);
			this.BattleState = BattleState.None;
			CampaignEventDispatcher.Instance.OnMapEventStarted(this, attackerParty, defenderParty);
		}

		// Token: 0x06002843 RID: 10307 RVA: 0x000AACC8 File Offset: 0x000A8EC8
		private Vec2 CalculateMapEventPosition(PartyBase attackerParty, PartyBase defenderParty)
		{
			Vec2 vec;
			if (defenderParty.IsSettlement)
			{
				vec = defenderParty.Position2D;
			}
			else
			{
				vec = attackerParty.Position2D + defenderParty.Position2D;
				vec = new Vec2(vec.x / 2f, vec.y / 2f);
			}
			return vec;
		}

		// Token: 0x06002844 RID: 10308 RVA: 0x000AAD18 File Offset: 0x000A8F18
		internal bool IsWinnerSide(BattleSideEnum side)
		{
			return (this.BattleState == BattleState.DefenderVictory && side == BattleSideEnum.Defender) || (this.BattleState == BattleState.AttackerVictory && side == BattleSideEnum.Attacker);
		}

		// Token: 0x06002845 RID: 10309 RVA: 0x000AAD38 File Offset: 0x000A8F38
		private void AddInsideSettlementParties(Settlement relatedSettlement)
		{
			if (CampaignSiegeTestStatic.IsSiegeTestBuild)
			{
				return;
			}
			List<PartyBase> list = new List<PartyBase>();
			foreach (PartyBase partyBase in relatedSettlement.GetInvolvedPartiesForEventType(this._mapEventType))
			{
				if (partyBase != PartyBase.MainParty)
				{
					MobileParty mobileParty = partyBase.MobileParty;
					if (((mobileParty != null) ? mobileParty.AttachedTo : null) != MobileParty.MainParty)
					{
						list.Add(partyBase);
					}
				}
			}
			foreach (PartyBase partyBase2 in list)
			{
				if (partyBase2.MapFaction == this.AttackerSide.MapFaction)
				{
					partyBase2.MapEventSide = this.AttackerSide;
				}
				else
				{
					MobileParty mobileParty2 = partyBase2.MobileParty;
					if (((mobileParty2 != null && mobileParty2.IsGarrison) || partyBase2.IsSettlement) && this.IsSallyOut)
					{
						partyBase2.MapEventSide = this.AttackerSide;
					}
					else if (partyBase2.MapFaction == this.DefenderSide.MapFaction || (partyBase2.MapFaction.IsBanditFaction && this.DefenderSide.MapFaction.IsBanditFaction && this.MapEventSettlement != null && this.MapEventSettlement.IsHideout))
					{
						partyBase2.MapEventSide = this.DefenderSide;
					}
					else if (relatedSettlement == this.MapEventSettlement && partyBase2.IsMobile && !partyBase2.MobileParty.IsGarrison && !partyBase2.MobileParty.IsMilitia)
					{
						LeaveSettlementAction.ApplyForParty(partyBase2.MobileParty);
						partyBase2.MobileParty.Ai.SetMoveModeHold();
					}
				}
			}
		}

		// Token: 0x06002846 RID: 10310 RVA: 0x000AAF10 File Offset: 0x000A9110
		private int GetBattleSizeValue()
		{
			if (this.IsSiegeAssault)
			{
				return 4;
			}
			int numberOfInvolvedMen = this.GetNumberOfInvolvedMen();
			if (numberOfInvolvedMen < 30)
			{
				return 0;
			}
			if (numberOfInvolvedMen < 80)
			{
				return 1;
			}
			if (numberOfInvolvedMen >= 120)
			{
				return 3;
			}
			return 2;
		}

		// Token: 0x06002847 RID: 10311 RVA: 0x000AAF44 File Offset: 0x000A9144
		private static CampaignTime CalculateNextSimulationTime()
		{
			return CampaignTime.Now + CampaignTime.Minutes(30L);
		}

		// Token: 0x06002848 RID: 10312 RVA: 0x000AAF58 File Offset: 0x000A9158
		internal void AddInvolvedPartyInternal(PartyBase involvedParty, BattleSideEnum side)
		{
			if (involvedParty.LeaderHero != null && involvedParty.LeaderHero.Clan == Clan.PlayerClan && involvedParty != PartyBase.MainParty && side == BattleSideEnum.Defender && this.AttackerSide.LeaderParty != null)
			{
				bool flag = false;
				using (IEnumerator<PartyBase> enumerator = this.InvolvedParties.GetEnumerator())
				{
					while (enumerator.MoveNext())
					{
						if (enumerator.Current == PartyBase.MainParty)
						{
							flag = true;
							break;
						}
					}
				}
				if (!flag)
				{
					Settlement settlement = Hero.MainHero.HomeSettlement;
					float num = Campaign.MapDiagonalSquared;
					foreach (Settlement settlement2 in Settlement.All)
					{
						if (settlement2.IsVillage || settlement2.IsFortification)
						{
							float num2 = settlement2.Position2D.DistanceSquared(involvedParty.Position2D);
							if (num2 < num)
							{
								num = num2;
								settlement = settlement2;
							}
						}
					}
					if (settlement != null)
					{
						TextObject textObject = GameTexts.FindText("str_party_attacked", null);
						textObject.SetTextVariable("CLAN_PARTY_NAME", involvedParty.Name);
						textObject.SetTextVariable("ENEMY_PARTY_NAME", this.AttackerSide.LeaderParty.Name);
						textObject.SetTextVariable("SETTLEMENT_NAME", settlement.Name);
						MBInformationManager.AddQuickInformation(textObject, 0, null, "");
					}
				}
			}
			if (this.IsSiegeAssault && involvedParty.MobileParty != null && involvedParty.MobileParty.CurrentSettlement == null && side == BattleSideEnum.Defender)
			{
				this._mapEventType = MapEvent.BattleTypes.SiegeOutside;
			}
			if (involvedParty.MobileParty != null && involvedParty.MobileParty.IsGarrison && side == BattleSideEnum.Attacker && this.IsSiegeOutside)
			{
				this._mapEventType = MapEvent.BattleTypes.SallyOut;
				this.MapEventSettlement = involvedParty.MobileParty.CurrentSettlement;
			}
			involvedParty.ResetTempXp();
			if (involvedParty == MobileParty.MainParty.Party && !this.IsSiegeAssault && !this.IsRaid)
			{
				involvedParty.MobileParty.Ai.SetMoveModeHold();
			}
			if (involvedParty == PartyBase.MainParty)
			{
				involvedParty.MobileParty.Ai.ForceAiNoPathMode = false;
			}
			this.RecalculateRenownAndInfluenceValues(involvedParty);
			if (this.IsFieldBattle && involvedParty.IsMobile && involvedParty.MobileParty.BesiegedSettlement == null)
			{
				Vec2 vec = this.GetMapEventSide(side).LeaderParty.Position2D - this.Position;
				float num3 = vec.Normalize();
				if (involvedParty != this.GetMapEventSide(side).LeaderParty)
				{
					int num4 = this.GetMapEventSide(side).Parties.Count((MapEventParty p) => p.Party.IsMobile) - 1;
					involvedParty.MobileParty.EventPositionAdder = this.Position + vec * MathF.Max(num3, 0.4f) + (float)((num4 + 1) / 2 * ((num4 % 2 == 0) ? 1 : (-1))) * vec.RightVec() * 0.4f - (involvedParty.Position2D + involvedParty.MobileParty.ArmyPositionAdder);
				}
				else
				{
					involvedParty.MobileParty.EventPositionAdder = this.Position + vec * MathF.Max(num3, 0.4f) - (involvedParty.Position2D + involvedParty.MobileParty.ArmyPositionAdder);
				}
			}
			involvedParty.Visuals.SetMapIconAsDirty();
			if (involvedParty.IsMobile && involvedParty.MobileParty.Army != null && involvedParty.MobileParty.Army.LeaderParty == involvedParty.MobileParty)
			{
				foreach (MobileParty mobileParty in involvedParty.MobileParty.Army.LeaderParty.AttachedParties)
				{
					mobileParty.Party.Visuals.SetMapIconAsDirty();
				}
			}
			if (this.HasWinner && involvedParty.MapEventSide.MissionSide != this.WinningSide && involvedParty.NumberOfHealthyMembers > 0)
			{
				this.BattleState = BattleState.None;
			}
			if (involvedParty.IsVisible)
			{
				this.IsVisible = true;
			}
			this.ResetUnsuitablePartiesThatWereTargetingThisMapEvent();
		}

		// Token: 0x17000A0D RID: 2573
		// (get) Token: 0x06002849 RID: 10313 RVA: 0x000AB39C File Offset: 0x000A959C
		// (set) Token: 0x0600284A RID: 10314 RVA: 0x000AB3A4 File Offset: 0x000A95A4
		public bool IsVisible
		{
			get
			{
				return this._isVisible;
			}
			private set
			{
				this._isVisible = value;
				IMapEventVisual mapEventVisual = this.MapEventVisual;
				if (mapEventVisual == null)
				{
					return;
				}
				mapEventVisual.SetVisibility(value);
			}
		}

		// Token: 0x0600284B RID: 10315 RVA: 0x000AB3C0 File Offset: 0x000A95C0
		internal void PartyVisibilityChanged(PartyBase party, bool isPartyVisible)
		{
			if (isPartyVisible)
			{
				this.IsVisible = true;
				return;
			}
			bool flag = false;
			foreach (PartyBase partyBase in this.InvolvedParties)
			{
				if (partyBase != party && partyBase.IsVisible)
				{
					flag = true;
					break;
				}
			}
			this.IsVisible = flag;
		}

		// Token: 0x0600284C RID: 10316 RVA: 0x000AB42C File Offset: 0x000A962C
		internal void RemoveInvolvedPartyInternal(PartyBase party)
		{
			IPartyVisual visuals = party.Visuals;
			if (visuals != null)
			{
				visuals.SetMapIconAsDirty();
			}
			if (party.IsMobile && party.MobileParty.Army != null && party.MobileParty.Army.LeaderParty == party.MobileParty)
			{
				foreach (MobileParty mobileParty in party.MobileParty.Army.LeaderParty.AttachedParties)
				{
					IPartyVisual visuals2 = mobileParty.Party.Visuals;
					if (visuals2 != null)
					{
						visuals2.SetMapIconAsDirty();
					}
				}
			}
			if (this.IsFieldBattle && party.IsMobile)
			{
				party.MobileParty.EventPositionAdder = Vec2.Zero;
				foreach (MapEventSide mapEventSide in this._sides)
				{
					MapEventParty[] array = mapEventSide.Parties.ToArray();
					Vec2 vec = mapEventSide.LeaderParty.Position2D - this.Position;
					float num = vec.Normalize();
					for (int j = 0; j < array.Length; j++)
					{
						PartyBase party2 = array[j].Party;
						if (party2.IsMobile && party2 != mapEventSide.LeaderParty)
						{
							party2.MobileParty.EventPositionAdder = this.Position + vec * MathF.Max(num, 0.4f) + (float)((j + 1) / 2 * ((j % 2 == 0) ? 1 : (-1))) * vec.RightVec() * 0.4f - (party2.Position2D + party2.MobileParty.ArmyPositionAdder);
						}
					}
				}
			}
			if (this.IsSiegeOutside && this.DefenderSide.Parties.All((MapEventParty x) => x.Party.MobileParty == null || (this.MapEventSettlement != null && x.Party.MobileParty.CurrentSettlement == this.MapEventSettlement)))
			{
				this._mapEventType = MapEvent.BattleTypes.Siege;
			}
			if (party == PartyBase.MainParty && this.State == MapEventState.Wait)
			{
				this.AttackerSide.RemoveNearbyPartiesFromPlayerMapEvent();
				this.DefenderSide.RemoveNearbyPartiesFromPlayerMapEvent();
			}
			if (party.IsVisible)
			{
				this.PartyVisibilityChanged(party, false);
			}
			this.ResetUnsuitablePartiesThatWereTargetingThisMapEvent();
		}

		// Token: 0x0600284D RID: 10317 RVA: 0x000AB664 File Offset: 0x000A9864
		public int GetNumberOfInvolvedMen()
		{
			return this.DefenderSide.RecalculateMemberCountOfSide() + this.AttackerSide.RecalculateMemberCountOfSide();
		}

		// Token: 0x0600284E RID: 10318 RVA: 0x000AB67D File Offset: 0x000A987D
		public int GetNumberOfInvolvedMen(BattleSideEnum side)
		{
			return this.GetMapEventSide(side).RecalculateMemberCountOfSide();
		}

		// Token: 0x0600284F RID: 10319 RVA: 0x000AB68B File Offset: 0x000A988B
		private void LootDefeatedParties(out bool playerCaptured, LootCollector lootCollector)
		{
			this.GetMapEventSide(this.DefeatedSide).CollectAll(lootCollector, out playerCaptured);
		}

		// Token: 0x06002850 RID: 10320 RVA: 0x000AB6A0 File Offset: 0x000A98A0
		internal void AddCasualtiesInBattle(TroopRoster troopRoster, LootCollector lootCollector)
		{
			lootCollector.CasualtiesInBattle.Add(troopRoster);
		}

		// Token: 0x06002851 RID: 10321 RVA: 0x000AB6B0 File Offset: 0x000A98B0
		private int CalculatePlunderedGold()
		{
			float num = 0f;
			foreach (MapEventParty mapEventParty in this.GetMapEventSide(this.DefeatedSide).Parties)
			{
				PartyBase party = mapEventParty.Party;
				if (party.LeaderHero != null)
				{
					int num2 = Campaign.Current.Models.BattleRewardModel.CalculateGoldLossAfterDefeat(party.LeaderHero);
					num += (float)num2;
					mapEventParty.GoldLost = num2;
				}
				else if (party.IsMobile && party.MobileParty.IsPartyTradeActive)
				{
					int num3 = (int)(party.MobileParty.IsBandit ? ((float)party.MobileParty.PartyTradeGold * 0.5f) : ((float)party.MobileParty.PartyTradeGold * 0.1f));
					num += (float)num3;
					mapEventParty.GoldLost = num3;
				}
			}
			return (int)num;
		}

		// Token: 0x06002852 RID: 10322 RVA: 0x000AB7AC File Offset: 0x000A99AC
		private void CalculateRenownShares(MapEventResultExplainer resultExplainers = null, bool forScoreboard = false)
		{
			if (this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory)
			{
				((this.BattleState == BattleState.AttackerVictory) ? this.AttackerSide : this.DefenderSide).DistributeRenownAndInfluence(resultExplainers, forScoreboard);
			}
		}

		// Token: 0x06002853 RID: 10323 RVA: 0x000AB7DE File Offset: 0x000A99DE
		private void CalculateLootShares(LootCollector lootCollector)
		{
			if (this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory)
			{
				((this.BattleState == BattleState.AttackerVictory) ? this.AttackerSide : this.DefenderSide).DistributeLootAmongWinners(lootCollector);
			}
		}

		// Token: 0x06002854 RID: 10324 RVA: 0x000AB80F File Offset: 0x000A9A0F
		private int GetSimulatedDamage(CharacterObject strikerTroop, CharacterObject strikedTroop, PartyBase strikerParty, PartyBase strikedParty, float strikerAdvantage)
		{
			return Campaign.Current.Models.CombatSimulationModel.SimulateHit(strikerTroop, strikedTroop, strikerParty, strikedParty, strikerAdvantage, this);
		}

		// Token: 0x06002855 RID: 10325 RVA: 0x000AB830 File Offset: 0x000A9A30
		private void SimulateBattleForRound(BattleSideEnum side, float advantage)
		{
			bool flag = this.AttackerSide.NumRemainingSimulationTroops == 0 || this.DefenderSide.NumRemainingSimulationTroops == 0 || this.SimulateSingleHit((int)side, (int)(BattleSideEnum.Attacker - side), advantage);
			if (flag)
			{
				bool flag2 = false;
				BattleState calculateWinner = this.GetCalculateWinner(ref flag2);
				if (calculateWinner != BattleState.None)
				{
					this.BattleState = calculateWinner;
					return;
				}
				if (flag2)
				{
					IBattleObserver battleObserver = this.BattleObserver;
					if (battleObserver == null)
					{
						return;
					}
					battleObserver.BattleResultsReady();
				}
			}
		}

		// Token: 0x06002856 RID: 10326 RVA: 0x000AB898 File Offset: 0x000A9A98
		private bool SimulateSingleHit(int strikerSideIndex, int strikedSideIndex, float strikerAdvantage)
		{
			MapEventSide mapEventSide = this._sides[strikerSideIndex];
			MapEventSide mapEventSide2 = this._sides[strikedSideIndex];
			UniqueTroopDescriptor uniqueTroopDescriptor = mapEventSide.SelectRandomSimulationTroop();
			UniqueTroopDescriptor uniqueTroopDescriptor2 = mapEventSide2.SelectRandomSimulationTroop();
			CharacterObject allocatedTroop = mapEventSide.GetAllocatedTroop(uniqueTroopDescriptor);
			CharacterObject allocatedTroop2 = mapEventSide2.GetAllocatedTroop(uniqueTroopDescriptor2);
			PartyBase allocatedTroopParty = mapEventSide.GetAllocatedTroopParty(uniqueTroopDescriptor);
			PartyBase allocatedTroopParty2 = mapEventSide2.GetAllocatedTroopParty(uniqueTroopDescriptor2);
			int num = this.GetSimulatedDamage(allocatedTroop, allocatedTroop2, allocatedTroopParty, allocatedTroopParty2, strikerAdvantage);
			if (num > 0)
			{
				if (this.IsPlayerSimulation && allocatedTroopParty2 == PartyBase.MainParty)
				{
					float playerTroopsReceivedDamageMultiplier = Campaign.Current.Models.DifficultyModel.GetPlayerTroopsReceivedDamageMultiplier();
					num = MBRandom.RoundRandomized((float)num * playerTroopsReceivedDamageMultiplier);
				}
				DamageTypes damageTypes = ((MBRandom.RandomFloat < 0.3f) ? DamageTypes.Blunt : DamageTypes.Cut);
				bool flag = mapEventSide2.ApplySimulationDamageToSelectedTroop(num, damageTypes, allocatedTroopParty);
				mapEventSide.ApplySimulatedHitRewardToSelectedTroop(allocatedTroop, allocatedTroop2, num, flag);
				if (this.IsPlayerSimulation && allocatedTroopParty == PartyBase.MainParty && flag)
				{
					CampaignEventDispatcher.Instance.OnPlayerPartyKnockedOrKilledTroop(allocatedTroop2);
				}
				return flag;
			}
			return false;
		}

		// Token: 0x06002857 RID: 10327 RVA: 0x000AB990 File Offset: 0x000A9B90
		private bool GetAttackersRunAwayChance()
		{
			if (this._mapEventUpdateCount <= 1)
			{
				return false;
			}
			if (this.AttackerSide.LeaderParty.LeaderHero == null)
			{
				return false;
			}
			if (this.IsSallyOut)
			{
				return false;
			}
			float num = 0f;
			foreach (MapEventParty mapEventParty in this.AttackerSide.Parties)
			{
				num += mapEventParty.Party.TotalStrength;
			}
			float num2 = 0f;
			foreach (MapEventParty mapEventParty2 in this.DefenderSide.Parties)
			{
				num2 += mapEventParty2.Party.TotalStrength;
			}
			if (this.IsSiegeAssault)
			{
				num *= 0.6666667f;
			}
			if (num2 > num * 1.1f)
			{
				float randomFloat = MBRandom.RandomFloat;
				float num3 = ((this._mapEventUpdateCount < 16) ? MathF.Sqrt((float)this._mapEventUpdateCount / 16f) : 1f);
				return randomFloat * num3 > num / (num2 * 1.1f);
			}
			return false;
		}

		// Token: 0x06002858 RID: 10328 RVA: 0x000ABAC8 File Offset: 0x000A9CC8
		internal void Update()
		{
			if (this._isFinishCalled)
			{
				return;
			}
			bool flag = false;
			if (this._sides[0].LeaderParty == null || this._sides[1].LeaderParty == null || !this._sides[0].LeaderParty.MapFaction.IsAtWarWith(this._sides[1].LeaderParty.MapFaction))
			{
				this.DiplomaticallyFinished = true;
			}
			if (!this.DiplomaticallyFinished)
			{
				MapEventComponent component = this.Component;
				if (component != null)
				{
					component.Update(ref flag);
				}
				if (((this.DefenderSide.TroopCount > 0 && this.AttackerSide.TroopCount > 0) || (!this.FirstUpdateIsDone && (this.DefenderSide.TroopCount > 0 || this._mapEventType != MapEvent.BattleTypes.Raid))) && this._nextSimulationTime.IsPast)
				{
					this.AttackersRanAway = this._mapEventType != MapEvent.BattleTypes.Siege && this._mapEventType != MapEvent.BattleTypes.SallyOut && this._mapEventType != MapEvent.BattleTypes.SiegeOutside && this._mapEventType != MapEvent.BattleTypes.Raid && this.GetAttackersRunAwayChance();
					this._mapEventUpdateCount++;
					if (!this.AttackersRanAway)
					{
						this.SimulateBattleSessionForMapEvent();
						this._nextSimulationTime = MapEvent.CalculateNextSimulationTime();
						this.FirstUpdateIsDone = true;
					}
					else
					{
						flag = true;
					}
				}
				if ((this._mapEventType != MapEvent.BattleTypes.Raid || this.DefenderSide.Parties.Count > 1) && this.BattleState != BattleState.None)
				{
					flag = true;
				}
			}
			else
			{
				flag = true;
				foreach (PartyBase partyBase in this.InvolvedParties)
				{
					if (partyBase.IsMobile && partyBase.MobileParty != MobileParty.MainParty && (partyBase.MobileParty.Army == null || partyBase.MobileParty.Army.LeaderParty == partyBase.MobileParty))
					{
						partyBase.MobileParty.Ai.RecalculateShortTermAi();
					}
				}
			}
			if (flag)
			{
				MapEventComponent component2 = this.Component;
				if (component2 != null)
				{
					component2.Finish();
				}
				if (!this.IsPlayerMapEvent || PlayerEncounter.Current == null)
				{
					this.FinishBattle();
				}
			}
		}

		// Token: 0x06002859 RID: 10329 RVA: 0x000ABCD8 File Offset: 0x000A9ED8
		public void FinishBattleAndKeepSiegeEvent()
		{
			this._keepSiegeEvent = true;
			this.FinishBattle();
		}

		// Token: 0x0600285A RID: 10330 RVA: 0x000ABCE7 File Offset: 0x000A9EE7
		public void FinishSiegeEventKeepBattle()
		{
			this._mapEventType = MapEvent.BattleTypes.FieldBattle;
		}

		// Token: 0x0600285B RID: 10331 RVA: 0x000ABCF0 File Offset: 0x000A9EF0
		private void CheckSiegeStageChange()
		{
			if (this.MapEventSettlement != null && this.IsSiegeAssault)
			{
				bool flag = this.AttackerSide.Parties.Sum((MapEventParty party) => party.Party.NumberOfHealthyMembers) != 0;
				int num = this.DefenderSide.Parties.Sum((MapEventParty party) => party.Party.NumberOfHealthyMembers);
				if (flag)
				{
				}
				return;
			}
		}

		// Token: 0x0600285C RID: 10332 RVA: 0x000ABD74 File Offset: 0x000A9F74
		public void SimulateBattleSetup(FlattenedTroopRoster[] priorTroops)
		{
			if (this.IsSiegeAssault)
			{
				this.CheckSiegeStageChange();
			}
			foreach (MapEventSide mapEventSide in this._sides)
			{
				FlattenedTroopRoster flattenedTroopRoster = ((priorTroops != null) ? priorTroops[(int)mapEventSide.MissionSide] : null);
				mapEventSide.MakeReadyForSimulation(flattenedTroopRoster, (flattenedTroopRoster != null) ? flattenedTroopRoster.Count<FlattenedTroopRosterElement>() : (-1));
			}
			this._battleState = BattleState.None;
		}

		// Token: 0x0600285D RID: 10333 RVA: 0x000ABDD4 File Offset: 0x000A9FD4
		public void SimulateBattleForRounds(int simulationRoundsDefender, int simulationRoundsAttacker)
		{
			bool flag = false;
			this.BattleState = this.GetCalculateWinner(ref flag);
			ValueTuple<float, float> battleAdvantage = Campaign.Current.Models.CombatSimulationModel.GetBattleAdvantage(this.DefenderSide.LeaderParty, this.AttackerSide.LeaderParty, this._mapEventType, this.MapEventSettlement);
			float item = battleAdvantage.Item1;
			float item2 = battleAdvantage.Item2;
			int num = 0;
			while (0 < simulationRoundsAttacker + simulationRoundsDefender && this.BattleState == BattleState.None)
			{
				float num2 = (float)simulationRoundsAttacker / (float)(simulationRoundsAttacker + simulationRoundsDefender);
				if (MBRandom.RandomFloat < num2)
				{
					simulationRoundsAttacker--;
					this.SimulateBattleForRound(BattleSideEnum.Attacker, item2);
				}
				else
				{
					simulationRoundsDefender--;
					this.SimulateBattleForRound(BattleSideEnum.Defender, item);
				}
				num++;
			}
		}

		// Token: 0x0600285E RID: 10334 RVA: 0x000ABE78 File Offset: 0x000AA078
		private void SimulateBattleSessionForMapEvent()
		{
			this.SimulateBattleSetup(null);
			ValueTuple<int, int> simulationRoundsForBattle = Campaign.Current.Models.CombatSimulationModel.GetSimulationRoundsForBattle(this, this.DefenderSide.NumRemainingSimulationTroops, this.AttackerSide.NumRemainingSimulationTroops);
			int item = simulationRoundsForBattle.Item1;
			int item2 = simulationRoundsForBattle.Item2;
			this.SimulateBattleForRounds(item, item2);
			this.SimulateBattleEndSession();
		}

		// Token: 0x0600285F RID: 10335 RVA: 0x000ABED4 File Offset: 0x000AA0D4
		internal void SimulatePlayerEncounterBattle()
		{
			ValueTuple<int, int> simulationRoundsForBattle = Campaign.Current.Models.CombatSimulationModel.GetSimulationRoundsForBattle(this, this.DefenderSide.NumRemainingSimulationTroops, this.AttackerSide.NumRemainingSimulationTroops);
			int item = simulationRoundsForBattle.Item1;
			int item2 = simulationRoundsForBattle.Item2;
			this.SimulateBattleForRounds(item, item2);
		}

		// Token: 0x06002860 RID: 10336 RVA: 0x000ABF24 File Offset: 0x000AA124
		private void SimulateBattleEndSession()
		{
			this.CommitXpGains();
			this.ApplyRenownAndInfluenceChanges();
			this.ApplyRewardsAndChanges();
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				sides[i].EndSimulation();
			}
		}

		// Token: 0x17000A0E RID: 2574
		// (get) Token: 0x06002861 RID: 10337 RVA: 0x000ABF60 File Offset: 0x000AA160
		public bool IsPlayerMapEvent
		{
			get
			{
				return this == MapEvent.PlayerMapEvent;
			}
		}

		// Token: 0x17000A0F RID: 2575
		// (get) Token: 0x06002862 RID: 10338 RVA: 0x000ABF6A File Offset: 0x000AA16A
		public bool IsFinished
		{
			get
			{
				return this._state == MapEventState.WaitingRemoval;
			}
		}

		// Token: 0x17000A10 RID: 2576
		// (get) Token: 0x06002863 RID: 10339 RVA: 0x000ABF75 File Offset: 0x000AA175
		// (set) Token: 0x06002864 RID: 10340 RVA: 0x000ABF7D File Offset: 0x000AA17D
		public BattleState BattleState
		{
			get
			{
				return this._battleState;
			}
			internal set
			{
				if (value != this._battleState)
				{
					this._battleState = value;
					if (this._battleState == BattleState.AttackerVictory || this._battleState == BattleState.DefenderVictory)
					{
						this.OnBattleWon(this._battleState);
					}
				}
			}
		}

		// Token: 0x17000A11 RID: 2577
		// (get) Token: 0x06002865 RID: 10341 RVA: 0x000ABFAD File Offset: 0x000AA1AD
		public MapEventSide Winner
		{
			get
			{
				if (this.BattleState == BattleState.AttackerVictory)
				{
					return this.AttackerSide;
				}
				if (this.BattleState != BattleState.DefenderVictory)
				{
					return null;
				}
				return this.DefenderSide;
			}
		}

		// Token: 0x06002866 RID: 10342 RVA: 0x000ABFD0 File Offset: 0x000AA1D0
		private void OnBattleWon(BattleState winnerSide)
		{
			this.CalculateBattleResults(true);
			IBattleObserver battleObserver = this.BattleObserver;
			if (battleObserver == null)
			{
				return;
			}
			battleObserver.BattleResultsReady();
		}

		// Token: 0x17000A12 RID: 2578
		// (get) Token: 0x06002867 RID: 10343 RVA: 0x000ABFE9 File Offset: 0x000AA1E9
		public BattleSideEnum WinningSide
		{
			get
			{
				if (this.BattleState == BattleState.AttackerVictory)
				{
					return BattleSideEnum.Attacker;
				}
				if (this.BattleState != BattleState.DefenderVictory)
				{
					return BattleSideEnum.None;
				}
				return BattleSideEnum.Defender;
			}
		}

		// Token: 0x17000A13 RID: 2579
		// (get) Token: 0x06002868 RID: 10344 RVA: 0x000AC002 File Offset: 0x000AA202
		public BattleSideEnum DefeatedSide
		{
			get
			{
				if (this.BattleState == BattleState.AttackerVictory)
				{
					return BattleSideEnum.Defender;
				}
				if (this.BattleState != BattleState.DefenderVictory)
				{
					return BattleSideEnum.None;
				}
				return BattleSideEnum.Attacker;
			}
		}

		// Token: 0x06002869 RID: 10345 RVA: 0x000AC01C File Offset: 0x000AA21C
		private BattleState GetCalculateWinner(ref bool isRoundWinnerDetermined)
		{
			BattleState battleState = BattleState.None;
			int num = this.AttackerSide.NumRemainingSimulationTroops;
			int num2 = this.DefenderSide.NumRemainingSimulationTroops;
			if (this.IsPlayerSimulation && !Hero.MainHero.IsWounded && this.InvolvedParties.Contains(PartyBase.MainParty))
			{
				if (PartyBase.MainParty.Side == BattleSideEnum.Attacker)
				{
					if (num == 0)
					{
						isRoundWinnerDetermined = true;
					}
					num++;
				}
				else if (PartyBase.MainParty.Side == BattleSideEnum.Defender)
				{
					if (num2 == 0)
					{
						isRoundWinnerDetermined = true;
					}
					num2++;
				}
			}
			if (num == 0)
			{
				battleState = BattleState.DefenderVictory;
			}
			else if (num2 == 0)
			{
				battleState = BattleState.AttackerVictory;
			}
			return battleState;
		}

		// Token: 0x0600286A RID: 10346 RVA: 0x000AC0A5 File Offset: 0x000AA2A5
		public void SetOverrideWinner(BattleSideEnum winner)
		{
			this.BattleState = ((winner == BattleSideEnum.Attacker) ? BattleState.AttackerVictory : ((winner == BattleSideEnum.Defender) ? BattleState.DefenderVictory : BattleState.None));
		}

		// Token: 0x0600286B RID: 10347 RVA: 0x000AC0BB File Offset: 0x000AA2BB
		public void SetDefenderPulledBack()
		{
			this.BattleState = BattleState.DefenderPullBack;
		}

		// Token: 0x0600286C RID: 10348 RVA: 0x000AC0C4 File Offset: 0x000AA2C4
		public void ResetBattleState()
		{
			this.BattleState = BattleState.None;
		}

		// Token: 0x0600286D RID: 10349 RVA: 0x000AC0D0 File Offset: 0x000AA2D0
		internal bool CheckIfOneSideHasLost()
		{
			int num = this.DefenderSide.RecalculateMemberCountOfSide();
			int num2 = this.AttackerSide.RecalculateMemberCountOfSide();
			if (this.BattleState == BattleState.None && (num == 0 || num2 == 0))
			{
				this.BattleState = ((num2 > 0) ? BattleState.AttackerVictory : BattleState.DefenderVictory);
			}
			return this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory;
		}

		// Token: 0x0600286E RID: 10350 RVA: 0x000AC125 File Offset: 0x000AA325
		internal ItemRoster ItemRosterForPlayerLootShare(PartyBase party)
		{
			return this.GetMapEventSide(party.Side).ItemRosterForPlayerLootShare(party);
		}

		// Token: 0x0600286F RID: 10351 RVA: 0x000AC13C File Offset: 0x000AA33C
		public bool IsPlayerSergeant()
		{
			return this.IsPlayerMapEvent && this.GetLeaderParty(this.PlayerSide) != PartyBase.MainParty && MobileParty.MainParty.Army != null && MobileParty.MainParty.Army.LeaderParty != MobileParty.MainParty;
		}

		// Token: 0x06002870 RID: 10352 RVA: 0x000AC18C File Offset: 0x000AA38C
		private void FinishBattle()
		{
			List<MobileParty> list = new List<MobileParty>();
			if (this.AttackersRanAway)
			{
				foreach (MapEventParty mapEventParty in this.AttackerSide.Parties)
				{
					if (mapEventParty.Party.IsMobile)
					{
						list.Add(mapEventParty.Party.MobileParty);
					}
				}
			}
			this._isFinishCalled = true;
			if (!this._battleResultsCalculated)
			{
				this.CalculateBattleResults(false);
			}
			this.ApplyBattleResults();
			this.FinalizeEventAux();
			if (this.AttackersRanAway)
			{
				foreach (MobileParty mobileParty in list)
				{
					if (mobileParty.IsActive && mobileParty.AttachedTo == null)
					{
						if (mobileParty.BesiegerCamp != null)
						{
							mobileParty.BesiegerCamp = null;
						}
						mobileParty.TeleportPartyToSafePosition(3.3f, 3f);
						mobileParty.Ai.SetMoveModeHold();
					}
				}
			}
		}

		// Token: 0x17000A14 RID: 2580
		// (get) Token: 0x06002871 RID: 10353 RVA: 0x000AC2AC File Offset: 0x000AA4AC
		public MapEventResultExplainer BattleResultExplainers
		{
			get
			{
				return this._battleResultExplainers;
			}
		}

		// Token: 0x06002872 RID: 10354 RVA: 0x000AC2B4 File Offset: 0x000AA4B4
		public override string ToString()
		{
			object[] array = new object[4];
			array[0] = "Battle: ";
			int num = 1;
			PartyBase leaderParty = this.AttackerSide.LeaderParty;
			array[num] = ((leaderParty != null) ? leaderParty.Name : null);
			array[2] = " x ";
			array[3] = this.DefenderSide.LeaderParty.Name;
			return string.Concat(array);
		}

		// Token: 0x06002873 RID: 10355 RVA: 0x000AC30C File Offset: 0x000AA50C
		internal void CalculateBattleResults(bool forScoreBoard = false)
		{
			if (this._battleResultsCalculated)
			{
				return;
			}
			this._battleResultsCalculated = !forScoreBoard;
			LootCollector lootCollector = new LootCollector();
			if (this.IsPlayerMapEvent)
			{
				this._battleResultExplainers = new MapEventResultExplainer();
				if (PlayerEncounter.EncounteredPartySurrendered)
				{
					this._sides[(int)this.DefeatedSide.GetOppositeSide()].ResetContributionToBattleToStrength();
				}
			}
			if (this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory)
			{
				int num = this.CalculatePlunderedGold();
				if (!forScoreBoard)
				{
					this.LootDefeatedParties(out this.PlayerCaptured, lootCollector);
					this.CalculatePlunderedGoldShares((float)num, this._battleResultExplainers);
				}
				if (!forScoreBoard)
				{
					this.CalculateLootShares(lootCollector);
				}
				this.CalculateRenownShares(this._battleResultExplainers, forScoreBoard);
			}
		}

		// Token: 0x06002874 RID: 10356 RVA: 0x000AC3B3 File Offset: 0x000AA5B3
		private void CalculatePlunderedGoldShares(float totalPlunderedGold, MapEventResultExplainer resultExplainers = null)
		{
			if (this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory)
			{
				((this.BattleState == BattleState.AttackerVictory) ? this.AttackerSide : this.DefenderSide).CalculatePlunderedGoldShare(totalPlunderedGold, resultExplainers);
			}
		}

		// Token: 0x06002875 RID: 10357 RVA: 0x000AC3E5 File Offset: 0x000AA5E5
		internal void ApplyBattleResults()
		{
			if (this._battleResultsCommitted)
			{
				return;
			}
			this.CommitXpGains();
			this.ApplyRenownAndInfluenceChanges();
			this.ApplyRewardsAndChanges();
			this._battleResultsCommitted = true;
		}

		// Token: 0x06002876 RID: 10358 RVA: 0x000AC40C File Offset: 0x000AA60C
		private void ApplyRewardsAndChanges()
		{
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				sides[i].ApplyFinalRewardsAndChanges();
			}
		}

		// Token: 0x06002877 RID: 10359 RVA: 0x000AC438 File Offset: 0x000AA638
		internal void ApplyRenownAndInfluenceChanges()
		{
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				sides[i].ApplyRenownAndInfluenceChanges();
			}
		}

		// Token: 0x06002878 RID: 10360 RVA: 0x000AC464 File Offset: 0x000AA664
		private void CommitXpGains()
		{
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				sides[i].CommitXpGains();
			}
		}

		// Token: 0x06002879 RID: 10361 RVA: 0x000AC48E File Offset: 0x000AA68E
		internal void ResetBattleResults()
		{
			this._battleResultsCommitted = false;
		}

		// Token: 0x17000A15 RID: 2581
		// (get) Token: 0x0600287A RID: 10362 RVA: 0x000AC497 File Offset: 0x000AA697
		public bool IsFinalized
		{
			get
			{
				return this._state == MapEventState.WaitingRemoval;
			}
		}

		// Token: 0x0600287B RID: 10363 RVA: 0x000AC4A2 File Offset: 0x000AA6A2
		public void FinalizeEvent()
		{
			this.FinalizeEventAux();
		}

		// Token: 0x0600287C RID: 10364 RVA: 0x000AC4AC File Offset: 0x000AA6AC
		private void FinalizeEventAux()
		{
			if (this.IsFinalized)
			{
				return;
			}
			this.State = MapEventState.WaitingRemoval;
			CampaignEventDispatcher.Instance.OnMapEventEnded(this);
			if (this.MapEventSettlement != null)
			{
				if ((this.IsSiegeAssault || this.IsSiegeOutside || this.IsSallyOut) && this.MapEventSettlement.SiegeEvent != null)
				{
					this.MapEventSettlement.SiegeEvent.OnBeforeSiegeEventEnd(this.BattleState, this._mapEventType);
				}
				if (!this._keepSiegeEvent && (this.IsSiegeAssault || this.IsSiegeOutside))
				{
					BattleState battleState = this.BattleState;
					if (battleState != BattleState.DefenderVictory)
					{
						if (battleState == BattleState.AttackerVictory)
						{
							CampaignEventDispatcher.Instance.SiegeCompleted(this.MapEventSettlement, this.AttackerSide.LeaderParty.MobileParty, true, this._mapEventType);
						}
					}
					else
					{
						SiegeEvent siegeEvent = this.MapEventSettlement.SiegeEvent;
						if (siegeEvent != null)
						{
							siegeEvent.BesiegerCamp.RemoveAllSiegeParties();
						}
						CampaignEventDispatcher.Instance.SiegeCompleted(this.MapEventSettlement, this.AttackerSide.LeaderParty.MobileParty, false, this._mapEventType);
					}
				}
				else if (this.IsSallyOut)
				{
					if (this.MapEventSettlement.Town != null && this.MapEventSettlement.Town.GarrisonParty != null && this.MapEventSettlement.Town.GarrisonParty.IsActive)
					{
						this.MapEventSettlement.Town.GarrisonParty.Ai.SetMoveModeHold();
					}
				}
				else if (this._mapEventType == MapEvent.BattleTypes.Hideout)
				{
					CampaignEventDispatcher.Instance.OnHideoutBattleCompleted((this.BattleState == BattleState.AttackerVictory) ? BattleSideEnum.Attacker : BattleSideEnum.Defender, this);
				}
				MapEventComponent component = this.Component;
				if (component != null)
				{
					component.FinalizeComponent();
				}
			}
			foreach (MapEventSide mapEventSide in this._sides)
			{
				mapEventSide.UpdatePartiesMoveState();
				mapEventSide.HandleMapEventEnd();
			}
			IMapEventVisual mapEventVisual = this.MapEventVisual;
			if (mapEventVisual != null)
			{
				mapEventVisual.OnMapEventEnd();
			}
			foreach (PartyBase partyBase in this.InvolvedParties)
			{
				if (partyBase.IsMobile)
				{
					partyBase.MobileParty.EventPositionAdder = Vec2.Zero;
				}
				IPartyVisual visuals = partyBase.Visuals;
				if (visuals != null)
				{
					visuals.SetMapIconAsDirty();
				}
				if (partyBase.IsMobile && partyBase.MobileParty.Army != null && partyBase.MobileParty.Army.LeaderParty == partyBase.MobileParty)
				{
					foreach (MobileParty mobileParty in partyBase.MobileParty.Army.LeaderParty.AttachedParties)
					{
						mobileParty.Party.Visuals.SetMapIconAsDirty();
					}
				}
			}
			if (this._mapEventType != MapEvent.BattleTypes.Siege && this._mapEventType != MapEvent.BattleTypes.SiegeOutside && this._mapEventType != MapEvent.BattleTypes.SallyOut)
			{
				foreach (PartyBase partyBase2 in this.InvolvedParties)
				{
					if (partyBase2.IsMobile && partyBase2 != PartyBase.MainParty && partyBase2.MobileParty.BesiegedSettlement != null && (partyBase2.MobileParty.Army == null || partyBase2.MobileParty.Army.LeaderParty == partyBase2.MobileParty))
					{
						if (partyBase2.IsActive)
						{
							EncounterManager.StartSettlementEncounter(partyBase2.MobileParty, partyBase2.MobileParty.BesiegedSettlement);
						}
						else
						{
							partyBase2.MobileParty.BesiegerCamp = null;
						}
					}
				}
			}
			MapEventSide[] array = this._sides;
			for (int i = 0; i < array.Length; i++)
			{
				array[i].Clear();
			}
		}

		// Token: 0x17000A16 RID: 2582
		// (get) Token: 0x0600287D RID: 10365 RVA: 0x000AC86C File Offset: 0x000AAA6C
		public CampaignTime BattleStartTime
		{
			get
			{
				return this._mapEventStartTime;
			}
		}

		// Token: 0x17000A17 RID: 2583
		// (get) Token: 0x0600287E RID: 10366 RVA: 0x000AC874 File Offset: 0x000AAA74
		public bool HasWinner
		{
			get
			{
				return this.BattleState == BattleState.AttackerVictory || this.BattleState == BattleState.DefenderVictory;
			}
		}

		// Token: 0x17000A18 RID: 2584
		// (get) Token: 0x0600287F RID: 10367 RVA: 0x000AC88A File Offset: 0x000AAA8A
		// (set) Token: 0x06002880 RID: 10368 RVA: 0x000AC892 File Offset: 0x000AAA92
		[SaveableProperty(123)]
		public bool IsPlayerSimulation { get; set; }

		// Token: 0x06002881 RID: 10369 RVA: 0x000AC89C File Offset: 0x000AAA9C
		public bool HasTroopsOnBothSides()
		{
			bool flag = this.PartiesOnSide(BattleSideEnum.Attacker).Any((MapEventParty party) => party.Party.NumberOfHealthyMembers > 0);
			bool flag2 = this.PartiesOnSide(BattleSideEnum.Defender).Any((MapEventParty party) => party.Party.NumberOfHealthyMembers > 0);
			return flag && flag2;
		}

		// Token: 0x06002882 RID: 10370 RVA: 0x000AC902 File Offset: 0x000AAB02
		public PartyBase GetLeaderParty(BattleSideEnum side)
		{
			return this._sides[(int)side].LeaderParty;
		}

		// Token: 0x06002883 RID: 10371 RVA: 0x000AC911 File Offset: 0x000AAB11
		public float GetRenownValue(BattleSideEnum side)
		{
			return this._sides[(int)side].RenownValue;
		}

		// Token: 0x06002884 RID: 10372 RVA: 0x000AC920 File Offset: 0x000AAB20
		public void RecalculateRenownAndInfluenceValues(PartyBase party)
		{
			this.StrengthOfSide[(int)party.Side] += party.TotalStrength;
			MapEventSide[] sides = this._sides;
			for (int i = 0; i < sides.Length; i++)
			{
				sides[i].CalculateRenownAndInfluenceValues(this.StrengthOfSide);
			}
		}

		// Token: 0x06002885 RID: 10373 RVA: 0x000AC96C File Offset: 0x000AAB6C
		public void RecalculateStrengthOfSides()
		{
			foreach (MapEventSide mapEventSide in this._sides)
			{
				this.StrengthOfSide[(int)mapEventSide.MissionSide] = mapEventSide.RecalculateStrengthOfSide();
			}
		}

		// Token: 0x06002886 RID: 10374 RVA: 0x000AC9A5 File Offset: 0x000AABA5
		public void DoSurrender(BattleSideEnum side)
		{
			this.GetMapEventSide(side).Surrender();
			this.BattleState = ((side == BattleSideEnum.Defender) ? BattleState.AttackerVictory : BattleState.DefenderVictory);
		}

		// Token: 0x06002887 RID: 10375 RVA: 0x000AC9C0 File Offset: 0x000AABC0
		internal BattleSideEnum GetOtherSide(BattleSideEnum side)
		{
			if (side != BattleSideEnum.Attacker)
			{
				return BattleSideEnum.Attacker;
			}
			return BattleSideEnum.Defender;
		}

		// Token: 0x06002888 RID: 10376 RVA: 0x000AC9CC File Offset: 0x000AABCC
		private void ResetUnsuitablePartiesThatWereTargetingThisMapEvent()
		{
			LocatableSearchData<MobileParty> locatableSearchData = MobileParty.StartFindingLocatablesAroundPosition(this.Position, 15f);
			for (MobileParty mobileParty = MobileParty.FindNextLocatable(ref locatableSearchData); mobileParty != null; mobileParty = MobileParty.FindNextLocatable(ref locatableSearchData))
			{
				if (!mobileParty.IsMainParty && mobileParty.ShortTermBehavior == AiBehavior.EngageParty && (mobileParty.ShortTermTargetParty == this.GetLeaderParty(BattleSideEnum.Attacker).MobileParty || mobileParty.ShortTermTargetParty == this.GetLeaderParty(BattleSideEnum.Defender).MobileParty) && !MapEventHelper.CanPartyJoinBattle(mobileParty.Party, this, BattleSideEnum.Attacker) && !MapEventHelper.CanPartyJoinBattle(mobileParty.Party, this, BattleSideEnum.Defender))
				{
					mobileParty.Ai.SetMoveModeHold();
				}
			}
		}

		// Token: 0x17000A19 RID: 2585
		// (get) Token: 0x06002889 RID: 10377 RVA: 0x000ACA61 File Offset: 0x000AAC61
		Vec2 IMapEntity.InteractionPosition
		{
			get
			{
				return this.Position;
			}
		}

		// Token: 0x17000A1A RID: 2586
		// (get) Token: 0x0600288A RID: 10378 RVA: 0x000ACA69 File Offset: 0x000AAC69
		TextObject IMapEntity.Name
		{
			get
			{
				return this.GetName();
			}
		}

		// Token: 0x17000A1B RID: 2587
		// (get) Token: 0x0600288B RID: 10379 RVA: 0x000ACA71 File Offset: 0x000AAC71
		bool IMapEntity.IsMobileEntity
		{
			get
			{
				return false;
			}
		}

		// Token: 0x17000A1C RID: 2588
		// (get) Token: 0x0600288C RID: 10380 RVA: 0x000ACA74 File Offset: 0x000AAC74
		IMapEntity IMapEntity.AttachedEntity
		{
			get
			{
				return null;
			}
		}

		// Token: 0x17000A1D RID: 2589
		// (get) Token: 0x0600288D RID: 10381 RVA: 0x000ACA77 File Offset: 0x000AAC77
		IPartyVisual IMapEntity.PartyVisual
		{
			get
			{
				return null;
			}
		}

		// Token: 0x17000A1E RID: 2590
		// (get) Token: 0x0600288E RID: 10382 RVA: 0x000ACA7A File Offset: 0x000AAC7A
		bool IMapEntity.ShowCircleAroundEntity
		{
			get
			{
				return false;
			}
		}

		// Token: 0x0600288F RID: 10383 RVA: 0x000ACA7D File Offset: 0x000AAC7D
		bool IMapEntity.OnMapClick(bool followModifierUsed)
		{
			return false;
		}

		// Token: 0x06002890 RID: 10384 RVA: 0x000ACA80 File Offset: 0x000AAC80
		void IMapEntity.OnOpenEncyclopedia()
		{
		}

		// Token: 0x06002891 RID: 10385 RVA: 0x000ACA82 File Offset: 0x000AAC82
		bool IMapEntity.IsMainEntity()
		{
			return false;
		}

		// Token: 0x06002892 RID: 10386 RVA: 0x000ACA85 File Offset: 0x000AAC85
		void IMapEntity.OnHover()
		{
			InformationManager.ShowTooltip(typeof(MapEvent), new object[] { this });
		}

		// Token: 0x06002893 RID: 10387 RVA: 0x000ACAA0 File Offset: 0x000AACA0
		bool IMapEntity.IsEnemyOf(IFaction faction)
		{
			return false;
		}

		// Token: 0x06002894 RID: 10388 RVA: 0x000ACAA3 File Offset: 0x000AACA3
		bool IMapEntity.IsAllyOf(IFaction faction)
		{
			return false;
		}

		// Token: 0x06002895 RID: 10389 RVA: 0x000ACAA6 File Offset: 0x000AACA6
		public void GetMountAndHarnessVisualIdsForPartyIcon(out string mountStringId, out string harnessStringId)
		{
			mountStringId = "";
			harnessStringId = "";
		}

		// Token: 0x06002896 RID: 10390 RVA: 0x000ACAB6 File Offset: 0x000AACB6
		void IMapEntity.OnPartyInteraction(MobileParty mobileParty)
		{
		}

		// Token: 0x04000C42 RID: 3138
		private const float BattleRetreatMinimumTime = 1f;

		// Token: 0x04000C43 RID: 3139
		private const float SiegeDefenderAdvantage = 2f;

		// Token: 0x04000C44 RID: 3140
		private const int MapEventSettlementSettingDistance = 3;

		// Token: 0x04000C47 RID: 3143
		[SaveableField(101)]
		private MapEventState _state;

		// Token: 0x04000C48 RID: 3144
		[SaveableField(102)]
		private MapEventSide[] _sides = new MapEventSide[2];

		// Token: 0x04000C4A RID: 3146
		public const float SiegeAdvantage = 1.5f;

		// Token: 0x04000C4B RID: 3147
		public bool DiplomaticallyFinished;

		// Token: 0x04000C4D RID: 3149
		[SaveableField(106)]
		private int _mapEventUpdateCount;

		// Token: 0x04000C4E RID: 3150
		[SaveableField(107)]
		private CampaignTime _nextSimulationTime;

		// Token: 0x04000C4F RID: 3151
		[SaveableField(108)]
		private CampaignTime _mapEventStartTime;

		// Token: 0x04000C50 RID: 3152
		[SaveableField(110)]
		private MapEvent.BattleTypes _mapEventType;

		// Token: 0x04000C53 RID: 3155
		[CachedData]
		public IMapEventVisual MapEventVisual;

		// Token: 0x04000C54 RID: 3156
		[SaveableField(114)]
		private bool _isVisible;

		// Token: 0x04000C55 RID: 3157
		private bool _keepSiegeEvent;

		// Token: 0x04000C56 RID: 3158
		[SaveableField(116)]
		private bool FirstUpdateIsDone;

		// Token: 0x04000C57 RID: 3159
		[SaveableField(117)]
		private BattleState _battleState;

		// Token: 0x04000C58 RID: 3160
		private bool _isFinishCalled;

		// Token: 0x04000C59 RID: 3161
		private bool _battleResultsCalculated;

		// Token: 0x04000C5A RID: 3162
		private bool _battleResultsCommitted;

		// Token: 0x04000C5B RID: 3163
		private bool PlayerCaptured;

		// Token: 0x04000C5C RID: 3164
		private MapEventResultExplainer _battleResultExplainers;

		// Token: 0x04000C5E RID: 3166
		[SaveableField(125)]
		public float[] StrengthOfSide = new float[2];

		// Token: 0x020005DB RID: 1499
		public enum BattleTypes
		{
			// Token: 0x04001827 RID: 6183
			None,
			// Token: 0x04001828 RID: 6184
			FieldBattle,
			// Token: 0x04001829 RID: 6185
			Raid,
			// Token: 0x0400182A RID: 6186
			IsForcingVolunteers,
			// Token: 0x0400182B RID: 6187
			IsForcingSupplies,
			// Token: 0x0400182C RID: 6188
			Siege,
			// Token: 0x0400182D RID: 6189
			Hideout,
			// Token: 0x0400182E RID: 6190
			SallyOut,
			// Token: 0x0400182F RID: 6191
			SiegeOutside
		}
	}
}
