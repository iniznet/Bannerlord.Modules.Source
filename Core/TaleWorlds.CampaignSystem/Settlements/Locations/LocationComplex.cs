using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements.Locations
{
	// Token: 0x0200036C RID: 876
	public class LocationComplex
	{
		// Token: 0x06003326 RID: 13094 RVA: 0x000D3276 File Offset: 0x000D1476
		internal static void AutoGeneratedStaticCollectObjectsLocationComplex(object o, List<object> collectedObjects)
		{
			((LocationComplex)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06003327 RID: 13095 RVA: 0x000D3284 File Offset: 0x000D1484
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._locations);
		}

		// Token: 0x06003328 RID: 13096 RVA: 0x000D3292 File Offset: 0x000D1492
		internal static object AutoGeneratedGetMemberValue_locations(object o)
		{
			return ((LocationComplex)o)._locations;
		}

		// Token: 0x17000C80 RID: 3200
		// (get) Token: 0x06003329 RID: 13097 RVA: 0x000D329F File Offset: 0x000D149F
		public static LocationComplex Current
		{
			get
			{
				if (PlayerEncounter.LocationEncounter != null)
				{
					return PlayerEncounter.LocationEncounter.Settlement.LocationComplex;
				}
				return null;
			}
		}

		// Token: 0x0600332A RID: 13098 RVA: 0x000D32B9 File Offset: 0x000D14B9
		public static bool CanAlways(LocationCharacter locationCharacter, Location location)
		{
			return true;
		}

		// Token: 0x0600332B RID: 13099 RVA: 0x000D32BC File Offset: 0x000D14BC
		public static bool CanNever(LocationCharacter locationCharacter, Location location)
		{
			return false;
		}

		// Token: 0x0600332C RID: 13100 RVA: 0x000D32BF File Offset: 0x000D14BF
		public static bool CanIfHero(LocationCharacter locationCharacter, Location location)
		{
			return locationCharacter.Character.IsHero;
		}

		// Token: 0x0600332D RID: 13101 RVA: 0x000D32CC File Offset: 0x000D14CC
		public static bool CanIfDay(LocationCharacter locationCharacter, Location location)
		{
			return !Campaign.Current.IsNight;
		}

		// Token: 0x0600332E RID: 13102 RVA: 0x000D32DC File Offset: 0x000D14DC
		public static bool CanIfPriceIsPaid(LocationCharacter locationCharacter, Location location)
		{
			string stringId = location.StringId;
			if (!(stringId == "lordshall"))
			{
				return stringId == "prison" && Campaign.Current.Models.BribeCalculationModel.GetBribeToEnterDungeon(Settlement.CurrentSettlement) == 0;
			}
			return Campaign.Current.Models.BribeCalculationModel.GetBribeToEnterLordsHall(Settlement.CurrentSettlement) == 0;
		}

		// Token: 0x0600332F RID: 13103 RVA: 0x000D3347 File Offset: 0x000D1547
		public static bool CanIfGrownUpMaleOrHero(LocationCharacter locationCharacter, Location location)
		{
			return LocationComplex.CanIfMaleOrHero(locationCharacter, location) && locationCharacter.Character.Age >= (float)Campaign.Current.Models.AgeModel.HeroComesOfAge;
		}

		// Token: 0x06003330 RID: 13104 RVA: 0x000D3379 File Offset: 0x000D1579
		public static bool CanIfMaleOrHero(LocationCharacter locationCharacter, Location location)
		{
			return !locationCharacter.Character.IsFemale || locationCharacter.Character.IsHero;
		}

		// Token: 0x06003331 RID: 13105 RVA: 0x000D3398 File Offset: 0x000D1598
		public static bool CanIfSettlementAccessModelLetsPlayer(LocationCharacter locationCharacter, Location location)
		{
			bool flag;
			TextObject textObject;
			return Campaign.Current.Models.SettlementAccessModel.CanMainHeroAccessLocation(Settlement.CurrentSettlement, location.StringId, out flag, out textObject);
		}

		// Token: 0x06003332 RID: 13106 RVA: 0x000D33C8 File Offset: 0x000D15C8
		public LocationComplex()
		{
			this._locations = new Dictionary<string, Location>();
		}

		// Token: 0x06003333 RID: 13107 RVA: 0x000D33DC File Offset: 0x000D15DC
		public LocationComplex(LocationComplexTemplate complexTemplate)
			: this()
		{
			foreach (Location location in complexTemplate.Locations)
			{
				this._locations.Add(location.StringId, new Location(location, this));
			}
			foreach (KeyValuePair<string, string> keyValuePair in complexTemplate.Passages)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		// Token: 0x06003334 RID: 13108 RVA: 0x000D34A4 File Offset: 0x000D16A4
		public LocationComplex(LocationComplex complex)
			: this()
		{
			List<KeyValuePair<string, string>> list = new List<KeyValuePair<string, string>>();
			foreach (Location location in complex.GetListOfLocations())
			{
				this._locations.Add(location.StringId, new Location(location, this));
				foreach (Location location2 in location.LocationsOfPassages)
				{
					if (!list.Contains(new KeyValuePair<string, string>(location2.StringId, location.StringId)) && !list.Contains(new KeyValuePair<string, string>(location.StringId, location2.StringId)))
					{
						list.Add(new KeyValuePair<string, string>(location.StringId, location2.StringId));
					}
				}
			}
			foreach (KeyValuePair<string, string> keyValuePair in list)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		// Token: 0x06003335 RID: 13109 RVA: 0x000D35F4 File Offset: 0x000D17F4
		public void Initialize(LocationComplexTemplate complexTemplate)
		{
			foreach (Location location in complexTemplate.Locations)
			{
				Location location2 = this.GetLocationWithId(location.StringId);
				if (location2 == null)
				{
					location2 = new Location(location, this);
					this._locations.Add(location.StringId, location2);
				}
				if (location2 != null)
				{
					location2.Initialize(location, this);
				}
			}
			foreach (string text in this._locations.Keys.ToList<string>())
			{
				Location locationWithId = this.GetLocationWithId(text);
				if (locationWithId == null || !locationWithId.IsInitialized)
				{
					this._locations.Remove(text);
				}
			}
			foreach (KeyValuePair<string, string> keyValuePair in complexTemplate.Passages)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		// Token: 0x06003336 RID: 13110 RVA: 0x000D3740 File Offset: 0x000D1940
		public void AddPassage(Location firstLocation, Location secondLocation)
		{
			firstLocation.AddPassageToLocation(secondLocation);
			secondLocation.AddPassageToLocation(firstLocation);
		}

		// Token: 0x06003337 RID: 13111 RVA: 0x000D3750 File Offset: 0x000D1950
		public void ChangeLocation(LocationCharacter locationCharacter, Location fromLocation, Location toLocation)
		{
			if (fromLocation != null)
			{
				fromLocation.RemoveLocationCharacter(locationCharacter);
			}
			if (toLocation != null)
			{
				toLocation.AddCharacter(locationCharacter);
			}
			if (toLocation != null)
			{
				toLocation.OnAIChangeLocation(fromLocation);
			}
			if (CampaignMission.Current != null && (toLocation == null || toLocation == CampaignMission.Current.Location))
			{
				PlayerEncounter.LocationEncounter.OnCharacterLocationChanged(locationCharacter, fromLocation, toLocation);
			}
		}

		// Token: 0x06003338 RID: 13112 RVA: 0x000D379F File Offset: 0x000D199F
		public IEnumerable<LocationCharacter> GetListOfCharactersInLocation(string locationName)
		{
			foreach (LocationCharacter locationCharacter in this._locations[locationName].GetCharacterList())
			{
				yield return locationCharacter;
			}
			IEnumerator<LocationCharacter> enumerator = null;
			yield break;
			yield break;
		}

		// Token: 0x06003339 RID: 13113 RVA: 0x000D37B8 File Offset: 0x000D19B8
		public IList<LocationCharacter> GetListOfCharacters()
		{
			List<LocationCharacter> list = new List<LocationCharacter>();
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				list = list.Concat(keyValuePair.Value.GetCharacterList()).ToList<LocationCharacter>();
			}
			return list.AsReadOnly();
		}

		// Token: 0x0600333A RID: 13114 RVA: 0x000D3828 File Offset: 0x000D1A28
		public IEnumerable<Location> GetListOfLocations()
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				yield return keyValuePair.Value;
			}
			Dictionary<string, Location>.Enumerator enumerator = default(Dictionary<string, Location>.Enumerator);
			yield break;
			yield break;
		}

		// Token: 0x0600333B RID: 13115 RVA: 0x000D3838 File Offset: 0x000D1A38
		public void AgentPassageUsageTick()
		{
			if (CampaignMission.Current.Mode != MissionMode.Stealth)
			{
				List<LocationCharacter> list = new List<LocationCharacter>();
				foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
				{
					if (keyValuePair.Value != CampaignMission.Current.Location && keyValuePair.Value.CanAIExit(null))
					{
						foreach (LocationCharacter locationCharacter in keyValuePair.Value.GetCharacterList())
						{
							if (!locationCharacter.FixedLocation)
							{
								list.Add(locationCharacter);
							}
						}
					}
				}
				if (list.Count > 0)
				{
					LocationCharacter locationCharacter2 = list[MBRandom.RandomInt(list.Count)];
					Location locationOfCharacter = this.GetLocationOfCharacter(locationCharacter2);
					int num = 0;
					foreach (Location location in locationOfCharacter.LocationsOfPassages)
					{
						if (location.CanAIEnter(locationCharacter2) && location.CharacterCount < location.ProsperityMax)
						{
							num += location.ProsperityMax;
						}
					}
					if (num <= 0)
					{
						return;
					}
					int num2 = MBRandom.RandomInt(num);
					Location location2 = null;
					foreach (Location location3 in locationOfCharacter.LocationsOfPassages)
					{
						if (location3.CanAIEnter(locationCharacter2) && location3.CharacterCount < location3.ProsperityMax)
						{
							num2 -= location3.ProsperityMax;
							if (num2 < 0)
							{
								location2 = location3;
							}
						}
					}
					this.ChangeLocation(locationCharacter2, locationOfCharacter, location2);
				}
			}
		}

		// Token: 0x0600333C RID: 13116 RVA: 0x000D3A28 File Offset: 0x000D1C28
		public Location GetLocationOfCharacter(LocationCharacter character)
		{
			Location location = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Value.ContainsCharacter(character))
				{
					location = keyValuePair.Value;
				}
			}
			return location;
		}

		// Token: 0x0600333D RID: 13117 RVA: 0x000D3A90 File Offset: 0x000D1C90
		public Location GetLocationOfCharacter(Hero hero)
		{
			Location location = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Value.ContainsCharacter(hero))
				{
					location = keyValuePair.Value;
					break;
				}
			}
			return location;
		}

		// Token: 0x0600333E RID: 13118 RVA: 0x000D3AF8 File Offset: 0x000D1CF8
		public LocationCharacter GetLocationCharacterOfHero(Hero hero)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				LocationCharacter locationCharacter = keyValuePair.Value.GetLocationCharacter(hero);
				if (locationCharacter != null)
				{
					return locationCharacter;
				}
			}
			return null;
		}

		// Token: 0x0600333F RID: 13119 RVA: 0x000D3B5C File Offset: 0x000D1D5C
		public LocationCharacter GetFirstLocationCharacterOfCharacter(CharacterObject character)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				foreach (LocationCharacter locationCharacter in keyValuePair.Value.GetCharacterList())
				{
					if (locationCharacter.Character == character)
					{
						return locationCharacter;
					}
				}
			}
			return null;
		}

		// Token: 0x06003340 RID: 13120 RVA: 0x000D3BF8 File Offset: 0x000D1DF8
		public void RemoveCharacterIfExists(Hero hero)
		{
			Location locationOfCharacter = this.GetLocationOfCharacter(hero);
			if (locationOfCharacter != null)
			{
				locationOfCharacter.RemoveCharacter(hero);
			}
		}

		// Token: 0x06003341 RID: 13121 RVA: 0x000D3C18 File Offset: 0x000D1E18
		public void RemoveCharacterIfExists(LocationCharacter locationCharacter)
		{
			Location locationOfCharacter = this.GetLocationOfCharacter(locationCharacter);
			if (locationOfCharacter != null)
			{
				locationOfCharacter.RemoveLocationCharacter(locationCharacter);
			}
		}

		// Token: 0x06003342 RID: 13122 RVA: 0x000D3C38 File Offset: 0x000D1E38
		public void ClearTempCharacters()
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				keyValuePair.Value.RemoveAllCharacters();
			}
		}

		// Token: 0x06003343 RID: 13123 RVA: 0x000D3C90 File Offset: 0x000D1E90
		public Location GetLocationWithId(string id)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Key == id)
				{
					return keyValuePair.Value;
				}
			}
			return null;
		}

		// Token: 0x06003344 RID: 13124 RVA: 0x000D3CF8 File Offset: 0x000D1EF8
		public string GetScene(string stringId, int upgradeLevel)
		{
			return this.GetLocationWithId(stringId).GetSceneName(upgradeLevel);
		}

		// Token: 0x06003345 RID: 13125 RVA: 0x000D3D08 File Offset: 0x000D1F08
		public LocationCharacter FindCharacter(IAgent agent)
		{
			LocationCharacter locationCharacter = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				locationCharacter = keyValuePair.Value.GetLocationCharacter(agent.Origin);
				if (locationCharacter != null)
				{
					break;
				}
			}
			return locationCharacter;
		}

		// Token: 0x06003346 RID: 13126 RVA: 0x000D3D70 File Offset: 0x000D1F70
		public IEnumerable<Location> FindAll(Func<string, bool> predicate)
		{
			return from kv in this._locations
				where predicate(kv.Key)
				select kv.Value;
		}

		// Token: 0x040010A4 RID: 4260
		[SaveableField(1)]
		private readonly Dictionary<string, Location> _locations;
	}
}
