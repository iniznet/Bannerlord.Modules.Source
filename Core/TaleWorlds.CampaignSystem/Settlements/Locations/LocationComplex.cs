using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements.Locations
{
	public class LocationComplex
	{
		internal static void AutoGeneratedStaticCollectObjectsLocationComplex(object o, List<object> collectedObjects)
		{
			((LocationComplex)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._locations);
		}

		internal static object AutoGeneratedGetMemberValue_locations(object o)
		{
			return ((LocationComplex)o)._locations;
		}

		public static LocationComplex Current
		{
			get
			{
				if (PlayerEncounter.LocationEncounter != null)
				{
					return PlayerEncounter.LocationEncounter.Settlement.LocationComplex;
				}
				return null;
			}
		}

		public static bool CanAlways(LocationCharacter locationCharacter, Location location)
		{
			return true;
		}

		public static bool CanNever(LocationCharacter locationCharacter, Location location)
		{
			return false;
		}

		public static bool CanIfHero(LocationCharacter locationCharacter, Location location)
		{
			return locationCharacter.Character.IsHero;
		}

		public static bool CanIfDay(LocationCharacter locationCharacter, Location location)
		{
			return !Campaign.Current.IsNight;
		}

		public static bool CanIfPriceIsPaid(LocationCharacter locationCharacter, Location location)
		{
			string stringId = location.StringId;
			if (!(stringId == "lordshall"))
			{
				return stringId == "prison" && Campaign.Current.Models.BribeCalculationModel.GetBribeToEnterDungeon(Settlement.CurrentSettlement) == 0;
			}
			return Campaign.Current.Models.BribeCalculationModel.GetBribeToEnterLordsHall(Settlement.CurrentSettlement) == 0;
		}

		public static bool CanIfGrownUpMaleOrHero(LocationCharacter locationCharacter, Location location)
		{
			return LocationComplex.CanIfMaleOrHero(locationCharacter, location) && locationCharacter.Character.Age >= (float)Campaign.Current.Models.AgeModel.HeroComesOfAge;
		}

		public static bool CanIfMaleOrHero(LocationCharacter locationCharacter, Location location)
		{
			return !locationCharacter.Character.IsFemale || locationCharacter.Character.IsHero;
		}

		public static bool CanIfSettlementAccessModelLetsPlayer(LocationCharacter locationCharacter, Location location)
		{
			bool flag;
			TextObject textObject;
			return Campaign.Current.Models.SettlementAccessModel.CanMainHeroAccessLocation(Settlement.CurrentSettlement, location.StringId, out flag, out textObject);
		}

		public LocationComplex()
		{
			this._locations = new Dictionary<string, Location>();
		}

		public LocationComplex(LocationComplexTemplate complexTemplate)
			: this()
		{
			foreach (Location location in complexTemplate.Locations)
			{
				this._locations.Add(location.StringId, new Location(location, this));
			}
			foreach (KeyValuePair<string, string> keyValuePair in complexTemplate.Passages)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		public LocationComplex(LocationComplex complex)
			: this()
		{
			List<KeyValuePair<string, string>> list = new List<KeyValuePair<string, string>>();
			foreach (Location location in complex.GetListOfLocations())
			{
				this._locations.Add(location.StringId, new Location(location, this));
				foreach (Location location2 in location.LocationsOfPassages)
				{
					if (!list.Contains(new KeyValuePair<string, string>(location2.StringId, location.StringId)) && !list.Contains(new KeyValuePair<string, string>(location.StringId, location2.StringId)))
					{
						list.Add(new KeyValuePair<string, string>(location.StringId, location2.StringId));
					}
				}
			}
			foreach (KeyValuePair<string, string> keyValuePair in list)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		public void Initialize(LocationComplexTemplate complexTemplate)
		{
			foreach (Location location in complexTemplate.Locations)
			{
				Location location2 = this.GetLocationWithId(location.StringId);
				if (location2 == null)
				{
					location2 = new Location(location, this);
					this._locations.Add(location.StringId, location2);
				}
				if (location2 != null)
				{
					location2.Initialize(location, this);
				}
			}
			foreach (string text in this._locations.Keys.ToList<string>())
			{
				Location locationWithId = this.GetLocationWithId(text);
				if (locationWithId == null || !locationWithId.IsInitialized)
				{
					this._locations.Remove(text);
				}
			}
			foreach (KeyValuePair<string, string> keyValuePair in complexTemplate.Passages)
			{
				this.AddPassage(this.GetLocationWithId(keyValuePair.Key), this.GetLocationWithId(keyValuePair.Value));
			}
		}

		public void AddPassage(Location firstLocation, Location secondLocation)
		{
			firstLocation.AddPassageToLocation(secondLocation);
			secondLocation.AddPassageToLocation(firstLocation);
		}

		public void ChangeLocation(LocationCharacter locationCharacter, Location fromLocation, Location toLocation)
		{
			if (fromLocation != null)
			{
				fromLocation.RemoveLocationCharacter(locationCharacter);
			}
			if (toLocation != null)
			{
				toLocation.AddCharacter(locationCharacter);
			}
			if (toLocation != null)
			{
				toLocation.OnAIChangeLocation(fromLocation);
			}
			if (CampaignMission.Current != null && (toLocation == null || toLocation == CampaignMission.Current.Location))
			{
				PlayerEncounter.LocationEncounter.OnCharacterLocationChanged(locationCharacter, fromLocation, toLocation);
			}
		}

		public IEnumerable<LocationCharacter> GetListOfCharactersInLocation(string locationName)
		{
			foreach (LocationCharacter locationCharacter in this._locations[locationName].GetCharacterList())
			{
				yield return locationCharacter;
			}
			IEnumerator<LocationCharacter> enumerator = null;
			yield break;
			yield break;
		}

		public IList<LocationCharacter> GetListOfCharacters()
		{
			List<LocationCharacter> list = new List<LocationCharacter>();
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				list = list.Concat(keyValuePair.Value.GetCharacterList()).ToList<LocationCharacter>();
			}
			return list.AsReadOnly();
		}

		public IEnumerable<Location> GetListOfLocations()
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				yield return keyValuePair.Value;
			}
			Dictionary<string, Location>.Enumerator enumerator = default(Dictionary<string, Location>.Enumerator);
			yield break;
			yield break;
		}

		public void AgentPassageUsageTick()
		{
			if (CampaignMission.Current.Mode != MissionMode.Stealth)
			{
				List<LocationCharacter> list = new List<LocationCharacter>();
				foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
				{
					if (keyValuePair.Value != CampaignMission.Current.Location && keyValuePair.Value.CanAIExit(null))
					{
						foreach (LocationCharacter locationCharacter in keyValuePair.Value.GetCharacterList())
						{
							if (!locationCharacter.FixedLocation)
							{
								list.Add(locationCharacter);
							}
						}
					}
				}
				if (list.Count > 0)
				{
					LocationCharacter locationCharacter2 = list[MBRandom.RandomInt(list.Count)];
					Location locationOfCharacter = this.GetLocationOfCharacter(locationCharacter2);
					int num = 0;
					foreach (Location location in locationOfCharacter.LocationsOfPassages)
					{
						if (location.CanAIEnter(locationCharacter2) && location.CharacterCount < location.ProsperityMax)
						{
							num += location.ProsperityMax;
						}
					}
					if (num <= 0)
					{
						return;
					}
					int num2 = MBRandom.RandomInt(num);
					Location location2 = null;
					foreach (Location location3 in locationOfCharacter.LocationsOfPassages)
					{
						if (location3.CanAIEnter(locationCharacter2) && location3.CharacterCount < location3.ProsperityMax)
						{
							num2 -= location3.ProsperityMax;
							if (num2 < 0)
							{
								location2 = location3;
							}
						}
					}
					this.ChangeLocation(locationCharacter2, locationOfCharacter, location2);
				}
			}
		}

		public Location GetLocationOfCharacter(LocationCharacter character)
		{
			Location location = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Value.ContainsCharacter(character))
				{
					location = keyValuePair.Value;
				}
			}
			return location;
		}

		public Location GetLocationOfCharacter(Hero hero)
		{
			Location location = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Value.ContainsCharacter(hero))
				{
					location = keyValuePair.Value;
					break;
				}
			}
			return location;
		}

		public LocationCharacter GetLocationCharacterOfHero(Hero hero)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				LocationCharacter locationCharacter = keyValuePair.Value.GetLocationCharacter(hero);
				if (locationCharacter != null)
				{
					return locationCharacter;
				}
			}
			return null;
		}

		public LocationCharacter GetFirstLocationCharacterOfCharacter(CharacterObject character)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				foreach (LocationCharacter locationCharacter in keyValuePair.Value.GetCharacterList())
				{
					if (locationCharacter.Character == character)
					{
						return locationCharacter;
					}
				}
			}
			return null;
		}

		public void RemoveCharacterIfExists(Hero hero)
		{
			Location locationOfCharacter = this.GetLocationOfCharacter(hero);
			if (locationOfCharacter != null)
			{
				locationOfCharacter.RemoveCharacter(hero);
			}
		}

		public void RemoveCharacterIfExists(LocationCharacter locationCharacter)
		{
			Location locationOfCharacter = this.GetLocationOfCharacter(locationCharacter);
			if (locationOfCharacter != null)
			{
				locationOfCharacter.RemoveLocationCharacter(locationCharacter);
			}
		}

		public void ClearTempCharacters()
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				keyValuePair.Value.RemoveAllCharacters();
			}
		}

		public Location GetLocationWithId(string id)
		{
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				if (keyValuePair.Key == id)
				{
					return keyValuePair.Value;
				}
			}
			return null;
		}

		public string GetScene(string stringId, int upgradeLevel)
		{
			return this.GetLocationWithId(stringId).GetSceneName(upgradeLevel);
		}

		public LocationCharacter FindCharacter(IAgent agent)
		{
			LocationCharacter locationCharacter = null;
			foreach (KeyValuePair<string, Location> keyValuePair in this._locations)
			{
				locationCharacter = keyValuePair.Value.GetLocationCharacter(agent.Origin);
				if (locationCharacter != null)
				{
					break;
				}
			}
			return locationCharacter;
		}

		public IEnumerable<Location> FindAll(Func<string, bool> predicate)
		{
			return from kv in this._locations
				where predicate(kv.Key)
				select kv.Value;
		}

		[SaveableField(1)]
		private readonly Dictionary<string, Location> _locations;
	}
}
