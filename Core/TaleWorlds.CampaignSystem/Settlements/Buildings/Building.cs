using System;
using System.Collections.Generic;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements.Buildings
{
	public class Building
	{
		internal static void AutoGeneratedStaticCollectObjectsBuilding(object o, List<object> collectedObjects)
		{
			((Building)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this.BuildingType);
			collectedObjects.Add(this.Town);
		}

		internal static object AutoGeneratedGetMemberValueTown(object o)
		{
			return ((Building)o).Town;
		}

		internal static object AutoGeneratedGetMemberValueBuildingType(object o)
		{
			return ((Building)o).BuildingType;
		}

		internal static object AutoGeneratedGetMemberValueBuildingProgress(object o)
		{
			return ((Building)o).BuildingProgress;
		}

		internal static object AutoGeneratedGetMemberValueIsCurrentlyDefault(object o)
		{
			return ((Building)o).IsCurrentlyDefault;
		}

		internal static object AutoGeneratedGetMemberValue_currentLevel(object o)
		{
			return ((Building)o)._currentLevel;
		}

		internal static object AutoGeneratedGetMemberValue_hitpoints(object o)
		{
			return ((Building)o)._hitpoints;
		}

		public TextObject Name
		{
			get
			{
				return this.BuildingType.Name;
			}
		}

		public TextObject Explanation
		{
			get
			{
				return this.BuildingType.Explanation;
			}
		}

		[SaveableProperty(6)]
		public Town Town { get; private set; }

		public int CurrentLevel
		{
			get
			{
				return this._currentLevel;
			}
			set
			{
				this._currentLevel = value;
				if (this.Town.Owner != null)
				{
					this.Town.Owner.Visuals.RefreshLevelMask(this.Town.Owner);
				}
			}
		}

		public Building(BuildingType buildingType, Town town, float buildingProgress = 0f, int currentLevel = 0)
		{
			this.BuildingType = buildingType;
			this.BuildingProgress = buildingProgress;
			this.Town = town;
			this._currentLevel = currentLevel;
			this.IsCurrentlyDefault = false;
			bool isDefaultProject = buildingType.IsDefaultProject;
		}

		public override int GetHashCode()
		{
			return this.BuildingType.GetHashCode() + this.Town.GetHashCode();
		}

		public int GetConstructionCost()
		{
			float num = 1f;
			if (this.Town.Settlement.OwnerClan.Kingdom != null && this.Town.Settlement.OwnerClan.Kingdom.ActivePolicies.Contains(DefaultPolicies.CastleCharters))
			{
				num = 0.8f;
			}
			return (int)((float)this.BuildingType.GetProductionCost(this._currentLevel) * num);
		}

		public void LevelUp()
		{
			if (this.CurrentLevel < 3)
			{
				int constructionCost = this.GetConstructionCost();
				this.CurrentLevel++;
				this.BuildingProgress -= (float)constructionCost;
				CampaignEventDispatcher.Instance.OnBuildingLevelChanged(this.Town, this, 1);
			}
		}

		public void LevelDown()
		{
			if (this.CurrentLevel != this.BuildingType.StartLevel)
			{
				this.CurrentLevel--;
				this.BuildingProgress = 0f;
				this._hitpoints = 100f;
				CampaignEventDispatcher.Instance.OnBuildingLevelChanged(this.Town, this, -1);
			}
		}

		public void HitPointChanged(float change)
		{
			if (this.CurrentLevel == this.BuildingType.StartLevel)
			{
				return;
			}
			this._hitpoints = MathF.Clamp(this._hitpoints + change, 0f, 100f);
			if (this._hitpoints == 0f)
			{
				this.LevelDown();
			}
		}

		public float GetBuildingEffectAmount(BuildingEffectEnum effect)
		{
			if (this._currentLevel < this.BuildingType.StartLevel || this._currentLevel > 3)
			{
				Debug.FailedAssert("Building: " + this.Name + " current level is out of bounds!", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Settlements\\Buildings\\Building.cs", "GetBuildingEffectAmount", 126);
			}
			if (this._currentLevel == 0)
			{
				return 0f;
			}
			return Campaign.Current.Models.BuildingEffectModel.GetBuildingEffectAmount(this, effect);
		}

		public TextObject GetBonusExplanation()
		{
			if (this._currentLevel == 0)
			{
				return TextObject.Empty;
			}
			return this.GetBonusExplanations()[this._currentLevel - 1];
		}

		private TextObject[] GetBonusExplanations()
		{
			TextObject[] array = new TextObject[]
			{
				TextObject.Empty,
				TextObject.Empty,
				TextObject.Empty
			};
			if (this._currentLevel == 0 || this._currentLevel > 3)
			{
				return array;
			}
			for (int i = 0; i < this._currentLevel; i++)
			{
				array[i] = this.BuildingType.GetExplanationAtLevel(i);
			}
			return array;
		}

		[SaveableField(0)]
		public readonly BuildingType BuildingType;

		[SaveableField(1)]
		public float BuildingProgress;

		public const float MaxHitpoints = 100f;

		[SaveableField(2)]
		public bool IsCurrentlyDefault;

		[SaveableField(3)]
		private int _currentLevel;

		[SaveableField(5)]
		private float _hitpoints = 100f;
	}
}
