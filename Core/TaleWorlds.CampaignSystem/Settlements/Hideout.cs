using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.LinQuick;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements
{
	// Token: 0x02000358 RID: 856
	public class Hideout : SettlementComponent, ISpottable
	{
		// Token: 0x06003066 RID: 12390 RVA: 0x000CBA1A File Offset: 0x000C9C1A
		internal static void AutoGeneratedStaticCollectObjectsHideout(object o, List<object> collectedObjects)
		{
			((Hideout)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06003067 RID: 12391 RVA: 0x000CBA28 File Offset: 0x000C9C28
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime(this._nextPossibleAttackTime, collectedObjects);
		}

		// Token: 0x06003068 RID: 12392 RVA: 0x000CBA42 File Offset: 0x000C9C42
		internal static object AutoGeneratedGetMemberValue_nextPossibleAttackTime(object o)
		{
			return ((Hideout)o)._nextPossibleAttackTime;
		}

		// Token: 0x06003069 RID: 12393 RVA: 0x000CBA54 File Offset: 0x000C9C54
		internal static object AutoGeneratedGetMemberValue_isSpotted(object o)
		{
			return ((Hideout)o)._isSpotted;
		}

		// Token: 0x17000B92 RID: 2962
		// (get) Token: 0x0600306A RID: 12394 RVA: 0x000CBA66 File Offset: 0x000C9C66
		public CampaignTime NextPossibleAttackTime
		{
			get
			{
				return this._nextPossibleAttackTime;
			}
		}

		// Token: 0x17000B93 RID: 2963
		// (get) Token: 0x0600306B RID: 12395 RVA: 0x000CBA6E File Offset: 0x000C9C6E
		public static MBReadOnlyList<Hideout> All
		{
			get
			{
				return Campaign.Current.AllHideouts;
			}
		}

		// Token: 0x0600306C RID: 12396 RVA: 0x000CBA7A File Offset: 0x000C9C7A
		public void UpdateNextPossibleAttackTime()
		{
			this._nextPossibleAttackTime = CampaignTime.Now + CampaignTime.Hours(12f);
		}

		// Token: 0x17000B94 RID: 2964
		// (get) Token: 0x0600306D RID: 12397 RVA: 0x000CBA98 File Offset: 0x000C9C98
		public bool IsInfested
		{
			get
			{
				return base.Owner.Settlement.Parties.CountQ((MobileParty x) => x.IsBandit) >= Campaign.Current.Models.BanditDensityModel.NumberOfMinimumBanditPartiesInAHideoutToInfestIt;
			}
		}

		// Token: 0x0600306E RID: 12398 RVA: 0x000CBAF2 File Offset: 0x000C9CF2
		public IEnumerable<PartyBase> GetDefenderParties(MapEvent.BattleTypes battleType)
		{
			yield return base.Settlement.Party;
			foreach (MobileParty mobileParty in base.Settlement.Parties)
			{
				if (mobileParty.IsBandit || mobileParty.IsBanditBossParty)
				{
					yield return mobileParty.Party;
				}
			}
			List<MobileParty>.Enumerator enumerator = default(List<MobileParty>.Enumerator);
			yield break;
			yield break;
		}

		// Token: 0x0600306F RID: 12399 RVA: 0x000CBB04 File Offset: 0x000C9D04
		public PartyBase GetNextDefenderParty(ref int partyIndex, MapEvent.BattleTypes battleType)
		{
			partyIndex++;
			if (partyIndex == 0)
			{
				return base.Settlement.Party;
			}
			for (int i = partyIndex - 1; i < base.Settlement.Parties.Count; i++)
			{
				MobileParty mobileParty = base.Settlement.Parties[i];
				if (mobileParty.IsBandit || mobileParty.IsBanditBossParty)
				{
					partyIndex = i + 1;
					return mobileParty.Party;
				}
			}
			return null;
		}

		// Token: 0x17000B95 RID: 2965
		// (get) Token: 0x06003070 RID: 12400 RVA: 0x000CBB74 File Offset: 0x000C9D74
		// (set) Token: 0x06003071 RID: 12401 RVA: 0x000CBB7C File Offset: 0x000C9D7C
		public string SceneName { get; private set; }

		// Token: 0x17000B96 RID: 2966
		// (get) Token: 0x06003072 RID: 12402 RVA: 0x000CBB88 File Offset: 0x000C9D88
		public IFaction MapFaction
		{
			get
			{
				foreach (MobileParty mobileParty in base.Settlement.Parties)
				{
					if (mobileParty.IsBandit)
					{
						return mobileParty.ActualClan;
					}
				}
				foreach (Clan clan in Clan.All)
				{
					if (clan.IsBanditFaction)
					{
						return clan;
					}
				}
				return null;
			}
		}

		// Token: 0x17000B97 RID: 2967
		// (get) Token: 0x06003073 RID: 12403 RVA: 0x000CBC38 File Offset: 0x000C9E38
		// (set) Token: 0x06003074 RID: 12404 RVA: 0x000CBC40 File Offset: 0x000C9E40
		public bool IsSpotted
		{
			get
			{
				return this._isSpotted;
			}
			set
			{
				this._isSpotted = value;
			}
		}

		// Token: 0x06003075 RID: 12405 RVA: 0x000CBC49 File Offset: 0x000C9E49
		public void SetScene(string sceneName)
		{
			this.SceneName = sceneName;
		}

		// Token: 0x06003076 RID: 12406 RVA: 0x000CBC52 File Offset: 0x000C9E52
		public Hideout()
		{
			this.IsSpotted = false;
		}

		// Token: 0x06003077 RID: 12407 RVA: 0x000CBC61 File Offset: 0x000C9E61
		public override void OnPartyEntered(MobileParty mobileParty)
		{
			base.OnPartyEntered(mobileParty);
			this.UpdateOwnership();
			if (mobileParty.MapFaction.IsBanditFaction)
			{
				mobileParty.BanditPartyComponent.SetHomeHideout(base.Owner.Settlement.Hideout);
			}
		}

		// Token: 0x06003078 RID: 12408 RVA: 0x000CBC98 File Offset: 0x000C9E98
		public override void OnPartyLeft(MobileParty mobileParty)
		{
			this.UpdateOwnership();
			if (base.Owner.Settlement.Parties.Count == 0)
			{
				this.OnHideoutIsEmpty();
			}
		}

		// Token: 0x06003079 RID: 12409 RVA: 0x000CBCBD File Offset: 0x000C9EBD
		public override void OnRelatedPartyRemoved(MobileParty mobileParty)
		{
			if (base.Owner.Settlement.Parties.Count == 0)
			{
				this.OnHideoutIsEmpty();
			}
		}

		// Token: 0x0600307A RID: 12410 RVA: 0x000CBCDC File Offset: 0x000C9EDC
		private void OnHideoutIsEmpty()
		{
			this.IsSpotted = false;
			base.Owner.Settlement.IsVisible = false;
			CampaignEventDispatcher.Instance.OnHideoutDeactivated(base.Settlement);
		}

		// Token: 0x0600307B RID: 12411 RVA: 0x000CBD06 File Offset: 0x000C9F06
		public override void OnInit()
		{
			base.Owner.Settlement.IsVisible = false;
		}

		// Token: 0x0600307C RID: 12412 RVA: 0x000CBD1C File Offset: 0x000C9F1C
		public override void Deserialize(MBObjectManager objectManager, XmlNode node)
		{
			base.BackgroundCropPosition = float.Parse(node.Attributes["background_crop_position"].Value);
			base.BackgroundMeshName = node.Attributes["background_mesh"].Value;
			base.WaitMeshName = node.Attributes["wait_mesh"].Value;
			base.Deserialize(objectManager, node);
			if (node.Attributes["scene_name"] != null)
			{
				this.SceneName = node.Attributes["scene_name"].InnerText;
			}
		}

		// Token: 0x0600307D RID: 12413 RVA: 0x000CBDB4 File Offset: 0x000C9FB4
		private void UpdateOwnership()
		{
			if (base.Owner.MemberRoster.Count == 0 || base.Owner.Settlement.Parties.All((MobileParty x) => x.Party.Owner != base.Owner.Owner))
			{
				base.Owner.Settlement.Party.Visuals.SetMapIconAsDirty();
			}
		}

		// Token: 0x0600307E RID: 12414 RVA: 0x000CBE10 File Offset: 0x000CA010
		[CommandLineFunctionality.CommandLineArgumentFunction("show_hideouts", "campaign")]
		public static string ShowHideouts(List<string> strings)
		{
			if (!CampaignCheats.CheckCheatUsage(ref CampaignCheats.ErrorType))
			{
				return CampaignCheats.ErrorType;
			}
			int num;
			if (!CampaignCheats.CheckParameters(strings, 1) || CampaignCheats.CheckHelp(strings) || !int.TryParse(strings[0], out num) || (num != 1 && num != 2))
			{
				return "Format is \"campaign.show_hideouts [1/2]\n 1: Show infested hideouts\n2: Show all hideouts\".";
			}
			foreach (Settlement settlement in Settlement.All)
			{
				if (settlement.IsHideout && (num != 1 || settlement.Hideout.IsInfested))
				{
					Hideout hideout = settlement.Hideout;
					hideout.IsSpotted = true;
					hideout.Owner.Settlement.IsVisible = true;
				}
			}
			return ((num == 1) ? "Infested" : "All") + " hideouts is visible now.";
		}

		// Token: 0x0600307F RID: 12415 RVA: 0x000CBEEC File Offset: 0x000CA0EC
		[CommandLineFunctionality.CommandLineArgumentFunction("hide_hideouts", "campaign")]
		public static string HideHideouts(List<string> strings)
		{
			if (!CampaignCheats.CheckCheatUsage(ref CampaignCheats.ErrorType))
			{
				return CampaignCheats.ErrorType;
			}
			foreach (Settlement settlement in Settlement.All)
			{
				if (settlement.IsHideout)
				{
					Hideout hideout = settlement.Hideout;
					hideout.IsSpotted = false;
					hideout.Owner.Settlement.IsVisible = false;
				}
			}
			return "All hideouts should be invisible now.";
		}

		// Token: 0x06003080 RID: 12416 RVA: 0x000CBF74 File Offset: 0x000CA174
		protected override void OnInventoryUpdated(ItemRosterElement item, int count)
		{
		}

		// Token: 0x04000FEC RID: 4076
		[SaveableField(200)]
		private CampaignTime _nextPossibleAttackTime;

		// Token: 0x04000FED RID: 4077
		[SaveableField(201)]
		private bool _isSpotted;
	}
}
