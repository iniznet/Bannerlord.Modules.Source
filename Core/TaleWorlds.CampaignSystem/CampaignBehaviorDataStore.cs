using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem
{
	internal class CampaignBehaviorDataStore
	{
		internal CampaignBehaviorDataStore()
		{
			this._behaviorDict = new Dictionary<string, CampaignBehaviorDataStore.BehaviorSaveData>();
		}

		internal void SaveBehaviorData(CampaignBehaviorBase campaignBehavior)
		{
			string stringId = campaignBehavior.StringId;
			CampaignBehaviorDataStore.BehaviorSaveData behaviorSaveData = new CampaignBehaviorDataStore.BehaviorSaveData(true);
			campaignBehavior.SyncData(behaviorSaveData);
			if (this._behaviorDict.ContainsKey(stringId))
			{
				Debug.FailedAssert("trying to save multiple behaviors with the same stringid: " + stringId, "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\CampaignBehaviorDataStore.cs", "SaveBehaviorData", 75);
				this._behaviorDict[stringId] = behaviorSaveData;
				return;
			}
			this._behaviorDict.Add(stringId, behaviorSaveData);
		}

		internal void ClearBehaviorData()
		{
			this._behaviorDict.Clear();
		}

		internal void LoadBehaviorData(CampaignBehaviorBase campaignBehavior)
		{
			string stringId = campaignBehavior.StringId;
			CampaignBehaviorDataStore.BehaviorSaveData behaviorSaveData;
			if (this._behaviorDict.TryGetValue(stringId, out behaviorSaveData))
			{
				campaignBehavior.SyncData(behaviorSaveData);
				return;
			}
			List<KeyValuePair<string, CampaignBehaviorDataStore.BehaviorSaveData>> list = this._behaviorDict.ToList<KeyValuePair<string, CampaignBehaviorDataStore.BehaviorSaveData>>();
			string name = campaignBehavior.GetType().Name;
			foreach (KeyValuePair<string, CampaignBehaviorDataStore.BehaviorSaveData> keyValuePair in list)
			{
				if (keyValuePair.Key.Contains(name))
				{
					this._behaviorDict.Remove(keyValuePair.Key);
					this._behaviorDict.Add(stringId, keyValuePair.Value);
					campaignBehavior.SyncData(keyValuePair.Value);
					break;
				}
			}
		}

		internal static void AutoGeneratedStaticCollectObjectsCampaignBehaviorDataStore(object o, List<object> collectedObjects)
		{
			((CampaignBehaviorDataStore)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._behaviorDict);
		}

		internal static object AutoGeneratedGetMemberValue_behaviorDict(object o)
		{
			return ((CampaignBehaviorDataStore)o)._behaviorDict;
		}

		[SaveableField(1)]
		private readonly Dictionary<string, CampaignBehaviorDataStore.BehaviorSaveData> _behaviorDict;

		internal class BehaviorSaveData : IDataStore
		{
			public BehaviorSaveData(bool isSaving)
			{
				this._isSaving = isSaving;
			}

			public bool SyncData<T>(string key, ref T data)
			{
				if (this.IsSaving)
				{
					this._records.Add(key, data);
					return true;
				}
				object obj;
				if (this._records.TryGetValue(key, out obj))
				{
					data = (T)((object)obj);
					return true;
				}
				return false;
			}

			public bool IsSaving
			{
				get
				{
					return this._isSaving;
				}
			}

			public bool IsLoading
			{
				get
				{
					return !this._isSaving;
				}
			}

			internal static void AutoGeneratedStaticCollectObjectsBehaviorSaveData(object o, List<object> collectedObjects)
			{
				((CampaignBehaviorDataStore.BehaviorSaveData)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				collectedObjects.Add(this._records);
			}

			internal static object AutoGeneratedGetMemberValue_records(object o)
			{
				return ((CampaignBehaviorDataStore.BehaviorSaveData)o)._records;
			}

			[SaveableField(0)]
			private Dictionary<string, object> _records = new Dictionary<string, object>();

			private readonly bool _isSaving;
		}
	}
}
