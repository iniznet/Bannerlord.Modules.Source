using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Inventory;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Siege;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.LinQuick;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Encounters
{
	// Token: 0x02000297 RID: 663
	public class PlayerEncounter
	{
		// Token: 0x06002367 RID: 9063 RVA: 0x00095474 File Offset: 0x00093674
		internal static void AutoGeneratedStaticCollectObjectsPlayerEncounter(object o, List<object> collectedObjects)
		{
			((PlayerEncounter)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002368 RID: 9064 RVA: 0x00095484 File Offset: 0x00093684
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._campaignBattleResult);
			collectedObjects.Add(this._mapEvent);
			collectedObjects.Add(this._encounteredParty);
			collectedObjects.Add(this._attackerParty);
			collectedObjects.Add(this._defenderParty);
			collectedObjects.Add(this._helpedHeroes);
			collectedObjects.Add(this._capturedHeroes);
			collectedObjects.Add(this._freedHeroes);
			collectedObjects.Add(this._alternativeRosterToReceiveLootItems);
			collectedObjects.Add(this._alternativeRosterToReceiveLootPrisoners);
			collectedObjects.Add(this._alternativeRosterToReceiveLootMembers);
			collectedObjects.Add(this.EncounterSettlementAux);
		}

		// Token: 0x06002369 RID: 9065 RVA: 0x00095521 File Offset: 0x00093721
		internal static object AutoGeneratedGetMemberValueOpponentSide(object o)
		{
			return ((PlayerEncounter)o).OpponentSide;
		}

		// Token: 0x0600236A RID: 9066 RVA: 0x00095533 File Offset: 0x00093733
		internal static object AutoGeneratedGetMemberValuePlayerSide(object o)
		{
			return ((PlayerEncounter)o).PlayerSide;
		}

		// Token: 0x0600236B RID: 9067 RVA: 0x00095545 File Offset: 0x00093745
		internal static object AutoGeneratedGetMemberValueIsJoinedBattle(object o)
		{
			return ((PlayerEncounter)o).IsJoinedBattle;
		}

		// Token: 0x0600236C RID: 9068 RVA: 0x00095557 File Offset: 0x00093757
		internal static object AutoGeneratedGetMemberValueEncounterSettlementAux(object o)
		{
			return ((PlayerEncounter)o).EncounterSettlementAux;
		}

		// Token: 0x0600236D RID: 9069 RVA: 0x00095564 File Offset: 0x00093764
		internal static object AutoGeneratedGetMemberValueIsPlayerWaiting(object o)
		{
			return ((PlayerEncounter)o).IsPlayerWaiting;
		}

		// Token: 0x0600236E RID: 9070 RVA: 0x00095576 File Offset: 0x00093776
		internal static object AutoGeneratedGetMemberValueFirstInit(object o)
		{
			return ((PlayerEncounter)o).FirstInit;
		}

		// Token: 0x0600236F RID: 9071 RVA: 0x00095588 File Offset: 0x00093788
		internal static object AutoGeneratedGetMemberValueIsEnemy(object o)
		{
			return ((PlayerEncounter)o).IsEnemy;
		}

		// Token: 0x06002370 RID: 9072 RVA: 0x0009559A File Offset: 0x0009379A
		internal static object AutoGeneratedGetMemberValuePlayerPartyInitialStrength(object o)
		{
			return ((PlayerEncounter)o).PlayerPartyInitialStrength;
		}

		// Token: 0x06002371 RID: 9073 RVA: 0x000955AC File Offset: 0x000937AC
		internal static object AutoGeneratedGetMemberValuePartiesStrengthRatioBeforePlayerJoin(object o)
		{
			return ((PlayerEncounter)o).PartiesStrengthRatioBeforePlayerJoin;
		}

		// Token: 0x06002372 RID: 9074 RVA: 0x000955BE File Offset: 0x000937BE
		internal static object AutoGeneratedGetMemberValueForceRaid(object o)
		{
			return ((PlayerEncounter)o).ForceRaid;
		}

		// Token: 0x06002373 RID: 9075 RVA: 0x000955D0 File Offset: 0x000937D0
		internal static object AutoGeneratedGetMemberValueForceSallyOut(object o)
		{
			return ((PlayerEncounter)o).ForceSallyOut;
		}

		// Token: 0x06002374 RID: 9076 RVA: 0x000955E2 File Offset: 0x000937E2
		internal static object AutoGeneratedGetMemberValueForceVolunteers(object o)
		{
			return ((PlayerEncounter)o).ForceVolunteers;
		}

		// Token: 0x06002375 RID: 9077 RVA: 0x000955F4 File Offset: 0x000937F4
		internal static object AutoGeneratedGetMemberValueForceSupplies(object o)
		{
			return ((PlayerEncounter)o).ForceSupplies;
		}

		// Token: 0x06002376 RID: 9078 RVA: 0x00095606 File Offset: 0x00093806
		internal static object AutoGeneratedGetMemberValue_campaignBattleResult(object o)
		{
			return ((PlayerEncounter)o)._campaignBattleResult;
		}

		// Token: 0x06002377 RID: 9079 RVA: 0x00095613 File Offset: 0x00093813
		internal static object AutoGeneratedGetMemberValue_isSiegeInterruptedByEnemyDefection(object o)
		{
			return ((PlayerEncounter)o)._isSiegeInterruptedByEnemyDefection;
		}

		// Token: 0x06002378 RID: 9080 RVA: 0x00095625 File Offset: 0x00093825
		internal static object AutoGeneratedGetMemberValue_isPlayerEncounterInterruptedByPeace(object o)
		{
			return ((PlayerEncounter)o)._isPlayerEncounterInterruptedByPeace;
		}

		// Token: 0x06002379 RID: 9081 RVA: 0x00095637 File Offset: 0x00093837
		internal static object AutoGeneratedGetMemberValue_mapEvent(object o)
		{
			return ((PlayerEncounter)o)._mapEvent;
		}

		// Token: 0x0600237A RID: 9082 RVA: 0x00095644 File Offset: 0x00093844
		internal static object AutoGeneratedGetMemberValue_mapEventState(object o)
		{
			return ((PlayerEncounter)o)._mapEventState;
		}

		// Token: 0x0600237B RID: 9083 RVA: 0x00095656 File Offset: 0x00093856
		internal static object AutoGeneratedGetMemberValue_encounteredParty(object o)
		{
			return ((PlayerEncounter)o)._encounteredParty;
		}

		// Token: 0x0600237C RID: 9084 RVA: 0x00095663 File Offset: 0x00093863
		internal static object AutoGeneratedGetMemberValue_attackerParty(object o)
		{
			return ((PlayerEncounter)o)._attackerParty;
		}

		// Token: 0x0600237D RID: 9085 RVA: 0x00095670 File Offset: 0x00093870
		internal static object AutoGeneratedGetMemberValue_defenderParty(object o)
		{
			return ((PlayerEncounter)o)._defenderParty;
		}

		// Token: 0x0600237E RID: 9086 RVA: 0x0009567D File Offset: 0x0009387D
		internal static object AutoGeneratedGetMemberValue_helpedHeroes(object o)
		{
			return ((PlayerEncounter)o)._helpedHeroes;
		}

		// Token: 0x0600237F RID: 9087 RVA: 0x0009568A File Offset: 0x0009388A
		internal static object AutoGeneratedGetMemberValue_capturedHeroes(object o)
		{
			return ((PlayerEncounter)o)._capturedHeroes;
		}

		// Token: 0x06002380 RID: 9088 RVA: 0x00095697 File Offset: 0x00093897
		internal static object AutoGeneratedGetMemberValue_freedHeroes(object o)
		{
			return ((PlayerEncounter)o)._freedHeroes;
		}

		// Token: 0x06002381 RID: 9089 RVA: 0x000956A4 File Offset: 0x000938A4
		internal static object AutoGeneratedGetMemberValue_leaveEncounter(object o)
		{
			return ((PlayerEncounter)o)._leaveEncounter;
		}

		// Token: 0x06002382 RID: 9090 RVA: 0x000956B6 File Offset: 0x000938B6
		internal static object AutoGeneratedGetMemberValue_playerSurrender(object o)
		{
			return ((PlayerEncounter)o)._playerSurrender;
		}

		// Token: 0x06002383 RID: 9091 RVA: 0x000956C8 File Offset: 0x000938C8
		internal static object AutoGeneratedGetMemberValue_enemySurrender(object o)
		{
			return ((PlayerEncounter)o)._enemySurrender;
		}

		// Token: 0x06002384 RID: 9092 RVA: 0x000956DA File Offset: 0x000938DA
		internal static object AutoGeneratedGetMemberValue_battleChallenge(object o)
		{
			return ((PlayerEncounter)o)._battleChallenge;
		}

		// Token: 0x06002385 RID: 9093 RVA: 0x000956EC File Offset: 0x000938EC
		internal static object AutoGeneratedGetMemberValue_meetingDone(object o)
		{
			return ((PlayerEncounter)o)._meetingDone;
		}

		// Token: 0x06002386 RID: 9094 RVA: 0x000956FE File Offset: 0x000938FE
		internal static object AutoGeneratedGetMemberValue_stateHandled(object o)
		{
			return ((PlayerEncounter)o)._stateHandled;
		}

		// Token: 0x06002387 RID: 9095 RVA: 0x00095710 File Offset: 0x00093910
		internal static object AutoGeneratedGetMemberValue_alternativeRosterToReceiveLootItems(object o)
		{
			return ((PlayerEncounter)o)._alternativeRosterToReceiveLootItems;
		}

		// Token: 0x06002388 RID: 9096 RVA: 0x0009571D File Offset: 0x0009391D
		internal static object AutoGeneratedGetMemberValue_alternativeRosterToReceiveLootPrisoners(object o)
		{
			return ((PlayerEncounter)o)._alternativeRosterToReceiveLootPrisoners;
		}

		// Token: 0x06002389 RID: 9097 RVA: 0x0009572A File Offset: 0x0009392A
		internal static object AutoGeneratedGetMemberValue_alternativeRosterToReceiveLootMembers(object o)
		{
			return ((PlayerEncounter)o)._alternativeRosterToReceiveLootMembers;
		}

		// Token: 0x0600238A RID: 9098 RVA: 0x00095737 File Offset: 0x00093937
		internal static object AutoGeneratedGetMemberValue_doesBattleContinue(object o)
		{
			return ((PlayerEncounter)o)._doesBattleContinue;
		}

		// Token: 0x0600238B RID: 9099 RVA: 0x00095749 File Offset: 0x00093949
		internal static object AutoGeneratedGetMemberValue_isSallyOutAmbush(object o)
		{
			return ((PlayerEncounter)o)._isSallyOutAmbush;
		}

		// Token: 0x170008BC RID: 2236
		// (get) Token: 0x0600238C RID: 9100 RVA: 0x0009575B File Offset: 0x0009395B
		public static PlayerEncounter Current
		{
			get
			{
				return Campaign.Current.PlayerEncounter;
			}
		}

		// Token: 0x170008BD RID: 2237
		// (get) Token: 0x0600238D RID: 9101 RVA: 0x00095767 File Offset: 0x00093967
		// (set) Token: 0x0600238E RID: 9102 RVA: 0x00095773 File Offset: 0x00093973
		public static LocationEncounter LocationEncounter
		{
			get
			{
				return Campaign.Current.LocationEncounter;
			}
			set
			{
				Campaign.Current.LocationEncounter = value;
			}
		}

		// Token: 0x170008BE RID: 2238
		// (get) Token: 0x0600238F RID: 9103 RVA: 0x00095780 File Offset: 0x00093980
		public static MapEvent Battle
		{
			get
			{
				if (PlayerEncounter.Current == null)
				{
					return null;
				}
				return PlayerEncounter.Current._mapEvent;
			}
		}

		// Token: 0x170008BF RID: 2239
		// (get) Token: 0x06002390 RID: 9104 RVA: 0x00095795 File Offset: 0x00093995
		public static PartyBase EncounteredParty
		{
			get
			{
				if (PlayerEncounter.Current != null)
				{
					return PlayerEncounter.Current._encounteredParty;
				}
				return null;
			}
		}

		// Token: 0x170008C0 RID: 2240
		// (get) Token: 0x06002391 RID: 9105 RVA: 0x000957AA File Offset: 0x000939AA
		public static MobileParty EncounteredMobileParty
		{
			get
			{
				PartyBase encounteredParty = PlayerEncounter.EncounteredParty;
				if (encounteredParty == null)
				{
					return null;
				}
				return encounteredParty.MobileParty;
			}
		}

		// Token: 0x170008C1 RID: 2241
		// (get) Token: 0x06002392 RID: 9106 RVA: 0x000957BC File Offset: 0x000939BC
		public static MapEvent EncounteredBattle
		{
			get
			{
				if (PlayerEncounter.Current._encounteredParty.MapEvent != null)
				{
					return PlayerEncounter.Current._encounteredParty.MapEvent;
				}
				if (PlayerEncounter.Current._encounteredParty.IsSettlement)
				{
					SiegeEvent siegeEvent = PlayerEncounter.Current._encounteredParty.SiegeEvent;
					if (((siegeEvent != null) ? siegeEvent.BesiegerCamp.BesiegerParty.MapEvent : null) != null)
					{
						return PlayerEncounter.Current._encounteredParty.SiegeEvent.BesiegerCamp.BesiegerParty.MapEvent;
					}
				}
				return null;
			}
		}

		// Token: 0x170008C2 RID: 2242
		// (get) Token: 0x06002393 RID: 9107 RVA: 0x00095842 File Offset: 0x00093A42
		public static BattleState BattleState
		{
			get
			{
				return PlayerEncounter.Current._mapEvent.BattleState;
			}
		}

		// Token: 0x170008C3 RID: 2243
		// (get) Token: 0x06002394 RID: 9108 RVA: 0x00095853 File Offset: 0x00093A53
		public static BattleSideEnum WinningSide
		{
			get
			{
				return PlayerEncounter.Current._mapEvent.WinningSide;
			}
		}

		// Token: 0x170008C4 RID: 2244
		// (get) Token: 0x06002395 RID: 9109 RVA: 0x00095864 File Offset: 0x00093A64
		// (set) Token: 0x06002396 RID: 9110 RVA: 0x00095870 File Offset: 0x00093A70
		public static bool BattleChallenge
		{
			get
			{
				return PlayerEncounter.Current._battleChallenge;
			}
			set
			{
				PlayerEncounter.Current._battleChallenge = value;
			}
		}

		// Token: 0x170008C5 RID: 2245
		// (get) Token: 0x06002397 RID: 9111 RVA: 0x0009587D File Offset: 0x00093A7D
		public static bool PlayerIsDefender
		{
			get
			{
				return PlayerEncounter.Current.PlayerSide == BattleSideEnum.Defender;
			}
		}

		// Token: 0x170008C6 RID: 2246
		// (get) Token: 0x06002398 RID: 9112 RVA: 0x0009588C File Offset: 0x00093A8C
		public static bool PlayerIsAttacker
		{
			get
			{
				return PlayerEncounter.Current.PlayerSide == BattleSideEnum.Attacker;
			}
		}

		// Token: 0x170008C7 RID: 2247
		// (get) Token: 0x06002399 RID: 9113 RVA: 0x0009589B File Offset: 0x00093A9B
		// (set) Token: 0x0600239A RID: 9114 RVA: 0x000958A7 File Offset: 0x00093AA7
		public static bool LeaveEncounter
		{
			get
			{
				return PlayerEncounter.Current._leaveEncounter;
			}
			set
			{
				PlayerEncounter.Current._leaveEncounter = value;
			}
		}

		// Token: 0x170008C8 RID: 2248
		// (get) Token: 0x0600239B RID: 9115 RVA: 0x000958B4 File Offset: 0x00093AB4
		public static bool MeetingDone
		{
			get
			{
				return PlayerEncounter.Current._meetingDone;
			}
		}

		// Token: 0x170008C9 RID: 2249
		// (get) Token: 0x0600239C RID: 9116 RVA: 0x000958C0 File Offset: 0x00093AC0
		// (set) Token: 0x0600239D RID: 9117 RVA: 0x000958CC File Offset: 0x00093ACC
		public static bool PlayerSurrender
		{
			get
			{
				return PlayerEncounter.Current._playerSurrender;
			}
			set
			{
				if (value)
				{
					PlayerEncounter.Current.PlayerSurrenderInternal();
				}
			}
		}

		// Token: 0x170008CA RID: 2250
		// (get) Token: 0x0600239E RID: 9118 RVA: 0x000958DB File Offset: 0x00093ADB
		// (set) Token: 0x0600239F RID: 9119 RVA: 0x000958E7 File Offset: 0x00093AE7
		public static bool EnemySurrender
		{
			get
			{
				return PlayerEncounter.Current._enemySurrender;
			}
			set
			{
				if (value)
				{
					PlayerEncounter.Current.EnemySurrenderInternal();
				}
			}
		}

		// Token: 0x170008CB RID: 2251
		// (get) Token: 0x060023A0 RID: 9120 RVA: 0x000958F6 File Offset: 0x00093AF6
		public static bool IsActive
		{
			get
			{
				return PlayerEncounter.Current != null;
			}
		}

		// Token: 0x170008CC RID: 2252
		// (get) Token: 0x060023A1 RID: 9121 RVA: 0x00095900 File Offset: 0x00093B00
		// (set) Token: 0x060023A2 RID: 9122 RVA: 0x00095908 File Offset: 0x00093B08
		[SaveableProperty(2)]
		public BattleSideEnum OpponentSide { get; private set; }

		// Token: 0x170008CD RID: 2253
		// (get) Token: 0x060023A3 RID: 9123 RVA: 0x00095911 File Offset: 0x00093B11
		// (set) Token: 0x060023A4 RID: 9124 RVA: 0x00095919 File Offset: 0x00093B19
		[SaveableProperty(3)]
		public BattleSideEnum PlayerSide { get; private set; }

		// Token: 0x170008CE RID: 2254
		// (get) Token: 0x060023A5 RID: 9125 RVA: 0x00095922 File Offset: 0x00093B22
		// (set) Token: 0x060023A6 RID: 9126 RVA: 0x0009592A File Offset: 0x00093B2A
		[SaveableProperty(6)]
		public bool IsJoinedBattle { get; private set; }

		// Token: 0x170008CF RID: 2255
		// (get) Token: 0x060023A7 RID: 9127 RVA: 0x00095933 File Offset: 0x00093B33
		public static bool InsideSettlement
		{
			get
			{
				return MobileParty.MainParty.IsActive && MobileParty.MainParty.CurrentSettlement != null;
			}
		}

		// Token: 0x170008D0 RID: 2256
		// (get) Token: 0x060023A8 RID: 9128 RVA: 0x00095950 File Offset: 0x00093B50
		// (set) Token: 0x060023A9 RID: 9129 RVA: 0x0009595C File Offset: 0x00093B5C
		public static CampaignBattleResult CampaignBattleResult
		{
			get
			{
				return PlayerEncounter.Current._campaignBattleResult;
			}
			set
			{
				PlayerEncounter.Current._campaignBattleResult = value;
			}
		}

		// Token: 0x170008D1 RID: 2257
		// (get) Token: 0x060023AA RID: 9130 RVA: 0x00095969 File Offset: 0x00093B69
		public bool IsPlayerEncounterInterruptedByPeace
		{
			get
			{
				return this._isPlayerEncounterInterruptedByPeace;
			}
		}

		// Token: 0x170008D2 RID: 2258
		// (get) Token: 0x060023AB RID: 9131 RVA: 0x00095971 File Offset: 0x00093B71
		public bool IsSallyOutAmbush
		{
			get
			{
				return this._isSallyOutAmbush;
			}
		}

		// Token: 0x170008D3 RID: 2259
		// (get) Token: 0x060023AC RID: 9132 RVA: 0x00095979 File Offset: 0x00093B79
		public static BattleSimulation CurrentBattleSimulation
		{
			get
			{
				if (PlayerEncounter.Current == null)
				{
					return null;
				}
				return PlayerEncounter.Current.BattleSimulation;
			}
		}

		// Token: 0x170008D4 RID: 2260
		// (get) Token: 0x060023AD RID: 9133 RVA: 0x0009598E File Offset: 0x00093B8E
		// (set) Token: 0x060023AE RID: 9134 RVA: 0x00095996 File Offset: 0x00093B96
		public PlayerEncounterState EncounterState
		{
			get
			{
				return this._mapEventState;
			}
			private set
			{
				this._mapEventState = value;
			}
		}

		// Token: 0x170008D5 RID: 2261
		// (get) Token: 0x060023AF RID: 9135 RVA: 0x0009599F File Offset: 0x00093B9F
		public ItemRoster RosterToReceiveLootItems
		{
			get
			{
				if (this._alternativeRosterToReceiveLootItems == null)
				{
					this._alternativeRosterToReceiveLootItems = new ItemRoster();
				}
				return this._alternativeRosterToReceiveLootItems;
			}
		}

		// Token: 0x170008D6 RID: 2262
		// (get) Token: 0x060023B0 RID: 9136 RVA: 0x000959BA File Offset: 0x00093BBA
		public TroopRoster RosterToReceiveLootPrisoners
		{
			get
			{
				if (this._alternativeRosterToReceiveLootPrisoners == null)
				{
					this._alternativeRosterToReceiveLootPrisoners = TroopRoster.CreateDummyTroopRoster();
				}
				return this._alternativeRosterToReceiveLootPrisoners;
			}
		}

		// Token: 0x170008D7 RID: 2263
		// (get) Token: 0x060023B1 RID: 9137 RVA: 0x000959DB File Offset: 0x00093BDB
		public TroopRoster RosterToReceiveLootMembers
		{
			get
			{
				if (this._alternativeRosterToReceiveLootMembers == null)
				{
					this._alternativeRosterToReceiveLootMembers = TroopRoster.CreateDummyTroopRoster();
				}
				return this._alternativeRosterToReceiveLootMembers;
			}
		}

		// Token: 0x170008D8 RID: 2264
		// (get) Token: 0x060023B2 RID: 9138 RVA: 0x000959FC File Offset: 0x00093BFC
		public static Settlement EncounterSettlement
		{
			get
			{
				PlayerEncounter playerEncounter = PlayerEncounter.Current;
				if (playerEncounter == null)
				{
					return null;
				}
				return playerEncounter.EncounterSettlementAux;
			}
		}

		// Token: 0x170008D9 RID: 2265
		// (get) Token: 0x060023B3 RID: 9139 RVA: 0x00095A0E File Offset: 0x00093C0E
		// (set) Token: 0x060023B4 RID: 9140 RVA: 0x00095A16 File Offset: 0x00093C16
		[SaveableProperty(28)]
		public Settlement EncounterSettlementAux { get; private set; }

		// Token: 0x170008DA RID: 2266
		// (get) Token: 0x060023B5 RID: 9141 RVA: 0x00095A1F File Offset: 0x00093C1F
		// (set) Token: 0x060023B6 RID: 9142 RVA: 0x00095A27 File Offset: 0x00093C27
		[SaveableProperty(50)]
		public bool IsPlayerWaiting { get; set; }

		// Token: 0x060023B7 RID: 9143 RVA: 0x00095A30 File Offset: 0x00093C30
		private PlayerEncounter()
		{
		}

		// Token: 0x060023B8 RID: 9144 RVA: 0x00095A40 File Offset: 0x00093C40
		public void OnLoad()
		{
			if (PlayerEncounter.InsideSettlement && PlayerEncounter.Battle == null)
			{
				PlayerEncounter.CreateLocationEncounter(MobileParty.MainParty.CurrentSettlement);
				return;
			}
			if (PlayerEncounter.Current != null && PlayerEncounter.EncounterSettlement != null && PlayerEncounter.EncounterSettlement.IsVillage && PlayerEncounter.Current.IsPlayerWaiting)
			{
				PlayerEncounter.CreateLocationEncounter(this.EncounterSettlementAux);
			}
		}

		// Token: 0x060023B9 RID: 9145 RVA: 0x00095A9C File Offset: 0x00093C9C
		public static void RestartPlayerEncounter(PartyBase defenderParty, PartyBase attackerParty, bool forcePlayerOutFromSettlement = true)
		{
			if (PlayerEncounter.Current != null)
			{
				PlayerEncounter.Finish(forcePlayerOutFromSettlement);
			}
			else if (!CampaignSiegeTestStatic.IsSiegeTestBuild)
			{
				Debug.FailedAssert("Usage of RestartPlayerEncounter might be invalid.", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "RestartPlayerEncounter", 408);
			}
			PlayerEncounter.Start();
			PlayerEncounter.Current.SetupFields(attackerParty, defenderParty);
		}

		// Token: 0x060023BA RID: 9146 RVA: 0x00095AE9 File Offset: 0x00093CE9
		internal static void SimulateBattle()
		{
			PlayerEncounter.Battle.SimulatePlayerEncounterBattle();
		}

		// Token: 0x060023BB RID: 9147 RVA: 0x00095AF8 File Offset: 0x00093CF8
		internal void Init(PartyBase attackerParty, PartyBase defenderParty, Settlement settlement = null)
		{
			this.EncounterSettlementAux = ((settlement != null) ? settlement : (defenderParty.IsSettlement ? defenderParty.Settlement : attackerParty.Settlement));
			PlayerEncounter.EncounteredPartySurrendered = false;
			this.PlayerPartyInitialStrength = PartyBase.MainParty.TotalStrength;
			this.SetupFields(attackerParty, defenderParty);
			if (defenderParty.MapEvent != null && attackerParty != MobileParty.MainParty.Party && defenderParty != MobileParty.MainParty.Party)
			{
				this._mapEvent = defenderParty.MapEvent;
				if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, this._mapEvent, BattleSideEnum.Defender))
				{
					MobileParty.MainParty.Party.MapEventSide = this._mapEvent.DefenderSide;
				}
				else if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, this._mapEvent, BattleSideEnum.Attacker))
				{
					MobileParty.MainParty.Party.MapEventSide = this._mapEvent.AttackerSide;
				}
			}
			bool flag = false;
			bool flag2 = false;
			string encounterMenu = Campaign.Current.Models.EncounterGameMenuModel.GetEncounterMenu(attackerParty, defenderParty, out flag2, out flag);
			if (!string.IsNullOrEmpty(encounterMenu))
			{
				if (flag2)
				{
					PlayerEncounter.StartBattle();
				}
				if (flag)
				{
					if (MobileParty.MainParty.MapEvent == null)
					{
						if (defenderParty.MapEvent != null)
						{
							if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, defenderParty.MapEvent, BattleSideEnum.Attacker))
							{
								PlayerEncounter.JoinBattle(BattleSideEnum.Attacker);
							}
							else if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, defenderParty.MapEvent, BattleSideEnum.Defender))
							{
								PlayerEncounter.JoinBattle(BattleSideEnum.Defender);
							}
							else
							{
								Debug.FailedAssert("false", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "Init", 474);
							}
						}
						else
						{
							Debug.FailedAssert("If there is no map event we should create one in order to join battle", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "Init", 479);
						}
					}
					this.CheckNearbyPartiesToJoinPlayerMapEvent();
				}
				if (attackerParty == PartyBase.MainParty && defenderParty.IsSettlement && !defenderParty.Settlement.IsUnderRaid && !defenderParty.Settlement.IsUnderSiege)
				{
					PlayerEncounter.EnterSettlement();
				}
				GameMenu.ActivateGameMenu(encounterMenu);
				return;
			}
			if (attackerParty == PartyBase.MainParty && defenderParty.IsSettlement && !defenderParty.Settlement.IsUnderRaid && !defenderParty.Settlement.IsUnderSiege)
			{
				PlayerEncounter.EnterSettlement();
			}
		}

		// Token: 0x060023BC RID: 9148 RVA: 0x00095CF4 File Offset: 0x00093EF4
		public static void Init()
		{
			if (PlayerEncounter.Current == null)
			{
				PlayerEncounter.Start();
			}
			PlayerEncounter.Current.InitAux();
		}

		// Token: 0x060023BD RID: 9149 RVA: 0x00095D0C File Offset: 0x00093F0C
		private void InitAux()
		{
			if (MobileParty.MainParty.MapEvent != null)
			{
				this._mapEvent = MobileParty.MainParty.MapEvent;
				this.SetupFields(this._mapEvent.AttackerSide.LeaderParty, this._mapEvent.DefenderSide.LeaderParty);
				this.CheckNearbyPartiesToJoinPlayerMapEvent();
			}
		}

		// Token: 0x060023BE RID: 9150 RVA: 0x00095D64 File Offset: 0x00093F64
		public void SetupFields(PartyBase attackerParty, PartyBase defenderParty)
		{
			this._attackerParty = attackerParty;
			this._defenderParty = defenderParty;
			MobileParty mobileParty = ((defenderParty.IsMobile && defenderParty != PartyBase.MainParty && defenderParty.MobileParty != MobileParty.MainParty.AttachedTo) ? defenderParty.MobileParty : ((attackerParty.IsMobile && attackerParty != PartyBase.MainParty && attackerParty.MobileParty != MobileParty.MainParty.AttachedTo) ? attackerParty.MobileParty : null));
			if (this._defenderParty.IsSettlement)
			{
				this.EncounterSettlementAux = defenderParty.Settlement;
			}
			else if (this._attackerParty.IsSettlement)
			{
				this.EncounterSettlementAux = this._attackerParty.Settlement;
			}
			else if (mobileParty.BesiegerCamp != null)
			{
				this.EncounterSettlementAux = mobileParty.BesiegerCamp.SiegeEvent.BesiegedSettlement;
			}
			PartyBase partyBase;
			if (mobileParty == null)
			{
				Settlement encounterSettlementAux = this.EncounterSettlementAux;
				partyBase = ((encounterSettlementAux != null) ? encounterSettlementAux.Party : null);
			}
			else
			{
				partyBase = mobileParty.Party;
			}
			this._encounteredParty = partyBase;
			if (MapEvent.PlayerMapEvent != null)
			{
				this.PlayerSide = MapEvent.PlayerMapEvent.PlayerSide;
			}
			else if (defenderParty == PartyBase.MainParty || (defenderParty.MobileParty != null && defenderParty.MobileParty == MobileParty.MainParty.AttachedTo) || (defenderParty.IsSettlement && (defenderParty.Settlement.MapFaction == MobileParty.MainParty.MapFaction || MobileParty.MainParty.CurrentSettlement == defenderParty.Settlement)))
			{
				this.PlayerSide = BattleSideEnum.Defender;
			}
			else
			{
				this.PlayerSide = BattleSideEnum.Attacker;
			}
			this.OpponentSide = this.PlayerSide.GetOppositeSide();
			if (!this._encounteredParty.IsSettlement)
			{
				MobileParty.MainParty.Ai.SetMoveModeHold();
			}
		}

		// Token: 0x060023BF RID: 9151 RVA: 0x00095EFC File Offset: 0x000940FC
		internal void OnPartyJoinEncounter(MobileParty newParty)
		{
			if (PlayerEncounter.Battle != null)
			{
				if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, PlayerEncounter.Battle, PartyBase.MainParty.Side))
				{
					newParty.Party.MapEventSide = PartyBase.MainParty.MapEventSide;
					return;
				}
				if (newParty == MobileParty.MainParty && PlayerEncounter.Battle.IsRaid && PlayerEncounter.Battle.AttackerSide.LeaderParty != MobileParty.MainParty.Party && PlayerEncounter.Battle.DefenderSide.TroopCount == 0)
				{
					return;
				}
				MobileParty.MainParty.Ai.SetMoveModeHold();
				string newPartyJoinMenu = Campaign.Current.Models.EncounterGameMenuModel.GetNewPartyJoinMenu(newParty);
				if (MapEventHelper.CanPartyJoinBattle(PartyBase.MainParty, PlayerEncounter.Battle, PartyBase.MainParty.OpponentSide))
				{
					newParty.Party.MapEventSide = PartyBase.MainParty.MapEventSide.OtherSide;
				}
				if (!string.IsNullOrEmpty(newPartyJoinMenu))
				{
					GameMenu.SwitchToMenu(newPartyJoinMenu);
				}
			}
		}

		// Token: 0x060023C0 RID: 9152 RVA: 0x00095FF0 File Offset: 0x000941F0
		private void CheckNearbyPartiesToJoinPlayerMapEvent()
		{
			if (this._mapEvent == null || this._mapEvent.IsRaid || this._mapEvent.IsSiegeAssault || this._mapEvent.IsForcingSupplies || this._mapEvent.IsForcingVolunteers)
			{
				return;
			}
			if (this._mapEvent.MapEventSettlement != null && this._mapEvent.MapEventSettlement.IsHideout)
			{
				return;
			}
			List<MobileParty> list = new List<MobileParty>();
			List<MobileParty> list2 = new List<MobileParty>();
			foreach (MapEventParty mapEventParty in this._mapEvent.PartiesOnSide(this.PlayerSide))
			{
				if (mapEventParty.Party.IsMobile)
				{
					list.Add(mapEventParty.Party.MobileParty);
				}
			}
			foreach (MapEventParty mapEventParty2 in this._mapEvent.PartiesOnSide(this.PlayerSide.GetOppositeSide()))
			{
				if (mapEventParty2.Party.IsMobile)
				{
					list2.Add(mapEventParty2.Party.MobileParty);
				}
			}
			PlayerEncounter.Current.FindNonAttachedNpcPartiesWhoWillJoinEvent(ref list, ref list2);
			foreach (MobileParty mobileParty in list)
			{
				this._mapEvent.GetMapEventSide(this.PlayerSide).AddNearbyPartyToPlayerMapEvent(mobileParty);
			}
			foreach (MobileParty mobileParty2 in list2)
			{
				this._mapEvent.GetMapEventSide(this.PlayerSide.GetOppositeSide()).AddNearbyPartyToPlayerMapEvent(mobileParty2);
			}
		}

		// Token: 0x060023C1 RID: 9153 RVA: 0x000961F0 File Offset: 0x000943F0
		private static TerrainType GetTerrainByCount(List<TerrainType> terrainTypeSamples, TerrainType currentPositionTerrainType)
		{
			for (int i = 0; i < terrainTypeSamples.Count; i++)
			{
				if (terrainTypeSamples[i] == TerrainType.Snow)
				{
					terrainTypeSamples[i] = TerrainType.Plain;
				}
			}
			if (currentPositionTerrainType == TerrainType.Plain || currentPositionTerrainType == TerrainType.Desert || currentPositionTerrainType == TerrainType.Swamp || currentPositionTerrainType == TerrainType.Steppe)
			{
				int num = (int)((float)terrainTypeSamples.Count * 0.33f);
				for (int j = 0; j < num; j++)
				{
					terrainTypeSamples.Add(currentPositionTerrainType);
				}
			}
			Dictionary<TerrainType, int> dictionary = new Dictionary<TerrainType, int>();
			foreach (TerrainType terrainType in terrainTypeSamples)
			{
				if (!dictionary.ContainsKey(terrainType))
				{
					dictionary.Add(terrainType, 1);
				}
				else
				{
					Dictionary<TerrainType, int> dictionary2 = dictionary;
					TerrainType terrainType2 = terrainType;
					int num2 = dictionary2[terrainType2];
					dictionary2[terrainType2] = num2 + 1;
				}
			}
			KeyValuePair<TerrainType, int> keyValuePair = new KeyValuePair<TerrainType, int>(TerrainType.Plain, 0);
			foreach (KeyValuePair<TerrainType, int> keyValuePair2 in dictionary)
			{
				if ((keyValuePair2.Key == TerrainType.Plain || keyValuePair2.Key == TerrainType.Desert || keyValuePair2.Key == TerrainType.Swamp || keyValuePair2.Key == TerrainType.Steppe) && keyValuePair2.Value > keyValuePair.Value)
				{
					keyValuePair = keyValuePair2;
				}
			}
			return keyValuePair.Key;
		}

		// Token: 0x060023C2 RID: 9154 RVA: 0x0009634C File Offset: 0x0009454C
		private static List<TerrainType> GetSceneProperties(List<TerrainType> terrainTypeSamples, int forestCount, out ForestDensity forestDensity)
		{
			forestDensity = ForestDensity.None;
			float num = (float)forestCount / (float)terrainTypeSamples.Count;
			if (num > 0.1f && num < 0.5f)
			{
				forestDensity = ForestDensity.Low;
			}
			else if (num >= 0.5f)
			{
				forestDensity = ForestDensity.High;
			}
			List<TerrainType> list = new List<TerrainType>();
			foreach (TerrainType terrainType in terrainTypeSamples)
			{
				if (!list.Contains(terrainType))
				{
					list.Add(terrainType);
				}
			}
			return list;
		}

		// Token: 0x060023C3 RID: 9155 RVA: 0x000963D8 File Offset: 0x000945D8
		public static string GetBattleSceneForMapPatch(MapPatchData mapPatch)
		{
			MBList<SingleplayerBattleSceneData> mblist = GameSceneDataManager.Instance.SingleplayerBattleScenes.Where((SingleplayerBattleSceneData scene) => scene.MapIndices.Contains(mapPatch.sceneIndex)).ToMBList<SingleplayerBattleSceneData>();
			string text;
			if (mblist.IsEmpty<SingleplayerBattleSceneData>())
			{
				Debug.FailedAssert("Battle scene for map patch with scene index " + mapPatch.sceneIndex + " does not exist. Picking a random scene", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "GetBattleSceneForMapPatch", 748);
				text = GameSceneDataManager.Instance.SingleplayerBattleScenes.GetRandomElement<SingleplayerBattleSceneData>().SceneID;
			}
			else if (mblist.Count > 1)
			{
				Debug.FailedAssert("Multiple battle scenes for map patch with scene index " + mapPatch.sceneIndex + " are defined. Picking a matching scene randomly", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "GetBattleSceneForMapPatch", 753);
				text = mblist.GetRandomElement<SingleplayerBattleSceneData>().SceneID;
			}
			else
			{
				text = mblist[0].SceneID;
			}
			return text;
		}

		// Token: 0x060023C4 RID: 9156 RVA: 0x000964CC File Offset: 0x000946CC
		public static string GetConversationSceneForMapPosition(Vec2 position2D)
		{
			TerrainType terrainType;
			List<TerrainType> environmentTerrainTypesCount = Campaign.Current.MapSceneWrapper.GetEnvironmentTerrainTypesCount(position2D, out terrainType);
			int num = 0;
			foreach (TerrainType terrainType2 in environmentTerrainTypesCount)
			{
				num += ((terrainType2 == TerrainType.Forest) ? 1 : 0);
			}
			TerrainType terrainByCount = PlayerEncounter.GetTerrainByCount(environmentTerrainTypesCount, terrainType);
			ForestDensity forestDensity;
			List<TerrainType> sceneProperties = PlayerEncounter.GetSceneProperties(environmentTerrainTypesCount, num, out forestDensity);
			int num2 = 0;
			Dictionary<ConversationSceneData, int> dictionary = new Dictionary<ConversationSceneData, int>();
			foreach (ConversationSceneData conversationSceneData in GameSceneDataManager.Instance.ConversationScenes)
			{
				if (conversationSceneData.Terrain == terrainByCount)
				{
					int num3 = 0;
					if ((forestDensity == ForestDensity.None && conversationSceneData.ForestDensity == ForestDensity.None) || (forestDensity != ForestDensity.None && conversationSceneData.ForestDensity > ForestDensity.None))
					{
						num3++;
					}
					int num4 = 2 - MathF.Abs(forestDensity - conversationSceneData.ForestDensity);
					num3 += num4;
					foreach (TerrainType terrainType3 in sceneProperties)
					{
						if (conversationSceneData.TerrainTypes.Contains(terrainType3))
						{
							num3 += 3;
						}
					}
					dictionary.Add(conversationSceneData, num3);
					if (num3 > num2)
					{
						num2 = num3;
					}
				}
			}
			MBList<ConversationSceneData> mblist = new MBList<ConversationSceneData>();
			foreach (KeyValuePair<ConversationSceneData, int> keyValuePair in dictionary)
			{
				if (keyValuePair.Value == num2)
				{
					mblist.Add(keyValuePair.Key);
				}
			}
			return ((mblist.Count > 0) ? mblist.GetRandomElement<ConversationSceneData>() : GameSceneDataManager.Instance.ConversationScenes.GetRandomElement<ConversationSceneData>()).SceneID;
		}

		// Token: 0x060023C5 RID: 9157 RVA: 0x000966D8 File Offset: 0x000948D8
		private MapEvent StartBattleInternal()
		{
			if (this._mapEvent == null)
			{
				if (this.ForceRaid)
				{
					this._mapEvent = RaidEventComponent.CreateRaidEvent(this._attackerParty, this._defenderParty).MapEvent;
				}
				else if (this.ForceSallyOut)
				{
					this._mapEvent = Campaign.Current.MapEventManager.StartSallyOutMapEvent(this._attackerParty, this._defenderParty);
				}
				else if (this.ForceVolunteers)
				{
					this._mapEvent = ForceVolunteersEventComponent.CreateForceSuppliesEvent(this._attackerParty, this._defenderParty).MapEvent;
				}
				else if (this.ForceSupplies)
				{
					this._mapEvent = ForceSuppliesEventComponent.CreateForceSuppliesEvent(this._attackerParty, this._defenderParty).MapEvent;
				}
				else if (this._defenderParty.IsSettlement)
				{
					if (this._defenderParty.Settlement.IsFortification)
					{
						this._mapEvent = Campaign.Current.MapEventManager.StartSiegeMapEvent(this._attackerParty, this._defenderParty);
					}
					else if (this._defenderParty.Settlement.IsVillage)
					{
						this._mapEvent = RaidEventComponent.CreateRaidEvent(this._attackerParty, this._defenderParty).MapEvent;
					}
					else if (this._defenderParty.Settlement.IsHideout)
					{
						this._mapEvent = Campaign.Current.MapEventManager.StartHideoutMapEvent(this._attackerParty, this._defenderParty);
					}
					else
					{
						Debug.FailedAssert("Proper mapEvent type could not be set for the battle.", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "StartBattleInternal", 873);
					}
				}
				else if (this._isSallyOutAmbush)
				{
					this._mapEvent = Campaign.Current.MapEventManager.StartSiegeMapEvent(this._attackerParty, this._defenderParty);
				}
				else if (this._attackerParty.IsMobile && this._attackerParty.MobileParty.CurrentSettlement != null && this._attackerParty.MobileParty.CurrentSettlement.SiegeEvent != null)
				{
					this._mapEvent = Campaign.Current.MapEventManager.StartSallyOutMapEvent(this._attackerParty, this._defenderParty);
				}
				else if (this._defenderParty.IsMobile && this._defenderParty.MobileParty.BesiegedSettlement != null)
				{
					this._mapEvent = Campaign.Current.MapEventManager.StartSiegeOutsideMapEvent(this._attackerParty, this._defenderParty);
				}
				else
				{
					this._mapEvent = Campaign.Current.MapEventManager.StartBattleMapEvent(this._attackerParty, this._defenderParty);
				}
			}
			this.CheckNearbyPartiesToJoinPlayerMapEvent();
			return this._mapEvent;
		}

		// Token: 0x060023C6 RID: 9158 RVA: 0x00096960 File Offset: 0x00094B60
		public static MapEvent StartBattle()
		{
			return PlayerEncounter.Current.StartBattleInternal();
		}

		// Token: 0x060023C7 RID: 9159 RVA: 0x0009696C File Offset: 0x00094B6C
		private void JoinBattleInternal(BattleSideEnum side)
		{
			this.PlayerSide = side;
			if (side == BattleSideEnum.Defender)
			{
				this.OpponentSide = BattleSideEnum.Attacker;
			}
			else if (side == BattleSideEnum.Attacker)
			{
				this.OpponentSide = BattleSideEnum.Defender;
			}
			if (PlayerEncounter.EncounteredBattle != null)
			{
				this._mapEvent = PlayerEncounter.EncounteredBattle;
				this._encounteredParty = ((this.PlayerSide == BattleSideEnum.Attacker) ? PlayerEncounter.EncounteredBattle.DefenderSide.LeaderParty : PlayerEncounter.EncounteredBattle.AttackerSide.LeaderParty);
				this.PartiesStrengthRatioBeforePlayerJoin = this.CalculateStrengthOfParties();
				PartyBase.MainParty.MapEventSide = PlayerEncounter.EncounteredBattle.GetMapEventSide(side);
				this.EncounterSettlementAux = this._mapEvent.MapEventSettlement;
				if (PlayerEncounter.EncounteredBattle.IsSiegeAssault && this.PlayerSide == BattleSideEnum.Attacker)
				{
					MobileParty.MainParty.BesiegerCamp = this._encounteredParty.SiegeEvent.BesiegerCamp;
				}
				this.IsJoinedBattle = true;
				this.CheckNearbyPartiesToJoinPlayerMapEvent();
				return;
			}
			PlayerEncounter.Finish(PlayerEncounter.InsideSettlement);
		}

		// Token: 0x060023C8 RID: 9160 RVA: 0x00096A54 File Offset: 0x00094C54
		private float CalculateStrengthOfParties()
		{
			float num = 0f;
			float num2 = 0f;
			foreach (MapEventParty mapEventParty in this._mapEvent.DefenderSide.Parties)
			{
				num += mapEventParty.Party.TotalStrength;
			}
			foreach (MapEventParty mapEventParty2 in this._mapEvent.AttackerSide.Parties)
			{
				num2 += mapEventParty2.Party.TotalStrength;
			}
			return num / num2;
		}

		// Token: 0x060023C9 RID: 9161 RVA: 0x00096B1C File Offset: 0x00094D1C
		public static void JoinBattle(BattleSideEnum side)
		{
			PlayerEncounter.Current.JoinBattleInternal(side);
		}

		// Token: 0x060023CA RID: 9162 RVA: 0x00096B29 File Offset: 0x00094D29
		private void PlayerSurrenderInternal()
		{
			this._playerSurrender = true;
			if (PlayerEncounter.Battle == null)
			{
				PlayerEncounter.StartBattle();
			}
			this._mapEvent.DoSurrender(PartyBase.MainParty.Side);
			MobileParty.MainParty.BesiegerCamp = null;
		}

		// Token: 0x060023CB RID: 9163 RVA: 0x00096B5F File Offset: 0x00094D5F
		private void EnemySurrenderInternal()
		{
			this._enemySurrender = true;
			this._mapEvent.DoSurrender(PartyBase.MainParty.OpponentSide);
		}

		// Token: 0x060023CC RID: 9164 RVA: 0x00096B7D File Offset: 0x00094D7D
		public static void Start()
		{
			Campaign.Current.PlayerEncounter = new PlayerEncounter();
		}

		// Token: 0x060023CD RID: 9165 RVA: 0x00096B8E File Offset: 0x00094D8E
		public static void ProtectPlayerSide(float hoursToProtect = 1f)
		{
			MobileParty.MainParty.TeleportPartyToSafePosition(3.3f, 3f);
			MobileParty.MainParty.IgnoreForHours(hoursToProtect);
		}

		// Token: 0x060023CE RID: 9166 RVA: 0x00096BB0 File Offset: 0x00094DB0
		public static void Finish(bool forcePlayerOutFromSettlement = true)
		{
			if (MobileParty.MainParty.Army == null || MobileParty.MainParty.Army.LeaderParty == PlayerEncounter.EncounteredMobileParty)
			{
				Campaign.Current.TimeControlMode = CampaignTimeControlMode.Stop;
			}
			if (Campaign.Current.CurrentMenuContext != null)
			{
				GameMenu.ExitToLast();
			}
			if (PlayerEncounter.Current != null)
			{
				bool flag = PlayerSiege.PlayerSiegeEvent != null && PlayerSiege.PlayerSide == BattleSideEnum.Attacker && MobileParty.MainParty.MapEvent != null && !MobileParty.MainParty.MapEvent.IsSiegeAssault && MobileParty.MainParty.MapEvent.HasWinner && MobileParty.MainParty.MapEvent.PlayerSide == BattleSideEnum.Defender && MobileParty.MainParty.BesiegedSettlement != null;
				if ((flag || PlayerEncounter.Current._isSiegeInterruptedByEnemyDefection) && Hero.MainHero.PartyBelongedToAsPrisoner == null && !PlayerEncounter.Current._leaveEncounter && PlayerEncounter.Current._encounteredParty.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
				{
					GameMenu.ActivateGameMenu("continue_siege_after_attack");
					if (PlayerEncounter.Current._isSiegeInterruptedByEnemyDefection)
					{
						PlayerEncounter.Current._isSiegeInterruptedByEnemyDefection = false;
					}
				}
				if (PlayerEncounter.Current._isPlayerEncounterInterruptedByPeace)
				{
					GameMenu.ActivateGameMenu("hostile_action_end_by_peace");
					PlayerEncounter.Current._isPlayerEncounterInterruptedByPeace = false;
				}
				if ((flag || PlayerEncounter.Current._isSiegeInterruptedByEnemyDefection) && Hero.MainHero.PartyBelongedToAsPrisoner != null && PlayerEncounter.Current._leaveEncounter)
				{
					MobileParty.MainParty.BesiegerCamp = null;
				}
				PlayerEncounter.Current.FirstInit = true;
				Settlement encounterSettlement = PlayerEncounter.EncounterSettlement;
				if (encounterSettlement != null)
				{
					encounterSettlement.OnPlayerEncounterFinish();
				}
				PlayerEncounter.Current.FinalizeBattle();
				PlayerEncounter.Current.FinishEncounterInternal();
				if (PlayerEncounter.CurrentBattleSimulation != null)
				{
					MapState mapState = Game.Current.GameStateManager.LastOrDefault<MapState>();
					if (mapState != null && mapState.IsSimulationActive)
					{
						mapState.EndBattleSimulation();
					}
					PlayerEncounter.Current.BattleSimulation = null;
				}
				if (PlayerEncounter.InsideSettlement && MobileParty.MainParty.AttachedTo == null && forcePlayerOutFromSettlement)
				{
					PlayerEncounter.LeaveSettlement();
				}
			}
			Campaign.Current.PlayerEncounter = null;
			Campaign.Current.LocationEncounter = null;
			MobileParty.MainParty.Ai.SetMoveModeHold();
		}

		// Token: 0x060023CF RID: 9167 RVA: 0x00096DC4 File Offset: 0x00094FC4
		private void FinishEncounterInternal()
		{
			if (this._encounteredParty != null && this._encounteredParty.IsMobile && MobileParty.MainParty.AttachedTo == null && FactionManager.IsAtWarAgainstFaction(this._encounteredParty.MapFaction, PartyBase.MainParty.MapFaction) && this._encounteredParty.MobileParty.IsActive)
			{
				MobileParty.MainParty.TeleportPartyToSafePosition(0.3f, 0.1f);
				this._encounteredParty.MobileParty.Ai.SetDoNotAttackMainParty(2);
			}
		}

		// Token: 0x060023D0 RID: 9168 RVA: 0x00096E4C File Offset: 0x0009504C
		private void UpdateInternal()
		{
			this._mapEvent = MapEvent.PlayerMapEvent;
			if (PlayerEncounter.EncounteredPartySurrendered && this.EncounterState == PlayerEncounterState.Begin)
			{
				this.EncounterState = PlayerEncounterState.Wait;
			}
			this._stateHandled = false;
			while (!this._stateHandled)
			{
				if (PlayerEncounter.Current._leaveEncounter)
				{
					PlayerEncounter.Finish(true);
					this._stateHandled = true;
				}
				if (!this._stateHandled)
				{
					switch (this.EncounterState)
					{
					case PlayerEncounterState.Begin:
						this.DoBegin();
						break;
					case PlayerEncounterState.Wait:
						this.DoWait();
						break;
					case PlayerEncounterState.PrepareResults:
						this.DoPrepareResults();
						break;
					case PlayerEncounterState.ApplyResults:
						this.DoApplyResults();
						break;
					case PlayerEncounterState.PlayerVictory:
						this.DoPlayerVictory();
						break;
					case PlayerEncounterState.PlayerTotalDefeat:
						this.DoPlayerDefeat();
						break;
					case PlayerEncounterState.CaptureHeroes:
						this.DoCaptureHeroes();
						break;
					case PlayerEncounterState.FreeHeroes:
						this.DoFreeHeroes();
						break;
					case PlayerEncounterState.LootParty:
						this.DoLootParty();
						break;
					case PlayerEncounterState.LootInventory:
						this.DoLootInventory();
						break;
					case PlayerEncounterState.End:
						this.DoEnd();
						break;
					default:
						Debug.FailedAssert("[DEBUG]Invalid map event state: " + this._mapEventState, "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "UpdateInternal", 1151);
						break;
					}
				}
			}
		}

		// Token: 0x060023D1 RID: 9169 RVA: 0x00096F74 File Offset: 0x00095174
		private void EndBattleByCheatInternal(bool playerWon)
		{
			if (playerWon)
			{
				foreach (MapEventParty mapEventParty in this._mapEvent.PartiesOnSide(this.OpponentSide))
				{
					for (int i = 0; i < mapEventParty.Party.MemberRoster.Count; i++)
					{
						int elementNumber = mapEventParty.Party.MemberRoster.GetElementNumber(i);
						int elementWoundedNumber = mapEventParty.Party.MemberRoster.GetElementWoundedNumber(i);
						int num = elementNumber - elementWoundedNumber;
						int num2 = elementWoundedNumber + MBRandom.RandomInt(num);
						num2 = ((num2 <= 0 && elementNumber >= 0) ? 1 : num2);
						mapEventParty.Party.MemberRoster.SetElementNumber(i, num2);
						mapEventParty.Party.MemberRoster.SetElementWoundedNumber(i, num2);
					}
				}
			}
		}

		// Token: 0x060023D2 RID: 9170 RVA: 0x00097064 File Offset: 0x00095264
		public static void EndBattleByCheat(bool playerWon)
		{
			PlayerEncounter.Current.EndBattleByCheatInternal(playerWon);
		}

		// Token: 0x060023D3 RID: 9171 RVA: 0x00097071 File Offset: 0x00095271
		public static void Update()
		{
			PlayerEncounter.Current.UpdateInternal();
		}

		// Token: 0x060023D4 RID: 9172 RVA: 0x0009707D File Offset: 0x0009527D
		private void DoBegin()
		{
			this.EncounterState = PlayerEncounterState.Wait;
			this._stateHandled = true;
		}

		// Token: 0x060023D5 RID: 9173 RVA: 0x0009708D File Offset: 0x0009528D
		public static void DoMeeting()
		{
			PlayerEncounter.Current.DoMeetingInternal();
		}

		// Token: 0x060023D6 RID: 9174 RVA: 0x00097099 File Offset: 0x00095299
		public static void SetMeetingDone()
		{
			PlayerEncounter.Current._meetingDone = true;
		}

		// Token: 0x060023D7 RID: 9175 RVA: 0x000970A8 File Offset: 0x000952A8
		private void DoMeetingInternal()
		{
			PartyBase partyBase = this._encounteredParty;
			if (partyBase.IsSettlement)
			{
				foreach (MapEventParty mapEventParty in MobileParty.MainParty.MapEvent.DefenderSide.Parties)
				{
					if (!mapEventParty.Party.IsSettlement)
					{
						partyBase = mapEventParty.Party;
						break;
					}
				}
			}
			this.EncounterState = PlayerEncounterState.Begin;
			this._stateHandled = true;
			if (PlayerEncounter.PlayerIsAttacker && this._defenderParty.IsMobile && this._defenderParty.MobileParty.Army != null && this._defenderParty.MobileParty.Army.LeaderParty == this._defenderParty.MobileParty && (this._defenderParty.SiegeEvent != null || (!this._defenderParty.MobileParty.MapFaction.IsAtWarWith(MobileParty.MainParty.MapFaction) && !this._defenderParty.MobileParty.Army.LeaderParty.AttachedParties.Contains(MobileParty.MainParty))))
			{
				GameMenu.SwitchToMenu("army_encounter");
				return;
			}
			Campaign.Current.CurrentConversationContext = ConversationContext.PartyEncounter;
			this._meetingDone = true;
			CharacterObject conversationCharacterPartyLeader = ConversationHelper.GetConversationCharacterPartyLeader(partyBase);
			ConversationCharacterData conversationCharacterData = new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, true, false, false, false, false, false);
			ConversationCharacterData conversationCharacterData2 = new ConversationCharacterData(conversationCharacterPartyLeader, partyBase, true, false, false, false, false, false);
			CampaignMapConversation.OpenConversation(conversationCharacterData, conversationCharacterData2);
		}

		// Token: 0x060023D8 RID: 9176 RVA: 0x00097234 File Offset: 0x00095434
		private void ContinueBattle()
		{
			Debug.Print("[PlayerEncounter.ContinueBattle Start]", 0, Debug.DebugColor.White, 17592186044416UL);
			MapEventSide mapEventSide = this._mapEvent.GetMapEventSide(this._mapEvent.PlayerSide);
			MapEventSide otherSide = mapEventSide.OtherSide;
			this._mapEvent.RecalculateStrengthOfSides();
			float num = this._mapEvent.StrengthOfSide[(int)mapEventSide.MissionSide];
			float num2 = this._mapEvent.StrengthOfSide[(int)otherSide.MissionSide];
			float num3 = num / (num + num2);
			Debug.Print("playerSideStrength: " + num, 0, Debug.DebugColor.White, 17592186044416UL);
			Debug.Print("otherSideStrength: " + num2, 0, Debug.DebugColor.White, 17592186044416UL);
			Debug.Print("playerSideStrengthRatio: " + num3, 0, Debug.DebugColor.White, 17592186044416UL);
			if (num3 >= 0.95f && otherSide.GetTotalHealthyHeroCountOfSide() <= 0)
			{
				Debug.Print("Player side wins according to the strength ratio.", 0, Debug.DebugColor.White, 17592186044416UL);
				MapEvent mapEvent = this._mapEvent;
				if (mapEvent != null)
				{
					mapEvent.SetOverrideWinner(this._mapEvent.PlayerSide);
				}
				PlayerEncounter.EnemySurrender = true;
				this.EncounterState = PlayerEncounterState.PrepareResults;
			}
			else if (num3 < 0.05f && mapEventSide.GetTotalHealthyHeroCountOfSide() <= 0)
			{
				Debug.Print("Other side wins according to the strength ratio.", 0, Debug.DebugColor.White, 17592186044416UL);
				MapEvent mapEvent2 = this._mapEvent;
				if (mapEvent2 != null)
				{
					mapEvent2.SetOverrideWinner(otherSide.MissionSide);
				}
				this.EncounterState = PlayerEncounterState.PrepareResults;
			}
			else
			{
				Debug.Print("Battle continues.", 0, Debug.DebugColor.White, 17592186044416UL);
				Debug.Print("Other side strength by party:", 0, Debug.DebugColor.White, 17592186044416UL);
				foreach (MapEventParty mapEventParty in otherSide.Parties)
				{
					Debug.Print(string.Concat(new object[]
					{
						"party name: ",
						mapEventParty.Party.Name,
						", strength: ",
						mapEventParty.Party.TotalStrength,
						", healthy count: ",
						mapEventParty.Party.MemberRoster.TotalHealthyCount,
						", wounded count: ",
						mapEventParty.Party.MemberRoster.TotalWounded
					}), 0, Debug.DebugColor.White, 17592186044416UL);
				}
				this._mapEvent.AttackerSide.CommitXpGains();
				this._mapEvent.DefenderSide.CommitXpGains();
				this._mapEvent.ApplyRenownAndInfluenceChanges();
				this._mapEvent.SetOverrideWinner(BattleSideEnum.None);
				if (this._mapEvent.IsSiegeAssault && otherSide == this._mapEvent.AttackerSide)
				{
					CampaignBattleResult campaignBattleResult = this._campaignBattleResult;
					if (campaignBattleResult != null && campaignBattleResult.EnemyRetreated)
					{
						List<MapEventParty> list = this._mapEvent.AttackerSide.Parties.ToList<MapEventParty>();
						this._mapEvent.FinishBattleAndKeepSiegeEvent();
						foreach (MapEventParty mapEventParty2 in list)
						{
							mapEventParty2.Party.Visuals.SetMapIconAsDirty();
							if (mapEventParty2.Party.IsMobile)
							{
								mapEventParty2.Party.MobileParty.Ai.SetMoveBesiegeSettlement(Settlement.CurrentSettlement);
								mapEventParty2.Party.MobileParty.Ai.RecalculateShortTermAi();
							}
						}
						GameMenu.ActivateGameMenu("menu_siege_strategies");
					}
				}
				this._campaignBattleResult = null;
				this._stateHandled = true;
			}
			Debug.Print("[PlayerEncounter.ContinueBattle End]", 0, Debug.DebugColor.White, 17592186044416UL);
		}

		// Token: 0x060023D9 RID: 9177 RVA: 0x000975FC File Offset: 0x000957FC
		private void DoWait()
		{
			MBTextManager.SetTextVariable("PARTY", MapEvent.PlayerMapEvent.GetLeaderParty(PartyBase.MainParty.OpponentSide).Name, false);
			if (!PlayerEncounter.EncounteredPartySurrendered)
			{
				MBTextManager.SetTextVariable("ENCOUNTER_TEXT", GameTexts.FindText("str_you_have_encountered_PARTY", null), true);
			}
			else
			{
				MBTextManager.SetTextVariable("ENCOUNTER_TEXT", GameTexts.FindText("str_you_have_encountered_PARTY_they_surrendered", null), true);
			}
			if (this.CheckIfBattleShouldContinueAfterBattleMission())
			{
				this.ContinueBattle();
				return;
			}
			if (this._mapEvent != null && this._mapEvent.IsSiegeAssault)
			{
				this._mapEvent.CheckIfOneSideHasLost();
				this._campaignBattleResult = CampaignBattleResult.GetResult(this._mapEvent.BattleState, false);
			}
			if (this._campaignBattleResult != null && this._campaignBattleResult.BattleResolved)
			{
				if (this._campaignBattleResult.PlayerVictory)
				{
					MapEvent mapEvent = this._mapEvent;
					if (mapEvent != null)
					{
						mapEvent.SetOverrideWinner(PartyBase.MainParty.Side);
					}
				}
				else
				{
					bool flag = true;
					if (this._mapEvent != null && this._mapEvent.IsHideoutBattle)
					{
						this._mapEvent.MapEventSettlement.Hideout.UpdateNextPossibleAttackTime();
						if (this._mapEvent.GetMapEventSide(this.PlayerSide).RecalculateMemberCountOfSide() > 0)
						{
							flag = false;
						}
					}
					if (flag)
					{
						MapEvent mapEvent2 = this._mapEvent;
						if (mapEvent2 != null)
						{
							mapEvent2.SetOverrideWinner(PartyBase.MainParty.OpponentSide);
						}
					}
				}
				this.EncounterState = PlayerEncounterState.PrepareResults;
				return;
			}
			if (this.BattleSimulation != null && (PlayerEncounter.BattleState == BattleState.AttackerVictory || PlayerEncounter.BattleState == BattleState.DefenderVictory))
			{
				if (this._mapEvent.WinningSide == this.PlayerSide)
				{
					PlayerEncounter.EnemySurrender = true;
				}
				else
				{
					bool totalManCount = MobileParty.MainParty.MemberRoster.TotalManCount != 0;
					int totalWounded = MobileParty.MainParty.MemberRoster.TotalWounded;
					if ((totalManCount ? 1 : 0) - totalWounded == 0)
					{
						PlayerEncounter.PlayerSurrender = true;
					}
				}
				this.EncounterState = PlayerEncounterState.PrepareResults;
				return;
			}
			if (this.BattleSimulation != null && this.BattleSimulation.IsSimulationFinished)
			{
				MapEvent mapEvent3 = this._mapEvent;
				if (((mapEvent3 != null) ? mapEvent3.MapEventSettlement : null) != null && PlayerEncounter.BattleState == BattleState.None && this._mapEvent.IsSiegeAssault && PlayerSiege.PlayerSiegeEvent != null)
				{
					this._stateHandled = true;
					PlayerSiege.PlayerSiegeEvent.BreakSiegeEngine(PlayerSiege.PlayerSiegeEvent.GetSiegeEventSide(this._mapEvent.PlayerSide), DefaultSiegeEngineTypes.Preparations);
					return;
				}
			}
			if (this._mapEvent != null && (!this._mapEvent.IsRaid || PlayerEncounter.PlayerSurrender) && this._mapEvent.HasWinner)
			{
				this.EncounterState = PlayerEncounterState.PrepareResults;
				return;
			}
			this._stateHandled = true;
			if (this.IsJoinedBattle && Campaign.Current.CurrentMenuContext != null && Campaign.Current.CurrentMenuContext.GameMenu.StringId == "join_encounter")
			{
				PlayerEncounter.LeaveBattle();
			}
			if (this._mapEvent != null && this._mapEvent.IsHideoutBattle)
			{
				this._mapEvent.MapEventSettlement.Hideout.UpdateNextPossibleAttackTime();
			}
		}

		// Token: 0x060023DA RID: 9178 RVA: 0x000978CC File Offset: 0x00095ACC
		public static bool CheckIfLeadingAvaliable()
		{
			bool flag = Hero.MainHero.PartyBelongedTo != null && !Hero.MainHero.IsWounded;
			bool flag2 = Hero.MainHero.PartyBelongedTo != null && Hero.MainHero.PartyBelongedTo.Army != null && Hero.MainHero.PartyBelongedTo.Army.ArmyOwner != Hero.MainHero;
			bool flag3 = false;
			foreach (MapEventParty mapEventParty in MobileParty.MainParty.MapEvent.PartiesOnSide(MobileParty.MainParty.MapEvent.PlayerSide))
			{
				if (mapEventParty.Party != MobileParty.MainParty.Party && mapEventParty.Party.LeaderHero != null && mapEventParty.Party.LeaderHero.Clan.Renown > Clan.PlayerClan.Renown)
				{
					flag3 = true;
					break;
				}
			}
			return flag && (flag2 || flag3);
		}

		// Token: 0x060023DB RID: 9179 RVA: 0x000979E4 File Offset: 0x00095BE4
		public static Hero GetLeadingHero()
		{
			if (Hero.MainHero.PartyBelongedTo != null && Hero.MainHero.PartyBelongedTo.Army != null)
			{
				return MobileParty.MainParty.Army.ArmyOwner;
			}
			foreach (MapEventParty mapEventParty in MobileParty.MainParty.MapEvent.PartiesOnSide(MobileParty.MainParty.MapEvent.PlayerSide))
			{
				if (mapEventParty.Party != MobileParty.MainParty.Party && mapEventParty.Party.LeaderHero != null && mapEventParty.Party.LeaderHero.Clan.Renown > Clan.PlayerClan.Renown)
				{
					return mapEventParty.Party.LeaderHero;
				}
			}
			return Hero.MainHero;
		}

		// Token: 0x060023DC RID: 9180 RVA: 0x00097AD0 File Offset: 0x00095CD0
		private void DoPrepareResults()
		{
			this._mapEvent.CalculateBattleResults(false);
			this.EncounterState = PlayerEncounterState.ApplyResults;
		}

		// Token: 0x060023DD RID: 9181 RVA: 0x00097AE5 File Offset: 0x00095CE5
		public static void SetPlayerVictorious()
		{
			PlayerEncounter.Current.SetPlayerVictoriousInternal();
		}

		// Token: 0x060023DE RID: 9182 RVA: 0x00097AF1 File Offset: 0x00095CF1
		public void SetIsSallyOutAmbush(bool value)
		{
			PlayerEncounter.Current._isSallyOutAmbush = value;
		}

		// Token: 0x060023DF RID: 9183 RVA: 0x00097AFE File Offset: 0x00095CFE
		public void SetPlayerSiegeInterruptedByEnemyDefection()
		{
			PlayerEncounter.Current._isSiegeInterruptedByEnemyDefection = true;
		}

		// Token: 0x060023E0 RID: 9184 RVA: 0x00097B0B File Offset: 0x00095D0B
		public void SetPlayerEncounterInterruptedByPeace()
		{
			PlayerEncounter.Current._isPlayerEncounterInterruptedByPeace = true;
			if (this._mapEvent != null)
			{
				this._mapEvent.DiplomaticallyFinished = true;
			}
		}

		// Token: 0x060023E1 RID: 9185 RVA: 0x00097B2C File Offset: 0x00095D2C
		public void ResetPlayerEncounterInterruptedByPeace()
		{
			PlayerEncounter.Current._isPlayerEncounterInterruptedByPeace = false;
		}

		// Token: 0x060023E2 RID: 9186 RVA: 0x00097B39 File Offset: 0x00095D39
		private void SetPlayerVictoriousInternal()
		{
			if (this.PlayerSide == BattleSideEnum.Attacker || this.PlayerSide == BattleSideEnum.Defender)
			{
				this._mapEvent.SetOverrideWinner(this.PlayerSide);
			}
		}

		// Token: 0x060023E3 RID: 9187 RVA: 0x00097B5D File Offset: 0x00095D5D
		public static void SetPlayerSiegeContinueWithDefenderPullBack()
		{
			PlayerEncounter.Current._mapEvent.SetDefenderPulledBack();
		}

		// Token: 0x060023E4 RID: 9188 RVA: 0x00097B70 File Offset: 0x00095D70
		private void DoApplyResults()
		{
			CampaignEventDispatcher.Instance.OnPlayerBattleEnd(this._mapEvent);
			this._mapEvent.ApplyBattleResults();
			if (this._mapEvent.WinningSide == PartyBase.MainParty.Side)
			{
				this.EncounterState = PlayerEncounterState.PlayerVictory;
				return;
			}
			if (this._mapEvent.DefeatedSide == PartyBase.MainParty.Side)
			{
				this.EncounterState = PlayerEncounterState.PlayerTotalDefeat;
				return;
			}
			this.EncounterState = PlayerEncounterState.End;
		}

		// Token: 0x060023E5 RID: 9189 RVA: 0x00097BDE File Offset: 0x00095DDE
		public static void StartAttackMission()
		{
			PlayerEncounter.Current._campaignBattleResult = new CampaignBattleResult();
		}

		// Token: 0x060023E6 RID: 9190 RVA: 0x00097BF0 File Offset: 0x00095DF0
		private void DoPlayerVictory()
		{
			if (this._helpedHeroes == null)
			{
				this._helpedHeroes = new List<Hero>();
				foreach (PartyBase partyBase in MapEvent.PlayerMapEvent.InvolvedParties)
				{
					if (partyBase != PartyBase.MainParty && partyBase.Side == PartyBase.MainParty.Side && partyBase.Owner != null && partyBase.Owner != Hero.MainHero && partyBase.LeaderHero != null && (MapEvent.PlayerMapEvent.AttackerSide.LeaderParty == partyBase || MapEvent.PlayerMapEvent.DefenderSide.LeaderParty == partyBase) && partyBase.MobileParty != null && (partyBase.MobileParty.Army == null || partyBase.MobileParty.Army != MobileParty.MainParty.Army) && Campaign.Current.Models.BattleRewardModel.GetPlayerGainedRelationAmount(MapEvent.PlayerMapEvent, partyBase.LeaderHero) > 0)
					{
						this._helpedHeroes.Add(partyBase.LeaderHero);
					}
				}
				return;
			}
			if (this._helpedHeroes.Count > 0)
			{
				if (this._helpedHeroes[0].DeathMark == KillCharacterAction.KillCharacterActionDetail.None)
				{
					Campaign.Current.CurrentConversationContext = ConversationContext.PartyEncounter;
					ConversationCharacterData conversationCharacterData = new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, false, false, false, false, false, false);
					ConversationCharacterData conversationCharacterData2 = new ConversationCharacterData(this._helpedHeroes[0].CharacterObject, this._helpedHeroes[0].PartyBelongedTo.Party, false, false, false, false, false, false);
					CampaignMapConversation.OpenConversation(conversationCharacterData, conversationCharacterData2);
				}
				this._helpedHeroes.RemoveAt(0);
				this._stateHandled = true;
				return;
			}
			this.EncounterState = PlayerEncounterState.CaptureHeroes;
		}

		// Token: 0x060023E7 RID: 9191 RVA: 0x00097DBC File Offset: 0x00095FBC
		private void DoPlayerDefeat()
		{
			bool playerSurrender = PlayerEncounter.PlayerSurrender;
			PlayerEncounter.Finish(true);
			if (MobileParty.MainParty.BesiegerCamp != null)
			{
				if (MobileParty.MainParty.BesiegerCamp != null)
				{
					MobileParty.MainParty.BesiegerCamp = null;
				}
				else
				{
					PlayerSiege.ClosePlayerSiege();
				}
			}
			if (Hero.MainHero.DeathMark != KillCharacterAction.KillCharacterActionDetail.DiedInBattle)
			{
				GameMenu.ActivateGameMenu(playerSurrender ? "taken_prisoner" : "defeated_and_taken_prisoner");
			}
			this._stateHandled = true;
		}

		// Token: 0x060023E8 RID: 9192 RVA: 0x00097E28 File Offset: 0x00096028
		private void DoCaptureHeroes()
		{
			TroopRoster prisonerRosterReceivingLootShare = this._mapEvent.GetPrisonerRosterReceivingLootShare(PartyBase.MainParty);
			if (this._capturedHeroes == null)
			{
				this._capturedHeroes = prisonerRosterReceivingLootShare.RemoveIf((TroopRosterElement lordElement) => lordElement.Character.IsHero).ToList<TroopRosterElement>();
			}
			if (this._capturedHeroes.Count > 0)
			{
				TroopRosterElement troopRosterElement = this._capturedHeroes[this._capturedHeroes.Count - 1];
				Campaign.Current.CurrentConversationContext = ConversationContext.CapturedLord;
				ConversationCharacterData conversationCharacterData = new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, false, false, false, false, false, false);
				ConversationCharacterData conversationCharacterData2 = new ConversationCharacterData(troopRosterElement.Character, null, true, true, true, false, false, false);
				if (PlayerEncounter.InsideSettlement && Settlement.CurrentSettlement.IsHideout)
				{
					CampaignMission.OpenConversationMission(conversationCharacterData, conversationCharacterData2, "", "");
				}
				else
				{
					CampaignMapConversation.OpenConversation(conversationCharacterData, conversationCharacterData2);
				}
				Campaign.Current.ConversationManager.ConversationEndOneShot += delegate
				{
					this._capturedHeroes.RemoveRange(this._capturedHeroes.Count - 1, 1);
				};
				this._stateHandled = true;
				return;
			}
			this.EncounterState = PlayerEncounterState.FreeHeroes;
		}

		// Token: 0x060023E9 RID: 9193 RVA: 0x00097F38 File Offset: 0x00096138
		private void DoFreeHeroes()
		{
			TroopRoster memberRosterReceivingLootShare = this._mapEvent.GetMemberRosterReceivingLootShare(PartyBase.MainParty);
			if (this._freedHeroes == null)
			{
				this._freedHeroes = memberRosterReceivingLootShare.RemoveIf((TroopRosterElement lordElement) => lordElement.Character.IsHero).ToList<TroopRosterElement>();
			}
			if (this._freedHeroes.Count > 0)
			{
				TroopRosterElement troopRosterElement = this._freedHeroes[this._freedHeroes.Count - 1];
				Campaign.Current.CurrentConversationContext = ConversationContext.FreedHero;
				ConversationCharacterData conversationCharacterData = new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, false, false, false, false, false, false);
				ConversationCharacterData conversationCharacterData2 = new ConversationCharacterData(troopRosterElement.Character, null, true, true, false, false, false, false);
				CampaignMapConversation.OpenConversation(conversationCharacterData, conversationCharacterData2);
				Campaign.Current.ConversationManager.ConversationEndOneShot += delegate
				{
					this._freedHeroes.RemoveRange(this._freedHeroes.Count - 1, 1);
				};
				this._stateHandled = true;
				return;
			}
			this.EncounterState = PlayerEncounterState.LootParty;
		}

		// Token: 0x060023EA RID: 9194 RVA: 0x0009801C File Offset: 0x0009621C
		private void DoLootInventory()
		{
			ItemRoster itemRosterReceivingLootShare = this._mapEvent.GetItemRosterReceivingLootShare(PartyBase.MainParty);
			if (itemRosterReceivingLootShare.Count > 0)
			{
				InventoryManager.OpenScreenAsLoot(new Dictionary<PartyBase, ItemRoster> { 
				{
					PartyBase.MainParty,
					itemRosterReceivingLootShare
				} });
				this._stateHandled = true;
			}
			this.EncounterState = PlayerEncounterState.End;
		}

		// Token: 0x060023EB RID: 9195 RVA: 0x00098068 File Offset: 0x00096268
		private void DoLootParty()
		{
			TroopRoster memberRosterReceivingLootShare = this._mapEvent.GetMemberRosterReceivingLootShare(PartyBase.MainParty);
			TroopRoster prisonerRosterReceivingLootShare = this._mapEvent.GetPrisonerRosterReceivingLootShare(PartyBase.MainParty);
			if (memberRosterReceivingLootShare.Count > 0 || prisonerRosterReceivingLootShare.Count > 0)
			{
				PartyScreenManager.OpenScreenAsLoot(memberRosterReceivingLootShare, prisonerRosterReceivingLootShare, TextObject.Empty, memberRosterReceivingLootShare.TotalManCount + prisonerRosterReceivingLootShare.TotalManCount, null);
				this._stateHandled = true;
			}
			this.EncounterState = PlayerEncounterState.LootInventory;
		}

		// Token: 0x060023EC RID: 9196 RVA: 0x000980D2 File Offset: 0x000962D2
		public static void SacrificeTroops(int num, out TroopRoster losses, out ItemRoster lostBaggage)
		{
			PlayerEncounter.Current.SacrificeTroopsImp(num, out losses, out lostBaggage);
		}

		// Token: 0x060023ED RID: 9197 RVA: 0x000980E1 File Offset: 0x000962E1
		private void SacrificeTroopsImp(int num, out TroopRoster losses, out ItemRoster lostBaggage)
		{
			losses = new TroopRoster(null);
			lostBaggage = new ItemRoster();
			this._mapEvent.GetMapEventSide(this.PlayerSide).MakeReadyForSimulation(null, -1);
			this.RemoveRandomTroops(num, losses);
			this.RemoveRandomItems(lostBaggage);
		}

		// Token: 0x060023EE RID: 9198 RVA: 0x0009811C File Offset: 0x0009631C
		private void RemoveRandomItems(ItemRoster lostBaggage)
		{
			foreach (ItemRosterElement itemRosterElement in new ItemRoster(PartyBase.MainParty.ItemRoster))
			{
				if (!itemRosterElement.EquipmentElement.Item.NotMerchandise)
				{
					int num = MBRandom.RoundRandomized((float)itemRosterElement.Amount * 0.15f);
					PartyBase.MainParty.ItemRoster.AddToCounts(itemRosterElement.EquipmentElement, -num);
					lostBaggage.AddToCounts(itemRosterElement.EquipmentElement, num);
				}
			}
		}

		// Token: 0x060023EF RID: 9199 RVA: 0x000981C0 File Offset: 0x000963C0
		public void RemoveRandomTroops(int num, TroopRoster sacrifiedTroops)
		{
			int num2 = MobileParty.MainParty.Party.NumberOfRegularMembers;
			if (MobileParty.MainParty.Army != null)
			{
				foreach (MobileParty mobileParty in MobileParty.MainParty.Army.LeaderParty.AttachedParties)
				{
					num2 += mobileParty.Party.NumberOfRegularMembers;
				}
			}
			float num3 = (float)num / (float)num2;
			this.SacrifaceTroopsWithRatio(MobileParty.MainParty, num3, sacrifiedTroops);
			if (MobileParty.MainParty.Army != null)
			{
				foreach (MobileParty mobileParty2 in MobileParty.MainParty.Army.LeaderParty.AttachedParties)
				{
					this.SacrifaceTroopsWithRatio(mobileParty2, num3, sacrifiedTroops);
				}
			}
		}

		// Token: 0x060023F0 RID: 9200 RVA: 0x000982B8 File Offset: 0x000964B8
		private void SacrifaceTroopsWithRatio(MobileParty mobileParty, float sacrifaceRatio, TroopRoster sacrifiedTroops)
		{
			int num = MBRandom.RoundRandomized((float)mobileParty.Party.NumberOfRegularMembers * sacrifaceRatio);
			for (int i = 0; i < num; i++)
			{
				float num2 = 100f;
				TroopRosterElement troopRosterElement = mobileParty.Party.MemberRoster.GetTroopRoster().FirstOrDefault<TroopRosterElement>();
				foreach (TroopRosterElement troopRosterElement2 in mobileParty.Party.MemberRoster.GetTroopRoster())
				{
					float num3 = (float)troopRosterElement2.Character.Level - ((troopRosterElement2.WoundedNumber > 0) ? 0.5f : 0f) - MBRandom.RandomFloat * 0.5f;
					if (!troopRosterElement2.Character.IsHero && num3 < num2 && troopRosterElement2.Number > 0)
					{
						num2 = num3;
						troopRosterElement = troopRosterElement2;
					}
				}
				mobileParty.MemberRoster.AddToCounts(troopRosterElement.Character, -1, false, (troopRosterElement.WoundedNumber > 0) ? (-1) : 0, 0, true, -1);
				sacrifiedTroops.AddToCounts(troopRosterElement.Character, 1, false, 0, 0, true, -1);
			}
		}

		// Token: 0x060023F1 RID: 9201 RVA: 0x000983E0 File Offset: 0x000965E0
		private void DoEnd()
		{
			MapEvent mapEvent = this._mapEvent;
			object obj = mapEvent != null && mapEvent.IsSiegeAssault;
			bool isHideoutBattle = this._mapEvent.IsHideoutBattle;
			object obj2 = obj;
			bool flag = obj2 != null && MobileParty.MainParty.MapEvent != null && MobileParty.MainParty.MapEvent == this._mapEvent;
			bool flag2 = MobileParty.MainParty.MapEvent != null && this.PlayerSide == BattleSideEnum.Attacker;
			bool isRaid = this._mapEvent.IsRaid;
			bool isForcingVolunteers = this._mapEvent.IsForcingVolunteers;
			bool isForcingSupplies = this._mapEvent.IsForcingSupplies;
			bool flag3 = this.BattleSimulation != null && this._mapEvent.WinningSide != this.PlayerSide;
			Settlement mapEventSettlement = this._mapEvent.MapEventSettlement;
			BattleState battleState = this._mapEvent.BattleState;
			this._stateHandled = true;
			if (!flag3)
			{
				PlayerEncounter.Finish(true);
			}
			else
			{
				PlayerEncounter.Battle.ResetBattleResults();
			}
			if (obj2 != null)
			{
				if (mapEventSettlement != null)
				{
					if (flag)
					{
						if (flag2)
						{
							mapEventSettlement.SettlementComponent.IsTaken = true;
						}
						EncounterManager.StartSettlementEncounter((MobileParty.MainParty.Army != null) ? MobileParty.MainParty.Army.LeaderParty : MobileParty.MainParty, mapEventSettlement);
						return;
					}
					if (PlayerEncounter.InsideSettlement)
					{
						PlayerEncounter.LeaveSettlement();
						return;
					}
				}
			}
			else if (isRaid || isForcingVolunteers || isForcingSupplies)
			{
				if ((!this._attackerParty.IsMobile || this._attackerParty.MobileParty.Army == null || this._attackerParty.MobileParty.Army.LeaderParty == this._attackerParty.MobileParty) && flag2 && this._attackerParty == MobileParty.MainParty.Party)
				{
					EncounterManager.StartSettlementEncounter(MobileParty.MainParty, mapEventSettlement);
					PlayerEncounter.Current.ForceSupplies = isForcingSupplies;
					PlayerEncounter.Current.ForceVolunteers = isForcingVolunteers;
					PlayerEncounter.Current.ForceRaid = isRaid;
					BeHostileAction.ApplyEncounterHostileAction(PartyBase.MainParty, Settlement.CurrentSettlement.Party);
					if (isForcingSupplies)
					{
						GameMenu.SwitchToMenu("force_supplies_village");
						return;
					}
					if (isForcingVolunteers)
					{
						GameMenu.SwitchToMenu("force_volunteers_village");
						return;
					}
					if (isRaid)
					{
						if (PlayerEncounter.InsideSettlement)
						{
							LeaveSettlementAction.ApplyForParty(MobileParty.MainParty);
						}
						PlayerEncounter.StartBattle();
						GameMenu.SwitchToMenu("raiding_village");
						PlayerEncounter.Current.ForceRaid = false;
						PlayerEncounter.Current.ForceVolunteers = false;
						PlayerEncounter.Current.ForceSupplies = false;
						return;
					}
				}
			}
			else if (isHideoutBattle)
			{
				if (mapEventSettlement != null)
				{
					if (battleState == BattleState.AttackerVictory)
					{
						if (mapEventSettlement.Parties.Count > 0)
						{
							foreach (MobileParty mobileParty in new List<MobileParty>(mapEventSettlement.Parties))
							{
								LeaveSettlementAction.ApplyForParty(mobileParty);
								mobileParty.Ai.SetDoNotAttackMainParty(3);
							}
						}
						mapEventSettlement.Hideout.IsSpotted = false;
						mapEventSettlement.IsVisible = false;
						return;
					}
					if (battleState == BattleState.None)
					{
						EncounterManager.StartSettlementEncounter(MobileParty.MainParty, mapEventSettlement);
						GameMenu.SwitchToMenu("hideout_after_defeated_and_saved");
						return;
					}
				}
			}
			else if (flag3)
			{
				this.EncounterState = PlayerEncounterState.Begin;
				GameMenu.SwitchToMenu("encounter");
			}
		}

		// Token: 0x060023F2 RID: 9202 RVA: 0x000986F4 File Offset: 0x000968F4
		public bool CheckIfBattleShouldContinueAfterBattleMission()
		{
			if (this._doesBattleContinue || this._campaignBattleResult != null)
			{
				this._doesBattleContinue = MapEventHelper.CheckIfBattleShouldContinueAfterBattleMission(this._mapEvent, this._campaignBattleResult);
			}
			return this._doesBattleContinue;
		}

		// Token: 0x060023F3 RID: 9203 RVA: 0x00098724 File Offset: 0x00096924
		public void FinalizeBattle()
		{
			if (this._mapEvent != null)
			{
				if (this._mapEvent.HasWinner || this._mapEvent.DiplomaticallyFinished || (this._mapEvent.IsRaid && this._mapEvent.MapEventSettlement.SettlementHitPoints.ApproximatelyEqualsTo(0f, 1E-05f)))
				{
					MobileParty mobileParty = this._mapEvent.AttackerSide.LeaderParty.MobileParty;
					bool flag = this._mapEvent.IsRaid && this._mapEvent.BattleState == BattleState.AttackerVictory && !this._mapEvent.MapEventSettlement.SettlementHitPoints.ApproximatelyEqualsTo(0f, 1E-05f);
					Settlement mapEventSettlement = this._mapEvent.MapEventSettlement;
					this._mapEvent.FinalizeEvent();
					this._mapEvent = null;
					if (mobileParty != MobileParty.MainParty && flag)
					{
						mobileParty.Ai.SetMoveRaidSettlement(mapEventSettlement);
						mobileParty.Ai.RecalculateShortTermAi();
						return;
					}
				}
				else
				{
					PlayerEncounter.LeaveBattle();
				}
			}
		}

		// Token: 0x060023F4 RID: 9204 RVA: 0x0009882C File Offset: 0x00096A2C
		public void FindNonAttachedNpcPartiesWhoWillJoinEvent(ref List<MobileParty> partiesToJoinPlayerSide, ref List<MobileParty> partiesToJoinEnemySide)
		{
			LocatableSearchData<MobileParty> locatableSearchData = MobileParty.StartFindingLocatablesAroundPosition(MobileParty.MainParty.Position2D, 4f);
			MobileParty mobileParty = MobileParty.FindNextLocatable(ref locatableSearchData);
			List<MobileParty> list = new List<MobileParty>();
			List<MobileParty> list2 = new List<MobileParty>();
			while (mobileParty != null)
			{
				if (mobileParty != MobileParty.MainParty && mobileParty.MapEvent == null && mobileParty.SiegeEvent == null && mobileParty.CurrentSettlement == null && mobileParty.AttachedTo == null && (mobileParty.IsLordParty || mobileParty.IsBandit || mobileParty.ShouldJoinPlayerBattles))
				{
					if (!mobileParty.MapFaction.IsAtWarWith(MobileParty.MainParty.MapFaction) && mobileParty.MapFaction.IsAtWarWith(PlayerEncounter.EncounteredParty.MapFaction))
					{
						list.Add(mobileParty);
					}
					if (mobileParty.MapFaction.IsAtWarWith(MobileParty.MainParty.MapFaction) && !mobileParty.MapFaction.IsAtWarWith(PlayerEncounter.EncounteredParty.MapFaction))
					{
						list2.Add(mobileParty);
					}
				}
				mobileParty = MobileParty.FindNextLocatable(ref locatableSearchData);
			}
			if (!list2.AnyQ((MobileParty t) => t.ShouldBeIgnored))
			{
				if (!partiesToJoinEnemySide.AnyQ((MobileParty t) => t.ShouldBeIgnored))
				{
					goto IL_160;
				}
			}
			Debug.Print("Ally parties wont join player encounter since there is an ignored party in enemy side", 0, Debug.DebugColor.White, 17592186044416UL);
			list.Clear();
			IL_160:
			if (!list.AnyQ((MobileParty t) => t.ShouldBeIgnored))
			{
				if (!partiesToJoinPlayerSide.AnyQ((MobileParty t) => t != MobileParty.MainParty && t.ShouldBeIgnored))
				{
					goto IL_1CB;
				}
			}
			Debug.Print("Enemy parties wont join player encounter since there is an ignored party in ally side", 0, Debug.DebugColor.White, 17592186044416UL);
			list2.Clear();
			IL_1CB:
			partiesToJoinPlayerSide.AddRange(list.Except(partiesToJoinPlayerSide));
			partiesToJoinEnemySide.AddRange(list2.Except(partiesToJoinEnemySide));
		}

		// Token: 0x060023F5 RID: 9205 RVA: 0x00098A24 File Offset: 0x00096C24
		public void FindAllNpcPartiesWhoWillJoinEvent(ref List<MobileParty> partiesToJoinPlayerSide, ref List<MobileParty> partiesToJoinEnemySide)
		{
			this.FindNonAttachedNpcPartiesWhoWillJoinEvent(ref partiesToJoinPlayerSide, ref partiesToJoinEnemySide);
			foreach (MobileParty mobileParty in partiesToJoinPlayerSide.ToList<MobileParty>())
			{
				partiesToJoinPlayerSide.AddRange(mobileParty.AttachedParties.Except(partiesToJoinPlayerSide));
			}
			foreach (MobileParty mobileParty2 in partiesToJoinEnemySide.ToList<MobileParty>())
			{
				partiesToJoinEnemySide.AddRange(mobileParty2.AttachedParties.Except(partiesToJoinEnemySide));
			}
		}

		// Token: 0x060023F6 RID: 9206 RVA: 0x00098AE0 File Offset: 0x00096CE0
		public static void EnterSettlement()
		{
			Settlement encounterSettlement = PlayerEncounter.EncounterSettlement;
			PlayerEncounter.CreateLocationEncounter(encounterSettlement);
			EnterSettlementAction.ApplyForParty(MobileParty.MainParty, encounterSettlement);
		}

		// Token: 0x060023F7 RID: 9207 RVA: 0x00098B04 File Offset: 0x00096D04
		private static void CreateLocationEncounter(Settlement settlement)
		{
			if (settlement.IsTown)
			{
				PlayerEncounter.LocationEncounter = new TownEncounter(settlement);
				return;
			}
			if (settlement.IsVillage)
			{
				PlayerEncounter.LocationEncounter = new VillageEncounter(settlement);
				return;
			}
			if (settlement.IsCastle)
			{
				PlayerEncounter.LocationEncounter = new CastleEncounter(settlement);
			}
		}

		// Token: 0x060023F8 RID: 9208 RVA: 0x00098B44 File Offset: 0x00096D44
		public static void LeaveBattle()
		{
			MapEvent playerMapEvent = MapEvent.PlayerMapEvent;
			bool flag = false;
			if (playerMapEvent != null)
			{
				int numberOfInvolvedMen = playerMapEvent.GetNumberOfInvolvedMen(PartyBase.MainParty.Side);
				Army playerArmy = MobileParty.MainParty.Army;
				if ((PartyBase.MainParty.MapEventSide.LeaderParty != PartyBase.MainParty && PartyBase.MainParty.MapEventSide.Parties.Any(delegate(MapEventParty p)
				{
					if (!p.IsNpcParty)
					{
						return false;
					}
					if (playerArmy != null)
					{
						MobileParty mobileParty = p.Party.MobileParty;
						return ((mobileParty != null) ? mobileParty.Army : null) != playerArmy;
					}
					return true;
				})) || (PartyBase.MainParty.MapEvent.IsSallyOut && Campaign.Current.Models.EncounterModel.GetLeaderOfMapEvent(PartyBase.MainParty.MapEvent, PartyBase.MainParty.MapEventSide.MissionSide) != Hero.MainHero))
				{
					PartyBase.MainParty.MapEventSide = null;
				}
				else
				{
					playerMapEvent.FinalizeEvent();
				}
				flag = numberOfInvolvedMen > PartyBase.MainParty.NumberOfHealthyMembers && playerMapEvent.AttackerSide.LeaderParty != PartyBase.MainParty && playerMapEvent.DefenderSide.LeaderParty != PartyBase.MainParty;
			}
			if (PlayerEncounter.CurrentBattleSimulation != null)
			{
				MapState mapState = Game.Current.GameStateManager.LastOrDefault<MapState>();
				if (mapState != null && mapState.IsSimulationActive)
				{
					mapState.EndBattleSimulation();
				}
				PlayerEncounter.Current.BattleSimulation = null;
				PlayerEncounter.Current._mapEvent.BattleObserver = null;
			}
			PlayerEncounter.Current.IsJoinedBattle = false;
			PlayerEncounter.Current._mapEvent = null;
			if (flag && !playerMapEvent.HasWinner)
			{
				MapEvent mapEvent = playerMapEvent;
				BattleSimulation battleSimulation = PlayerEncounter.Current.BattleSimulation;
				mapEvent.SimulateBattleSetup((battleSimulation != null) ? battleSimulation.SelectedTroops : null);
			}
		}

		// Token: 0x060023F9 RID: 9209 RVA: 0x00098CCC File Offset: 0x00096ECC
		public static void LeaveSettlement()
		{
			LeaveSettlementAction.ApplyForParty(MobileParty.MainParty);
			PlayerEncounter.LocationEncounter = null;
			PartyBase.MainParty.Visuals.SetMapIconAsDirty();
		}

		// Token: 0x060023FA RID: 9210 RVA: 0x00098CED File Offset: 0x00096EED
		public static void InitSimulation(FlattenedTroopRoster selectedTroopsForPlayerSide, FlattenedTroopRoster selectedTroopsForOtherSide)
		{
			if (PlayerEncounter.Current == null)
			{
				return;
			}
			PlayerEncounter.Current.BattleSimulation = new BattleSimulation(selectedTroopsForPlayerSide, selectedTroopsForOtherSide);
		}

		// Token: 0x060023FB RID: 9211 RVA: 0x00098D08 File Offset: 0x00096F08
		public void InterruptEncounter(string encounterInterrupedType)
		{
			GameState activeState = Game.Current.GameStateManager.ActiveState;
			if (MapEvent.PlayerMapEvent != null)
			{
				PlayerEncounter.LeaveBattle();
			}
			GameMenu.ActivateGameMenu(encounterInterrupedType);
		}

		// Token: 0x060023FC RID: 9212 RVA: 0x00098D2C File Offset: 0x00096F2C
		public static void StartVillageBattleMission()
		{
			Settlement mapEventSettlement = PlayerEncounter.Battle.MapEventSettlement;
			if (BanditLoopTestStatic.IsBanditLoopTest)
			{
				CampaignMission.OpenBattleMission("empire_village_b");
				return;
			}
			int num = (mapEventSettlement.IsTown ? mapEventSettlement.Town.GetWallLevel() : 1);
			CampaignMission.OpenBattleMission(mapEventSettlement.LocationComplex.GetScene("village_center", num));
		}

		// Token: 0x060023FD RID: 9213 RVA: 0x00098D88 File Offset: 0x00096F88
		public static void StartCombatMissionWithDialogueInTownCenter(CharacterObject characterToTalkTo, CharacterObject allyTroopsWithFixedTeam)
		{
			int wallLevel = Settlement.CurrentSettlement.Town.GetWallLevel();
			CampaignMission.OpenCombatMissionWithDialogue(Settlement.CurrentSettlement.LocationComplex.GetScene("center", wallLevel), characterToTalkTo, allyTroopsWithFixedTeam, wallLevel);
		}

		// Token: 0x060023FE RID: 9214 RVA: 0x00098DC3 File Offset: 0x00096FC3
		public static void StartHostileAction()
		{
			PlayerEncounter.Current.StartHostileActionInternal();
		}

		// Token: 0x060023FF RID: 9215 RVA: 0x00098DCF File Offset: 0x00096FCF
		private void StartHostileActionInternal()
		{
			if (this._mapEvent != null)
			{
				if (PlayerEncounter.InsideSettlement)
				{
					PlayerEncounter.LeaveSettlement();
				}
				PlayerEncounter.Update();
			}
		}

		// Token: 0x06002400 RID: 9216 RVA: 0x00098DEC File Offset: 0x00096FEC
		public void FinishRaid()
		{
			Settlement mapEventSettlement = PlayerEncounter.Battle.MapEventSettlement;
			bool diplomaticallyFinished = PlayerEncounter.Battle.DiplomaticallyFinished;
			PartyBase leaderParty = PlayerEncounter.Battle.AttackerSide.LeaderParty;
			PlayerEncounter.Finish(true);
			if (!diplomaticallyFinished)
			{
				if (leaderParty == MobileParty.MainParty.Party)
				{
					GameMenu.ActivateGameMenu("village_player_raid_ended");
					return;
				}
				GameMenu.ActivateGameMenu("village_raid_ended_leaded_by_someone_else");
			}
		}

		// Token: 0x06002401 RID: 9217 RVA: 0x00098E48 File Offset: 0x00097048
		public static void GetBattleRewards(out float renownChange, out float influenceChange, out float moraleChange, out float goldChange, out float playerEarnedLootPercentage, ref ExplainedNumber renownExplainedNumber, ref ExplainedNumber influenceExplainedNumber, ref ExplainedNumber moraleExplainedNumber)
		{
			if (PlayerEncounter.Current == null)
			{
				renownChange = 0f;
				influenceChange = 0f;
				moraleChange = 0f;
				goldChange = 0f;
				playerEarnedLootPercentage = 0f;
				return;
			}
			PlayerEncounter.Current.GetBattleRewardsInternal(out renownChange, out influenceChange, out moraleChange, out goldChange, out playerEarnedLootPercentage, ref renownExplainedNumber, ref influenceExplainedNumber, ref moraleExplainedNumber);
		}

		// Token: 0x06002402 RID: 9218 RVA: 0x00098E98 File Offset: 0x00097098
		private void GetBattleRewardsInternal(out float renownChange, out float influenceChange, out float moraleChange, out float goldChange, out float playerEarnedLootPercentage, ref ExplainedNumber renownExplainedNumber, ref ExplainedNumber influenceExplainedNumber, ref ExplainedNumber moraleExplainedNumber)
		{
			MapEventResultExplainer battleResultExplainers = this._mapEvent.BattleResultExplainers;
			this._mapEvent.GetBattleRewards(PartyBase.MainParty, out renownChange, out influenceChange, out moraleChange, out goldChange, out playerEarnedLootPercentage);
			if (battleResultExplainers != null)
			{
				renownExplainedNumber = battleResultExplainers.RenownExplainedNumber;
				influenceExplainedNumber = battleResultExplainers.InfluenceExplainedNumber;
				moraleExplainedNumber = battleResultExplainers.MoraleExplainedNumber;
			}
		}

		// Token: 0x06002403 RID: 9219 RVA: 0x00098EF4 File Offset: 0x000970F4
		public float GetPlayerStrengthRatioInEncounter()
		{
			List<MobileParty> list = new List<MobileParty> { MobileParty.MainParty };
			List<MobileParty> list2 = new List<MobileParty> { MobileParty.ConversationParty };
			this.FindAllNpcPartiesWhoWillJoinEvent(ref list, ref list2);
			float num = 0f;
			float num2 = 0f;
			foreach (MobileParty mobileParty in list)
			{
				if (mobileParty != null)
				{
					num += mobileParty.Party.TotalStrength;
				}
				else
				{
					Debug.FailedAssert("Player side party null", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "GetPlayerStrengthRatioInEncounter", 2335);
				}
			}
			foreach (MobileParty mobileParty2 in list2)
			{
				if (mobileParty2 != null)
				{
					num2 += mobileParty2.Party.TotalStrength;
				}
				else
				{
					Debug.FailedAssert("Opponent side party null", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Encounters\\PlayerEncounter.cs", "GetPlayerStrengthRatioInEncounter", 2347);
				}
			}
			if (num2 <= 0f)
			{
				num2 = 1E-05f;
			}
			return num / num2;
		}

		// Token: 0x04000ADC RID: 2780
		[SaveableField(0)]
		public static bool EncounteredPartySurrendered;

		// Token: 0x04000ADD RID: 2781
		[SaveableField(1)]
		public bool FirstInit = true;

		// Token: 0x04000ADE RID: 2782
		public const float JoiningRadius = 3f;

		// Token: 0x04000AE1 RID: 2785
		[SaveableField(5)]
		public bool IsEnemy;

		// Token: 0x04000AE3 RID: 2787
		[SaveableField(7)]
		public float PlayerPartyInitialStrength;

		// Token: 0x04000AE4 RID: 2788
		[SaveableField(8)]
		private CampaignBattleResult _campaignBattleResult;

		// Token: 0x04000AE5 RID: 2789
		[SaveableField(9)]
		public float PartiesStrengthRatioBeforePlayerJoin;

		// Token: 0x04000AE6 RID: 2790
		[SaveableField(10)]
		public bool ForceRaid;

		// Token: 0x04000AE7 RID: 2791
		[SaveableField(11)]
		public bool ForceSallyOut;

		// Token: 0x04000AE8 RID: 2792
		[SaveableField(32)]
		public bool ForceVolunteers;

		// Token: 0x04000AE9 RID: 2793
		[SaveableField(33)]
		public bool ForceSupplies;

		// Token: 0x04000AEA RID: 2794
		[SaveableField(34)]
		private bool _isSiegeInterruptedByEnemyDefection;

		// Token: 0x04000AEB RID: 2795
		[SaveableField(35)]
		private bool _isPlayerEncounterInterruptedByPeace;

		// Token: 0x04000AEC RID: 2796
		public BattleSimulation BattleSimulation;

		// Token: 0x04000AED RID: 2797
		[SaveableField(13)]
		private MapEvent _mapEvent;

		// Token: 0x04000AEE RID: 2798
		[SaveableField(14)]
		private PlayerEncounterState _mapEventState;

		// Token: 0x04000AEF RID: 2799
		[SaveableField(15)]
		private PartyBase _encounteredParty;

		// Token: 0x04000AF0 RID: 2800
		[SaveableField(16)]
		private PartyBase _attackerParty;

		// Token: 0x04000AF1 RID: 2801
		[SaveableField(17)]
		private PartyBase _defenderParty;

		// Token: 0x04000AF2 RID: 2802
		[SaveableField(18)]
		private List<Hero> _helpedHeroes;

		// Token: 0x04000AF3 RID: 2803
		[SaveableField(19)]
		private List<TroopRosterElement> _capturedHeroes;

		// Token: 0x04000AF4 RID: 2804
		[SaveableField(20)]
		private List<TroopRosterElement> _freedHeroes;

		// Token: 0x04000AF5 RID: 2805
		[SaveableField(22)]
		private bool _leaveEncounter;

		// Token: 0x04000AF6 RID: 2806
		[SaveableField(23)]
		private bool _playerSurrender;

		// Token: 0x04000AF7 RID: 2807
		[SaveableField(24)]
		private bool _enemySurrender;

		// Token: 0x04000AF8 RID: 2808
		[SaveableField(25)]
		private bool _battleChallenge;

		// Token: 0x04000AF9 RID: 2809
		[SaveableField(26)]
		private bool _meetingDone;

		// Token: 0x04000AFA RID: 2810
		[SaveableField(27)]
		private bool _stateHandled;

		// Token: 0x04000AFB RID: 2811
		[SaveableField(36)]
		private ItemRoster _alternativeRosterToReceiveLootItems;

		// Token: 0x04000AFC RID: 2812
		[SaveableField(37)]
		private TroopRoster _alternativeRosterToReceiveLootPrisoners;

		// Token: 0x04000AFD RID: 2813
		[SaveableField(38)]
		private TroopRoster _alternativeRosterToReceiveLootMembers;

		// Token: 0x04000B00 RID: 2816
		[SaveableField(51)]
		private bool _doesBattleContinue;

		// Token: 0x04000B01 RID: 2817
		[SaveableField(52)]
		private bool _isSallyOutAmbush;
	}
}
