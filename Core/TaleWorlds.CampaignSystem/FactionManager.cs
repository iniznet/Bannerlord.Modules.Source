using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem
{
	public class FactionManager
	{
		internal static void AutoGeneratedStaticCollectObjectsFactionManager(object o, List<object> collectedObjects)
		{
			((FactionManager)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._stances);
		}

		internal static object AutoGeneratedGetMemberValue_stances(object o)
		{
			return ((FactionManager)o)._stances;
		}

		public static FactionManager Instance
		{
			get
			{
				return Campaign.Current.FactionManager;
			}
		}

		public FactionManager()
		{
			this._stances = new FactionManagerStancesData();
		}

		internal void AfterLoad()
		{
			foreach (StanceLink stanceLink in this._stances.GetStanceLinks())
			{
				if (stanceLink.Faction1 != stanceLink.Faction2)
				{
					FactionManager.AddStanceToFaction(stanceLink.Faction1, stanceLink);
					FactionManager.AddStanceToFaction(stanceLink.Faction2, stanceLink);
				}
			}
		}

		internal StanceLink GetStanceLinkInternal(IFaction faction1, IFaction faction2)
		{
			StanceLink stanceLink = this._stances.GetStance(faction1, faction2);
			if (stanceLink == null)
			{
				bool flag = (faction1.IsBanditFaction && !faction2.IsBanditFaction) || (!faction1.IsBanditFaction && faction2.IsBanditFaction);
				stanceLink = new StanceLink(flag ? StanceType.War : StanceType.Neutral, faction1, faction2, flag);
				this.AddStance(faction1, faction2, stanceLink);
			}
			return stanceLink;
		}

		private void AddStance(IFaction faction1, IFaction faction2, StanceLink stanceLink)
		{
			this._stances.AddStance(stanceLink);
			FactionManager.AddStanceToFaction(faction1, stanceLink);
			FactionManager.AddStanceToFaction(faction2, stanceLink);
		}

		private void RemoveStance(StanceLink stance)
		{
			this._stances.RemoveStance(stance);
			FactionManager.RemoveStanceFromFaction(stance.Faction1, stance);
			FactionManager.RemoveStanceFromFaction(stance.Faction2, stance);
		}

		private static void AddStanceToFaction(IFaction faction1, StanceLink stanceLink)
		{
			Kingdom kingdom = faction1 as Kingdom;
			if (kingdom != null)
			{
				kingdom.AddStanceInternal(stanceLink);
				return;
			}
			(faction1 as Clan).AddStanceInternal(stanceLink);
		}

		private static void RemoveStanceFromFaction(IFaction faction1, StanceLink stanceLink)
		{
			Kingdom kingdom = faction1 as Kingdom;
			if (kingdom != null)
			{
				kingdom.RemoveStanceInternal(stanceLink);
				return;
			}
			(faction1 as Clan).RemoveStanceInternal(stanceLink);
		}

		private static StanceLink SetStance(IFaction faction1, IFaction faction2, StanceType stanceType)
		{
			StanceLink stanceLinkInternal = FactionManager.Instance.GetStanceLinkInternal(faction1, faction2);
			stanceLinkInternal.StanceType = stanceType;
			return stanceLinkInternal;
		}

		public static void DeclareAlliance(IFaction faction1, IFaction faction2)
		{
			if (faction1 != faction2 && !faction1.IsBanditFaction && !faction2.IsBanditFaction)
			{
				FactionManager.SetStance(faction1, faction2, StanceType.Neutral);
			}
		}

		public static void DeclareWar(IFaction faction1, IFaction faction2, bool isAtConstantWar = false)
		{
			if (faction1 != faction2 && !faction1.IsBanditFaction && !faction2.IsBanditFaction)
			{
				FactionManager.SetStance(faction1, faction2, StanceType.War).IsAtConstantWar = isAtConstantWar;
			}
		}

		public static void SetNeutral(IFaction faction1, IFaction faction2)
		{
			if (faction1 != faction2 && !faction1.IsBanditFaction && !faction2.IsBanditFaction)
			{
				FactionManager.Instance.GetStanceLinkInternal(faction1, faction2).StanceType = StanceType.Neutral;
			}
		}

		public static bool IsAtWarAgainstFaction(IFaction faction1, IFaction faction2)
		{
			return faction1 != null && faction2 != null && faction1 != faction2 && FactionManager.Instance.GetStanceLinkInternal(faction1, faction2).IsAtWar;
		}

		public static bool IsAlliedWithFaction(IFaction faction1, IFaction faction2)
		{
			if (faction1 == null || faction2 == null)
			{
				return false;
			}
			if (faction1 == faction2)
			{
				return true;
			}
			StanceLink stanceLinkInternal = FactionManager.Instance.GetStanceLinkInternal(faction1, faction2);
			return stanceLinkInternal != null && stanceLinkInternal.IsAllied;
		}

		public static bool IsNeutralWithFaction(IFaction faction1, IFaction faction2)
		{
			if (faction1 == null || faction2 == null || faction1 == faction2)
			{
				return false;
			}
			StanceLink stanceLinkInternal = FactionManager.Instance.GetStanceLinkInternal(faction1, faction2);
			return (stanceLinkInternal != null || ((!faction1.IsBanditFaction || faction2.IsBanditFaction || faction2.IsOutlaw) && (!faction2.IsBanditFaction || faction1.IsBanditFaction || faction1.IsOutlaw))) && (stanceLinkInternal == null || stanceLinkInternal.IsNeutral);
		}

		internal void RemoveFactionsFromCampaignWars(IFaction faction1)
		{
			if (faction1.MapFaction != faction1)
			{
				return;
			}
			foreach (StanceLink stanceLink in faction1.Stances.ToArray<StanceLink>())
			{
				this.RemoveStance(stanceLink);
			}
		}

		public static IEnumerable<IFaction> GetEnemyFactions(IFaction faction)
		{
			foreach (StanceLink stanceLink in faction.Stances)
			{
				if (stanceLink.IsAtWar)
				{
					IFaction faction2 = null;
					if (stanceLink.Faction1 == faction)
					{
						faction2 = stanceLink.Faction2;
					}
					else if (stanceLink.Faction2 == faction)
					{
						faction2 = stanceLink.Faction1;
					}
					if (faction2.IsMapFaction && !faction2.IsBanditFaction)
					{
						yield return faction2;
					}
				}
			}
			IEnumerator<StanceLink> enumerator = null;
			yield break;
			yield break;
		}

		public static IEnumerable<Kingdom> GetEnemyKingdoms(Kingdom faction)
		{
			foreach (StanceLink stanceLink in faction.Stances)
			{
				if (stanceLink.IsAtWar)
				{
					IFaction faction2 = null;
					if (stanceLink.Faction1 == faction)
					{
						faction2 = stanceLink.Faction2;
					}
					else if (stanceLink.Faction2 == faction)
					{
						faction2 = stanceLink.Faction1;
					}
					if (faction2 != null && faction2.IsKingdomFaction)
					{
						yield return faction2 as Kingdom;
					}
				}
			}
			IEnumerator<StanceLink> enumerator = null;
			yield break;
			yield break;
		}

		public static int GetRelationBetweenClans(Clan clan1, Clan clan2)
		{
			float num = 0f;
			float num2 = 1E-05f;
			if ((clan1.Lords.Count == 0 && clan1.IsBanditFaction && !clan2.IsBanditFaction) || (clan2.Lords.Count == 0 && clan2.IsBanditFaction && !clan1.IsBanditFaction))
			{
				return -10;
			}
			foreach (Hero hero in clan1.Lords)
			{
				if (hero.Age > (float)Campaign.Current.Models.AgeModel.HeroComesOfAge)
				{
					foreach (Hero hero2 in clan2.Lords)
					{
						if (hero2.Age > (float)Campaign.Current.Models.AgeModel.HeroComesOfAge)
						{
							float num3 = 0.1f;
							if (hero == clan1.Leader)
							{
								num3 += 0.2f;
							}
							else
							{
								Hero hero3 = hero;
								Hero leader = clan1.Leader;
								if (hero3 == ((leader != null) ? leader.Spouse : null))
								{
									num3 += 0.05f;
								}
							}
							if (hero2 == clan2.Leader)
							{
								num3 += 0.2f;
							}
							else
							{
								Hero hero4 = hero2;
								Hero leader2 = clan2.Leader;
								if (hero4 == ((leader2 != null) ? leader2.Spouse : null))
								{
									num3 += 0.05f;
								}
							}
							if (hero == clan1.Leader && hero2 == clan2.Leader)
							{
								num3 *= 20f;
							}
							int baseHeroRelation = hero.GetBaseHeroRelation(hero2);
							num += num3 * (float)baseHeroRelation;
							num2 += num3;
						}
					}
				}
			}
			return (int)(num / num2);
		}

		[SaveableField(20)]
		private FactionManagerStancesData _stances;
	}
}
