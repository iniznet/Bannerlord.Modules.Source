using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues
{
	public class LadysKnightOutIssueBehavior : CampaignBehaviorBase
	{
		public override void RegisterEvents()
		{
			CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, new Action<Hero>(this.OnCheckForIssue));
		}

		public void OnCheckForIssue(Hero hero)
		{
			if (this.ConditionsHold(hero))
			{
				Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnStartIssue), typeof(LadysKnightOutIssueBehavior.LadysKnightOutIssue), IssueBase.IssueFrequency.Common, null));
				return;
			}
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(LadysKnightOutIssueBehavior.LadysKnightOutIssue), IssueBase.IssueFrequency.Common));
		}

		private bool ConditionsHold(Hero issueOwner)
		{
			return issueOwner.IsLord && issueOwner.IsFemale && issueOwner.GetTraitLevel(DefaultTraits.Mercy) < 0 && issueOwner.GetTraitLevel(DefaultTraits.PersonaSoftspoken) <= 0 && issueOwner.GetTraitLevel(DefaultTraits.PersonaCurt) <= 0 && issueOwner.Clan.Leader != issueOwner && issueOwner.Clan != Clan.PlayerClan && issueOwner.IsNoncombatant && issueOwner.CurrentSettlement != null && issueOwner.CurrentSettlement.IsTown && issueOwner.CurrentSettlement.Town.Security <= 50f;
		}

		private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
		{
			return new LadysKnightOutIssueBehavior.LadysKnightOutIssue(issueOwner);
		}

		public override void SyncData(IDataStore dataStore)
		{
		}

		private const IssueBase.IssueFrequency LadysKnightOutIssueFrequency = IssueBase.IssueFrequency.Common;

		public class LadysKnightOutIssue : IssueBase
		{
			internal static void AutoGeneratedStaticCollectObjectsLadysKnightOutIssue(object o, List<object> collectedObjects)
			{
				((LadysKnightOutIssueBehavior.LadysKnightOutIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			public override TextObject IssueBriefByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=M3af4N66}If you follow tournaments in this region, you'll know that I am a great devotee. I attend as many as I can - I love the spectacle, the tension... Despite this, I've never had a champion fight in my name, which is quite the fashion these days. Would you consider being my champion, {PLAYER.NAME}? I'm sure you could win glory for both of us.[if:convo_merry][ib:confident3]", null);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueAcceptByPlayer
			{
				get
				{
					return new TextObject("{=4nbnFMNZ}I can't promise to win, my lady.", null);
				}
			}

			public override TextObject IssueLordSolutionExplanationByIssueGiver
			{
				get
				{
					return new TextObject("{=SzIPvqLk}Of course not. If you don't wish to fight yourself - and I understand you might be quite busy - you could use your influence to convince one of the nobles of this realm to hold their next tournament in my honor.[ib:demure2][if:convo_merry]", null);
				}
			}

			public override TextObject IssuePlayerResponseAfterLordExplanation
			{
				get
				{
					return new TextObject("{=MuwmsOSn}I will consider this. What does it mean to be your champion?", null);
				}
			}

			public override TextObject IssueQuestSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=Pnc8ToV1}Just participate in a future tournament in this realm, and say you dedicate your victories to me. {TOURNAMENT_ROUND_GOAL}[ib:hip]", null);
					if (this.TournamentRoundGoal == 5)
					{
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", new TextObject("{=2Rzw16OX}If you can advance to win the tournament, I'm sure that will do us both honor.[ib:hip2][if:convo_relaxed_happy]", null));
					}
					else
					{
						TextObject textObject2 = new TextObject("{=al27CmYV}If you can advance to reach round {ROUND_COUNT}, I'm sure that will do us both honor.[if:convo_calm_friendly][ib:demure]", null);
						textObject2.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", textObject2);
					}
					return textObject;
				}
			}

			public override TextObject IssueQuestSolutionAcceptByPlayer
			{
				get
				{
					if (this.TournamentRoundGoal == 5)
					{
						return new TextObject("{=YArbm6TV}Then I will enter the tournament and win it, my lady.", null);
					}
					TextObject textObject = new TextObject("{=w3rcCibp}Then I will enter the tournament and reach round {ROUND_COUNT} my lady.", null);
					textObject.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
					return textObject;
				}
			}

			public override TextObject IssueLordSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=0WOPfOIH}I'm afraid I don't have time to fight but I can use my influence.", null);
				}
			}

			public override TextObject IssueLordSolutionResponseByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=ZZ7Q3VOG}Thank you my {?PLAYER.GENDER}lady{?}lord{\\?}. I am indeed honored.", null);
					StringHelpers.SetCharacterProperties("PLAYER", base.IssueOwner.CharacterObject, textObject, false);
					return textObject;
				}
			}

			protected override TextObject LordSolutionStartLog
			{
				get
				{
					TextObject textObject = new TextObject("{=EnhdXpQf}{ISSUE_OWNER.LINK} from {ISSUE_OWNER.FACTION}, has told you about of the tournament at the {ISSUE_OWNER_SETTLEMENT}. She wants you to be her champion. {TOURNAMENT_ROUND_GOAL}", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.IssueOwner.CharacterObject, textObject, true);
					textObject.SetTextVariable("ISSUE_OWNER_SETTLEMENT", base.IssueOwner.CurrentSettlement.EncyclopediaLinkWithName);
					if (this.TournamentRoundGoal == 5)
					{
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", new TextObject("{=YbzHpFiu}She expects you to win the tournament.", null));
					}
					else
					{
						TextObject textObject2 = new TextObject("{=5qkTxOJ5}She expects you to reach round {ROUND_COUNT}.", null);
						textObject2.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", textObject2);
					}
					return textObject;
				}
			}

			protected override TextObject LordSolutionCounterOfferRefuseLog
			{
				get
				{
					TextObject textObject = new TextObject("{=IPg30HIs}You told {ISSUE_OWNER.LINK} that instead of her request, the next tournament held will be held in her honor.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.IssueOwner.CharacterObject, textObject, false);
					return textObject;
				}
			}

			public override bool IsThereAlternativeSolution
			{
				get
				{
					return false;
				}
			}

			public override bool IsThereLordSolution
			{
				get
				{
					return true;
				}
			}

			public override TextObject Title
			{
				get
				{
					return new TextObject("{=a4XGmdd9}Lady's Knight Out", null);
				}
			}

			public override TextObject Description
			{
				get
				{
					TextObject textObject = new TextObject("{=oBl6SxeJ}{ISSUE_OWNER.LINK} wants you to participate in a tournament in her name.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.IssueOwner.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private int TournamentRoundGoal
			{
				get
				{
					if (base.IssueDifficultyMultiplier > 0.7f)
					{
						return 5;
					}
					if (0.7f >= base.IssueDifficultyMultiplier && base.IssueDifficultyMultiplier > 0.5f)
					{
						return 4;
					}
					if (0.5f >= base.IssueDifficultyMultiplier && base.IssueDifficultyMultiplier > 0.2f)
					{
						return 3;
					}
					return 2;
				}
			}

			public override int NeededInfluenceForLordSolution
			{
				get
				{
					return 15 + MathF.Ceiling(30f * base.IssueDifficultyMultiplier);
				}
			}

			public LadysKnightOutIssue(Hero issueOwner)
				: base(issueOwner, CampaignTime.DaysFromNow(30f))
			{
			}

			protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
			{
				if (issueEffect == DefaultIssueEffects.SettlementLoyalty)
				{
					return -0.2f;
				}
				if (issueEffect == DefaultIssueEffects.ClanInfluence)
				{
					return -0.1f;
				}
				return 0f;
			}

			protected override void OnGameLoad()
			{
			}

			protected override void HourlyTick()
			{
			}

			protected override QuestBase GenerateIssueQuest(string questId)
			{
				return new LadysKnightOutIssueBehavior.LadysKnightOutIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(30f), base.IssueDifficultyMultiplier, 750);
			}

			public override IssueBase.IssueFrequency GetFrequency()
			{
				return IssueBase.IssueFrequency.Common;
			}

			protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out IssueBase.PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
			{
				skill = null;
				relationHero = null;
				flag = IssueBase.PreconditionFlags.None;
				if (issueGiver.GetRelationWithPlayer() < -10f)
				{
					flag |= IssueBase.PreconditionFlags.Relation;
					relationHero = issueGiver;
				}
				if (FactionManager.IsAtWarAgainstFaction(issueGiver.CurrentSettlement.MapFaction, Hero.MainHero.MapFaction))
				{
					flag |= IssueBase.PreconditionFlags.AtWar;
				}
				return flag == IssueBase.PreconditionFlags.None;
			}

			public override bool IssueStayAliveConditions()
			{
				return base.IssueOwner.IsNoncombatant && base.IssueOwner.CurrentSettlement != null && base.IssueOwner.CurrentSettlement.IsTown && base.IssueOwner.CurrentSettlement.Town.Security <= 80f;
			}

			protected override void CompleteIssueWithTimedOutConsequences()
			{
			}

			protected override void LordSolutionConsequenceWithRefuseCounterOffer()
			{
				Clan.PlayerClan.AddRenown(7f, true);
				ChangeRelationAction.ApplyPlayerRelation(base.IssueOwner, 5, true, true);
			}

			private const int TakingQuestRelationLimit = -10;

			private const int QuestTimeLimit = 30;

			private const int IssueDuration = 30;

			private const int BaseRewardGold = 750;
		}

		public class LadysKnightOutIssueQuest : QuestBase
		{
			internal static void AutoGeneratedStaticCollectObjectsLadysKnightOutIssueQuest(object o, List<object> collectedObjects)
			{
				((LadysKnightOutIssueBehavior.LadysKnightOutIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._tournamentTown);
			}

			internal static object AutoGeneratedGetMemberValue_difficultyMultiplier(object o)
			{
				return ((LadysKnightOutIssueBehavior.LadysKnightOutIssueQuest)o)._difficultyMultiplier;
			}

			internal static object AutoGeneratedGetMemberValue_tournamentTown(object o)
			{
				return ((LadysKnightOutIssueBehavior.LadysKnightOutIssueQuest)o)._tournamentTown;
			}

			private int TournamentRoundGoal
			{
				get
				{
					if (this._difficultyMultiplier > 0.7f)
					{
						return 5;
					}
					if (0.7f >= this._difficultyMultiplier && this._difficultyMultiplier > 0.5f)
					{
						return 4;
					}
					if (0.5f >= this._difficultyMultiplier && this._difficultyMultiplier > 0.2f)
					{
						return 3;
					}
					return 2;
				}
			}

			private TextObject QuestStartLog
			{
				get
				{
					TextObject textObject = new TextObject("{=kqgadhCF}{QUEST_GIVER.LINK} from {QUEST_GIVER.FACTION}, has asked you to be her champion in an upcoming tournament. {TOURNAMENT_ROUND_GOAL} \nYou told her that you will honor her name in a tournament.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, true);
					textObject.SetTextVariable("QUEST_GIVER_TOWN", base.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
					if (this.TournamentRoundGoal == 5)
					{
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", new TextObject("{=r8VcYkUf}She expects you to fight in her name and win the tournament.", null));
					}
					else
					{
						TextObject textObject2 = new TextObject("{=edJtO2ua}She expects you to fight in her name and reach at least {ROUND_COUNT}.", null);
						textObject2.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", textObject2);
					}
					return textObject;
				}
			}

			private TextObject PlayerWinsTournamentSuccessLog
			{
				get
				{
					TextObject textObject = new TextObject("{=QAg8DQy6}You received a message from {QUEST_GIVER.LINK}.\n \"Thank you for fighting so valiantly in my name. Please take these {REWARD} denars with our gratitude.\"", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("REWARD", this.RewardGold);
					return textObject;
				}
			}

			private TextObject PlayerFailedToReachTournamentLevelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=04ti5hcX}{TOURNAMENT_ROUND_GOAL}{QUEST_GIVER.LINK} will certainly be disappointed.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					if (this.TournamentRoundGoal == 5)
					{
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", new TextObject("{=tDNiLiRM}You have failed to win the tournament. ", null));
					}
					else
					{
						TextObject textObject2 = new TextObject("{=CxKC5gqq}You have failed to reach round {ROUND_COUNT} in the tournament. ", null);
						textObject2.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
						textObject.SetTextVariable("TOURNAMENT_ROUND_GOAL", textObject2);
					}
					return textObject;
				}
			}

			private TextObject PlayerFailedToJoinTournamentLog
			{
				get
				{
					TextObject textObject = new TextObject("{=D40RPEbz}You have failed to enter a tournament in time. {QUEST_GIVER.LINK} will certainly be disappointed.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject WarDeclaredOnQuestGiversFactionCancelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=zh3Wf6bu}You are now at war with {QUEST_GIVER.LINK}'s faction. Quest is canceled.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject PlayerDeclaredWarQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject QuestGiverIsDeadCancelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=2Ju7Eduu}{QUEST_GIVER.LINK} has died. Your quest is canceled.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject QuestGiverLeftSettlementCancelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=1RBxhh4W}{QUEST_GIVER.LINK} is not avaliable for this quest anymore.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject MainHeroAttackedLadysClansVillageLog
			{
				get
				{
					TextObject textObject = new TextObject("{=Qft5pfYr}You have been accused of a crime, and {QUEST_GIVER.LINK} has declared that you are no longer her champion.", null);
					textObject.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, false);
					return textObject;
				}
			}

			public override TextObject Title
			{
				get
				{
					return new TextObject("{=a4XGmdd9}Lady's Knight Out", null);
				}
			}

			public override bool IsRemainingTimeHidden
			{
				get
				{
					return false;
				}
			}

			public LadysKnightOutIssueQuest(string questId, Hero questGiver, CampaignTime duration, float issueDifficultyMultiplier, int rewardGold)
				: base(questId, questGiver, duration, rewardGold)
			{
				this._difficultyMultiplier = issueDifficultyMultiplier;
				this._tournamentTown = null;
				this.SetDialogs();
				base.InitializeQuestOnCreation();
			}

			protected override void InitializeQuestOnGameLoad()
			{
				this.SetDialogs();
			}

			protected override void HourlyTick()
			{
			}

			protected override void RegisterEvents()
			{
				CampaignEvents.PlayerStartedTournamentMatch.AddNonSerializedListener(this, new Action<Town>(this.OnPlayerStartedTournamentMatch));
				CampaignEvents.PlayerEliminatedFromTournament.AddNonSerializedListener(this, new Action<int, Town>(this.OnPlayerEliminatedFromTournament));
				CampaignEvents.TournamentFinished.AddNonSerializedListener(this, new Action<CharacterObject, MBReadOnlyList<CharacterObject>, Town, ItemObject>(this.OnTournamentFinished));
				CampaignEvents.WarDeclared.AddNonSerializedListener(this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
				CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener(this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
				CampaignEvents.HeroKilledEvent.AddNonSerializedListener(this, new Action<Hero, Hero, KillCharacterAction.KillCharacterActionDetail, bool>(this.OnHeroKilled));
				CampaignEvents.OnSettlementLeftEvent.AddNonSerializedListener(this, new Action<MobileParty, Settlement>(this.OnSettlementLeft));
				CampaignEvents.MapEventStarted.AddNonSerializedListener(this, new Action<MapEvent, PartyBase, PartyBase>(this.OnMapEventStarted));
			}

			private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
			{
				if ((mapEvent.IsForcingSupplies || mapEvent.IsForcingVolunteers || mapEvent.IsRaid) && attackerParty == PartyBase.MainParty && mapEvent.MapEventSettlement.IsVillage && mapEvent.MapEventSettlement.OwnerClan == base.QuestGiver.Clan)
				{
					this.CriminalActionPerformedTowardsSettlement();
					return;
				}
				if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
				{
					QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
				}
			}

			protected override void OnTimedOut()
			{
				base.OnTimedOut();
				this.PlayerFailedToJoinTournamentInTime();
			}

			protected override void SetDialogs()
			{
				this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(new TextObject("{=at0iWxo1}It is exciting to think a warrior of your caliber will be my champion. {TOURNAMENT_ROUND_GOAL}", null), null, null).Condition(new ConversationSentence.OnConditionDelegate(this.QuestAcceptedCondition))
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences))
					.CloseDialog();
				this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(new TextObject("{=iPcbFoDx}Are you prepared for the tournament? Eating well? Staying healthy?", null), null, null).Condition(() => CharacterObject.OneToOneConversationCharacter == base.QuestGiver.CharacterObject)
					.PlayerLine(new TextObject("{=YOmuyrIt}Do you know if there is a tournament starting soon?", null), null)
					.BeginNpcOptions()
					.NpcOption(new TextObject("{=CeYwClaG}Yes, there is one starting at {NEARBY_TOURNAMENTS_LIST}. I am sure the arena master can explain the rules, if you need to know them.", null), new ConversationSentence.OnConditionDelegate(this.NpcTournamentLocationCondition), null, null)
					.CloseDialog()
					.NpcDefaultOption("{=sUfSCLQx}Sadly, I've heard no news of an upcoming tournament. I am sure one will be held before too long.")
					.CloseDialog()
					.EndNpcOptions()
					.CloseDialog();
			}

			private bool QuestAcceptedCondition()
			{
				if (this.TournamentRoundGoal == 5)
				{
					MBTextManager.SetTextVariable("TOURNAMENT_ROUND_GOAL", new TextObject("{=nctTI5mv}I have every reason to believe you'll win the tournament.", null), false);
				}
				else
				{
					TextObject textObject = new TextObject("{=3FMvLhWV}I have every reason to believe you'll reach round {ROUND_COUNT}.", null);
					textObject.SetTextVariable("ROUND_COUNT", this.TournamentRoundGoal);
					MBTextManager.SetTextVariable("TOURNAMENT_ROUND_GOAL", textObject, false);
				}
				return CharacterObject.OneToOneConversationCharacter == base.QuestGiver.CharacterObject;
			}

			private void QuestAcceptedConsequences()
			{
				base.StartQuest();
				base.AddLog(this.QuestStartLog, false);
			}

			private bool NpcTournamentLocationCondition()
			{
				List<Town> list = Town.AllTowns.Where((Town x) => Campaign.Current.TournamentManager.GetTournamentGame(x) != null && x != Settlement.CurrentSettlement.Town).ToList<Town>();
				list = list.OrderBy((Town x) => x.Settlement.Position2D.DistanceSquared(Settlement.CurrentSettlement.Position2D)).ToList<Town>();
				if (list.Count > 0)
				{
					MBTextManager.SetTextVariable("NEARBY_TOURNAMENTS_LIST", list[0].Name, false);
					return true;
				}
				return false;
			}

			private void OnPlayerStartedTournamentMatch(Town town)
			{
				this._tournamentTown = town;
			}

			private void OnPlayerEliminatedFromTournament(int round, Town settlement)
			{
				if (this.TournamentRoundGoal > round + 1)
				{
					this.PlayerCouldntReachedTournamentRoundGoal();
					return;
				}
				this.PlayerReachedTournamentRoundGoal();
			}

			private void OnTournamentFinished(CharacterObject winner, MBReadOnlyList<CharacterObject> participants, Town town, ItemObject prize)
			{
				if (town == this._tournamentTown && winner == CharacterObject.PlayerCharacter)
				{
					this.PlayerReachedTournamentRoundGoal();
				}
			}

			private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
			{
				if (base.QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
				{
					base.CompleteQuestWithCancel(this.WarDeclaredOnQuestGiversFactionCancelLog);
				}
			}

			private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
			{
				QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest(this, faction1, faction2, detail, this.PlayerDeclaredWarQuestLogText, this.WarDeclaredOnQuestGiversFactionCancelLog, false);
			}

			private void OnHeroKilled(Hero victim, Hero killer, KillCharacterAction.KillCharacterActionDetail detail, bool showNotification)
			{
				if (victim == base.QuestGiver)
				{
					this.QuestGiverIsDead();
				}
			}

			private void OnSettlementLeft(MobileParty party, Settlement settlement)
			{
				if (base.QuestGiver.CurrentSettlement == null)
				{
					this.QuestGiverLeftSettlement();
				}
			}

			private void PlayerReachedTournamentRoundGoal()
			{
				base.AddLog(this.PlayerWinsTournamentSuccessLog, false);
				Clan.PlayerClan.AddRenown(1f, true);
				GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, this.RewardGold, false);
				ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, 5, true, true);
				base.CompleteQuestWithSuccess();
			}

			private void PlayerCouldntReachedTournamentRoundGoal()
			{
				ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, -5, true, true);
				base.CompleteQuestWithFail(this.PlayerFailedToReachTournamentLevelLog);
			}

			private void PlayerFailedToJoinTournamentInTime()
			{
				base.AddLog(this.PlayerFailedToJoinTournamentLog, false);
				ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, -5, true, true);
			}

			private void QuestGiverIsDead()
			{
				base.CompleteQuestWithCancel(this.QuestGiverIsDeadCancelLog);
			}

			private void QuestGiverLeftSettlement()
			{
				base.CompleteQuestWithCancel(this.QuestGiverLeftSettlementCancelLog);
			}

			private void CriminalActionPerformedTowardsSettlement()
			{
				this.RelationshipChangeWithQuestGiver = -5;
				Tuple<TraitObject, int>[] array = new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, -50)
				};
				TraitLevelingHelper.OnIssueSolvedThroughQuest(Hero.MainHero, array);
				base.CompleteQuestWithFail(this.MainHeroAttackedLadysClansVillageLog);
			}

			[SaveableField(1)]
			private readonly float _difficultyMultiplier;

			[SaveableField(2)]
			private Town _tournamentTown;
		}

		public class LadysKnightOutIssueTypeDefiner : SaveableTypeDefiner
		{
			public LadysKnightOutIssueTypeDefiner()
				: base(585700)
			{
			}

			protected override void DefineClassTypes()
			{
				base.AddClassDefinition(typeof(LadysKnightOutIssueBehavior.LadysKnightOutIssue), 1, null);
				base.AddClassDefinition(typeof(LadysKnightOutIssueBehavior.LadysKnightOutIssueQuest), 2, null);
			}
		}
	}
}
