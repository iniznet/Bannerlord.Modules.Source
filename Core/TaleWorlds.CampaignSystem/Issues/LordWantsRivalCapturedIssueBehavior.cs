using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues
{
	// Token: 0x02000318 RID: 792
	public class LordWantsRivalCapturedIssueBehavior : CampaignBehaviorBase
	{
		// Token: 0x06002D2A RID: 11562 RVA: 0x000BC79C File Offset: 0x000BA99C
		public override void RegisterEvents()
		{
			CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, new Action<Hero>(this.OnCheckForIssue));
		}

		// Token: 0x06002D2B RID: 11563 RVA: 0x000BC7B5 File Offset: 0x000BA9B5
		public override void SyncData(IDataStore dataStore)
		{
		}

		// Token: 0x06002D2C RID: 11564 RVA: 0x000BC7B8 File Offset: 0x000BA9B8
		private bool ConditionsHold(Hero issueGiver, out Hero targetHero)
		{
			targetHero = null;
			if (issueGiver.IsLord && !issueGiver.IsMinorFactionHero && issueGiver.Clan.Leader == issueGiver && issueGiver.Clan != Clan.PlayerClan && issueGiver.GetTraitLevel(DefaultTraits.Mercy) <= 0 && issueGiver.GetTraitLevel(DefaultTraits.Honor) <= 0 && issueGiver.GetTraitLevel(DefaultTraits.Valor) <= 0)
			{
				List<Clan> list = Clan.FindAll((Clan x) => x.MapFaction != issueGiver.MapFaction && x.MapFaction.IsAtWarWith(issueGiver.MapFaction) && x.Lords.Count > 0).ToList<Clan>();
				int count = list.Count;
				if (count > 0)
				{
					int num = MBRandom.RandomInt(count);
					int num2 = num;
					bool flag = true;
					Func<Hero, bool> <>9__1;
					do
					{
						Clan clan = list[num2];
						MBReadOnlyList<Hero> lords = clan.Lords;
						Func<Hero, bool> func;
						if ((func = <>9__1) == null)
						{
							func = (<>9__1 = (Hero noble) => noble.IsAlive && !noble.IsFactionLeader && noble.PartyBelongedTo != null && noble.PartyBelongedTo.MemberRoster.TotalHealthyCount >= 50 && (float)noble.GetRelation(issueGiver) <= -10f);
						}
						targetHero = lords.GetRandomElementWithPredicate(func);
						num2++;
						if (num2 == count)
						{
							num2 = 0;
						}
						if (num2 == num)
						{
							flag = false;
						}
					}
					while (targetHero == null && flag);
				}
			}
			return targetHero != null;
		}

		// Token: 0x06002D2D RID: 11565 RVA: 0x000BC8F4 File Offset: 0x000BAAF4
		public void OnCheckForIssue(Hero hero)
		{
			Hero hero2;
			if (this.ConditionsHold(hero, out hero2))
			{
				Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnSelected), typeof(LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue), IssueBase.IssueFrequency.Rare, hero2));
				return;
			}
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue), IssueBase.IssueFrequency.Rare));
		}

		// Token: 0x06002D2E RID: 11566 RVA: 0x000BC95C File Offset: 0x000BAB5C
		private IssueBase OnSelected(in PotentialIssueData pid, Hero issueOwner)
		{
			PotentialIssueData potentialIssueData = pid;
			return new LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue(issueOwner, potentialIssueData.RelatedObject as Hero);
		}

		// Token: 0x04000D9C RID: 3484
		private const IssueBase.IssueFrequency LordWantsRivalCapturedIssueFrequency = IssueBase.IssueFrequency.Rare;

		// Token: 0x04000D9D RID: 3485
		private const float TargetHeroRelationMaxRelation = -10f;

		// Token: 0x0200064B RID: 1611
		public class LordWantsRivalCapturedIssue : IssueBase
		{
			// Token: 0x06004EB3 RID: 20147 RVA: 0x0015D0ED File Offset: 0x0015B2ED
			internal static void AutoGeneratedStaticCollectObjectsLordWantsRivalCapturedIssue(object o, List<object> collectedObjects)
			{
				((LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x06004EB4 RID: 20148 RVA: 0x0015D0FB File Offset: 0x0015B2FB
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._targetHero);
			}

			// Token: 0x06004EB5 RID: 20149 RVA: 0x0015D110 File Offset: 0x0015B310
			internal static object AutoGeneratedGetMemberValue_targetHero(object o)
			{
				return ((LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue)o)._targetHero;
			}

			// Token: 0x170010CC RID: 4300
			// (get) Token: 0x06004EB6 RID: 20150 RVA: 0x0015D11D File Offset: 0x0015B31D
			protected override int RewardGold
			{
				get
				{
					return 5000;
				}
			}

			// Token: 0x170010CD RID: 4301
			// (get) Token: 0x06004EB7 RID: 20151 RVA: 0x0015D124 File Offset: 0x0015B324
			public override TextObject IssueBriefByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=uc4M4bhG}Well, there is something I want. There is one {?TARGET_HERO.GENDER}lady{?}lord{\\?} of the {TARGET_FACTION} with whom I have a long, long relationship. And not a friendly one. Even though we are not now at war, as long as {?TARGET_HERO.GENDER}she{?}he{\\?} is free, I know my life and lands are not safe. As I say, it won't be easy at all. But whoever manages to do that, bring {?TARGET_HERO.GENDER}her{?}him{\\?} back alive to me, having my gratitude aside, will be a very rich man indeed.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					textObject.SetTextVariable("TARGET_FACTION", this._targetHero.Clan.Name);
					return textObject;
				}
			}

			// Token: 0x170010CE RID: 4302
			// (get) Token: 0x06004EB8 RID: 20152 RVA: 0x0015D174 File Offset: 0x0015B374
			public override TextObject IssueAcceptByPlayer
			{
				get
				{
					TextObject textObject = new TextObject("{=tzBybYcf}I am interested. Who is this {?TARGET_HERO.GENDER}woman{?}man{\\?}?", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010CF RID: 4303
			// (get) Token: 0x06004EB9 RID: 20153 RVA: 0x0015D1A8 File Offset: 0x0015B3A8
			public override TextObject IssueQuestSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=zKhvUmeH}{?TARGET_HERO.GENDER}She{?}He{\\?} is {TARGET_HERO.NAME} from {TARGET_HERO.CLAN}. I want {?TARGET_HERO.GENDER}her{?}him{\\?} brought to me, so I can settle this score once and for all. I have {BASE_REWARD}{GOLD_ICON} that I have set aside. If you can bring me {TARGET_HERO.LINK} alive within a year, it is yours to claim.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, true);
					textObject.SetTextVariable("BASE_REWARD", this.RewardGold);
					GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x170010D0 RID: 4304
			// (get) Token: 0x06004EBA RID: 20154 RVA: 0x0015D1FC File Offset: 0x0015B3FC
			public override TextObject IssueQuestSolutionAcceptByPlayer
			{
				get
				{
					TextObject textObject = new TextObject("{=Ysjh2GF2}Hold on to that reward, then. I will bring {?TARGET_HERO.GENDER}her{?}him{\\?} alive.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010D1 RID: 4305
			// (get) Token: 0x06004EBB RID: 20155 RVA: 0x0015D22E File Offset: 0x0015B42E
			public override bool IsThereAlternativeSolution
			{
				get
				{
					return false;
				}
			}

			// Token: 0x170010D2 RID: 4306
			// (get) Token: 0x06004EBC RID: 20156 RVA: 0x0015D231 File Offset: 0x0015B431
			public override bool IsThereLordSolution
			{
				get
				{
					return false;
				}
			}

			// Token: 0x170010D3 RID: 4307
			// (get) Token: 0x06004EBD RID: 20157 RVA: 0x0015D234 File Offset: 0x0015B434
			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=FoNfLOny}{ISSUE_OWNER.NAME} wants {TARGET_HERO.NAME} captured", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010D4 RID: 4308
			// (get) Token: 0x06004EBE RID: 20158 RVA: 0x0015D280 File Offset: 0x0015B480
			public override TextObject Description
			{
				get
				{
					TextObject textObject = new TextObject("{=FoNfLOny}{ISSUE_OWNER.NAME} wants {TARGET_HERO.NAME} captured", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x06004EBF RID: 20159 RVA: 0x0015D2CA File Offset: 0x0015B4CA
			public LordWantsRivalCapturedIssue(Hero issueOwner, Hero targetHero)
				: base(issueOwner, CampaignTime.DaysFromNow(20f))
			{
				this._targetHero = targetHero;
			}

			// Token: 0x06004EC0 RID: 20160 RVA: 0x0015D2E4 File Offset: 0x0015B4E4
			protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
			{
				if (issueEffect == DefaultIssueEffects.ClanInfluence)
				{
					return -0.3f;
				}
				return 0f;
			}

			// Token: 0x06004EC1 RID: 20161 RVA: 0x0015D2F9 File Offset: 0x0015B4F9
			public override IssueBase.IssueFrequency GetFrequency()
			{
				return IssueBase.IssueFrequency.Rare;
			}

			// Token: 0x06004EC2 RID: 20162 RVA: 0x0015D2FC File Offset: 0x0015B4FC
			public override bool IssueStayAliveConditions()
			{
				return !this._targetHero.IsDead && !base.IssueOwner.IsDead && !this._targetHero.IsPrisoner && this._targetHero.PartyBelongedTo != null && base.IssueOwner.MapFaction != this._targetHero.MapFaction && base.IssueOwner.Clan != Clan.PlayerClan;
			}

			// Token: 0x06004EC3 RID: 20163 RVA: 0x0015D36C File Offset: 0x0015B56C
			protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out IssueBase.PreconditionFlags flags, out Hero relationHero, out SkillObject skill)
			{
				relationHero = null;
				flags = IssueBase.PreconditionFlags.None;
				if (issueGiver.GetRelationWithPlayer() < -10f)
				{
					flags |= IssueBase.PreconditionFlags.Relation;
					relationHero = issueGiver;
				}
				if (issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
				{
					flags |= IssueBase.PreconditionFlags.AtWar;
				}
				if (Clan.PlayerClan.Tier < 2)
				{
					flags |= IssueBase.PreconditionFlags.ClanTier;
				}
				if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 50)
				{
					flags |= IssueBase.PreconditionFlags.NotEnoughTroops;
				}
				skill = null;
				return flags == IssueBase.PreconditionFlags.None;
			}

			// Token: 0x06004EC4 RID: 20164 RVA: 0x0015D3F0 File Offset: 0x0015B5F0
			protected override void OnGameLoad()
			{
			}

			// Token: 0x06004EC5 RID: 20165 RVA: 0x0015D3F2 File Offset: 0x0015B5F2
			protected override QuestBase GenerateIssueQuest(string questId)
			{
				return new LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(300f), this.RewardGold, this._targetHero);
			}

			// Token: 0x06004EC6 RID: 20166 RVA: 0x0015D416 File Offset: 0x0015B616
			protected override void CompleteIssueWithTimedOutConsequences()
			{
			}

			// Token: 0x04001A6C RID: 6764
			private const int QuestTimeLimit = 300;

			// Token: 0x04001A6D RID: 6765
			[SaveableField(10)]
			private Hero _targetHero;
		}

		// Token: 0x0200064C RID: 1612
		public class LordWantsRivalCapturedIssueQuest : QuestBase
		{
			// Token: 0x06004EC7 RID: 20167 RVA: 0x0015D418 File Offset: 0x0015B618
			internal static void AutoGeneratedStaticCollectObjectsLordWantsRivalCapturedIssueQuest(object o, List<object> collectedObjects)
			{
				((LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x06004EC8 RID: 20168 RVA: 0x0015D426 File Offset: 0x0015B626
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._targetHero);
			}

			// Token: 0x06004EC9 RID: 20169 RVA: 0x0015D43B File Offset: 0x0015B63B
			internal static object AutoGeneratedGetMemberValue_targetHero(object o)
			{
				return ((LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssueQuest)o)._targetHero;
			}

			// Token: 0x06004ECA RID: 20170 RVA: 0x0015D448 File Offset: 0x0015B648
			internal static object AutoGeneratedGetMemberValue_firstCounterOfferMade(object o)
			{
				return ((LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssueQuest)o)._firstCounterOfferMade;
			}

			// Token: 0x170010D5 RID: 4309
			// (get) Token: 0x06004ECB RID: 20171 RVA: 0x0015D45C File Offset: 0x0015B65C
			private bool PlayerCapturedTargetHero
			{
				get
				{
					return (from x in MobileParty.MainParty.PrisonRoster.GetTroopRoster()
						where x.Character.IsHero
						select x).FirstOrDefault((TroopRosterElement x) => x.Character.HeroObject == this._targetHero).Character != null;
				}
			}

			// Token: 0x170010D6 RID: 4310
			// (get) Token: 0x06004ECC RID: 20172 RVA: 0x0015D4B8 File Offset: 0x0015B6B8
			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=FoNfLOny}{ISSUE_OWNER.NAME} wants {TARGET_HERO.NAME} captured", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010D7 RID: 4311
			// (get) Token: 0x06004ECD RID: 20173 RVA: 0x0015D502 File Offset: 0x0015B702
			public override bool IsRemainingTimeHidden
			{
				get
				{
					return false;
				}
			}

			// Token: 0x170010D8 RID: 4312
			// (get) Token: 0x06004ECE RID: 20174 RVA: 0x0015D508 File Offset: 0x0015B708
			private TextObject _playerStartsQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=nB07bljx}{ISSUE_OWNER.LINK}, a {?ISSUE_OWNER.GENDER}lady{?}lord{\\?} of the {ISSUE_OWNER.CLAN}, has a personal vendetta against {TARGET_HERO.LINK} of the {TARGET_HERO.CLAN}. {?ISSUE_OWNER.GENDER}She{?}He{\\?} wants {TARGET_HERO.LINK} captured and brought back to {?ISSUE_OWNER.GENDER}her{?}him{\\?}. If you manage doing that, {?ISSUE_OWNER.GENDER}she{?}he{\\?} promised a reward of {REWARD_GOLD}{GOLD_ICON}. You agreed to find {TARGET_HERO.LINK} and bring {?TARGET_HERO.GENDER}her{?}him{\\?} to {ISSUE_OWNER.LINK} within one year.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, true);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, true);
					textObject.SetTextVariable("REWARD_GOLD", this.RewardGold);
					return textObject;
				}
			}

			// Token: 0x170010D9 RID: 4313
			// (get) Token: 0x06004ECF RID: 20175 RVA: 0x0015D564 File Offset: 0x0015B764
			private TextObject _playerAcceptedOfferQuestFail
			{
				get
				{
					TextObject textObject = new TextObject("{=vh4bBfYq}You have accepted {TARGET_HERO.LINK}'s offer and freed {?TARGET_HERO.GENDER}her{?}him{\\?}. {?TARGET_HERO.GENDER}She{?}He{\\?} and {?TARGET_HERO.GENDER}her{?}his{\\?} clan would be very happy. On the other hand {ISSUE_OWNER.LINK} will feel {?ISSUE_OWNER.GENDER}she{?}he{\\?} is betrayed and be furious.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010DA RID: 4314
			// (get) Token: 0x06004ED0 RID: 20176 RVA: 0x0015D5B0 File Offset: 0x0015B7B0
			private TextObject _playerDeliveredPrisonerQuestSuccess
			{
				get
				{
					TextObject textObject = new TextObject("{=UIyhmGKC}You have handed over the prisoner {TARGET_HERO.LINK} to {ISSUE_OWNER.LINK}'s agent, who handed you {BASE_REWARD}{GOLD_ICON} denars as promised. He also says; {ISSUE_OWNER.LINK} is grateful for your service and sends {?ISSUE_OWNER.GENDER}her{?}his{\\?} regards.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					textObject.SetTextVariable("BASE_REWARD", this.RewardGold);
					GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x170010DB RID: 4315
			// (get) Token: 0x06004ED1 RID: 20177 RVA: 0x0015D61C File Offset: 0x0015B81C
			private TextObject _playerCapturedTargetBrief1LogText
			{
				get
				{
					TextObject textObject = new TextObject("{=VdGyUQH0}You have captured {TARGET_HERO.LINK}. It looks like {?TARGET_HERO.GENDER}she{?}he{\\?} is desperate and very afraid of being sent to {ISSUE_OWNER.LINK} so for {?TARGET_HERO.GENDER}her{?}his{\\?} release, {?TARGET_HERO.GENDER}she{?}he{\\?} offers a sum of {BASE_REWARD_X_2}{GOLD_ICON} denars, double of what {ISSUE_OWNER.LINK} was willing to pay for his capture. {ISSUE_OWNER.LINK} on the other hand sends you a letter soon after {TARGET_HERO.LINK}'s capture. The letter reads:", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					textObject.SetTextVariable("BASE_REWARD_X_2", this.RewardGold * 2);
					GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x170010DC RID: 4316
			// (get) Token: 0x06004ED2 RID: 20178 RVA: 0x0015D68C File Offset: 0x0015B88C
			private TextObject _playerCapturedTargetBrief2LogText
			{
				get
				{
					TextObject textObject = new TextObject("{=vzF9atyv}My dear {PLAYER.NAME}, I have been informed that you have captured {TARGET_HERO.LINK}. This is great news. One of my agents will wait for you at the gates of the next settlement that belongs to my clan with the bounty I promised. You should deliver your prisoner to him as soon as you can. I have plans for {?TARGET_HERO.GENDER}her{?}him{\\?}. Thank you and best wishes, - {ISSUE_OWNER.LINK}", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010DD RID: 4317
			// (get) Token: 0x06004ED3 RID: 20179 RVA: 0x0015D6E8 File Offset: 0x0015B8E8
			private TextObject _playerCapturedTargetBrief3LogText
			{
				get
				{
					TextObject textObject = new TextObject("{=1H6SKtUl}Deliver the prisoner to {ISSUE_OWNER.LINK} {?ISSUE_OWNER.GENDER}herself{?}himself{\\?} or one of {?ISSUE_OWNER.GENDER}her{?}his{\\?} settlements. If you don't want to deliver {TARGET_HERO.LINK}, talk with {?TARGET_HERO.GENDER}her{?}him{\\?} to negotiate on {?TARGET_HERO.GENDER}her{?}his{\\?} release.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010DE RID: 4318
			// (get) Token: 0x06004ED4 RID: 20180 RVA: 0x0015D734 File Offset: 0x0015B934
			private TextObject _targetKilledByPlayerLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=GlfwOWre}You have received a letter from {ISSUE_OWNER.LINK}; It reads: \"My dear {PLAYER.NAME}, I have been informed that that vile creature called {TARGET_HERO.LINK} has been slain by you! While this is great news, I had other plans for {?TARGET_HERO.GENDER}her{?}him{\\?}. What a pity. Anyway, I am feeling generous. So I will still pay half of what we had previously agreed upon. The messenger who brought you this note should give you the sum. Best wishes - {ISSUE_OWNER.LINK}\"", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010DF RID: 4319
			// (get) Token: 0x06004ED5 RID: 20181 RVA: 0x0015D790 File Offset: 0x0015B990
			private TextObject _targetDiedLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=Ny2i62w5}{TARGET_HERO} died and your agreement with {ISSUE_OWNER.LINK} has been canceled.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010E0 RID: 4320
			// (get) Token: 0x06004ED6 RID: 20182 RVA: 0x0015D7DC File Offset: 0x0015B9DC
			private TextObject _questGiverCapturedTargetHero
			{
				get
				{
					TextObject textObject = new TextObject("{=2HIE7n9G}{ISSUE_OWNER.LINK} has captured {TARGET_HERO.LINK} {?ISSUE_OWNER.GENDER}herself{?}himself{\\?}, your contract with {ISSUE_OWNER.LINK} has canceled.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010E1 RID: 4321
			// (get) Token: 0x06004ED7 RID: 20183 RVA: 0x0015D828 File Offset: 0x0015BA28
			private TextObject _targetHeroAndQuestGiverInSameFaction
			{
				get
				{
					TextObject textObject = new TextObject("{=4JE6bYIE}{ISSUE_OWNER.LINK} and {TARGET_HERO.LINK} are now part of the same faction so they can't fight against each other. Your contract with {ISSUE_OWNER.LINK} has canceled.", null);
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x170010E2 RID: 4322
			// (get) Token: 0x06004ED8 RID: 20184 RVA: 0x0015D872 File Offset: 0x0015BA72
			private TextObject _warDeclaredQuestLog
			{
				get
				{
					TextObject textObject = new TextObject("{=cKz1cyuM}Your clan is now at war with {QUEST_GIVER_SETTLEMENT_FACTION}. Quest is canceled.", null);
					textObject.SetTextVariable("QUEST_GIVER_SETTLEMENT_FACTION", base.QuestGiver.MapFaction.Name);
					return textObject;
				}
			}

			// Token: 0x170010E3 RID: 4323
			// (get) Token: 0x06004ED9 RID: 20185 RVA: 0x0015D89B File Offset: 0x0015BA9B
			private TextObject _timeOutLogText
			{
				get
				{
					return new TextObject("{=maXW8tps}You failed to capture and deliver the prisoner in time.", null);
				}
			}

			// Token: 0x06004EDA RID: 20186 RVA: 0x0015D8A8 File Offset: 0x0015BAA8
			public LordWantsRivalCapturedIssueQuest(string questId, Hero giverHero, CampaignTime duration, int rewardGold, Hero targetHero)
				: base(questId, giverHero, duration, rewardGold)
			{
				this._targetHero = targetHero;
				this.SetDialogs();
				base.InitializeQuestOnCreation();
				this._firstCounterOfferMade = false;
				this._questGiversAgentCharacterObject = null;
			}

			// Token: 0x06004EDB RID: 20187 RVA: 0x0015D8D7 File Offset: 0x0015BAD7
			private bool DialogCondition()
			{
				StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, null, false);
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, null, false);
				return Hero.OneToOneConversationHero == base.QuestGiver;
			}

			// Token: 0x06004EDC RID: 20188 RVA: 0x0015D910 File Offset: 0x0015BB10
			protected override void SetDialogs()
			{
				this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(new TextObject("{=qaKh6vRl}Let's see if you are as good as your word. If you really manage, I admit, I will be very impressed. I look forward to meeting you again.", null), null, null).Condition(new ConversationSentence.OnConditionDelegate(this.DialogCondition))
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences))
					.CloseDialog();
				this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(new TextObject("{=xFHb9nAk}Have you been able to find {?TARGET_HERO.GENDER}her{?}his{\\?} whereabouts yet?", null), null, null).Condition(new ConversationSentence.OnConditionDelegate(this.DialogCondition))
					.Consequence(delegate
					{
						Campaign.Current.ConversationManager.ConversationEndOneShot += MapEventHelper.OnConversationEnd;
					})
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=ZkVP4RYV}Yes, I've captured {?TARGET_HERO.GENDER}her{?}him{\\?}.", null), null)
					.Condition(() => this.PlayerCapturedTargetHero)
					.NpcLine(new TextObject("{=qvlln5ej}Thanks, I knew I could trust you.", null), null, null)
					.Consequence(delegate
					{
						Campaign.Current.ConversationManager.ConversationEndOneShot += this.PlayerDeliveredPrisonerQuestSuccess;
					})
					.CloseDialog()
					.PlayerOption(new TextObject("{=fwQtClVo}I will deal with {?TARGET_HERO.GENDER}her{?}him{\\?} right away! ", null), null)
					.NpcLine(new TextObject("{=fr4F4IQc}It's good to hear that, {PLAYER.NAME}. ", null), null, null)
					.CloseDialog()
					.PlayerOption(new TextObject("{=18NtjryL}Not yet, but I will soon.", null), null)
					.NpcLine(new TextObject("{=zs8rZnf8}I will be waiting for your good news {PLAYER.NAME}.", null), null, null)
					.CloseDialog()
					.EndPlayerOptions();
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetTargetHeroDialogFlow(), this);
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetTargetHeroCounterOffer1DialogFlow(), this);
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetTargetHeroCounterOffer2DialogFlow(), this);
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetQuestGiversAgentDialogFlow(), this);
			}

			// Token: 0x06004EDD RID: 20189 RVA: 0x0015DAC0 File Offset: 0x0015BCC0
			private DialogFlow GetTargetHeroDialogFlow()
			{
				TextObject textObject = new TextObject("{=Mn4bI9Jg}What are you doing? Are you another one of {QUEST_GIVER.NAME}'s lackeys? Do you think you can hunt me like an animal.[ib:closed][if:convo_angry]", null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
				TextObject textObject2 = new TextObject("{=qOhDHFyH}Are you another one of {QUEST_GIVER.NAME}'s lackeys? Did {?QUEST_GIVER.GENDER}she{?}he{\\?} send you to hunt me like an animal? Well, I think you've found you've caught not a hare but a lion.", null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject2, false);
				return DialogFlow.CreateDialogFlow("start", 125).BeginNpcOptions().NpcOption(textObject2, new ConversationSentence.OnConditionDelegate(this.target_hero_encounter_agressive_condition), null, null)
					.NpcLine(new TextObject("{=TzvGs0v1}Well I guess it's too late to change your mind now, I decided to make an example of you.", null), null, null)
					.CloseDialog()
					.NpcOption(textObject, new ConversationSentence.OnConditionDelegate(this.target_hero_encounter_default_condition), null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=WoAgHDrN}I'm bringing you in, one way or the other.", null), null)
					.NpcLine(new TextObject("{=hzCTbbLP}You think you've caught a hare but instead you've caught a lion.[ib:closed][if:convo_bared_teeth]", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.player_target_hero_encounter_consequence))
					.CloseDialog()
					.PlayerOption(new TextObject("{=pZm7HRDG}Don't worry I have no intention to attack.", null), null)
					.NpcLine(new TextObject("{=eJuvk4om}Wise decision.[ib:closed][if:convo_bared_teeth]", null), null, null)
					.Consequence(delegate
					{
						PlayerEncounter.LeaveEncounter = true;
					})
					.CloseDialog()
					.EndPlayerOptions()
					.EndNpcOptions();
			}

			// Token: 0x06004EDE RID: 20190 RVA: 0x0015DBFC File Offset: 0x0015BDFC
			private DialogFlow GetTargetHeroCounterOffer1DialogFlow()
			{
				TextObject textObject = new TextObject("{=dYa9oVSP}Fate is cruel. So, I am your prisoner. But you don't need to do {QUEST_GIVER.NAME}'s dirty work. For the sake of your honor, {?PLAYER.GENDER}lady{?}sir{\\?}, listen to me!", null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
				TextObject textObject2 = new TextObject("{=zliqo1Y8}{?PLAYER.GENDER}Madam{?}Sir{\\?}, I will pay double whatever {?QUEST_GIVER.GENDER}she{?}he{\\?} promised to release me. Believe me, you don't want a reputation as {?QUEST_GIVER.GENDER}her{?}his{\\?} kidnapper-for-hire.", null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
				TextObject textObject3 = new TextObject("{=uBcBuDKV}It's no worse than taking {QUEST_GIVER.NAME}'s silver in the first place for this task. Do think it over.", null);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
				return DialogFlow.CreateDialogFlow("start", 125).NpcLine(textObject, null, null).Condition(new ConversationSentence.OnConditionDelegate(this.after_taken_prisoner_counter_offer_condition))
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.FirstCounterOfferFinished))
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=SJfqzt8m}Go on... I'm listening", null), null)
					.NpcLine(textObject2, null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=rFriAZcL}Can you really pay me {BASE_REWARD_X_2}{GOLD_ICON} for your freedom?", null), null)
					.Condition(new ConversationSentence.OnConditionDelegate(this.set_reward_x_2_and_gold_icon))
					.NpcLine(new TextObject("{=59ijHPtR}Yes. That is a lot but yes I can pay that.", null), null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=E8wdxbui}All right, I accept. I release you now. Now pay me.", null), null)
					.NpcLine(new TextObject("{=bWbcuOji}Yes. That is a lot but yes I can pay that. Thank you {?PLAYER.GENDER}milady{?}my Lord{\\?}. I knew we could reach an agreement.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestFailCounterOfferAccepted))
					.CloseDialog()
					.PlayerOption(new TextObject("{=MacG8ikN}I will think about it.", null), null)
					.NpcLine(new TextObject("{=UKTjwBxk}Please be quick about it!", null), null, null)
					.CloseDialog()
					.EndPlayerOptions()
					.PlayerOption(new TextObject("{=czuvE3PC}Do you think I will break my word for a handful more silver?", null), null)
					.NpcLine(textObject3, null, null)
					.CloseDialog()
					.EndPlayerOptions()
					.PlayerOption(new TextObject("{=2v0eQ755}Sorry, not interested.", null), null)
					.NpcLine(new TextObject("{=D1biQObM}I will pay double whatever {ISSUE_OWNER.NAME} is paying you! Please consider my offer!", null), null, null)
					.CloseDialog()
					.EndPlayerOptions();
			}

			// Token: 0x06004EDF RID: 20191 RVA: 0x0015DDE4 File Offset: 0x0015BFE4
			private DialogFlow GetTargetHeroCounterOffer2DialogFlow()
			{
				return DialogFlow.CreateDialogFlow("start", 125).NpcLine(new TextObject("{=QDMbaUYv}My {?PLAYER.GENDER}lady{?}lord{\\?}! please tell me you have decided to release me.[if:convo_nervous]", null), null, null).Condition(new ConversationSentence.OnConditionDelegate(this.counter_offer_2_condition))
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=tNo1Dctm}Yes. If you pay me {BASE_REWARD_X_2}{GOLD_ICON}, I will release you", null), null)
					.Condition(new ConversationSentence.OnConditionDelegate(this.set_reward_x_2_and_gold_icon))
					.NpcLine(new TextObject("{=jeljPTgV}Thank you, my {?PLAYER.GENDER}lady{?}lord{\\?}. I knew we could reach an agreement.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestFailCounterOfferAccepted))
					.PlayerOption(new TextObject("{=AOgrLJos}No. I haven't decided yet.", null), null)
					.NpcLine(new TextObject("{=UKTjwBxk}Please be quick about it!", null), null, null)
					.CloseDialog()
					.EndPlayerOptions();
			}

			// Token: 0x06004EE0 RID: 20192 RVA: 0x0015DE98 File Offset: 0x0015C098
			private DialogFlow GetQuestGiversAgentDialogFlow()
			{
				return DialogFlow.CreateDialogFlow("start", 125).NpcLine(new TextObject("{=lYhWyuCM}Greetings {?PLAYER.GENDER}milady{?}sir{\\?}, {QUEST_GIVER.NAME} has sent me to collect {TARGET_HERO.NAME}.", null), null, null).Condition(new ConversationSentence.OnConditionDelegate(this.quest_givers_agent_dialog_condition))
					.NpcLine(new TextObject("{=1PCaW5YI}My liege {QUEST_GIVER.NAME} also instructed me to present you the sum of {REWARD_GOLD}{GOLD_ICON} denars for the prisoners exchange.", null), null, null)
					.NpcLine(new TextObject("{=Mt1cSesD}My {?PLAYER.GENDER}lady{?}lord{\\?} also instructed me to express {?QUEST_GIVER.GENDER}her{?}his{\\?} gratitude for your services, and admiration for your skill.", null), null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=itHCs6bB}I'm delivering {?TARGET_HERO.GENDER}her{?}him{\\?} as I promised.", null), null)
					.NpcLine(new TextObject("{=RScf2bnd}Thank you {?PLAYER.GENDER}milady{?}sir{\\?}. My liege {?QUEST_GIVER.GENDER}lady{?}lord{\\?} {QUEST_GIVER.NAME} sends {?QUEST_GIVER.GENDER}her{?}his{\\?} regards. Here is the reward {?QUEST_GIVER.GENDER}she{?}he{\\?} has promised. I must take my leave now.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.PlayerDeliveredPrisonerQuestSuccess))
					.CloseDialog()
					.PlayerOption(new TextObject("{=uHY7NqZf}I can't do this. I am releasing {TARGET_HERO.NAME}. Tell your master that {TARGET_HERO.NAME} is no longer a prisoner.", null), null)
					.NpcLine(new TextObject("{=A8NttdZY}My {?QUEST_GIVER.GENDER}lady{?}lord{\\?} will be furious that you are going back on your word.", null), null, null)
					.PlayerLine(new TextObject("{=UaSddsa2}My decision is final.", null), null)
					.NpcLine(new TextObject("{=XrUPGyRO}You will regret your decision...", null), null, null)
					.CloseDialog()
					.EndPlayerOptions()
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestFailCounterOfferAccepted));
			}

			// Token: 0x06004EE1 RID: 20193 RVA: 0x0015DF98 File Offset: 0x0015C198
			private bool quest_givers_agent_dialog_condition()
			{
				StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, null, false);
				StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, null, false);
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, null, false);
				MBTextManager.SetTextVariable("REWARD_GOLD", this.RewardGold);
				GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				return CharacterObject.OneToOneConversationCharacter == this._questGiversAgentCharacterObject;
			}

			// Token: 0x06004EE2 RID: 20194 RVA: 0x0015E013 File Offset: 0x0015C213
			private void FirstCounterOfferFinished()
			{
				this._firstCounterOfferMade = true;
				TakePrisonerAction.Apply(PartyBase.MainParty, this._targetHero);
			}

			// Token: 0x06004EE3 RID: 20195 RVA: 0x0015E02C File Offset: 0x0015C22C
			private bool common_first_dialogue_condition()
			{
				return Hero.OneToOneConversationHero == this._targetHero && this._targetHero.CurrentSettlement == null && !this.PlayerCapturedTargetHero && Campaign.Current.CurrentConversationContext != ConversationContext.CapturedLord;
			}

			// Token: 0x06004EE4 RID: 20196 RVA: 0x0015E062 File Offset: 0x0015C262
			private void player_target_hero_encounter_consequence()
			{
				GameMenu.SwitchToMenu("encounter");
			}

			// Token: 0x06004EE5 RID: 20197 RVA: 0x0015E06E File Offset: 0x0015C26E
			private bool target_hero_encounter_agressive_condition()
			{
				return this.common_first_dialogue_condition() && this._targetHero.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction);
			}

			// Token: 0x06004EE6 RID: 20198 RVA: 0x0015E094 File Offset: 0x0015C294
			private bool target_hero_encounter_default_condition()
			{
				return this.common_first_dialogue_condition() && !FactionManager.IsAlliedWithFaction(this._targetHero.MapFaction, Hero.MainHero.MapFaction);
			}

			// Token: 0x06004EE7 RID: 20199 RVA: 0x0015E0C0 File Offset: 0x0015C2C0
			private bool after_taken_prisoner_counter_offer_condition()
			{
				if (Campaign.Current.CurrentConversationContext == ConversationContext.CapturedLord)
				{
					StringHelpers.SetCharacterProperties("ISSUE_OWNER", base.QuestGiver.CharacterObject, null, false);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, null, false);
					return Hero.OneToOneConversationHero == this._targetHero && !this._firstCounterOfferMade;
				}
				return false;
			}

			// Token: 0x06004EE8 RID: 20200 RVA: 0x0015E11E File Offset: 0x0015C31E
			private bool counter_offer_2_condition()
			{
				StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, null, false);
				return Hero.OneToOneConversationHero == this._targetHero && this.PlayerCapturedTargetHero && this._firstCounterOfferMade;
			}

			// Token: 0x06004EE9 RID: 20201 RVA: 0x0015E14F File Offset: 0x0015C34F
			private bool set_reward_x_2_and_gold_icon()
			{
				MBTextManager.SetTextVariable("BASE_REWARD_X_2", this.RewardGold * 2);
				GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				return true;
			}

			// Token: 0x06004EEA RID: 20202 RVA: 0x0015E174 File Offset: 0x0015C374
			private void QuestFailCounterOfferAccepted()
			{
				GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, this.RewardGold * 2, false);
				ChangeRelationAction.ApplyPlayerRelation(this._targetHero, 10, true, true);
				this.RelationshipChangeWithQuestGiver = -15;
				EndCaptivityAction.ApplyByReleasedByChoice(new FlattenedTroopRoster(1) { 
				{
					this._targetHero.CharacterObject,
					false,
					0
				} });
				base.AddLog(this._playerAcceptedOfferQuestFail, false);
				base.CompleteQuestWithBetrayal(null);
			}

			// Token: 0x06004EEB RID: 20203 RVA: 0x0015E1E0 File Offset: 0x0015C3E0
			private void PlayerDeliveredPrisonerQuestSuccess()
			{
				GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, this.RewardGold, false);
				ChangeRelationAction.ApplyPlayerRelation(this._targetHero, -10, true, true);
				this.RelationshipChangeWithQuestGiver = 15;
				base.AddLog(this._playerDeliveredPrisonerQuestSuccess, false);
				base.CompleteQuestWithSuccess();
				if (Hero.OneToOneConversationHero == base.QuestGiver)
				{
					TransferPrisonerAction.Apply(this._targetHero.CharacterObject, PartyBase.MainParty, (base.QuestGiver.PartyBelongedTo != null) ? base.QuestGiver.PartyBelongedTo.Party : base.QuestGiver.CurrentSettlement.Party);
					return;
				}
				TransferPrisonerAction.Apply(this._targetHero.CharacterObject, PartyBase.MainParty, Settlement.CurrentSettlement.Party);
			}

			// Token: 0x06004EEC RID: 20204 RVA: 0x0015E29B File Offset: 0x0015C49B
			private void QuestAcceptedConsequences()
			{
				base.StartQuest();
				base.AddLog(this._playerStartsQuestLogText, false);
			}

			// Token: 0x06004EED RID: 20205 RVA: 0x0015E2B1 File Offset: 0x0015C4B1
			protected override void OnTimedOut()
			{
				this.RelationshipChangeWithQuestGiver = -5;
				base.AddLog(this._timeOutLogText, false);
			}

			// Token: 0x06004EEE RID: 20206 RVA: 0x0015E2C9 File Offset: 0x0015C4C9
			protected override void InitializeQuestOnGameLoad()
			{
				this.SetDialogs();
			}

			// Token: 0x06004EEF RID: 20207 RVA: 0x0015E2D4 File Offset: 0x0015C4D4
			protected override void RegisterEvents()
			{
				CampaignEvents.OnPlayerBattleEndEvent.AddNonSerializedListener(this, new Action<MapEvent>(this.OnPlayerBattleEventEnded));
				CampaignEvents.HeroPrisonerTaken.AddNonSerializedListener(this, new Action<PartyBase, Hero>(this.OnPrisonerTaken));
				CampaignEvents.WarDeclared.AddNonSerializedListener(this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
				CampaignEvents.ClanChangedKingdom.AddNonSerializedListener(this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
				CampaignEvents.HeroPrisonerReleased.AddNonSerializedListener(this, new Action<Hero, PartyBase, IFaction, EndCaptivityDetail>(this.OnPrisonerReleased));
				CampaignEvents.SettlementEntered.AddNonSerializedListener(this, new Action<MobileParty, Settlement, Hero>(this.OnSettlementEntered));
				CampaignEvents.HeroKilledEvent.AddNonSerializedListener(this, new Action<Hero, Hero, KillCharacterAction.KillCharacterActionDetail, bool>(this.OnHeroKilled));
				CampaignEvents.MapEventStarted.AddNonSerializedListener(this, new Action<MapEvent, PartyBase, PartyBase>(this.OnMapEventStarted));
			}

			// Token: 0x06004EF0 RID: 20208 RVA: 0x0015E399 File Offset: 0x0015C599
			private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
			{
				if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
				{
					QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
				}
			}

			// Token: 0x06004EF1 RID: 20209 RVA: 0x0015E3AC File Offset: 0x0015C5AC
			private void OnPrisonerReleased(Hero prisoner, PartyBase party, IFaction capturerFaction, EndCaptivityDetail detail)
			{
				if (base.IsOngoing && this.PlayerCapturedTargetHero && prisoner == this._targetHero)
				{
					TextObject textObject = new TextObject("{=VuwaQjUN}{TARGET_HERO.LINK} has managed to escape and {?TARGET_HERO.GENDER}she{?}he{\\?} is no longer a prisoner.", null);
					StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
					base.AddLog(textObject, false);
					this._firstCounterOfferMade = false;
				}
			}

			// Token: 0x06004EF2 RID: 20210 RVA: 0x0015E406 File Offset: 0x0015C606
			private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
			{
				this.CheckCancelConditions(DiplomacyHelper.IsWarCausedByPlayer(faction1, faction2, detail));
			}

			// Token: 0x06004EF3 RID: 20211 RVA: 0x0015E416 File Offset: 0x0015C616
			private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
			{
				this.CheckCancelConditions(false);
			}

			// Token: 0x06004EF4 RID: 20212 RVA: 0x0015E420 File Offset: 0x0015C620
			private void OnHeroKilled(Hero victim, Hero killer, KillCharacterAction.KillCharacterActionDetail detail, bool showNotification = true)
			{
				if (victim == this._targetHero)
				{
					if (killer == Hero.MainHero)
					{
						base.AddLog(this._targetKilledByPlayerLogText, false);
						GainRenownAction.Apply(Hero.MainHero, 10f, false);
						this.RelationshipChangeWithQuestGiver = 10;
						base.CompleteQuestWithSuccess();
						return;
					}
					base.CompleteQuestWithCancel(null);
					base.AddLog(this._targetDiedLogText, false);
				}
			}

			// Token: 0x06004EF5 RID: 20213 RVA: 0x0015E480 File Offset: 0x0015C680
			private void OnSettlementEntered(MobileParty party, Settlement settlement, Hero hero)
			{
				if (this.PlayerCapturedTargetHero && hero == Hero.MainHero && party == MobileParty.MainParty && settlement.IsFortification && settlement.OwnerClan == base.QuestGiver.Clan)
				{
					this._questGiversAgentCharacterObject = MBObjectManager.Instance.GetObject<CharacterObject>("guard_" + base.QuestGiver.Culture.StringId);
					CampaignMapConversation.OpenConversation(new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, false, false, false, false, false, false), new ConversationCharacterData(this._questGiversAgentCharacterObject, null, false, false, false, false, false, false));
				}
			}

			// Token: 0x06004EF6 RID: 20214 RVA: 0x0015E51C File Offset: 0x0015C71C
			private void OnPlayerBattleEventEnded(MapEvent mapEvent)
			{
				if ((mapEvent.IsPlayerMapEvent || mapEvent.IsPlayerSimulation) && mapEvent.PartiesOnSide(mapEvent.GetOtherSide(mapEvent.PlayerSide)).Any((MapEventParty x) => x.Party.Owner == this._targetHero) && mapEvent.HasWinner && mapEvent.WinningSide == mapEvent.PlayerSide && !this._targetHero.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
				{
					ChangeRelationAction.ApplyPlayerRelation(this._targetHero.MapFaction.Leader, -10, true, true);
					DeclareWarAction.ApplyByPlayerHostility(Hero.MainHero.MapFaction, this._targetHero.MapFaction);
				}
			}

			// Token: 0x06004EF7 RID: 20215 RVA: 0x0015E5C8 File Offset: 0x0015C7C8
			private void OnPrisonerTaken(PartyBase capturer, Hero prisoner)
			{
				if (prisoner == this._targetHero)
				{
					if (capturer == PartyBase.MainParty)
					{
						base.AddLog(this._playerCapturedTargetBrief1LogText, false);
						base.AddLog(this._playerCapturedTargetBrief2LogText, false);
						base.AddLog(this._playerCapturedTargetBrief3LogText, false);
						return;
					}
					if (base.QuestGiver.PartyBelongedTo != null && capturer == base.QuestGiver.PartyBelongedTo.Party)
					{
						if (base.IsOngoing)
						{
							base.AddLog(this._questGiverCapturedTargetHero, false);
							base.CompleteQuestWithCancel(null);
							return;
						}
					}
					else
					{
						TextObject textObject = TextObject.Empty;
						if (capturer.IsMobile)
						{
							textObject = new TextObject("{=gq8sgb2J}{TARGET_HERO.LINK} has been taken prisoner by {OTHER_HERO.LINK}.", null);
							StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
							StringHelpers.SetCharacterProperties("OTHER_HERO", ConversationHelper.GetConversationCharacterPartyLeader(capturer), textObject, false);
						}
						else if (capturer.IsSettlement)
						{
							textObject = new TextObject("{=HkvlHhPN}{TARGET_HERO.LINK} has been taken prisoner and thrown into the dungeons of {SETTLEMENT}.", null);
							StringHelpers.SetCharacterProperties("TARGET_HERO", this._targetHero.CharacterObject, textObject, false);
							textObject.SetTextVariable("SETTLEMENT", capturer.Settlement.EncyclopediaLinkWithName);
						}
						if (textObject != TextObject.Empty)
						{
							base.AddLog(textObject, false);
						}
					}
				}
			}

			// Token: 0x06004EF8 RID: 20216 RVA: 0x0015E6F0 File Offset: 0x0015C8F0
			private void CheckCancelConditions(bool causedByPlayer = false)
			{
				if (base.IsOngoing)
				{
					if (base.QuestGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
					{
						if (causedByPlayer)
						{
							base.CompleteQuestWithFail(null);
						}
						else
						{
							base.CompleteQuestWithCancel(null);
						}
						base.AddLog(this._warDeclaredQuestLog, false);
						return;
					}
					if (base.QuestGiver.MapFaction == this._targetHero.MapFaction)
					{
						base.CompleteQuestWithCancel(null);
						base.AddLog(this._targetHeroAndQuestGiverInSameFaction, false);
					}
				}
			}

			// Token: 0x04001A6E RID: 6766
			[SaveableField(1)]
			private Hero _targetHero;

			// Token: 0x04001A6F RID: 6767
			[SaveableField(2)]
			private bool _firstCounterOfferMade;

			// Token: 0x04001A70 RID: 6768
			private CharacterObject _questGiversAgentCharacterObject;
		}

		// Token: 0x0200064D RID: 1613
		public class LordWantsRivalCapturedIssueTypeDefiner : SaveableTypeDefiner
		{
			// Token: 0x06004EFD RID: 20221 RVA: 0x0015E7BF File Offset: 0x0015C9BF
			public LordWantsRivalCapturedIssueTypeDefiner()
				: base(51400)
			{
			}

			// Token: 0x06004EFE RID: 20222 RVA: 0x0015E7CC File Offset: 0x0015C9CC
			protected override void DefineClassTypes()
			{
				base.AddClassDefinition(typeof(LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssue), 1, null);
				base.AddClassDefinition(typeof(LordWantsRivalCapturedIssueBehavior.LordWantsRivalCapturedIssueQuest), 2, null);
			}
		}
	}
}
