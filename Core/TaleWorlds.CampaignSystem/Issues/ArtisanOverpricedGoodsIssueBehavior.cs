using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues
{
	public class ArtisanOverpricedGoodsIssueBehavior : CampaignBehaviorBase
	{
		private static IEnumerable<ItemObject> PossibleRequestedItems
		{
			get
			{
				yield return MBObjectManager.Instance.GetObject<ItemObject>("cow");
				yield return MBObjectManager.Instance.GetObject<ItemObject>("sheep");
				yield return MBObjectManager.Instance.GetObject<ItemObject>("wool");
				yield return MBObjectManager.Instance.GetObject<ItemObject>("iron");
				yield return MBObjectManager.Instance.GetObject<ItemObject>("leather");
				yield return MBObjectManager.Instance.GetObject<ItemObject>("hardwood");
				yield break;
			}
		}

		public override void RegisterEvents()
		{
			CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, new Action<Hero>(this.OnCheckForIssue));
		}

		public override void SyncData(IDataStore dataStore)
		{
		}

		public void OnCheckForIssue(Hero hero)
		{
			Hero hero2;
			ItemObject itemObject;
			if (this.ConditionsHold(hero, out hero2, out itemObject))
			{
				KeyValuePair<Hero, ItemObject> keyValuePair = new KeyValuePair<Hero, ItemObject>(hero2, itemObject);
				Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnStartIssue), typeof(ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue), IssueBase.IssueFrequency.Common, keyValuePair));
				return;
			}
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue), IssueBase.IssueFrequency.Common));
		}

		private Hero GetAntagonistMerchant(Hero issueOwner)
		{
			return issueOwner.CurrentSettlement.Notables.GetRandomElementWithPredicate((Hero x) => x != issueOwner && x.IsMerchant && x.GetTraitLevel(DefaultTraits.Mercy) <= 0 && x.CanHaveQuestsOrIssues());
		}

		private bool ConditionsHold(Hero IssueOwner, out Hero antagonistMerchant, out ItemObject requestedItem)
		{
			antagonistMerchant = null;
			requestedItem = null;
			if (IssueOwner.CurrentSettlement != null && IssueOwner.CurrentSettlement.IsTown && IssueOwner.IsArtisan)
			{
				antagonistMerchant = this.GetAntagonistMerchant(IssueOwner);
				if (antagonistMerchant != null)
				{
					foreach (ItemObject itemObject in ArtisanOverpricedGoodsIssueBehavior.PossibleRequestedItems)
					{
						if (IssueOwner.CurrentSettlement.Town.GetItemCategoryPriceIndex(itemObject.ItemCategory) > 1.4f)
						{
							requestedItem = itemObject;
							return true;
						}
					}
					return false;
				}
				return false;
			}
			return false;
		}

		private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
		{
			PotentialIssueData potentialIssueData = pid;
			KeyValuePair<Hero, ItemObject> keyValuePair = (KeyValuePair<Hero, ItemObject>)potentialIssueData.RelatedObject;
			return new ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue(issueOwner, keyValuePair.Key, keyValuePair.Value);
		}

		private const IssueBase.IssueFrequency ArtisanOverpricedGoodsIssueFrequency = IssueBase.IssueFrequency.Common;

		private const float HighestPriceIndexAtTown = 1.4f;

		public class ArtisanOverpricedGoodsIssue : IssueBase
		{
			internal static void AutoGeneratedStaticCollectObjectsArtisanOverpricedGoodsIssue(object o, List<object> collectedObjects)
			{
				((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._requestedTradeGood);
				collectedObjects.Add(this.CounterOfferHero);
			}

			internal static object AutoGeneratedGetMemberValueRequestedTradeGoodAmount(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue)o).RequestedTradeGoodAmount;
			}

			internal static object AutoGeneratedGetMemberValueCounterOfferHero(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue)o).CounterOfferHero;
			}

			internal static object AutoGeneratedGetMemberValue_goldReward(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue)o)._goldReward;
			}

			internal static object AutoGeneratedGetMemberValue_requestedTradeGood(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue)o)._requestedTradeGood;
			}

			public override int AlternativeSolutionBaseNeededMenCount
			{
				get
				{
					return 4 + MathF.Ceiling(6f * base.IssueDifficultyMultiplier);
				}
			}

			protected override int AlternativeSolutionBaseDurationInDaysInternal
			{
				get
				{
					return 3 + MathF.Ceiling(5f * base.IssueDifficultyMultiplier);
				}
			}

			public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
			{
				get
				{
					return IssueBase.AlternativeSolutionScaleFlag.Duration;
				}
			}

			protected override int RewardGold
			{
				get
				{
					return this._goldReward;
				}
			}

			[SaveableProperty(12)]
			private int RequestedTradeGoodAmount { get; set; }

			private int RequiredGoldForAlternativeSolution
			{
				get
				{
					return MathF.Floor((float)(this._requestedTradeGood.Value * this.RequestedTradeGoodAmount) * 0.75f);
				}
			}

			[SaveableProperty(11)]
			public override Hero CounterOfferHero { get; protected set; }

			public override int NeededInfluenceForLordSolution
			{
				get
				{
					return 15 + MathF.Ceiling(35f * base.IssueDifficultyMultiplier);
				}
			}

			public override TextObject IssueBriefByIssueGiver
			{
				get
				{
					return new TextObject("{=FKtkmwtb}I don't know if you know much about the law here... Craftsmen like me are required to buy our raw materials from local merchants. The other side of the bargain is that they offer us reasonable prices. But they're not doing that! They've come together and agreed on a price that's just too high. They don't care if it ruins us - they can always sell the goods elsewhere.[ib:hip][if:convo_thinking]", null);
				}
			}

			public override TextObject IssueAcceptByPlayer
			{
				get
				{
					return new TextObject("{=j4V4fVBd}I see... How can I help?", null);
				}
			}

			protected override TextObject LordSolutionStartLog
			{
				get
				{
					return new TextObject("{=p5OHK0Lh}You decided to issue a decree banning the merchants' price-fixing arrangement.", null);
				}
			}

			protected override TextObject LordSolutionCounterOfferRefuseLog
			{
				get
				{
					return new TextObject("{=wrliXWLc}You approved the law which prevents price fixing in the markets and rejected the merchants' counter-offer.", null);
				}
			}

			protected override TextObject LordSolutionCounterOfferAcceptLog
			{
				get
				{
					return new TextObject("{=bSguu34C}After listening to the town merchants, you decided to let the merchants continue price-fixing.", null);
				}
			}

			public override TextObject IssueQuestSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=epcc2knY}Well, you get around, right? It wouldn't be hard for you to collect the {.%}{SELECTED_GOOD}{.%} we need. If you could bring, say {SELECTED_AMOUNT} {.%}{?SELECTED_AMOUNT > 1}{PLURAL(SELECTED_GOOD)}{?}{SELECTED_GOOD}{\\?}{.%} directly to me instead of selling to the merchants, I would gladly pay {REWARD_AMOUNT}{GOLD_ICON} for them. With this, the merchants would have to lower their prices.[if:convo_calm_friendly][ib:confident3]", null);
					textObject.SetTextVariable("SELECTED_GOOD", this._requestedTradeGood.Name);
					textObject.SetTextVariable("SELECTED_AMOUNT", this.RequestedTradeGoodAmount);
					textObject.SetTextVariable("REWARD_AMOUNT", this.RewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=XvC1eLR1}Or, if you will not be able to acquire the goods yourself, you can perhaps assign one of your trusted companions to the task. Somewhat with a good understanding of trade and and around {TROOP_NUMBER} {?TROOP_NUMBER}troops{?}troop{\\?} could do it easily enough, along with {GOLD_COST}{GOLD_ICON} denars to make the purchases.[ib:normal2][if:convo_undecided_open]", null);
					textObject.SetTextVariable("TROOP_NUMBER", base.GetTotalAlternativeSolutionNeededMenCount());
					textObject.SetTextVariable("GOLD_COST", this.RequiredGoldForAlternativeSolution);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			public override TextObject IssueLordSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=JeL0aUOa}You could stop them with a decree, my {?PLAYER.GENDER}lady{?}lord{\\?}. All the craftsmen here would be very grateful.", null);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueQuestSolutionAcceptByPlayer
			{
				get
				{
					TextObject textObject = new TextObject("{=mTuIMcLA}All right. I will bring {SELECTED_AMOUNT} {.%}{?SELECTED_AMOUNT > 1}{PLURAL(SELECTED_GOOD)}{?}{SELECTED_GOOD}{\\?}{.%} to you.", null);
					textObject.SetTextVariable("SELECTED_GOOD", this._requestedTradeGood.Name);
					textObject.SetTextVariable("SELECTED_AMOUNT", this.RequestedTradeGoodAmount);
					return textObject;
				}
			}

			public override TextObject IssueAlternativeSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=79h7xNeL}I will have one of my companions take care of this.", null);
				}
			}

			public override TextObject IssueDiscussAlternativeSolution
			{
				get
				{
					return new TextObject("{=E9GhODyh}I am very grateful to you for sparing your men to help us get what we need for a fair price.[if:convo_approving][ib:normal2]", null);
				}
			}

			public override TextObject IssueAlternativeSolutionResponseByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=2YiPE05P}Thank you, my {?PLAYER.GENDER}lady{?}lord{\\?}. Your companion will no doubt be very helpful.", null);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueLordSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=xTKHO53L}This is outrageous. I declare that from now on that there shall be no price fixing.", null);
				}
			}

			public override TextObject IssueLordSolutionResponseByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=6vPCEaSR}Thank you, my {?PLAYER.GENDER}lady{?}lord{\\?} that would be very good. Merchants will not like this but the hard-working artisans like me will be grateful to you for this.", null);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueLordSolutionCounterOfferBriefByOtherNpc
			{
				get
				{
					return new TextObject("{=ojNK5Zem}(One of the merchants in the town comes to talk as you are preparing to depart.)", null);
				}
			}

			public override TextObject IssueLordSolutionCounterOfferExplanationByOtherNpc
			{
				get
				{
					return new TextObject("{=8Tqv9ezH}We heard you wish to issue a decree changing our longstanding rules on pricing. Of course this is your right, but I'd like to remind you that we merchants pay significantly more taxes than the artisans. I would ask you to think of the finances of the town, and reconsider this.", null);
				}
			}

			public override TextObject IssueLordSolutionCounterOfferAcceptByPlayer
			{
				get
				{
					return new TextObject("{=FyTGbvLS}On second thought, I have decided not to interfere with the merchant's business.", null);
				}
			}

			public override TextObject IssueLordSolutionCounterOfferAcceptResponseByOtherNpc
			{
				get
				{
					TextObject textObject = new TextObject("{=wynCFpsT}This is a wise decision, my {?PLAYER.GENDER}lady{?}lord{\\?}. Thank you.", null);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueLordSolutionCounterOfferDeclineByPlayer
			{
				get
				{
					return new TextObject("{=IXuaflOe}I stand by my decision.", null);
				}
			}

			public override TextObject IssueLordSolutionCounterOfferDeclineResponseByOtherNpc
			{
				get
				{
					return new TextObject("{=ypAPaO1J}That's a pity.", null);
				}
			}

			protected override void LordSolutionConsequenceWithRefuseCounterOffer()
			{
				this.ApplySuccessRewards(base.IssueOwner);
			}

			protected override void LordSolutionConsequenceWithAcceptCounterOffer()
			{
				ChangeRelationAction.ApplyPlayerRelation(this.CounterOfferHero, 5, true, true);
				this.RelationshipChangeWithIssueOwner = -5;
				base.IssueSettlement.Town.Prosperity -= 30f;
				TraitLevelingHelper.OnIssueSolvedThroughBetrayal(base.IssueOwner, new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, -50)
				});
				base.IssueOwner.AddPower(-5f);
			}

			protected override TextObject AlternativeSolutionStartLog
			{
				get
				{
					TextObject textObject = new TextObject("{=aeKdXKnO}{ISSUE_GIVER.LINK}, an artisan from {SETTLEMENT}, has told you that a local merchant {COUNTER_OFFER.LINK} is asking ridiculous amounts of money for raw materials which {?ISSUE_GIVER.GENDER}she{?}he{\\?} needs to continue {?ISSUE_GIVER.GENDER}her{?}his{\\?} work. {?ISSUE_GIVER.GENDER}She{?}He{\\?} is willing to pay {REWARD_AMOUNT}{GOLD_ICON} for help obtaining the needed goods.{newline}You asked {COMPANION.LINK} to stay with {?ISSUE_GIVER.GENDER}her{?}him{\\?} and try to solve {?ISSUE_GIVER.GENDER}her{?}his{\\?} problems. You expect {COMPANION.LINK} to report back to you in {RETURN_DAYS} days.", null);
					StringHelpers.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("COUNTER_OFFER", this.CounterOfferHero.CharacterObject, textObject, false);
					textObject.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, false);
					textObject.SetTextVariable("SETTLEMENT", base.IssueOwner.CurrentSettlement.EncyclopediaLinkWithName);
					textObject.SetTextVariable("REWARD_AMOUNT", this.RewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					textObject.SetTextVariable("RETURN_DAYS", base.GetTotalAlternativeSolutionDurationInDays());
					return textObject;
				}
			}

			public override bool IsThereAlternativeSolution
			{
				get
				{
					return true;
				}
			}

			public override bool IsThereLordSolution
			{
				get
				{
					return true;
				}
			}

			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=dt6kKXSL}Overpriced Raw Materials at {SETTLEMENT}", null);
					textObject.SetTextVariable("SETTLEMENT", base.IssueSettlement.Name);
					return textObject;
				}
			}

			public override TextObject Description
			{
				get
				{
					TextObject textObject = new TextObject("{=U90asNb9}Artisans in {SETTLEMENT} cannot continue their work because of the overpriced raw materials.", null);
					textObject.SetTextVariable("SETTLEMENT", base.IssueOwner.CurrentSettlement.Name);
					return textObject;
				}
			}

			public override TextObject IssueAsRumorInSettlement
			{
				get
				{
					TextObject textObject = new TextObject("{=FPbmUpy7}{QUEST_GIVER.NAME} is in quite a stew over the merchants' monopoly, so I hear.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					return textObject;
				}
			}

			public override TextObject IssueAlternativeSolutionSuccessLog
			{
				get
				{
					TextObject textObject = new TextObject("{=3r2HLPQ1}Your {COMPANION.LINK} has delivered {ISSUE_GIVER.LINK}'s goods as you promised.", null);
					textObject.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, false);
					textObject.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject, false);
					return textObject;
				}
			}

			public ArtisanOverpricedGoodsIssue(Hero issueOwner, Hero counterOfferHero, ItemObject requestedTradeGood)
				: base(issueOwner, CampaignTime.DaysFromNow(30f))
			{
				this.CounterOfferHero = counterOfferHero;
				this._requestedTradeGood = requestedTradeGood;
				this.CalculateTradeGoodsAmountAndReward();
			}

			protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
			{
				if (issueEffect == DefaultIssueEffects.SettlementProsperity)
				{
					return -0.4f;
				}
				return 0f;
			}

			public override bool IssueStayAliveConditions()
			{
				return base.IssueOwner.CurrentSettlement.Town.GetItemCategoryPriceIndex(this._requestedTradeGood.ItemCategory) > 1.1999999f && this.CounterOfferHero.IsActive && this.CounterOfferHero.CurrentSettlement == base.IssueSettlement;
			}

			protected override void CompleteIssueWithTimedOutConsequences()
			{
			}

			public override ValueTuple<SkillObject, int> GetAlternativeSolutionSkill(Hero hero)
			{
				return new ValueTuple<SkillObject, int>((hero.GetSkillValue(DefaultSkills.Roguery) >= hero.GetSkillValue(DefaultSkills.Trade)) ? DefaultSkills.Roguery : DefaultSkills.Trade, 120);
			}

			public override bool AlternativeSolutionCondition(out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false) && QuestHelper.CheckGoldForAlternativeSolution(this.RequiredGoldForAlternativeSolution, ref explanation);
			}

			public override bool DoTroopsSatisfyAlternativeSolution(TroopRoster troopRoster, out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false);
			}

			public override void AlternativeSolutionStartConsequence()
			{
				GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, this.RequiredGoldForAlternativeSolution, false);
			}

			protected override void AlternativeSolutionEndWithSuccessConsequence()
			{
				this.ApplySuccessRewards(base.IssueOwner);
			}

			public override bool LordSolutionCondition(out TextObject explanation)
			{
				if (Clan.PlayerClan == Settlement.CurrentSettlement.OwnerClan)
				{
					explanation = TextObject.Empty;
					return true;
				}
				explanation = new TextObject("{=bItEf0WN}You need to be the {?PLAYER.GENDER}lady{?}lord{\\?} of this settlement.", null);
				StringHelpers.SetCharacterProperties("PLAYER", Hero.MainHero.CharacterObject, explanation, false);
				return false;
			}

			protected override int CompanionSkillRewardXP
			{
				get
				{
					return (int)(400f + 1700f * base.IssueDifficultyMultiplier);
				}
			}

			private void ApplySuccessRewards(Hero issueGiver)
			{
				issueGiver.AddPower(10f);
				ChangeRelationAction.ApplyPlayerRelation(issueGiver, 5, true, true);
				ChangeRelationAction.ApplyPlayerRelation(this.CounterOfferHero, -10, true, true);
				this.CounterOfferHero.AddPower(-10f);
				issueGiver.CurrentSettlement.Town.Prosperity += 30f;
			}

			public override IssueBase.IssueFrequency GetFrequency()
			{
				return IssueBase.IssueFrequency.Common;
			}

			protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out IssueBase.PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
			{
				flag = IssueBase.PreconditionFlags.None;
				relationHero = null;
				skill = null;
				if (issueGiver.GetRelationWithPlayer() < -10f)
				{
					flag |= IssueBase.PreconditionFlags.Relation;
					relationHero = issueGiver;
				}
				return flag == IssueBase.PreconditionFlags.None;
			}

			private void CalculateTradeGoodsAmountAndReward()
			{
				this.RequestedTradeGoodAmount = MathF.Max((int)(2500f / (float)this._requestedTradeGood.Value * base.IssueDifficultyMultiplier), 1);
				this._goldReward = 300 + (int)((float)(base.IssueOwner.CurrentSettlement.Town.GetItemPrice(this._requestedTradeGood, null, false) + this._requestedTradeGood.Value) / 2f) * this.RequestedTradeGoodAmount;
			}

			protected override void OnGameLoad()
			{
				if (this.RequestedTradeGoodAmount == 0 || this._goldReward == 0)
				{
					this.CalculateTradeGoodsAmountAndReward();
				}
			}

			protected override void HourlyTick()
			{
			}

			protected override QuestBase GenerateIssueQuest(string questId)
			{
				return new ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(30f), this._requestedTradeGood, this.RewardGold, this.RequestedTradeGoodAmount, this.CounterOfferHero);
			}

			private const int RequiredTradeSkillLevelForSendingComp = 120;

			private const int BaseRewardGold = 300;

			private const int IssueDuration = 30;

			private const int QuestTimeLimit = 30;

			private const int MinimumAlternativeTroopTier = 2;

			[SaveableField(13)]
			private int _goldReward;

			[SaveableField(10)]
			private ItemObject _requestedTradeGood;
		}

		public class ArtisanOverpricedGoodsIssueQuest : QuestBase
		{
			internal static void AutoGeneratedStaticCollectObjectsArtisanOverpricedGoodsIssueQuest(object o, List<object> collectedObjects)
			{
				((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._requestedTradeGood);
				collectedObjects.Add(this._playerStartsQuestLog);
			}

			internal static object AutoGeneratedGetMemberValue_rewardGold(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o)._rewardGold;
			}

			internal static object AutoGeneratedGetMemberValue_requestedTradeGood(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o)._requestedTradeGood;
			}

			internal static object AutoGeneratedGetMemberValue_requestedTradeGoodAmount(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o)._requestedTradeGoodAmount;
			}

			internal static object AutoGeneratedGetMemberValue_givenTradeGoods(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o)._givenTradeGoods;
			}

			internal static object AutoGeneratedGetMemberValue_playerStartsQuestLog(object o)
			{
				return ((ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest)o)._playerStartsQuestLog;
			}

			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=dt6kKXSL}Overpriced Raw Materials at {SETTLEMENT}", null);
					textObject.SetTextVariable("SETTLEMENT", base.QuestGiver.CurrentSettlement.Name);
					return textObject;
				}
			}

			private Hero AntagonistHero
			{
				get
				{
					return base.QuestGiver.CurrentSettlement.Notables.FirstOrDefault((Hero x) => x != base.QuestGiver && x.IsMerchant && x.GetTraitLevel(DefaultTraits.Mercy) <= 0);
				}
			}

			public override bool IsRemainingTimeHidden
			{
				get
				{
					return false;
				}
			}

			private TextObject _playerStartsQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=IL3QWZ93}{QUEST_GIVER.LINK}, an artisan from {SETTLEMENT}, has told you about local merchant asking ridiculous amounts of money for the raw materials that {?QUEST_GIVER.GENDER}she{?}he{\\?} needs to continue {?QUEST_GIVER.GENDER}her{?}his{\\?} work. You said that you can bring {?QUEST_GIVER.GENDER}her{?}him{\\?} {REQUESTED_AMOUNT} {.%}{?REQUESTED_AMOUNT > 1}{PLURAL(REQUESTED_GOOD)}{?}{REQUESTED_GOOD}{\\?}{.%}. {?QUEST_GIVER.GENDER}She{?}He{\\?} is willing to pay {REWARD_AMOUNT}{GOLD_ICON} for these items.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("SETTLEMENT", base.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
					textObject.SetTextVariable("REQUESTED_AMOUNT", this._requestedTradeGoodAmount);
					textObject.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
					textObject.SetTextVariable("REWARD_AMOUNT", this._rewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			private TextObject _successQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=6XvszYj2}You brought {REQUESTED_AMOUNT} {.%}{?REQUESTED_AMOUNT > 1}{PLURAL(REQUESTED_GOOD)}{?}{REQUESTED_GOOD}{\\?}{.%} to {?QUEST_GIVER.GENDER}her{?}him{\\?} as promised.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("REQUESTED_AMOUNT", this._requestedTradeGoodAmount);
					textObject.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
					return textObject;
				}
			}

			private TextObject _timeoutQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=Ts5dZih4}You couldn't fully bring {.%}{REQUESTED_GOOD}{.%} to {?QUEST_GIVER.GENDER}her{?}him{\\?} in time.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
					return textObject;
				}
			}

			protected override void InitializeQuestOnGameLoad()
			{
				this.SetDialogs();
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetMerchantDialogFlow(), this);
			}

			protected override void HourlyTick()
			{
			}

			public ArtisanOverpricedGoodsIssueQuest(string questId, Hero questGiver, CampaignTime dueTime, ItemObject requestedTradeGood, int rewardGold, int requestedTradeGoodAmount, Hero counterOfferHero)
				: base(questId, questGiver, dueTime, rewardGold)
			{
				this._requestedTradeGood = requestedTradeGood;
				this._requestedTradeGoodAmount = requestedTradeGoodAmount;
				this._rewardGold = rewardGold;
				this.SetDialogs();
				base.InitializeQuestOnCreation();
			}

			protected override void SetDialogs()
			{
				this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(new TextObject("{=e1sSXEOh}This is excellent news. If you could bring the goods, it would be an immense help, and the merchants would have to lower their prices. Thank you.[if:convo_excited][ib:hip2]", null), null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences))
					.CloseDialog();
				TextObject textObject = new TextObject("{=fKnkkWH1}Have you brought any {.%}{REQUESTED_GOOD}{.%}? My stocks are running out and I need some very soon.", null);
				textObject.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
				TextObject textObject2 = new TextObject("{=bPbzwMat}I could only deliver {AMOUNT_TO_DELIVER} {.%}{?AMOUNT_TO_DELIVER > 1}{PLURAL(REQUESTED_GOOD)}{?}{REQUESTED_GOOD}{\\?}{.%}.", null);
				textObject2.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
				textObject2.SetTextVariable("AMOUNT_TO_DELIVER", this.GetAvailableRequestedItemCountOnPlayer());
				TextObject textObject3 = new TextObject("{=IfF3OHNT}Thank you. These will be very useful. If you can get your hands on more, please bring them directly to me.", null);
				TextObject textObject4 = new TextObject("{=1LzohiMf}I brought {AMOUNT_TO_DELIVER} {.%}{?AMOUNT_TO_DELIVER > 1}{PLURAL(REQUESTED_GOOD)}{?}{REQUESTED_GOOD}{\\?}{.%} as we agreed.", null);
				textObject4.SetTextVariable("AMOUNT_TO_DELIVER", this._requestedTradeGoodAmount - this._givenTradeGoods);
				textObject4.SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
				TextObject textObject5 = new TextObject("{=cxQGUbUD}I'm so grateful! You've kept my workshop running and my family fed. Please take this money and some extra to cover your costs.[if:convo_grateful][ib:normal2]", null);
				TextObject textObject6 = new TextObject("{=4uKTfTg9}Sorry. I don't have anything for you this time.", null);
				TextObject textObject7 = new TextObject("{=YWorGaI1}Ah... We'll get by. I won't lie. It will be hard. I just hope you can deliver some soon.[if:convo_normal][ib:closed]", null);
				this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(textObject, null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.BeginPlayerOptions()
					.PlayerOption(textObject2, null)
					.Condition(delegate
					{
						int availableRequestedItemCountOnPlayer = this.GetAvailableRequestedItemCountOnPlayer();
						Campaign.Current.ConversationManager.GetCurrentDialogLine().SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
						Campaign.Current.ConversationManager.GetCurrentDialogLine().SetTextVariable("AMOUNT_TO_DELIVER", availableRequestedItemCountOnPlayer);
						return availableRequestedItemCountOnPlayer > 0 && availableRequestedItemCountOnPlayer < this._requestedTradeGoodAmount - this._givenTradeGoods;
					})
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.DeliverItemsPartiallyOnConsequence))
					.NpcLine(textObject3, null, null)
					.CloseDialog()
					.PlayerOption(textObject4, null)
					.Condition(delegate
					{
						int availableRequestedItemCountOnPlayer2 = this.GetAvailableRequestedItemCountOnPlayer();
						Campaign.Current.ConversationManager.GetCurrentDialogLine().SetTextVariable("AMOUNT_TO_DELIVER", this._requestedTradeGoodAmount - this._givenTradeGoods);
						Campaign.Current.ConversationManager.GetCurrentDialogLine().SetTextVariable("REQUESTED_GOOD", this._requestedTradeGood.Name);
						return availableRequestedItemCountOnPlayer2 >= this._requestedTradeGoodAmount - this._givenTradeGoods;
					})
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.DeliverItemsFullyOnConsequence))
					.NpcLine(textObject5, null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(base.CompleteQuestWithSuccess))
					.CloseDialog()
					.PlayerOption(textObject6, null)
					.NpcLine(textObject7, null, null)
					.CloseDialog()
					.EndPlayerOptions()
					.CloseDialog();
			}

			private int GetAvailableRequestedItemCountOnPlayer()
			{
				return PartyBase.MainParty.ItemRoster.GetItemNumber(this._requestedTradeGood);
			}

			private void DeliverItemsPartiallyOnConsequence()
			{
				int num = this.GetAvailableRequestedItemCountOnPlayer();
				if (PartyBase.MainParty.ItemRoster.ElementAt(PartyBase.MainParty.ItemRoster.FindIndex((ItemObject x) => x == this._requestedTradeGood)).Amount <= 0)
				{
					num = 0;
				}
				PartyBase.MainParty.ItemRoster.AddToCounts(this._requestedTradeGood, -num);
				this._givenTradeGoods += num;
				base.UpdateQuestTaskStage(this._playerStartsQuestLog, this._givenTradeGoods);
			}

			private void DeliverItemsFullyOnConsequence()
			{
				TraitLevelingHelper.OnIssueSolvedThroughQuest(base.QuestGiver, new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, 50)
				});
				ChangeCrimeRatingAction.Apply(base.QuestGiver.MapFaction, 5f, true);
				PartyBase.MainParty.ItemRoster.AddToCounts(this._requestedTradeGood, -(this._requestedTradeGoodAmount - this._givenTradeGoods));
				this._givenTradeGoods = this._requestedTradeGoodAmount;
				base.UpdateQuestTaskStage(this._playerStartsQuestLog, this._givenTradeGoods);
			}

			private void QuestAcceptedConsequences()
			{
				base.StartQuest();
				this._playerStartsQuestLog = base.AddDiscreteLog(this._playerStartsQuestLogText, new TextObject("{=yw62BLhy}Delivered Goods", null), this._givenTradeGoods, this._requestedTradeGoodAmount, null, true);
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetMerchantDialogFlow(), this);
			}

			private DialogFlow GetMerchantDialogFlow()
			{
				TextObject textObject = new TextObject("{=YNxGcaJI}I want to talk to you about the outlandish prices you're asking for the goods you sell the artisans.", null);
				TextObject textObject2 = new TextObject("{=UwEbBanm}These are the laws of our town. The artisans don't complain when the laws require us to buy tools from them.[if:convo_bored][ib:closed2]", null);
				TextObject textObject3 = new TextObject("{=sPEZq0Yk}What's sauce for the goose is sauce for the gander. We've done business for years like this and we're not just going to change things because one party complains.[if:convo_mocking_teasing][ib:hip]", null);
				TextObject textObject4 = new TextObject("{=VzzQX4EZ}Maybe you're right. I won't get involved in this.", null);
				TextObject textObject5 = new TextObject("{=KbFJJfl6}I am sorry. I will do what I must.", null);
				TextObject textObject6 = new TextObject("{=yccVH4KD}Thank you for listening to the voice of reason.", null);
				TextObject textObject7 = new TextObject("{=A8dyXgLz}That's a pity.", null);
				return DialogFlow.CreateDialogFlow("hero_main_options", 125).PlayerLine(textObject, null).Condition(new ConversationSentence.OnConditionDelegate(this.IsSuitableToTalk))
					.NpcLine(textObject2, null, null)
					.NpcLine(textObject3, null, null)
					.BeginPlayerOptions()
					.PlayerOption(textObject4, null)
					.NpcLine(textObject6, null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.AcceptCounterOffer))
					.CloseDialog()
					.PlayerOption(textObject5, null)
					.NpcLine(textObject7, null, null)
					.CloseDialog();
			}

			private bool IsSuitableToTalk()
			{
				return Settlement.CurrentSettlement == base.QuestGiver.CurrentSettlement && CharacterObject.OneToOneConversationCharacter.IsHero && CharacterObject.OneToOneConversationCharacter.HeroObject == this.AntagonistHero;
			}

			private void AcceptCounterOffer()
			{
				Hero antagonistHero = this.AntagonistHero;
				TextObject textObject = new TextObject("{=q4wWEbsa}You decided not to deliver the items after listening to {COUNTER_OFFER_HERO.LINK}.", null);
				StringHelpers.SetCharacterProperties("COUNTER_OFFER_HERO", antagonistHero.CharacterObject, textObject, false);
				ChangeRelationAction.ApplyPlayerRelation(antagonistHero, 5, true, true);
				antagonistHero.AddPower(5f);
				TraitLevelingHelper.OnIssueSolvedThroughBetrayal(base.QuestGiver, new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, -50)
				});
				base.QuestGiver.CurrentSettlement.Town.Prosperity -= 30f;
				base.CompleteQuestWithFail(textObject);
			}

			protected override void OnCompleteWithSuccess()
			{
				base.QuestGiver.AddPower(10f);
				TraitLevelingHelper.OnIssueSolvedThroughQuest(base.QuestGiver, new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, 50)
				});
				base.QuestGiver.CurrentSettlement.Town.Prosperity += 30f;
				this.RelationshipChangeWithQuestGiver = 5;
				if (this.AntagonistHero != null)
				{
					this.AntagonistHero.AddPower(-10f);
					ChangeRelationAction.ApplyPlayerRelation(this.AntagonistHero, -10, true, true);
				}
				GiveGoldAction.ApplyForQuestBetweenCharacters(base.QuestGiver, Hero.MainHero, this._rewardGold, false);
				base.AddLog(this._successQuestLogText, false);
			}

			public override void OnFailed()
			{
				base.QuestGiver.AddPower(-10f);
				this.RelationshipChangeWithQuestGiver = -5;
				base.QuestGiver.CurrentSettlement.Town.Prosperity -= 20f;
			}

			protected override void OnTimedOut()
			{
				base.AddLog(this._timeoutQuestLogText, false);
				base.QuestGiver.AddPower(-20f);
				this.RelationshipChangeWithQuestGiver = -5;
				base.QuestGiver.CurrentSettlement.Town.Prosperity -= 50f;
			}

			[SaveableField(20)]
			private int _rewardGold;

			[SaveableField(30)]
			private readonly ItemObject _requestedTradeGood;

			[SaveableField(60)]
			private readonly int _requestedTradeGoodAmount;

			[SaveableField(40)]
			private int _givenTradeGoods;

			[SaveableField(50)]
			private JournalLog _playerStartsQuestLog;
		}

		public class ArtisanOverpricedGoodsIssueTypeDefiner : SaveableTypeDefiner
		{
			public ArtisanOverpricedGoodsIssueTypeDefiner()
				: base(470000)
			{
			}

			protected override void DefineClassTypes()
			{
				base.AddClassDefinition(typeof(ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssue), 1, null);
				base.AddClassDefinition(typeof(ArtisanOverpricedGoodsIssueBehavior.ArtisanOverpricedGoodsIssueQuest), 2, null);
			}
		}
	}
}
