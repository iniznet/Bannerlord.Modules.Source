using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Conversation.Persuasion;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.GameState;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues
{
	// Token: 0x0200030A RID: 778
	public class GangLeaderNeedsWeaponsIssueQuestBehavior : CampaignBehaviorBase
	{
		// Token: 0x17000AD0 RID: 2768
		// (get) Token: 0x06002CC2 RID: 11458 RVA: 0x000BAF7C File Offset: 0x000B917C
		private static int CreatedPartyCount
		{
			get
			{
				return Campaign.Current.GetCampaignBehavior<GangLeaderNeedsWeaponsIssueQuestBehavior>()._createdPartyCount;
			}
		}

		// Token: 0x06002CC3 RID: 11459 RVA: 0x000BAF8D File Offset: 0x000B918D
		public GangLeaderNeedsWeaponsIssueQuestBehavior()
		{
			this._createdPartyCount = 0;
		}

		// Token: 0x06002CC4 RID: 11460 RVA: 0x000BAF9C File Offset: 0x000B919C
		public override void RegisterEvents()
		{
			CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, new Action<Hero>(this.OnCheckForIssue));
		}

		// Token: 0x06002CC5 RID: 11461 RVA: 0x000BAFB5 File Offset: 0x000B91B5
		public override void SyncData(IDataStore dataStore)
		{
			dataStore.SyncData<int>("_createdPartyCount", ref this._createdPartyCount);
		}

		// Token: 0x06002CC6 RID: 11462 RVA: 0x000BAFCC File Offset: 0x000B91CC
		public void OnCheckForIssue(Hero hero)
		{
			if (this.ConditionsHold(hero))
			{
				Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnStartIssue), typeof(GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue), IssueBase.IssueFrequency.Common, null));
				return;
			}
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue), IssueBase.IssueFrequency.Common));
		}

		// Token: 0x06002CC7 RID: 11463 RVA: 0x000BB030 File Offset: 0x000B9230
		private bool ConditionsHold(Hero IssueOwner)
		{
			return IssueOwner.IsGangLeader && IssueOwner.CurrentSettlement != null && IssueOwner.CurrentSettlement.IsTown && IssueOwner.CurrentSettlement.Town.Loyalty < 60f;
		}

		// Token: 0x06002CC8 RID: 11464 RVA: 0x000BB068 File Offset: 0x000B9268
		private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
		{
			this._createdPartyCount++;
			return new GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue(issueOwner);
		}

		// Token: 0x06002CC9 RID: 11465 RVA: 0x000BB07E File Offset: 0x000B927E
		private static TextObject GetNeededClassTextObject(WeaponClass requestedWeaponClass)
		{
			if (requestedWeaponClass == WeaponClass.OneHandedAxe)
			{
				return new TextObject("{=pbmqIN8E}One handed axes", null);
			}
			return new TextObject("{=!}Undefined!", null);
		}

		// Token: 0x04000D81 RID: 3457
		private const IssueBase.IssueFrequency GangLeaderNeedsWeaponsIssueFrequency = IssueBase.IssueFrequency.Common;

		// Token: 0x04000D82 RID: 3458
		private int _createdPartyCount;

		// Token: 0x04000D83 RID: 3459
		private static WeaponClass[] _canBeRequestedWeaponClassList = new WeaponClass[] { WeaponClass.OneHandedAxe };

		// Token: 0x0200061F RID: 1567
		public class GangLeaderNeedsWeaponsIssue : IssueBase
		{
			// Token: 0x060049BC RID: 18876 RVA: 0x00149440 File Offset: 0x00147640
			internal static void AutoGeneratedStaticCollectObjectsGangLeaderNeedsWeaponsIssue(object o, List<object> collectedObjects)
			{
				((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x060049BD RID: 18877 RVA: 0x0014944E File Offset: 0x0014764E
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x060049BE RID: 18878 RVA: 0x00149457 File Offset: 0x00147657
			internal static object AutoGeneratedGetMemberValue_requiredWeaponClassIndex(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue)o)._requiredWeaponClassIndex;
			}

			// Token: 0x060049BF RID: 18879 RVA: 0x00149469 File Offset: 0x00147669
			internal static object AutoGeneratedGetMemberValue_averagePriceForItem(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue)o)._averagePriceForItem;
			}

			// Token: 0x17000F2D RID: 3885
			// (get) Token: 0x060049C0 RID: 18880 RVA: 0x0014947B File Offset: 0x0014767B
			public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
			{
				get
				{
					return IssueBase.AlternativeSolutionScaleFlag.Duration;
				}
			}

			// Token: 0x17000F2E RID: 3886
			// (get) Token: 0x060049C1 RID: 18881 RVA: 0x00149480 File Offset: 0x00147680
			private int RequestedWeaponAmount
			{
				get
				{
					float num;
					if (base.IssueDifficultyMultiplier >= 0.1f && base.IssueDifficultyMultiplier < 0.3f)
					{
						num = 0.1f;
					}
					else if (base.IssueDifficultyMultiplier >= 0.3f && base.IssueDifficultyMultiplier < 0.6f)
					{
						num = 0.2f;
					}
					else
					{
						num = 0.3f;
					}
					if (3 + this._averagePriceForItem == 0)
					{
						return 0;
					}
					return (int)((float)(20000 / this._averagePriceForItem) * num);
				}
			}

			// Token: 0x17000F2F RID: 3887
			// (get) Token: 0x060049C2 RID: 18882 RVA: 0x001494F9 File Offset: 0x001476F9
			private int CompanionGoldNeedForAlternativeSolution
			{
				get
				{
					return this.RewardGold / 2 + this._averagePriceForItem * this.RequestedWeaponAmount / 4;
				}
			}

			// Token: 0x17000F30 RID: 3888
			// (get) Token: 0x060049C3 RID: 18883 RVA: 0x00149513 File Offset: 0x00147713
			public override int AlternativeSolutionBaseNeededMenCount
			{
				get
				{
					return 2 + MathF.Ceiling(4f * base.IssueDifficultyMultiplier);
				}
			}

			// Token: 0x17000F31 RID: 3889
			// (get) Token: 0x060049C4 RID: 18884 RVA: 0x00149528 File Offset: 0x00147728
			protected override int AlternativeSolutionBaseDurationInDaysInternal
			{
				get
				{
					return 7 + MathF.Ceiling(8f * base.IssueDifficultyMultiplier);
				}
			}

			// Token: 0x17000F32 RID: 3890
			// (get) Token: 0x060049C5 RID: 18885 RVA: 0x0014953D File Offset: 0x0014773D
			protected override int RewardGold
			{
				get
				{
					return 500 + this._averagePriceForItem * this.RequestedWeaponAmount;
				}
			}

			// Token: 0x17000F33 RID: 3891
			// (get) Token: 0x060049C6 RID: 18886 RVA: 0x00149552 File Offset: 0x00147752
			private WeaponClass RequestedWeaponClass
			{
				get
				{
					return GangLeaderNeedsWeaponsIssueQuestBehavior._canBeRequestedWeaponClassList[this._requiredWeaponClassIndex];
				}
			}

			// Token: 0x17000F34 RID: 3892
			// (get) Token: 0x060049C7 RID: 18887 RVA: 0x00149560 File Offset: 0x00147760
			public override TextObject IssueBriefByIssueGiver
			{
				get
				{
					return new TextObject("{=m24bXmOD}Yes, you can help me. Do you want to make some easy money? I need some 'tools' for my private business. Are you interested?", null);
				}
			}

			// Token: 0x17000F35 RID: 3893
			// (get) Token: 0x060049C8 RID: 18888 RVA: 0x0014956D File Offset: 0x0014776D
			public override TextObject IssueAcceptByPlayer
			{
				get
				{
					return new TextObject("{=PFNXodyo}What sort of tools?", null);
				}
			}

			// Token: 0x17000F36 RID: 3894
			// (get) Token: 0x060049C9 RID: 18889 RVA: 0x0014957C File Offset: 0x0014777C
			public override TextObject IssueQuestSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=xBaL3RM4}Well, as you know we're not farmers or artisans. I need {NEEDED_AMOUNT} pieces of {.%}{NEEDED_TYPE}{.%}. Don't mind the quality, just buy the weapons. Bring them to me and {REWARD_GOLD}{GOLD_ICON} is yours. Got it?", null);
					textObject.SetTextVariable("NEEDED_AMOUNT", this.RequestedWeaponAmount);
					textObject.SetTextVariable("REWARD_GOLD", this.RewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					textObject.SetTextVariable("NEEDED_TYPE", GangLeaderNeedsWeaponsIssueQuestBehavior.GetNeededClassTextObject(this.RequestedWeaponClass));
					return textObject;
				}
			}

			// Token: 0x17000F37 RID: 3895
			// (get) Token: 0x060049CA RID: 18890 RVA: 0x001495E0 File Offset: 0x001477E0
			public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=0i8RgslK}Or, maybe one of your trusted companions can take {COMPANION_NEED_GOLD_AMOUNT}{GOLD_ICON} denars and some {ALTERNATIVE_TROOP_AMOUNT} men can bring me {PLURAL(ITEM_TYPE)}. Your companion better have his pockets full, since all that should cost around {COMPANION_NEED_GOLD_AMOUNT}{GOLD_ICON}.", null);
					textObject.SetTextVariable("COMPANION_NEED_GOLD_AMOUNT", this.CompanionGoldNeedForAlternativeSolution);
					textObject.SetTextVariable("ITEM_TYPE", GangLeaderNeedsWeaponsIssueQuestBehavior.GetNeededClassTextObject(this.RequestedWeaponClass));
					textObject.SetTextVariable("ALTERNATIVE_TROOP_AMOUNT", base.GetTotalAlternativeSolutionNeededMenCount());
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x17000F38 RID: 3896
			// (get) Token: 0x060049CB RID: 18891 RVA: 0x00149644 File Offset: 0x00147844
			public override TextObject IssueQuestSolutionAcceptByPlayer
			{
				get
				{
					TextObject textObject = new TextObject("{=ABYGws1M}I'll bring you {NEEDED_AMOUNT} of those by myself.", null);
					textObject.SetTextVariable("NEEDED_AMOUNT", this.RequestedWeaponAmount);
					return textObject;
				}
			}

			// Token: 0x17000F39 RID: 3897
			// (get) Token: 0x060049CC RID: 18892 RVA: 0x00149663 File Offset: 0x00147863
			public override TextObject IssueAlternativeSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=Ggjb9BVQ}Actually I prefer not to get involved in this kind of business personally but my men will help you out.", null);
				}
			}

			// Token: 0x17000F3A RID: 3898
			// (get) Token: 0x060049CD RID: 18893 RVA: 0x00149670 File Offset: 0x00147870
			public override TextObject IssueAlternativeSolutionResponseByIssueGiver
			{
				get
				{
					return new TextObject("{=HawJormK}That's fine, so long as your men know well enough to handle this quietly. Good luck.", null);
				}
			}

			// Token: 0x17000F3B RID: 3899
			// (get) Token: 0x060049CE RID: 18894 RVA: 0x0014967D File Offset: 0x0014787D
			public override TextObject IssueDiscussAlternativeSolution
			{
				get
				{
					return new TextObject("{=aG9iX1a8}We're looking forward to trying out our new \"tools\" on some bastard's head. Let your boys know that drinks are on us when they get here.", null);
				}
			}

			// Token: 0x17000F3C RID: 3900
			// (get) Token: 0x060049CF RID: 18895 RVA: 0x0014968C File Offset: 0x0014788C
			protected override TextObject AlternativeSolutionStartLog
			{
				get
				{
					TextObject textObject = new TextObject("{=otwfa0K3}{QUEST_GIVER.LINK}, a gang leader from {SETTLEMENT} wanted you to buy some weapons for {?QUEST_GIVER.GENDER}her{?}his{\\?} private business. {?QUEST_GIVER.GENDER}She{?}He{\\?} offers you {REWARD_GOLD}{GOLD_ICON} on their delivery. You asked {COMPANION.LINK} to take some of your men and buy {NEEDED_AMOUNT} units of {NEEDED_TYPE} to deliver to {QUEST_GIVER.LINK} in {SETTLEMENT}. They should rejoin your party in {RETURN_DAYS} days.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, textObject, false);
					textObject.SetTextVariable("SETTLEMENT", base.IssueOwner.CurrentSettlement.EncyclopediaLinkWithName);
					textObject.SetTextVariable("RETURN_DAYS", base.GetTotalAlternativeSolutionDurationInDays());
					textObject.SetTextVariable("NEEDED_AMOUNT", this.RequestedWeaponAmount);
					textObject.SetTextVariable("NEEDED_TYPE", GangLeaderNeedsWeaponsIssueQuestBehavior.GetNeededClassTextObject(this.RequestedWeaponClass));
					textObject.SetTextVariable("REWARD_GOLD", this.RewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x17000F3D RID: 3901
			// (get) Token: 0x060049D0 RID: 18896 RVA: 0x00149750 File Offset: 0x00147950
			public override bool IsThereAlternativeSolution
			{
				get
				{
					return true;
				}
			}

			// Token: 0x17000F3E RID: 3902
			// (get) Token: 0x060049D1 RID: 18897 RVA: 0x00149753 File Offset: 0x00147953
			public override bool IsThereLordSolution
			{
				get
				{
					return false;
				}
			}

			// Token: 0x17000F3F RID: 3903
			// (get) Token: 0x060049D2 RID: 18898 RVA: 0x00149756 File Offset: 0x00147956
			public override TextObject Title
			{
				get
				{
					return new TextObject("{=zKHkS5Gf}Gang leader needs weapons", null);
				}
			}

			// Token: 0x17000F40 RID: 3904
			// (get) Token: 0x060049D3 RID: 18899 RVA: 0x00149764 File Offset: 0x00147964
			public override TextObject Description
			{
				get
				{
					TextObject textObject = new TextObject("{=VYq93e36}A gang leader needs you to buy weapons for {?QUEST_GIVER.GENDER}her{?}his{\\?} men.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x060049D4 RID: 18900 RVA: 0x00149798 File Offset: 0x00147998
			public GangLeaderNeedsWeaponsIssue(Hero issueOwner)
				: base(issueOwner, CampaignTime.DaysFromNow(15f))
			{
				MBList<ValueTuple<WeaponClass, int>> mblist = new MBList<ValueTuple<WeaponClass, int>>();
				foreach (WeaponClass weaponClass in GangLeaderNeedsWeaponsIssueQuestBehavior._canBeRequestedWeaponClassList)
				{
					int num = this.CalculateAveragePriceForWeaponClass(weaponClass);
					if (num > 0)
					{
						mblist.Add(new ValueTuple<WeaponClass, int>(weaponClass, num));
					}
				}
				ValueTuple<WeaponClass, int> selectedItemAndPrize = mblist.GetRandomElement<ValueTuple<WeaponClass, int>>();
				this._averagePriceForItem = selectedItemAndPrize.Item2;
				this._requiredWeaponClassIndex = Array.FindIndex<WeaponClass>(GangLeaderNeedsWeaponsIssueQuestBehavior._canBeRequestedWeaponClassList, (WeaponClass x) => x == selectedItemAndPrize.Item1);
			}

			// Token: 0x060049D5 RID: 18901 RVA: 0x00149832 File Offset: 0x00147A32
			protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
			{
				if (issueEffect == DefaultIssueEffects.SettlementSecurity)
				{
					return 1f;
				}
				if (issueEffect == DefaultIssueEffects.IssueOwnerPower)
				{
					return -0.2f;
				}
				return 0f;
			}

			// Token: 0x060049D6 RID: 18902 RVA: 0x00149855 File Offset: 0x00147A55
			public override ValueTuple<SkillObject, int> GetAlternativeSolutionSkill(Hero hero)
			{
				return new ValueTuple<SkillObject, int>((hero.GetSkillValue(DefaultSkills.Trade) >= hero.GetSkillValue(DefaultSkills.Crafting)) ? DefaultSkills.Trade : DefaultSkills.Crafting, 120);
			}

			// Token: 0x060049D7 RID: 18903 RVA: 0x00149884 File Offset: 0x00147A84
			private int CalculateAveragePriceForWeaponClass(WeaponClass weaponClass)
			{
				int num = 0;
				int num2 = 0;
				foreach (Settlement settlement in Settlement.All)
				{
					if (settlement.IsTown)
					{
						for (int i = 0; i < settlement.ItemRoster.Count; i++)
						{
							ItemRosterElement itemRosterElement = settlement.ItemRoster[i];
							WeaponComponent weaponComponent = itemRosterElement.EquipmentElement.Item.WeaponComponent;
							if (weaponComponent != null && weaponComponent.PrimaryWeapon.WeaponClass == weaponClass)
							{
								num2 += itemRosterElement.Amount;
								num += itemRosterElement.EquipmentElement.ItemValue;
							}
						}
					}
				}
				return num / ((num2 == 0) ? 1 : num2);
			}

			// Token: 0x060049D8 RID: 18904 RVA: 0x0014995C File Offset: 0x00147B5C
			protected override void CompleteIssueWithTimedOutConsequences()
			{
			}

			// Token: 0x17000F41 RID: 3905
			// (get) Token: 0x060049D9 RID: 18905 RVA: 0x0014995E File Offset: 0x00147B5E
			protected override int CompanionSkillRewardXP
			{
				get
				{
					return (int)(800f + 900f * base.IssueDifficultyMultiplier);
				}
			}

			// Token: 0x060049DA RID: 18906 RVA: 0x00149973 File Offset: 0x00147B73
			public override bool AlternativeSolutionCondition(out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false) && QuestHelper.CheckGoldForAlternativeSolution(this.CompanionGoldNeedForAlternativeSolution, ref explanation);
			}

			// Token: 0x060049DB RID: 18907 RVA: 0x001499A4 File Offset: 0x00147BA4
			public override bool DoTroopsSatisfyAlternativeSolution(TroopRoster troopRoster, out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false);
			}

			// Token: 0x060049DC RID: 18908 RVA: 0x001499BC File Offset: 0x00147BBC
			public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
			{
				return character.Tier >= 2;
			}

			// Token: 0x060049DD RID: 18909 RVA: 0x001499CA File Offset: 0x00147BCA
			public override void AlternativeSolutionStartConsequence()
			{
				GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, this.CompanionGoldNeedForAlternativeSolution, false);
			}

			// Token: 0x060049DE RID: 18910 RVA: 0x001499E0 File Offset: 0x00147BE0
			protected override void AlternativeSolutionEndWithSuccessConsequence()
			{
				ChangeCrimeRatingAction.Apply(base.IssueOwner.CurrentSettlement.MapFaction, 10f, true);
				base.IssueOwner.AddPower(10f);
				this.RelationshipChangeWithIssueOwner = 5;
				base.IssueOwner.CurrentSettlement.Town.Security -= 30f;
			}

			// Token: 0x060049DF RID: 18911 RVA: 0x00149A40 File Offset: 0x00147C40
			public override IssueBase.IssueFrequency GetFrequency()
			{
				return IssueBase.IssueFrequency.Common;
			}

			// Token: 0x060049E0 RID: 18912 RVA: 0x00149A44 File Offset: 0x00147C44
			protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out IssueBase.PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
			{
				flag = IssueBase.PreconditionFlags.None;
				skill = null;
				relationHero = null;
				if (issueGiver.GetRelationWithPlayer() < -10f)
				{
					flag |= IssueBase.PreconditionFlags.Relation;
					relationHero = issueGiver;
				}
				if (base.IssueOwner.CurrentSettlement.OwnerClan == Clan.PlayerClan)
				{
					flag |= IssueBase.PreconditionFlags.PlayerIsOwnerOfSettlement;
				}
				return flag == IssueBase.PreconditionFlags.None;
			}

			// Token: 0x060049E1 RID: 18913 RVA: 0x00149A98 File Offset: 0x00147C98
			public override bool IssueStayAliveConditions()
			{
				Settlement currentSettlement = base.IssueOwner.CurrentSettlement;
				return ((currentSettlement != null) ? currentSettlement.Town : null) != null && base.IssueOwner.CurrentSettlement.OwnerClan != Clan.PlayerClan && base.IssueOwner.CurrentSettlement.Town.Loyalty < 75f;
			}

			// Token: 0x060049E2 RID: 18914 RVA: 0x00149AF3 File Offset: 0x00147CF3
			protected override void OnGameLoad()
			{
			}

			// Token: 0x060049E3 RID: 18915 RVA: 0x00149AF5 File Offset: 0x00147CF5
			protected override QuestBase GenerateIssueQuest(string questId)
			{
				return new GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest(questId, base.IssueOwner, CampaignTime.DaysFromNow(25f), this.RewardGold, this._requiredWeaponClassIndex, this.RequestedWeaponAmount, base.IssueDifficultyMultiplier, this._averagePriceForItem);
			}

			// Token: 0x0400197A RID: 6522
			private const int BaseNeededWeaponCount = 3;

			// Token: 0x0400197B RID: 6523
			private const int BaseRewardGold = 500;

			// Token: 0x0400197C RID: 6524
			private const int AlternativeSolutionTroopTierRequirement = 2;

			// Token: 0x0400197D RID: 6525
			private const int RequiredSkillLevelForSendingComp = 120;

			// Token: 0x0400197E RID: 6526
			private const int IssueDuration = 15;

			// Token: 0x0400197F RID: 6527
			private const int QuestTimeLimit = 25;

			// Token: 0x04001980 RID: 6528
			[SaveableField(20)]
			private int _requiredWeaponClassIndex;

			// Token: 0x04001981 RID: 6529
			[SaveableField(30)]
			private int _averagePriceForItem;
		}

		// Token: 0x02000620 RID: 1568
		public class GangLeaderNeedsWeaponsIssueQuest : QuestBase
		{
			// Token: 0x060049E4 RID: 18916 RVA: 0x00149B2B File Offset: 0x00147D2B
			internal static void AutoGeneratedStaticCollectObjectsGangLeaderNeedsWeaponsIssueQuest(object o, List<object> collectedObjects)
			{
				((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			// Token: 0x060049E5 RID: 18917 RVA: 0x00149B39 File Offset: 0x00147D39
			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._weaponsThatGuardTook);
				collectedObjects.Add(this._playerStartsQuestLog);
			}

			// Token: 0x060049E6 RID: 18918 RVA: 0x00149B5A File Offset: 0x00147D5A
			internal static object AutoGeneratedGetMemberValue_randomForRequiredWeaponClass(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._randomForRequiredWeaponClass;
			}

			// Token: 0x060049E7 RID: 18919 RVA: 0x00149B6C File Offset: 0x00147D6C
			internal static object AutoGeneratedGetMemberValue_requestedWeaponAmount(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._requestedWeaponAmount;
			}

			// Token: 0x060049E8 RID: 18920 RVA: 0x00149B7E File Offset: 0x00147D7E
			internal static object AutoGeneratedGetMemberValue_playerDodgedGuards(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._playerDodgedGuards;
			}

			// Token: 0x060049E9 RID: 18921 RVA: 0x00149B90 File Offset: 0x00147D90
			internal static object AutoGeneratedGetMemberValue_collectedItemAmount(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._collectedItemAmount;
			}

			// Token: 0x060049EA RID: 18922 RVA: 0x00149BA2 File Offset: 0x00147DA2
			internal static object AutoGeneratedGetMemberValue_lowCrimeRatingWillBeApplied(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._lowCrimeRatingWillBeApplied;
			}

			// Token: 0x060049EB RID: 18923 RVA: 0x00149BB4 File Offset: 0x00147DB4
			internal static object AutoGeneratedGetMemberValue_highCrimeRatingWillBeApplied(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._highCrimeRatingWillBeApplied;
			}

			// Token: 0x060049EC RID: 18924 RVA: 0x00149BC6 File Offset: 0x00147DC6
			internal static object AutoGeneratedGetMemberValue_weaponsThatGuardTook(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._weaponsThatGuardTook;
			}

			// Token: 0x060049ED RID: 18925 RVA: 0x00149BD3 File Offset: 0x00147DD3
			internal static object AutoGeneratedGetMemberValue_issueDifficulty(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._issueDifficulty;
			}

			// Token: 0x060049EE RID: 18926 RVA: 0x00149BE5 File Offset: 0x00147DE5
			internal static object AutoGeneratedGetMemberValue_rewardGold(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._rewardGold;
			}

			// Token: 0x060049EF RID: 18927 RVA: 0x00149BF7 File Offset: 0x00147DF7
			internal static object AutoGeneratedGetMemberValue_bribeGold(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._bribeGold;
			}

			// Token: 0x060049F0 RID: 18928 RVA: 0x00149C09 File Offset: 0x00147E09
			internal static object AutoGeneratedGetMemberValue_persuasionTriedOnce(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._persuasionTriedOnce;
			}

			// Token: 0x060049F1 RID: 18929 RVA: 0x00149C1B File Offset: 0x00147E1B
			internal static object AutoGeneratedGetMemberValue_playerStartsQuestLog(object o)
			{
				return ((GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest)o)._playerStartsQuestLog;
			}

			// Token: 0x17000F42 RID: 3906
			// (get) Token: 0x060049F2 RID: 18930 RVA: 0x00149C28 File Offset: 0x00147E28
			public override TextObject Title
			{
				get
				{
					return new TextObject("{=zKHkS5Gf}Gang leader needs weapons", null);
				}
			}

			// Token: 0x17000F43 RID: 3907
			// (get) Token: 0x060049F3 RID: 18931 RVA: 0x00149C35 File Offset: 0x00147E35
			public override bool IsRemainingTimeHidden
			{
				get
				{
					return false;
				}
			}

			// Token: 0x17000F44 RID: 3908
			// (get) Token: 0x060049F4 RID: 18932 RVA: 0x00149C38 File Offset: 0x00147E38
			private TextObject PlayerStartsQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=B3WyJjBx}{QUEST_GIVER.LINK}, a gang leader from {SETTLEMENT}, asked you to buy some weapons for {?QUEST_GIVER.GENDER}her{?}his{\\?} private business. {?QUEST_GIVER.GENDER}She{?}He{\\?} offered you {REWARD_GOLD}{GOLD_ICON} for their delivery. {?QUEST_GIVER.GENDER}She{?}He{\\?} asked you to buy {NEEDED_AMOUNT} pieces of {NEEDED_TYPE} and deliver them to {SETTLEMENT} where {QUEST_GIVER.LINK}'s men will be waiting for you. {?QUEST_GIVER.GENDER}She{?}He{\\?} promised to give you {REWARD_GOLD}{GOLD_ICON} for your troubles.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("SETTLEMENT", base.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
					textObject.SetTextVariable("NEEDED_AMOUNT", this._requestedWeaponAmount);
					textObject.SetTextVariable("NEEDED_TYPE", GangLeaderNeedsWeaponsIssueQuestBehavior.GetNeededClassTextObject(this._requestedWeaponClass));
					textObject.SetTextVariable("REWARD_GOLD", this._rewardGold);
					GameTexts.SetVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			// Token: 0x17000F45 RID: 3909
			// (get) Token: 0x060049F5 RID: 18933 RVA: 0x00149CD0 File Offset: 0x00147ED0
			private TextObject SuccessQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=R6V2Jv3a}You have delivered the weapons to the {QUEST_GIVER.LINK} as promised.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x17000F46 RID: 3910
			// (get) Token: 0x060049F6 RID: 18934 RVA: 0x00149D04 File Offset: 0x00147F04
			private TextObject FailPlayerDefeatedAgainstGuardsLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=XrxCaoT2}You have failed to deliver the weapons to the {QUEST_GIVER.LINK}.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x17000F47 RID: 3911
			// (get) Token: 0x060049F7 RID: 18935 RVA: 0x00149D38 File Offset: 0x00147F38
			private TextObject FailQuestTimedOutLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=4n71Xoyq}You have failed to bring the weapons to the {QUEST_GIVER.LINK} in time.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			// Token: 0x17000F48 RID: 3912
			// (get) Token: 0x060049F8 RID: 18936 RVA: 0x00149D6C File Offset: 0x00147F6C
			private TextObject OwnerOfQuestSettlementIsPlayerClanLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=Txtwv90o}Your clan has conquered the town into which you are trying to smuggle weapons. As the {?PLAYER.GENDER}lady{?}lord{\\?} of the town you cannot get involved in this kind of activity. Your agreement with the {QUEST_GIVER.LINK} has canceled.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject, false);
					return textObject;
				}
			}

			// Token: 0x060049F9 RID: 18937 RVA: 0x00149DB0 File Offset: 0x00147FB0
			public GangLeaderNeedsWeaponsIssueQuest(string questId, Hero questGiver, CampaignTime dueTime, int rewardGold, int randomForRequiredWeaponClass, int requestedWeaponAmount, float issueDifficulty, int averagePrice)
				: base(questId, questGiver, dueTime, rewardGold)
			{
				this._randomForRequiredWeaponClass = randomForRequiredWeaponClass;
				this._requestedWeaponClass = GangLeaderNeedsWeaponsIssueQuestBehavior._canBeRequestedWeaponClassList[this._randomForRequiredWeaponClass];
				this._requestedWeaponAmount = requestedWeaponAmount;
				this._weaponsThatGuardTook = new Dictionary<EquipmentElement, int>();
				this._issueDifficulty = issueDifficulty;
				this._rewardGold = (float)rewardGold;
				this._bribeGold = averagePrice * requestedWeaponAmount / 4;
				this.SetDialogs();
				base.InitializeQuestOnCreation();
			}

			// Token: 0x060049FA RID: 18938 RVA: 0x00149E1F File Offset: 0x0014801F
			protected override void InitializeQuestOnGameLoad()
			{
				this.SetDialogs();
				this._requestedWeaponClass = GangLeaderNeedsWeaponsIssueQuestBehavior._canBeRequestedWeaponClassList[this._randomForRequiredWeaponClass];
			}

			// Token: 0x060049FB RID: 18939 RVA: 0x00149E3C File Offset: 0x0014803C
			protected override void RegisterEvents()
			{
				CampaignEvents.SettlementEntered.AddNonSerializedListener(this, new Action<MobileParty, Settlement, Hero>(this.OnSettlementEnter));
				CampaignEvents.OnSettlementLeftEvent.AddNonSerializedListener(this, new Action<MobileParty, Settlement>(this.OnSettlementLeft));
				CampaignEvents.PlayerInventoryExchangeEvent.AddNonSerializedListener(this, new Action<List<ValueTuple<ItemRosterElement, int>>, List<ValueTuple<ItemRosterElement, int>>, bool>(this.OnPlayerInventoryChanged));
				CampaignEvents.OnNewItemCraftedEvent.AddNonSerializedListener(this, new Action<ItemObject, Crafting.OverrideData, bool>(this.OnItemCrafted));
				CampaignEvents.GameMenuOpened.AddNonSerializedListener(this, new Action<MenuCallbackArgs>(this.OnGameMenuOpened));
				CampaignEvents.OnSettlementOwnerChangedEvent.AddNonSerializedListener(this, new Action<Settlement, bool, Hero, Hero, Hero, ChangeOwnerOfSettlementAction.ChangeOwnerOfSettlementDetail>(this.OnSettlementOwnerChanged));
				CampaignEvents.OnEquipmentSmeltedByHeroEvent.AddNonSerializedListener(this, new Action<Hero, EquipmentElement>(this.OnEquipmentSmeltedByHero));
			}

			// Token: 0x060049FC RID: 18940 RVA: 0x00149EEA File Offset: 0x001480EA
			protected override void OnBeforeTimedOut(ref bool completeWithSuccess, ref bool doNotResolveTheQuest)
			{
				this.GiveBackPlayersWeaponsOnCancelOrTimeOut();
			}

			// Token: 0x060049FD RID: 18941 RVA: 0x00149EF2 File Offset: 0x001480F2
			public override void OnCanceled()
			{
				this.GiveBackPlayersWeaponsOnCancelOrTimeOut();
			}

			// Token: 0x060049FE RID: 18942 RVA: 0x00149EFC File Offset: 0x001480FC
			private void GiveBackPlayersWeaponsOnCancelOrTimeOut()
			{
				if (this._weaponsThatGuardTook.Count > 0)
				{
					foreach (KeyValuePair<EquipmentElement, int> keyValuePair in this._weaponsThatGuardTook)
					{
						PartyBase.MainParty.ItemRoster.AddToCounts(keyValuePair.Key, keyValuePair.Value);
					}
				}
			}

			// Token: 0x060049FF RID: 18943 RVA: 0x00149F74 File Offset: 0x00148174
			private void OnEquipmentSmeltedByHero(Hero hero, EquipmentElement equipmentElement)
			{
				if (hero.PartyBelongedTo == MobileParty.MainParty)
				{
					ItemObject item = equipmentElement.Item;
					if (item.WeaponComponent != null && item.WeaponComponent.PrimaryWeapon.WeaponClass == this._requestedWeaponClass)
					{
						this.SetCurrentItemAmount(this._collectedItemAmount - 1);
					}
				}
			}

			// Token: 0x06004A00 RID: 18944 RVA: 0x00149FC4 File Offset: 0x001481C4
			private void OnItemCrafted(ItemObject itemObject, Crafting.OverrideData overrideData, bool isCraftingOrderItem)
			{
				if (!isCraftingOrderItem && itemObject.WeaponComponent != null && itemObject.WeaponComponent.PrimaryWeapon.WeaponClass == this._requestedWeaponClass)
				{
					this.SetCurrentItemAmount(this._collectedItemAmount + 1);
				}
			}

			// Token: 0x06004A01 RID: 18945 RVA: 0x00149FF7 File Offset: 0x001481F7
			private void SetCurrentItemAmount(int value)
			{
				this._collectedItemAmount = value;
				JournalLog playerStartsQuestLog = this._playerStartsQuestLog;
				if (playerStartsQuestLog == null)
				{
					return;
				}
				playerStartsQuestLog.UpdateCurrentProgress(this._collectedItemAmount);
			}

			// Token: 0x06004A02 RID: 18946 RVA: 0x0014A016 File Offset: 0x00148216
			private void OnSettlementOwnerChanged(Settlement settlement, bool openToClaim, Hero newOwner, Hero oldOwner, Hero capturerHero, ChangeOwnerOfSettlementAction.ChangeOwnerOfSettlementDetail detail)
			{
				if (settlement == base.QuestGiver.CurrentSettlement && newOwner == Hero.MainHero)
				{
					base.AddLog(this.OwnerOfQuestSettlementIsPlayerClanLogText, false);
					base.CompleteQuestWithCancel(null);
				}
			}

			// Token: 0x06004A03 RID: 18947 RVA: 0x0014A044 File Offset: 0x00148244
			private void OnGameMenuOpened(MenuCallbackArgs args)
			{
				if (args.MenuContext.GameMenu.StringId == "town" && Campaign.Current.GameMenuManager.NextLocation == null && GameStateManager.Current.ActiveState is MapState)
				{
					if (this._checkForBattleResult && PlayerEncounter.Battle != null && PlayerEncounter.Battle.InvolvedParties.Any((PartyBase x) => x == this._guardsParty.Party))
					{
						bool flag = PlayerEncounter.Battle.WinningSide == PlayerEncounter.Battle.PlayerSide;
						this._checkForBattleResult = false;
						PlayerEncounter.Finish(true);
						if (flag)
						{
							this.PlayerDodgedGuards();
						}
						else
						{
							this.PlayerDefeatedAgainstGuards();
						}
					}
					if (this._startBattleMission)
					{
						this._startBattleMission = false;
						this.StartFight();
					}
					if (this._playerGoBack)
					{
						PlayerEncounter.LeaveEncounter = true;
						PlayerEncounter.Finish(true);
						this._playerGoBack = false;
					}
				}
			}

			// Token: 0x06004A04 RID: 18948 RVA: 0x0014A127 File Offset: 0x00148327
			private void OnPlayerInventoryChanged(List<ValueTuple<ItemRosterElement, int>> purchasedItems, List<ValueTuple<ItemRosterElement, int>> soldItems, bool isTrading)
			{
				this.CalculateAndSetRequestedItemCountOnPlayer();
			}

			// Token: 0x06004A05 RID: 18949 RVA: 0x0014A130 File Offset: 0x00148330
			private void OnSettlementLeft(MobileParty party, Settlement settlement)
			{
				if (settlement == base.QuestGiver.CurrentSettlement && party == MobileParty.MainParty)
				{
					if (this._weaponsThatGuardTook.Count > 0)
					{
						int num = 1500;
						bool flag = false;
						foreach (KeyValuePair<EquipmentElement, int> keyValuePair in this._weaponsThatGuardTook.OrderBy((KeyValuePair<EquipmentElement, int> x) => x.Key.Item.Value).ToList<KeyValuePair<EquipmentElement, int>>())
						{
							int num2 = 0;
							int num3 = 0;
							while (num3 < keyValuePair.Value && num > 0)
							{
								if ((double)MBRandom.RandomFloat >= 0.6)
								{
									num2++;
									num -= keyValuePair.Key.Item.Value;
									flag = true;
								}
								num3++;
							}
							if (keyValuePair.Value > num2)
							{
								PartyBase.MainParty.ItemRoster.AddToCounts(keyValuePair.Key, keyValuePair.Value - num2);
							}
						}
						if (flag)
						{
							MBInformationManager.AddQuickInformation(new TextObject("{=Ibm1A68t}The guards gave your weapons back to you but you noticed something missing.", null), 0, null, "");
						}
						else
						{
							MBInformationManager.AddQuickInformation(new TextObject("{=isGIZ18i}The guards gave all your weapons back to you.", null), 0, null, "");
						}
						this._weaponsThatGuardTook.Clear();
						this.CalculateAndSetRequestedItemCountOnPlayer();
					}
					if (this._guardsParty != null)
					{
						EnterSettlementAction.ApplyForParty(this._guardsParty, base.QuestGiver.CurrentSettlement);
						this._guardsParty.IsVisible = false;
						this._guardsParty.IsActive = false;
					}
				}
			}

			// Token: 0x06004A06 RID: 18950 RVA: 0x0014A2D4 File Offset: 0x001484D4
			private void OnSettlementEnter(MobileParty party, Settlement settlement, Hero hero)
			{
				if (!this._playerDodgedGuards && party == MobileParty.MainParty && settlement == base.QuestGiver.CurrentSettlement && MobileParty.MainParty.Army == null && Campaign.Current.GameMenuManager.NextLocation == null && GameStateManager.Current.ActiveState is MapState && PlayerEncounter.EncounterSettlement != null)
				{
					this.CalculateAndSetRequestedItemCountOnPlayer();
					if (this._collectedItemAmount >= this._requestedWeaponAmount / 3 && !this._playerGoBack)
					{
						if (this._guardsParty == null)
						{
							this.CreateGuardsParty();
						}
						ConversationCharacterData conversationCharacterData = new ConversationCharacterData(ConversationHelper.GetConversationCharacterPartyLeader(this._guardsParty.Party), null, false, false, false, true, false, false);
						CampaignMapConversation.OpenConversation(new ConversationCharacterData(CharacterObject.PlayerCharacter, PartyBase.MainParty, false, false, false, false, false, false), conversationCharacterData);
					}
				}
			}

			// Token: 0x06004A07 RID: 18951 RVA: 0x0014A3A8 File Offset: 0x001485A8
			private void CreateGuardsParty()
			{
				this._guardsParty = MobileParty.CreateParty("weapon_smuggling_quest_guards_party_" + GangLeaderNeedsWeaponsIssueQuestBehavior.CreatedPartyCount, null, null);
				TextObject textObject = new TextObject("{=7aaAWc01}Guard's Party", null);
				this._guardsParty.InitializeMobilePartyAtPosition(new TroopRoster(this._guardsParty.Party), new TroopRoster(this._guardsParty.Party), base.QuestGiver.CurrentSettlement.GatePosition);
				this._guardsParty.SetCustomName(textObject);
				this._guardsParty.SetCustomHomeSettlement(base.QuestGiver.CurrentSettlement);
				this._guardsParty.Party.SetCustomOwner(base.QuestGiver.CurrentSettlement.OwnerClan.Leader);
				CharacterObject characterObject = CharacterObject.All.First((CharacterObject x) => x.StringId == "guard_" + this._guardsParty.HomeSettlement.Culture.StringId);
				this._guardsParty.MemberRoster.AddToCounts(characterObject, 1, true, 0, 0, true, -1);
				this._guardsParty.SetPartyUsedByQuest(true);
				this._guardsParty.Ai.DisableAi();
				float num = 5f + 15f * this._issueDifficulty;
				this._guardsParty.MemberRoster.AddToCounts(this._guardsParty.HomeSettlement.Culture.MeleeMilitiaTroop, (int)num, false, 0, 0, true, -1);
				EnterSettlementAction.ApplyForParty(this._guardsParty, base.QuestGiver.CurrentSettlement);
				this._guardsParty.IsVisible = false;
			}

			// Token: 0x06004A08 RID: 18952 RVA: 0x0014A514 File Offset: 0x00148714
			protected override void SetDialogs()
			{
				Campaign.Current.ConversationManager.AddDialogFlow(this.GetGuardDialogFlow(), this);
				this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(new TextObject("{=nQoAsBZY}When you enter the town my men will take the weapons from you. Good luck.", null), null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences))
					.CloseDialog();
				this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(new TextObject("{=CQH7E6Gr}What about my weapons?", null), null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=RbToDs0n}Here is your cargo. Now it's time for payment.", null), null)
					.Condition(new ConversationSentence.OnConditionDelegate(this.CheckIfPlayerHasEnoughRequestedWeapons))
					.NpcLine(new TextObject("{=nixINYwE}Yes of course. It was a pleasure doing business with you.", null), null, null)
					.Consequence(delegate
					{
						Campaign.Current.ConversationManager.ConversationEndOneShot += this.PlayerSuccessfullyDeliveredWeapons;
					})
					.CloseDialog()
					.PlayerOption(new TextObject("{=bj49Bq15}It's not that easy to find what you wanted. Be patient, please.", null), null)
					.NpcLine(new TextObject("{=avFXbBLV}I know how it is. Just bring me the weapons.", null), null, null)
					.EndPlayerOptions()
					.CloseDialog();
			}

			// Token: 0x06004A09 RID: 18953 RVA: 0x0014A633 File Offset: 0x00148833
			private bool CheckIfPlayerHasEnoughRequestedWeapons()
			{
				this.CalculateAndSetRequestedItemCountOnPlayer();
				return this._collectedItemAmount >= this._requestedWeaponAmount;
			}

			// Token: 0x06004A0A RID: 18954 RVA: 0x0014A64C File Offset: 0x0014884C
			private void CalculateAndSetRequestedItemCountOnPlayer()
			{
				int num = 0;
				foreach (ItemRosterElement itemRosterElement in PartyBase.MainParty.ItemRoster)
				{
					if (itemRosterElement.EquipmentElement.Item != null && itemRosterElement.EquipmentElement.Item.WeaponComponent != null && itemRosterElement.EquipmentElement.Item.WeaponComponent.PrimaryWeapon.WeaponClass == this._requestedWeaponClass)
					{
						num += itemRosterElement.Amount;
					}
				}
				this.SetCurrentItemAmount(num);
			}

			// Token: 0x06004A0B RID: 18955 RVA: 0x0014A6F8 File Offset: 0x001488F8
			private void QuestAcceptedConsequences()
			{
				base.StartQuest();
				this._playerStartsQuestLog = base.AddDiscreteLog(this.PlayerStartsQuestLogText, new TextObject("{=9j7LJk60}Collected Items", null), this._collectedItemAmount, this._requestedWeaponAmount, null, false);
				this.CalculateAndSetRequestedItemCountOnPlayer();
			}

			// Token: 0x06004A0C RID: 18956 RVA: 0x0014A734 File Offset: 0x00148934
			private DialogFlow GetGuardDialogFlow()
			{
				TextObject textObject = new TextObject("{=wBBidWVw}What have we here? You can't enter the town with so many weapons. Hand them over! You can retrieve them when you leave.", null);
				TextObject textObject2 = new TextObject("{=oVAtPtsu}Clear the way! We don't want to use force!", null);
				TextObject textObject3 = new TextObject("{=JL204Kc0}Sure... sure. We'll hand them over..", null);
				TextObject textObject4 = new TextObject("{=nlCa3tW8}You seem like a reasonable man. What is your price?", null);
				TextObject textObject5 = new TextObject("{=VUjaLmIH}Relax. We have permission. Let us pass. ", null);
				TextObject textObject6 = new TextObject("{=tGFgar0U}Fine. We won't enter at all, then. Good bye.", null);
				TextObject textObject7 = new TextObject("{=Qb7N6txQ}Mmm. For {BRIBE_COST}{GOLD_ICON} denars, I could be persuaded that this is just harmless scrap metal...", null);
				textObject7.SetTextVariable("BRIBE_COST", this._bribeGold);
				textObject7.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
				DialogFlow dialogFlow = DialogFlow.CreateDialogFlow("start", 125).NpcLine(textObject, null, null).Condition(new ConversationSentence.OnConditionDelegate(this.DialogStartCondition))
					.Consequence(delegate
					{
						this._task = this.GetPersuasionTask();
					})
					.BeginPlayerOptions()
					.PlayerOption(textObject2, null)
					.ClickableCondition(new ConversationSentence.OnClickableConditionDelegate(this.CheckPlayerHealth))
					.BeginNpcOptions()
					.NpcOption(new TextObject("{=NcQZz4N2}This is my last warning! It would be better for both sides if you don't resist.[ib:closed]", null), new ConversationSentence.OnConditionDelegate(this.CheckPlayersPartySize), null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=NTlbbrwB}If there will be a fight, then we will fight", null), null)
					.NpcLine(new TextObject("{=h5np5kcC}All right, all right... We don't want any trouble here, okay? Go on.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.PlayerDodgeGuardsLowCrimeRating))
					.CloseDialog()
					.PlayerOption(new TextObject("{=pfxG5Ubu}Fine, fine. Take our weapons.", null), null)
					.NpcLine(new TextObject("{=A8lvIDVw}Wise decision! Now move along! ", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.DeleteAllWeaponsFromPlayer))
					.CloseDialog()
					.EndPlayerOptions()
					.NpcOption(new TextObject("{=G632MneX}This is my last warning! Hand over your weapons![ib:closed]", null), null, null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=NTlbbrwB}If there will be a fight, then we will fight", null), null)
					.NpcLine(new TextObject("{=8WaoQpYn}Oh there will be one, all right.[ib:aggressive]", null), null, null)
					.Consequence(delegate
					{
						this._startBattleMission = true;
					})
					.CloseDialog()
					.PlayerOption(new TextObject("{=pfxG5Ubu}Fine, fine. Take our weapons.", null), null)
					.NpcLine(new TextObject("{=3xyd2Dxu}Good. That saves us all trouble.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.DeleteAllWeaponsFromPlayer))
					.CloseDialog()
					.EndPlayerOptions()
					.EndNpcOptions()
					.PlayerOption(textObject3, null)
					.NpcLine(new TextObject("{=GyI86plp}Don't worry. I guarantee your property will be returned, if everything's in order like you say...[ib:closed]", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.DeleteAllWeaponsFromPlayer))
					.CloseDialog()
					.PlayerOption(textObject4, null)
					.NpcLine(textObject7, null, null)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=Obk7j3ai}Here it is. Now let us pass", null), null)
					.ClickableCondition(new ConversationSentence.OnClickableConditionDelegate(this.HasPlayerEnoughMoneyToBribe))
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.PlayerBribeGuard))
					.NpcLine(new TextObject("{=musbt5Hm}Sorry for the interruption. Go on please...", null), null, null)
					.CloseDialog()
					.PlayerOption(new TextObject("{=d5ztuP3P}That's too much.", null), null)
					.NpcLine(new TextObject("{=49IwOe5E}As you wish...", null), null, null)
					.GotoDialogState("start")
					.EndPlayerOptions()
					.PlayerOption(textObject5, null)
					.Condition(() => !this._persuasionTriedOnce)
					.Consequence(delegate
					{
						this._persuasionTriedOnce = true;
					})
					.GotoDialogState("start_guard_persuasion")
					.PlayerOption(textObject6, null)
					.NpcLine(new TextObject("{=xvYDbEUa}All right. Go on.", null), null, null)
					.Consequence(delegate
					{
						this._playerGoBack = true;
					})
					.CloseDialog()
					.EndPlayerOptions();
				this.AddPersuasionDialogs(dialogFlow);
				return dialogFlow;
			}

			// Token: 0x06004A0D RID: 18957 RVA: 0x0014AA78 File Offset: 0x00148C78
			private bool CheckPlayerHealth(out TextObject explanation)
			{
				explanation = TextObject.Empty;
				if (Hero.MainHero.IsWounded)
				{
					explanation = new TextObject("{=yNMrF2QF}You are wounded", null);
					return false;
				}
				return true;
			}

			// Token: 0x06004A0E RID: 18958 RVA: 0x0014AAA0 File Offset: 0x00148CA0
			private void AddPersuasionDialogs(DialogFlow dialog)
			{
				dialog.AddDialogLine("guard_persuation_weapon_smuggling_check_accepted", "start_guard_persuasion", "guard_persuation_weapon_smuggling_start_reservation", "{=v5tPWFFu}Then, what is the purpose of this?", new ConversationSentence.OnConditionDelegate(this.persuasion_start_with_guards_on_condition), new ConversationSentence.OnConsequenceDelegate(this.persuasion_start_with_guards_on_consequence), this, 100, null, null, null);
				dialog.AddDialogLine("guard_persuation_weapon_smuggling_rejected", "guard_persuation_weapon_smuggling_start_reservation", "start", "{=!}{FAILED_PERSUASION_LINE}", new ConversationSentence.OnConditionDelegate(this.persuasion_failed_with_guards_on_condition), new ConversationSentence.OnConsequenceDelegate(this.persuasion_rejected_with_guards_on_consequence), this, 100, null, null, null);
				dialog.AddDialogLine("guard_persuation_weapon_smuggling_attempt", "guard_persuation_weapon_smuggling_start_reservation", "guard_persuation_weapon_smuggling_select_option", "{=D9SS2Oh0}I'm going to need you to tell me a little more.", () => !this.persuasion_failed_with_guards_on_condition(), null, this, 100, null, null, null);
				dialog.AddDialogLine("guard_persuation_weapon_smuggling_success", "guard_persuation_weapon_smuggling_start_reservation", "close_window", "{=kD8yLgRv}Go on. But I have my eye on you.", new ConversationSentence.OnConditionDelegate(ConversationManager.GetPersuasionProgressSatisfied), new ConversationSentence.OnConsequenceDelegate(this.persuasion_complete_with_guards_on_consequence), this, 200, null, null, null);
				string text = "guard_persuation_weapon_smuggling_select_option_1";
				string text2 = "guard_persuation_weapon_smuggling_select_option";
				string text3 = "guard_persuation_weapon_smuggling_selected_option_response";
				string text4 = "{=!}{GUARDS_PERSUADE_ATTEMPT_1}";
				ConversationSentence.OnConditionDelegate onConditionDelegate = new ConversationSentence.OnConditionDelegate(this.guard_persuation_weapon_smuggling_select_option_1_on_condition);
				ConversationSentence.OnConsequenceDelegate onConsequenceDelegate = new ConversationSentence.OnConsequenceDelegate(this.guard_persuation_weapon_smuggling_select_option_1_on_consequence);
				ConversationSentence.OnPersuasionOptionDelegate onPersuasionOptionDelegate = new ConversationSentence.OnPersuasionOptionDelegate(this.guard_persuation_weapon_smuggling_setup_option_1);
				ConversationSentence.OnClickableConditionDelegate onClickableConditionDelegate = new ConversationSentence.OnClickableConditionDelegate(this.guard_persuation_weapon_smuggling_clickable_option_1_on_condition);
				dialog.AddPlayerLine(text, text2, text3, text4, onConditionDelegate, onConsequenceDelegate, this, 100, onClickableConditionDelegate, onPersuasionOptionDelegate, null, null);
				string text5 = "guard_persuation_weapon_smuggling_select_option_2";
				string text6 = "guard_persuation_weapon_smuggling_select_option";
				string text7 = "guard_persuation_weapon_smuggling_selected_option_response";
				string text8 = "{=!}{GUARDS_PERSUADE_ATTEMPT_2}";
				ConversationSentence.OnConditionDelegate onConditionDelegate2 = new ConversationSentence.OnConditionDelegate(this.guard_persuation_weapon_smuggling_select_option_2_on_condition);
				ConversationSentence.OnConsequenceDelegate onConsequenceDelegate2 = new ConversationSentence.OnConsequenceDelegate(this.guard_persuation_weapon_smuggling_select_option_2_on_consequence);
				onPersuasionOptionDelegate = new ConversationSentence.OnPersuasionOptionDelegate(this.guard_persuation_weapon_smuggling_setup_option_2);
				onClickableConditionDelegate = new ConversationSentence.OnClickableConditionDelegate(this.guard_persuation_weapon_smuggling_clickable_option_2_on_condition);
				dialog.AddPlayerLine(text5, text6, text7, text8, onConditionDelegate2, onConsequenceDelegate2, this, 100, onClickableConditionDelegate, onPersuasionOptionDelegate, null, null);
				string text9 = "guard_persuation_weapon_smuggling_select_option_3";
				string text10 = "guard_persuation_weapon_smuggling_select_option";
				string text11 = "guard_persuation_weapon_smuggling_selected_option_response";
				string text12 = "{=!}{GUARDS_PERSUADE_ATTEMPT_3}";
				ConversationSentence.OnConditionDelegate onConditionDelegate3 = new ConversationSentence.OnConditionDelegate(this.guard_persuation_weapon_smuggling_select_option_3_on_condition);
				ConversationSentence.OnConsequenceDelegate onConsequenceDelegate3 = new ConversationSentence.OnConsequenceDelegate(this.guard_persuation_weapon_smuggling_select_option_3_on_consequence);
				onPersuasionOptionDelegate = new ConversationSentence.OnPersuasionOptionDelegate(this.guard_persuation_weapon_smuggling_setup_option_3);
				onClickableConditionDelegate = new ConversationSentence.OnClickableConditionDelegate(this.guard_persuation_weapon_smuggling_clickable_option_3_on_condition);
				dialog.AddPlayerLine(text9, text10, text11, text12, onConditionDelegate3, onConsequenceDelegate3, this, 100, onClickableConditionDelegate, onPersuasionOptionDelegate, null, null);
				dialog.AddDialogLine("guard_persuation_weapon_smuggling_select_option_reaction", "guard_persuation_weapon_smuggling_selected_option_response", "guard_persuation_weapon_smuggling_start_reservation", "{=!}{PERSUASION_REACTION}", new ConversationSentence.OnConditionDelegate(this.guard_persuation_weapon_smuggling_selected_option_response_on_condition), new ConversationSentence.OnConsequenceDelegate(this.guard_persuation_weapon_smuggling_selected_option_response_on_consequence), this, 100, null, null, null);
			}

			// Token: 0x06004A0F RID: 18959 RVA: 0x0014ACBE File Offset: 0x00148EBE
			private void persuasion_start_with_guards_on_consequence()
			{
				ConversationManager.StartPersuasion(2f, 1f, 0f, 2f, 2f, 0f, PersuasionDifficulty.VeryHard);
			}

			// Token: 0x06004A10 RID: 18960 RVA: 0x0014ACE4 File Offset: 0x00148EE4
			private bool persuasion_start_with_guards_on_condition()
			{
				return this._guardsParty != null && CharacterObject.OneToOneConversationCharacter == ConversationHelper.GetConversationCharacterPartyLeader(this._guardsParty.Party);
			}

			// Token: 0x06004A11 RID: 18961 RVA: 0x0014AD08 File Offset: 0x00148F08
			private bool persuasion_failed_with_guards_on_condition()
			{
				if (this._task.Options.All((PersuasionOptionArgs x) => x.IsBlocked) && !ConversationManager.GetPersuasionProgressSatisfied())
				{
					MBTextManager.SetTextVariable("FAILED_PERSUASION_LINE", this._task.FinalFailLine, false);
					return true;
				}
				return false;
			}

			// Token: 0x06004A12 RID: 18962 RVA: 0x0014AD66 File Offset: 0x00148F66
			private void persuasion_rejected_with_guards_on_consequence()
			{
				PlayerEncounter.LeaveEncounter = false;
				ConversationManager.EndPersuasion();
			}

			// Token: 0x06004A13 RID: 18963 RVA: 0x0014AD73 File Offset: 0x00148F73
			private void persuasion_complete_with_guards_on_consequence()
			{
				this.PlayerDodgedGuards();
				PlayerEncounter.LeaveEncounter = true;
				ConversationManager.EndPersuasion();
			}

			// Token: 0x06004A14 RID: 18964 RVA: 0x0014AD88 File Offset: 0x00148F88
			private PersuasionTask GetPersuasionTask()
			{
				PersuasionTask persuasionTask = new PersuasionTask(0);
				persuasionTask.FinalFailLine = new TextObject("{=XCJGl82o}Do you think you can pull one over on me? Now hand over the weapons!", null);
				persuasionTask.TryLaterLine = new TextObject("{=!}TODO", null);
				persuasionTask.SpokenLine = new TextObject("{=6P1ruzsC}Maybe...", null);
				PersuasionOptionArgs persuasionOptionArgs = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.RogueSkills, TraitEffect.Positive, PersuasionArgumentStrength.Hard, false, new TextObject("{=1hbos200}Here are some documents from the chancellery.", null), null, false, false, false);
				persuasionTask.AddOptionToTask(persuasionOptionArgs);
				PersuasionOptionArgs persuasionOptionArgs2 = new PersuasionOptionArgs(DefaultSkills.Roguery, DefaultTraits.Calculating, TraitEffect.Positive, PersuasionArgumentStrength.Normal, false, new TextObject("{=UHCKXapl}The metalworkers' guild asked for them. Don't worry, they'll be melted into scrap.", null), null, false, false, false);
				persuasionTask.AddOptionToTask(persuasionOptionArgs2);
				PersuasionOptionArgs persuasionOptionArgs3 = new PersuasionOptionArgs(DefaultSkills.Charm, DefaultTraits.RogueSkills, TraitEffect.Positive, PersuasionArgumentStrength.VeryHard, false, new TextObject("{=8Wa6OxG8}It's secret. You must be new in your post if you don't know who I am and what I do.", null), null, false, false, false);
				persuasionTask.AddOptionToTask(persuasionOptionArgs3);
				return persuasionTask;
			}

			// Token: 0x06004A15 RID: 18965 RVA: 0x0014AE4C File Offset: 0x0014904C
			private bool guard_persuation_weapon_smuggling_selected_option_response_on_condition()
			{
				PersuasionOptionResult item = ConversationManager.GetPersuasionChosenOptions().Last<Tuple<PersuasionOptionArgs, PersuasionOptionResult>>().Item2;
				MBTextManager.SetTextVariable("PERSUASION_REACTION", PersuasionHelper.GetDefaultPersuasionOptionReaction(item), false);
				if (item == PersuasionOptionResult.CriticalFailure)
				{
					this._task.BlockAllOptions();
				}
				return true;
			}

			// Token: 0x06004A16 RID: 18966 RVA: 0x0014AE8C File Offset: 0x0014908C
			private void guard_persuation_weapon_smuggling_selected_option_response_on_consequence()
			{
				Tuple<PersuasionOptionArgs, PersuasionOptionResult> tuple = ConversationManager.GetPersuasionChosenOptions().Last<Tuple<PersuasionOptionArgs, PersuasionOptionResult>>();
				float difficulty = Campaign.Current.Models.PersuasionModel.GetDifficulty(PersuasionDifficulty.VeryHard);
				float num;
				float num2;
				Campaign.Current.Models.PersuasionModel.GetEffectChances(tuple.Item1, out num, out num2, difficulty);
				this._task.ApplyEffects(num, num2);
			}

			// Token: 0x06004A17 RID: 18967 RVA: 0x0014AEE8 File Offset: 0x001490E8
			private bool guard_persuation_weapon_smuggling_select_option_1_on_condition()
			{
				if (this._task.Options.Count > 0)
				{
					TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}", null);
					textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(this._task.Options.ElementAt(0), false));
					textObject.SetTextVariable("PERSUASION_OPTION_LINE", this._task.Options.ElementAt(0).Line);
					MBTextManager.SetTextVariable("GUARDS_PERSUADE_ATTEMPT_1", textObject, false);
					return true;
				}
				return false;
			}

			// Token: 0x06004A18 RID: 18968 RVA: 0x0014AF68 File Offset: 0x00149168
			private bool guard_persuation_weapon_smuggling_select_option_2_on_condition()
			{
				if (this._task.Options.Count > 1)
				{
					TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}", null);
					textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(this._task.Options.ElementAt(1), false));
					textObject.SetTextVariable("PERSUASION_OPTION_LINE", this._task.Options.ElementAt(1).Line);
					MBTextManager.SetTextVariable("GUARDS_PERSUADE_ATTEMPT_2", textObject, false);
					return true;
				}
				return false;
			}

			// Token: 0x06004A19 RID: 18969 RVA: 0x0014AFE8 File Offset: 0x001491E8
			private bool guard_persuation_weapon_smuggling_select_option_3_on_condition()
			{
				if (this._task.Options.Count > 2)
				{
					TextObject textObject = new TextObject("{=bSo9hKwr}{PERSUASION_OPTION_LINE} {SUCCESS_CHANCE}", null);
					textObject.SetTextVariable("SUCCESS_CHANCE", PersuasionHelper.ShowSuccess(this._task.Options.ElementAt(2), false));
					textObject.SetTextVariable("PERSUASION_OPTION_LINE", this._task.Options.ElementAt(2).Line);
					MBTextManager.SetTextVariable("GUARDS_PERSUADE_ATTEMPT_3", textObject, false);
					return true;
				}
				return false;
			}

			// Token: 0x06004A1A RID: 18970 RVA: 0x0014B068 File Offset: 0x00149268
			private void guard_persuation_weapon_smuggling_select_option_1_on_consequence()
			{
				if (this._task.Options.Count > 0)
				{
					this._task.Options[0].BlockTheOption(true);
				}
			}

			// Token: 0x06004A1B RID: 18971 RVA: 0x0014B094 File Offset: 0x00149294
			private void guard_persuation_weapon_smuggling_select_option_2_on_consequence()
			{
				if (this._task.Options.Count > 1)
				{
					this._task.Options[1].BlockTheOption(true);
				}
			}

			// Token: 0x06004A1C RID: 18972 RVA: 0x0014B0C0 File Offset: 0x001492C0
			private void guard_persuation_weapon_smuggling_select_option_3_on_consequence()
			{
				if (this._task.Options.Count > 2)
				{
					this._task.Options[2].BlockTheOption(true);
				}
			}

			// Token: 0x06004A1D RID: 18973 RVA: 0x0014B0EC File Offset: 0x001492EC
			private PersuasionOptionArgs guard_persuation_weapon_smuggling_setup_option_1()
			{
				return this._task.Options.ElementAt(0);
			}

			// Token: 0x06004A1E RID: 18974 RVA: 0x0014B0FF File Offset: 0x001492FF
			private PersuasionOptionArgs guard_persuation_weapon_smuggling_setup_option_2()
			{
				return this._task.Options.ElementAt(1);
			}

			// Token: 0x06004A1F RID: 18975 RVA: 0x0014B112 File Offset: 0x00149312
			private PersuasionOptionArgs guard_persuation_weapon_smuggling_setup_option_3()
			{
				return this._task.Options.ElementAt(2);
			}

			// Token: 0x06004A20 RID: 18976 RVA: 0x0014B128 File Offset: 0x00149328
			private bool guard_persuation_weapon_smuggling_clickable_option_1_on_condition(out TextObject hintText)
			{
				hintText = new TextObject("{=9ACJsI6S}Blocked", null);
				if (this._task.Options.Count > 0)
				{
					hintText = (this._task.Options.ElementAt(0).IsBlocked ? hintText : TextObject.Empty);
					return !this._task.Options.ElementAt(0).IsBlocked;
				}
				return false;
			}

			// Token: 0x06004A21 RID: 18977 RVA: 0x0014B194 File Offset: 0x00149394
			private bool guard_persuation_weapon_smuggling_clickable_option_2_on_condition(out TextObject hintText)
			{
				hintText = new TextObject("{=9ACJsI6S}Blocked", null);
				if (this._task.Options.Count > 1)
				{
					hintText = (this._task.Options.ElementAt(1).IsBlocked ? hintText : TextObject.Empty);
					return !this._task.Options.ElementAt(1).IsBlocked;
				}
				return false;
			}

			// Token: 0x06004A22 RID: 18978 RVA: 0x0014B200 File Offset: 0x00149400
			private bool guard_persuation_weapon_smuggling_clickable_option_3_on_condition(out TextObject hintText)
			{
				hintText = new TextObject("{=9ACJsI6S}Blocked", null);
				if (this._task.Options.Count > 2)
				{
					hintText = (this._task.Options.ElementAt(2).IsBlocked ? hintText : TextObject.Empty);
					return !this._task.Options.ElementAt(2).IsBlocked;
				}
				return false;
			}

			// Token: 0x06004A23 RID: 18979 RVA: 0x0014B26B File Offset: 0x0014946B
			private bool DialogStartCondition()
			{
				return !this._playerDodgedGuards && this._guardsParty != null && CharacterObject.OneToOneConversationCharacter == ConversationHelper.GetConversationCharacterPartyLeader(this._guardsParty.Party);
			}

			// Token: 0x06004A24 RID: 18980 RVA: 0x0014B298 File Offset: 0x00149498
			private void StartFight()
			{
				int num = (base.QuestGiver.CurrentSettlement.IsTown ? base.QuestGiver.CurrentSettlement.Town.GetWallLevel() : 1);
				this._highCrimeRatingWillBeApplied = true;
				if (this._guardsParty.CurrentSettlement == null)
				{
					this._guardsParty.CurrentSettlement = base.QuestGiver.CurrentSettlement;
				}
				PlayerEncounter.RestartPlayerEncounter(this._guardsParty.Party, PartyBase.MainParty, false);
				PlayerEncounter.StartBattle();
				GameMenu.ActivateGameMenu("town");
				int num2 = (int)(5f + 15f * this._issueDifficulty);
				CampaignMission.OpenBattleMissionWhileEnteringSettlement(base.QuestGiver.CurrentSettlement.LocationComplex.GetLocationWithId("center").GetSceneName(num), num, num2, num2);
				this._checkForBattleResult = true;
			}

			// Token: 0x06004A25 RID: 18981 RVA: 0x0014B364 File Offset: 0x00149564
			private void PlayerDodgeGuardsLowCrimeRating()
			{
				this.PlayerDodgedGuards();
				this._lowCrimeRatingWillBeApplied = true;
			}

			// Token: 0x06004A26 RID: 18982 RVA: 0x0014B373 File Offset: 0x00149573
			private bool CheckPlayersPartySize()
			{
				return MobileParty.MainParty.MemberRoster.TotalRegulars - MobileParty.MainParty.MemberRoster.TotalWoundedRegulars > 30;
			}

			// Token: 0x06004A27 RID: 18983 RVA: 0x0014B398 File Offset: 0x00149598
			private void PlayerDodgedGuards()
			{
				MBInformationManager.AddQuickInformation(new TextObject("{=vYRbyXkz}The guards won't come after you anymore.", null), 0, null, "");
				if (this._guardsParty.IsActive && this._guardsParty.IsVisible)
				{
					DestroyPartyAction.Apply(PartyBase.MainParty, this._guardsParty);
				}
				this._playerDodgedGuards = true;
			}

			// Token: 0x06004A28 RID: 18984 RVA: 0x0014B3ED File Offset: 0x001495ED
			private void PlayerBribeGuard()
			{
				GiveGoldAction.ApplyBetweenCharacters(Hero.MainHero, null, this._bribeGold, false);
				this.PlayerDodgedGuards();
			}

			// Token: 0x06004A29 RID: 18985 RVA: 0x0014B408 File Offset: 0x00149608
			private void DeleteAllWeaponsFromPlayer()
			{
				Dictionary<EquipmentElement, int> dictionary = new Dictionary<EquipmentElement, int>();
				foreach (ItemRosterElement itemRosterElement in PartyBase.MainParty.ItemRoster)
				{
					if (itemRosterElement.EquipmentElement.Item != null && !itemRosterElement.EquipmentElement.IsQuestItem && itemRosterElement.EquipmentElement.Item.WeaponComponent != null && itemRosterElement.Amount > 0 && !dictionary.ContainsKey(itemRosterElement.EquipmentElement))
					{
						dictionary.Add(itemRosterElement.EquipmentElement, itemRosterElement.Amount);
						PartyBase.MainParty.ItemRoster.AddToCounts(itemRosterElement.EquipmentElement, -itemRosterElement.Amount);
					}
				}
				this._weaponsThatGuardTook = dictionary;
				this.CalculateAndSetRequestedItemCountOnPlayer();
			}

			// Token: 0x06004A2A RID: 18986 RVA: 0x0014B4F0 File Offset: 0x001496F0
			private void QuestSuccessDeleteWeaponsFromPlayer()
			{
				int num = this._requestedWeaponAmount;
				for (int i = PartyBase.MainParty.ItemRoster.Count - 1; i >= 0; i--)
				{
					ItemRosterElement itemRosterElement = PartyBase.MainParty.ItemRoster[i];
					if (itemRosterElement.EquipmentElement.Item != null && itemRosterElement.EquipmentElement.Item.WeaponComponent != null && itemRosterElement.EquipmentElement.Item.WeaponComponent.PrimaryWeapon.WeaponClass == this._requestedWeaponClass && itemRosterElement.Amount > 0)
					{
						if (num < itemRosterElement.Amount)
						{
							PartyBase.MainParty.ItemRoster.AddToCounts(itemRosterElement.EquipmentElement, -num);
							return;
						}
						PartyBase.MainParty.ItemRoster.AddToCounts(itemRosterElement.EquipmentElement, -itemRosterElement.Amount);
						num -= itemRosterElement.Amount;
					}
					if (num == 0)
					{
						break;
					}
				}
			}

			// Token: 0x06004A2B RID: 18987 RVA: 0x0014B5E3 File Offset: 0x001497E3
			private bool HasPlayerEnoughMoneyToBribe(out TextObject hintText)
			{
				hintText = TextObject.Empty;
				if (Hero.MainHero.Gold < this._bribeGold)
				{
					hintText = new TextObject("{=1V6DRayw}You don't have {BRIBE_COST} denars.", null);
					hintText.SetTextVariable("BRIBE_COST", this._bribeGold);
					return false;
				}
				return true;
			}

			// Token: 0x06004A2C RID: 18988 RVA: 0x0014B621 File Offset: 0x00149821
			private void PlayerDefeatedAgainstGuards()
			{
				base.AddLog(this.FailPlayerDefeatedAgainstGuardsLogText, false);
				base.QuestGiver.AddPower(-10f);
				this.RelationshipChangeWithQuestGiver = -5;
				base.CompleteQuestWithFail(null);
			}

			// Token: 0x06004A2D RID: 18989 RVA: 0x0014B650 File Offset: 0x00149850
			private void PlayerSuccessfullyDeliveredWeapons()
			{
				base.AddLog(this.SuccessQuestLogText, false);
				GainRenownAction.Apply(Hero.MainHero, 2f, false);
				GiveGoldAction.ApplyBetweenCharacters(null, Hero.MainHero, (int)this._rewardGold, false);
				base.QuestGiver.AddPower(10f);
				this.RelationshipChangeWithQuestGiver = 5;
				this.QuestSuccessDeleteWeaponsFromPlayer();
				this._weaponsThatGuardTook.Clear();
				base.QuestGiver.CurrentSettlement.Town.Security -= 30f;
				if (this._lowCrimeRatingWillBeApplied)
				{
					ChangeCrimeRatingAction.Apply(base.QuestGiver.CurrentSettlement.MapFaction, 30f, true);
				}
				if (this._highCrimeRatingWillBeApplied)
				{
					ChangeCrimeRatingAction.Apply(base.QuestGiver.CurrentSettlement.MapFaction, 60f, true);
				}
				base.CompleteQuestWithSuccess();
			}

			// Token: 0x06004A2E RID: 18990 RVA: 0x0014B724 File Offset: 0x00149924
			public override void OnFailed()
			{
				if (this._lowCrimeRatingWillBeApplied)
				{
					ChangeCrimeRatingAction.Apply(base.QuestGiver.CurrentSettlement.MapFaction, 30f, true);
				}
				if (this._highCrimeRatingWillBeApplied)
				{
					ChangeCrimeRatingAction.Apply(base.QuestGiver.CurrentSettlement.MapFaction, 60f, true);
				}
			}

			// Token: 0x06004A2F RID: 18991 RVA: 0x0014B777 File Offset: 0x00149977
			protected override void OnFinalize()
			{
				if (this._guardsParty != null && this._guardsParty.IsActive)
				{
					DestroyPartyAction.Apply(PartyBase.MainParty, this._guardsParty);
				}
			}

			// Token: 0x06004A30 RID: 18992 RVA: 0x0014B79E File Offset: 0x0014999E
			protected override void OnTimedOut()
			{
				base.AddLog(this.FailQuestTimedOutLogText, false);
				base.QuestGiver.AddPower(-10f);
				this.RelationshipChangeWithQuestGiver = -5;
			}

			// Token: 0x04001982 RID: 6530
			private const int LowCrimeRatingValue = 30;

			// Token: 0x04001983 RID: 6531
			private const int HighCrimeRatingValue = 60;

			// Token: 0x04001984 RID: 6532
			private WeaponClass _requestedWeaponClass;

			// Token: 0x04001985 RID: 6533
			[SaveableField(10)]
			private int _randomForRequiredWeaponClass;

			// Token: 0x04001986 RID: 6534
			[SaveableField(20)]
			private int _requestedWeaponAmount;

			// Token: 0x04001987 RID: 6535
			[SaveableField(30)]
			private bool _playerDodgedGuards;

			// Token: 0x04001988 RID: 6536
			[SaveableField(40)]
			private int _collectedItemAmount;

			// Token: 0x04001989 RID: 6537
			[SaveableField(50)]
			private bool _lowCrimeRatingWillBeApplied;

			// Token: 0x0400198A RID: 6538
			[SaveableField(60)]
			private bool _highCrimeRatingWillBeApplied;

			// Token: 0x0400198B RID: 6539
			[SaveableField(71)]
			private Dictionary<EquipmentElement, int> _weaponsThatGuardTook;

			// Token: 0x0400198C RID: 6540
			[SaveableField(80)]
			private float _issueDifficulty;

			// Token: 0x0400198D RID: 6541
			[SaveableField(90)]
			private float _rewardGold;

			// Token: 0x0400198E RID: 6542
			[SaveableField(100)]
			private int _bribeGold;

			// Token: 0x0400198F RID: 6543
			[SaveableField(101)]
			private bool _persuasionTriedOnce;

			// Token: 0x04001990 RID: 6544
			private bool _checkForBattleResult;

			// Token: 0x04001991 RID: 6545
			private MobileParty _guardsParty;

			// Token: 0x04001992 RID: 6546
			private bool _startBattleMission;

			// Token: 0x04001993 RID: 6547
			private bool _playerGoBack;

			// Token: 0x04001994 RID: 6548
			private PersuasionTask _task;

			// Token: 0x04001995 RID: 6549
			private const PersuasionDifficulty Difficulty = PersuasionDifficulty.VeryHard;

			// Token: 0x04001996 RID: 6550
			[SaveableField(110)]
			private JournalLog _playerStartsQuestLog;
		}

		// Token: 0x02000621 RID: 1569
		public class GangLeaderNeedsWeaponsIssueTypeDefiner : SaveableTypeDefiner
		{
			// Token: 0x06004A3C RID: 19004 RVA: 0x0014B87C File Offset: 0x00149A7C
			public GangLeaderNeedsWeaponsIssueTypeDefiner()
				: base(3940000)
			{
			}

			// Token: 0x06004A3D RID: 19005 RVA: 0x0014B889 File Offset: 0x00149A89
			protected override void DefineClassTypes()
			{
				base.AddClassDefinition(typeof(GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssue), 1, null);
				base.AddClassDefinition(typeof(GangLeaderNeedsWeaponsIssueQuestBehavior.GangLeaderNeedsWeaponsIssueQuest), 2, null);
			}
		}
	}
}
