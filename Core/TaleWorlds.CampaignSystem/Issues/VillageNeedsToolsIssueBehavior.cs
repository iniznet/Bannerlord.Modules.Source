using System;
using System.Collections.Generic;
using System.Linq;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues
{
	public class VillageNeedsToolsIssueBehavior : CampaignBehaviorBase
	{
		public override void RegisterEvents()
		{
			CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener(this, new Action<Hero>(this.OnCheckForIssue));
		}

		private void OnCheckForIssue(Hero hero)
		{
			ItemObject tools = DefaultItems.Tools;
			if (this.ConditionsHold(hero, tools))
			{
				Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnStartIssue), typeof(VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue), IssueBase.IssueFrequency.VeryCommon, tools));
				return;
			}
			Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof(VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue), IssueBase.IssueFrequency.VeryCommon));
		}

		private bool ConditionsHold(Hero issueGiver, ItemObject item)
		{
			Settlement currentSettlement = issueGiver.CurrentSettlement;
			if (issueGiver.IsHeadman && currentSettlement != null && currentSettlement.IsVillage && currentSettlement.Village.GetProsperityLevel() < SettlementComponent.ProsperityLevel.Mid && currentSettlement.Village.VillageType.Productions.Count > 0)
			{
				if (currentSettlement.Village.VillageType.Productions.All((ValueTuple<ItemObject, float> x) => !x.Item1.IsAnimal))
				{
					return currentSettlement.ItemRoster.GetItemNumber(item) == 0;
				}
			}
			return false;
		}

		private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
		{
			PotentialIssueData potentialIssueData = pid;
			return new VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue(issueOwner, (ItemObject)potentialIssueData.RelatedObject);
		}

		public override void SyncData(IDataStore dataStore)
		{
		}

		private const IssueBase.IssueFrequency VillageNeedsToolsIssueFrequency = IssueBase.IssueFrequency.VeryCommon;

		public class VillageNeedsToolsIssue : IssueBase
		{
			internal static void AutoGeneratedStaticCollectObjectsVillageNeedsToolsIssue(object o, List<object> collectedObjects)
			{
				((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._requestedItem);
				collectedObjects.Add(this._exchangeItem);
			}

			internal static object AutoGeneratedGetMemberValue_requestedItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o)._requestedItem;
			}

			internal static object AutoGeneratedGetMemberValue_exchangeItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o)._exchangeItem;
			}

			internal static object AutoGeneratedGetMemberValue_numberOfExchangeItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o)._numberOfExchangeItem;
			}

			internal static object AutoGeneratedGetMemberValue_numberOfRequestedItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o)._numberOfRequestedItem;
			}

			internal static object AutoGeneratedGetMemberValue_payment(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue)o)._payment;
			}

			public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
			{
				get
				{
					return IssueBase.AlternativeSolutionScaleFlag.Duration;
				}
			}

			protected override int RewardGold
			{
				get
				{
					return 500 + this._numberOfRequestedItem * (int)((float)(base.IssueSettlement.SettlementComponent.GetItemPrice(this._requestedItem, null, false) + this._requestedItem.Value) / 2f);
				}
			}

			private int CostOfToolsForAlternativeSolution
			{
				get
				{
					return (int)((float)(this._requestedItem.Value * this._numberOfRequestedItem) * 0.7f);
				}
			}

			protected override int CompanionSkillRewardXP
			{
				get
				{
					return 500 + (int)(700f * base.IssueDifficultyMultiplier);
				}
			}

			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=gnuojd9u}{VILLAGE} Needs Tools", null);
					textObject.SetTextVariable("VILLAGE", base.IssueOwner.CurrentSettlement.Name);
					return textObject;
				}
			}

			public override TextObject Description
			{
				get
				{
					return new TextObject("{=Td2RGRBn}Headman in the village requested tools to increase production.", null);
				}
			}

			public override TextObject IssueBriefByIssueGiver
			{
				get
				{
					return new TextObject("{=BGJpwxvm}We do have some problems. [ib:demure][if:convo_dismayed] A sickness passed through here last month. Praise the Heavens, only a few people died, but many were weakened and we couldn't get much work done. Now we need to hire some laborers from nearby settlements to make up the shortfall, but we don't have the tools for them. We're in a bit of a rush - do you think you could find tools for us?", null);
				}
			}

			public override TextObject IssueAcceptByPlayer
			{
				get
				{
					return new TextObject("{=3EL0wY1h}Tell me about the details.", null);
				}
			}

			public override TextObject IssueQuestSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject;
					if (this._exchangeItem == null)
					{
						textObject = new TextObject("{=daXZlOBi}We need {REQUESTED_ITEM_COUNT} {.%}{?(REQUESTED_ITEM_COUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?}{.%} in {NUMBER_OF_DAYS} days. We can offer {PAYMENT}{GOLD_ICON} for the tools and your services. What do you say?", null);
						textObject.SetTextVariable("PAYMENT", this._payment);
					}
					else
					{
						textObject = new TextObject("{=uwmfgcM3}We need {REQUESTED_ITEM_COUNT} {.%}{?(REQUESTED_ITEM_COUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?}{.%} in {NUMBER_OF_DAYS} days. The village is short on denars so we can make the payment in kind - with {?NUMBER_OF_EXCHANGE_ITEM > 1}{NUMBER_OF_EXCHANGE_ITEM} {._}{PLURAL(EXCHANGE_ITEM)}{?}one {._}{EXCHANGE_ITEM}{\\?}. What do you say?", null);
						textObject.SetTextVariable("EXCHANGE_ITEM", this._exchangeItem.Name);
						textObject.SetTextVariable("NUMBER_OF_EXCHANGE_ITEM", this._numberOfExchangeItem);
					}
					textObject.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
					textObject.SetTextVariable("REQUESTED_ITEM_COUNT", this._numberOfRequestedItem);
					textObject.SetTextVariable("NUMBER_OF_DAYS", 30);
					return textObject;
				}
			}

			public override TextObject IssuePlayerResponseAfterAlternativeExplanation
			{
				get
				{
					return new TextObject("{=Tp4X51vX}Maybe my men can handle this for you.", null);
				}
			}

			public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
			{
				get
				{
					TextObject textObject = new TextObject("{=8llksa4h}If so, you'll need a man with good understanding of trade. Also you will need at least {NUMBER_OF_TROOPS} fighting men to protect the goods while taking them to market and back. Your companion will also probably need around {GOLD_COST}{GOLD_ICON} in order to buy the tools.[if:convo_confused_normal]", null);
					textObject.SetTextVariable("NUMBER_OF_TROOPS", base.GetTotalAlternativeSolutionNeededMenCount());
					textObject.SetTextVariable("GOLD_COST", this.CostOfToolsForAlternativeSolution);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					return textObject;
				}
			}

			public override TextObject IssueQuestSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=ggGmjgIS}I think I can handle this myself.", null);
				}
			}

			public override TextObject IssueAlternativeSolutionAcceptByPlayer
			{
				get
				{
					return new TextObject("{=5aDpzB1F}My men will deliver your goods on time don't worry.", null);
				}
			}

			public override TextObject IssueDiscussAlternativeSolution
			{
				get
				{
					return new TextObject("{=bkZOcbGu}Your men are still getting us the tools. I ask for your patience. We very much appreciate this.", null);
				}
			}

			public override bool IsThereAlternativeSolution
			{
				get
				{
					return true;
				}
			}

			public override bool IsThereLordSolution
			{
				get
				{
					return false;
				}
			}

			protected override int AlternativeSolutionBaseDurationInDaysInternal
			{
				get
				{
					return 4 + MathF.Ceiling(5f * base.IssueDifficultyMultiplier);
				}
			}

			public override int AlternativeSolutionBaseNeededMenCount
			{
				get
				{
					return 2 + MathF.Ceiling(4f * base.IssueDifficultyMultiplier);
				}
			}

			public override TextObject IssueAlternativeSolutionResponseByIssueGiver
			{
				get
				{
					return new TextObject("{=JxUrkzd1}Thank you. I hope your men can get us the tools on time. Good luck.[ib:demure][if:convo_astonished]", null);
				}
			}

			protected override TextObject AlternativeSolutionStartLog
			{
				get
				{
					TextObject textObject = new TextObject("{=qycE7IO0}{QUEST_GIVER.LINK} told you that {?QUEST_GIVER.GENDER}she{?}he{\\?} needs {._}{ITEM} for {?QUEST_GIVER.GENDER}her{?}his{\\?} village. {?QUEST_GIVER.GENDER}She{?}He{\\?} offers you {REWARD_GOLD}{GOLD_ICON} for the delivery of the tools. You asked your companion {COMPANION.LINK} and {NEEDED_MEN_COUNT} of your men to deliver {NUMBER_OF_ITEM} {?NUMBER_OF_ITEM>1}units{?}unit{\\?} of {._}{ITEM} to {QUEST_GIVER.LINK}. They will rejoin your party in {ALTERNATIVE_SOLUTION_DURATION} days.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, textObject, false);
					textObject.SetTextVariable("ITEM", this._requestedItem.Name);
					textObject.SetTextVariable("NUMBER_OF_ITEM", this._numberOfRequestedItem);
					textObject.SetTextVariable("REWARD_GOLD", this.RewardGold);
					textObject.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					textObject.SetTextVariable("NEEDED_MEN_COUNT", base.GetTotalAlternativeSolutionNeededMenCount());
					textObject.SetTextVariable("ALTERNATIVE_SOLUTION_DURATION", base.GetTotalAlternativeSolutionDurationInDays());
					return textObject;
				}
			}

			public override TextObject IssueAlternativeSolutionSuccessLog
			{
				get
				{
					TextObject textObject = new TextObject("{=W0w0Eunx}Your companion {COMPANION.LINK} has delivered {ISSUE_GIVER.LINK}'s goods as you promised.", null);
					StringHelpers.SetCharacterProperties("ISSUE_GIVER", base.IssueOwner.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("COMPANION", base.AlternativeSolutionHero.CharacterObject, textObject, false);
					return textObject;
				}
			}

			public VillageNeedsToolsIssue(Hero issueOwner, ItemObject requestedItem)
				: base(issueOwner, CampaignTime.DaysFromNow(30f))
			{
				this._requestedItem = requestedItem;
				int itemPrice = issueOwner.CurrentSettlement.SettlementComponent.GetItemPrice(this._requestedItem, null, false);
				this._numberOfRequestedItem = MathF.Round((float)((int)(2500f / (float)this._requestedItem.Value)) * base.IssueDifficultyMultiplier);
				int num = 500 + this._numberOfRequestedItem * (int)((float)(itemPrice + this._requestedItem.Value) / 2f);
				if (issueOwner.CurrentSettlement.Village.Hearth < 300f)
				{
					this._exchangeItem = issueOwner.CurrentSettlement.Village.VillageType.PrimaryProduction;
					this._numberOfExchangeItem = MathF.Ceiling((float)num * 0.7f / (float)this._exchangeItem.Value);
					return;
				}
				this._payment = num;
				this._numberOfExchangeItem = 0;
				this._exchangeItem = null;
			}

			protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
			{
				if (issueEffect == DefaultIssueEffects.VillageHearth)
				{
					return -0.2f;
				}
				return 0f;
			}

			public override ValueTuple<SkillObject, int> GetAlternativeSolutionSkill(Hero hero)
			{
				return new ValueTuple<SkillObject, int>((hero.GetSkillValue(DefaultSkills.Engineering) >= hero.GetSkillValue(DefaultSkills.Crafting)) ? DefaultSkills.Engineering : DefaultSkills.Crafting, 120);
			}

			protected override void OnGameLoad()
			{
			}

			protected override void HourlyTick()
			{
			}

			protected override QuestBase GenerateIssueQuest(string questId)
			{
				return new VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest(questId, base.IssueOwner, this._requestedItem, this._numberOfRequestedItem, this._exchangeItem, this._numberOfExchangeItem, this._payment, CampaignTime.DaysFromNow(30f));
			}

			public override IssueBase.IssueFrequency GetFrequency()
			{
				return IssueBase.IssueFrequency.VeryCommon;
			}

			protected override bool CanPlayerTakeQuestConditions(Hero issueGiver, out IssueBase.PreconditionFlags flag, out Hero relationHero, out SkillObject skill)
			{
				bool flag2 = issueGiver.GetRelationWithPlayer() >= -10f && !issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction);
				flag = (flag2 ? IssueBase.PreconditionFlags.None : ((!issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction)) ? IssueBase.PreconditionFlags.Relation : IssueBase.PreconditionFlags.AtWar));
				relationHero = issueGiver;
				skill = null;
				return flag2;
			}

			public override bool IssueStayAliveConditions()
			{
				return base.IssueOwner.CurrentSettlement.ItemRoster.GetItemNumber(this._requestedItem) == 0 && !base.IssueOwner.CurrentSettlement.IsRaided && !base.IssueOwner.CurrentSettlement.IsUnderRaid;
			}

			protected override void CompleteIssueWithTimedOutConsequences()
			{
			}

			public override void AlternativeSolutionStartConsequence()
			{
				GiveGoldAction.ApplyForCharacterToParty(Hero.MainHero, null, this.CostOfToolsForAlternativeSolution, false);
			}

			public override bool DoTroopsSatisfyAlternativeSolution(TroopRoster troopRoster, out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false);
			}

			public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
			{
				return character.Tier >= 2;
			}

			public override bool AlternativeSolutionCondition(out TextObject explanation)
			{
				explanation = TextObject.Empty;
				return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, base.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2, false) && QuestHelper.CheckGoldForAlternativeSolution(this.CostOfToolsForAlternativeSolution, ref explanation);
			}

			protected override void AlternativeSolutionEndWithSuccessConsequence()
			{
				VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest.GiveTradeOrExchangeRewardToMainParty(base.IssueOwner, this._payment, this._exchangeItem, this._numberOfExchangeItem);
				ChangeRelationAction.ApplyPlayerRelation(base.IssueOwner, 5, true, true);
				base.IssueOwner.AddPower(10f);
				base.IssueOwner.CurrentSettlement.Village.Hearth += 50f;
			}

			private const int TimeLimit = 30;

			private const int TroopTierForAlternativeSolution = 2;

			public const int PowerRewardForQuestGiverOnSuccess = 10;

			private const int RelationWithIssueOwnerRewardOnSuccess = 5;

			private const int VillageHeartChangeOnSuccess = 50;

			private const int RequiredSkillValueForAlternativeSolution = 120;

			[SaveableField(10)]
			private readonly ItemObject _requestedItem;

			[SaveableField(20)]
			private readonly ItemObject _exchangeItem;

			[SaveableField(30)]
			private readonly int _numberOfExchangeItem;

			[SaveableField(40)]
			private readonly int _numberOfRequestedItem;

			[SaveableField(50)]
			private readonly int _payment;
		}

		public class VillageNeedsToolsIssueQuest : QuestBase
		{
			internal static void AutoGeneratedStaticCollectObjectsVillageNeedsToolsIssueQuest(object o, List<object> collectedObjects)
			{
				((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
			}

			protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
			{
				base.AutoGeneratedInstanceCollectObjects(collectedObjects);
				collectedObjects.Add(this._requestedTradeGood);
				collectedObjects.Add(this._exchangeItem);
				collectedObjects.Add(this._numberOfToolsLog);
			}

			internal static object AutoGeneratedGetMemberValue_requestedTradeGood(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o)._requestedTradeGood;
			}

			internal static object AutoGeneratedGetMemberValue_numberOfRequestedGood(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o)._numberOfRequestedGood;
			}

			internal static object AutoGeneratedGetMemberValue_exchangeItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o)._exchangeItem;
			}

			internal static object AutoGeneratedGetMemberValue_numberOfExchangeItem(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o)._numberOfExchangeItem;
			}

			internal static object AutoGeneratedGetMemberValue_numberOfToolsLog(object o)
			{
				return ((VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest)o)._numberOfToolsLog;
			}

			public override TextObject Title
			{
				get
				{
					TextObject textObject = new TextObject("{=gnuojd9u}{VILLAGE} Needs Tools", null);
					textObject.SetTextVariable("VILLAGE", base.QuestGiver.CurrentSettlement.Name);
					return textObject;
				}
			}

			public override bool IsRemainingTimeHidden
			{
				get
				{
					return false;
				}
			}

			private TextObject QuestStartedLog
			{
				get
				{
					TextObject textObject = new TextObject("{=BOp61V4A}{QUEST_GIVER.LINK} told you that {?QUEST_GIVER.GENDER}she{?}he{\\?} needs {._}{REQUIRED_ITEM} for {?QUEST_GIVER.GENDER}her{?}his{\\?} village. {?QUEST_GIVER.GENDER}She{?}He{\\?} asked you to bring {ITEM_COUNT} {.%}{?(ITEM_COUNT > 1)}{PLURAL(REQUIRED_ITEM)}{?}{REQUIRED_ITEM}{\\?}{.%}  to {?QUEST_GIVER.GENDER}her{?}him{\\?}. {PAYMENT_DESCRIPTION}", null);
					textObject.SetTextVariable("REQUIRED_ITEM", this._requestedTradeGood.Name);
					textObject.SetTextVariable("ITEM_COUNT", this._numberOfRequestedGood);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					TextObject textObject2;
					if (this._exchangeItem == null)
					{
						textObject2 = new TextObject("{=ZOTBiLiS}{?QUEST_GIVER.GENDER}She{?}He{\\?} will pay you {PAYMENT}{GOLD_ICON} when the task is done.", null);
						textObject2.SetTextVariable("PAYMENT", this.RewardGold);
						textObject2.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
					}
					else
					{
						textObject2 = new TextObject("{=eQzskygV}{?QUEST_GIVER.GENDER}She{?}He{\\?} will make payment as {EXCHANGE_ITEM_COUNT} {?EXCHANGE_ITEM_COUNT>1}units{?}unit{\\?} of {._}{EXCHANGE_ITEM} when the task is done.", null);
						textObject2.SetTextVariable("EXCHANGE_ITEM", this._exchangeItem.Name);
						textObject2.SetTextVariable("EXCHANGE_ITEM_COUNT", this._numberOfExchangeItem);
					}
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject2, false);
					textObject.SetTextVariable("PAYMENT_DESCRIPTION", textObject2);
					return textObject;
				}
			}

			private TextObject WarDeclaredQuestCancelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=PakhagOy}Your clan is now at war with {QUEST_GIVER.LINK}'s lord. Your agreement with {QUEST_GIVER.LINK} was canceled.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject PlayerDeclaredWarQuestLogText
			{
				get
				{
					TextObject textObject = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					return textObject;
				}
			}

			private TextObject VillageRaidedQuestCancelLog
			{
				get
				{
					TextObject textObject = new TextObject("{=9zJNjWes}{SETTLEMENT} was raided. Your agreement with {QUEST_GIVER.LINK} was canceled.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("SETTLEMENT", base.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
					return textObject;
				}
			}

			private TextObject QuestTimeOutFailLog
			{
				get
				{
					TextObject textObject = new TextObject("{=jXTshvhV}You couldn't fully bring {ITEM} to {?QUEST_GIVER.GENDER}her{?}him{\\?} on time.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("ITEM", this._requestedTradeGood.Name);
					return textObject;
				}
			}

			private TextObject QuestSuccessLog
			{
				get
				{
					TextObject textObject = new TextObject("{=ytqqEyFw}You brought {NUMBER_OF_ITEM} {?NUMBER_OF_ITEM>1}units{?}unit{\\?} of {ITEM} to {?QUEST_GIVER.GENDER}her{?}him{\\?} as promised.", null);
					StringHelpers.SetCharacterProperties("QUEST_GIVER", base.QuestGiver.CharacterObject, textObject, false);
					textObject.SetTextVariable("ITEM", this._requestedTradeGood.Name);
					textObject.SetTextVariable("NUMBER_OF_ITEM", this._numberOfRequestedGood);
					return textObject;
				}
			}

			public VillageNeedsToolsIssueQuest(string questId, Hero questGiver, ItemObject requestedItem, int numberOfRequestedGood, ItemObject exchangeItem, int numberOfExchangeItem, int payment, CampaignTime duration)
				: base(questId, questGiver, duration, payment)
			{
				this._requestedTradeGood = requestedItem;
				this._numberOfRequestedGood = numberOfRequestedGood;
				this._exchangeItem = exchangeItem;
				this._numberOfExchangeItem = numberOfExchangeItem;
				this.SetDialogs();
				base.InitializeQuestOnCreation();
			}

			protected override void SetDialogs()
			{
				this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start", 100).NpcLine(new TextObject("{=ELxhTMuy}Excellent. But please hurry - we need to put the men we hired to work right away. Good luck.", null), null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.Consequence(delegate
					{
						base.StartQuest();
						TextObject textObject = new TextObject("{=M8PXWpyV}Collected {ITEM}", null);
						textObject.SetTextVariable("ITEM", this._requestedTradeGood.Name);
						this._numberOfToolsLog = base.AddDiscreteLog(this.QuestStartedLog, textObject, 0, this._numberOfRequestedGood, null, false);
						this.UpdateToolsAmount();
					})
					.CloseDialog();
				this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss", 100).NpcLine(new TextObject("{=dJVjbgyu}Any news about our tools {?PLAYER.GENDER}madame{?}sir{\\?}?", null), null, null).Condition(() => Hero.OneToOneConversationHero == base.QuestGiver)
					.BeginPlayerOptions()
					.PlayerOption(new TextObject("{=yvXNvh2B}Yes, I brought your tools.", null), null)
					.Condition(new ConversationSentence.OnConditionDelegate(this.PlayerHasTools))
					.NpcLine(new TextObject("{=yF3cBat5}Thank you {?PLAYER.GENDER}madame{?}sir{\\?}. Here is what we promised.", null), null, null)
					.Consequence(new ConversationSentence.OnConsequenceDelegate(this.FinishQuestSuccess1))
					.CloseDialog()
					.PlayerOption(new TextObject("{=ULWYVuVw}I'm still looking for your goods.", null), null)
					.NpcLine(new TextObject("{=tkaEZNpB}Of course. But… please hurry, {?PLAYER.GENDER}madame{?}sir{\\?}. We can't afford to pay the hired men to sit around. We don't have much money to spare, {?PLAYER.GENDER}madame{?}sir{\\?}.", null), null, null)
					.CloseDialog()
					.EndPlayerOptions();
			}

			private bool PlayerHasTools()
			{
				return this.GetCurrentToolsAmountInPlayerRoster() >= this._numberOfRequestedGood;
			}

			protected override void HourlyTick()
			{
			}

			protected override void RegisterEvents()
			{
				CampaignEvents.WarDeclared.AddNonSerializedListener(this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
				CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener(this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
				CampaignEvents.RaidCompletedEvent.AddNonSerializedListener(this, new Action<BattleSideEnum, RaidEventComponent>(this.RaidCompleted));
				CampaignEvents.PlayerInventoryExchangeEvent.AddNonSerializedListener(this, new Action<List<ValueTuple<ItemRosterElement, int>>, List<ValueTuple<ItemRosterElement, int>>, bool>(this.OnInventoryExchange));
				CampaignEvents.MapEventStarted.AddNonSerializedListener(this, new Action<MapEvent, PartyBase, PartyBase>(this.OnMapEventStarted));
			}

			private void OnMapEventStarted(MapEvent mapEvent, PartyBase attackerParty, PartyBase defenderParty)
			{
				if (QuestHelper.CheckMinorMajorCoercion(this, mapEvent, attackerParty))
				{
					QuestHelper.ApplyGenericMinorMajorCoercionConsequences(this, mapEvent);
				}
			}

			private void RaidCompleted(BattleSideEnum winnerSide, RaidEventComponent raidEvent)
			{
				if (raidEvent.MapEventSettlement == base.QuestGiver.CurrentSettlement)
				{
					base.CompleteQuestWithCancel(this.VillageRaidedQuestCancelLog);
				}
			}

			private void OnWarDeclared(IFaction faction1, IFaction faction2, DeclareWarAction.DeclareWarDetail detail)
			{
				QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest(this, faction1, faction2, detail, this.PlayerDeclaredWarQuestLogText, this.WarDeclaredQuestCancelLog, false);
			}

			private void OnClanChangedKingdom(Clan clan, Kingdom oldKingdom, Kingdom newKingdom, ChangeKingdomAction.ChangeKingdomActionDetail detail, bool showNotification = true)
			{
				if (base.QuestGiver.CurrentSettlement.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
				{
					base.CompleteQuestWithCancel(this.WarDeclaredQuestCancelLog);
				}
			}

			protected override void InitializeQuestOnGameLoad()
			{
				this.SetDialogs();
			}

			private void OnInventoryExchange(List<ValueTuple<ItemRosterElement, int>> purchasedItems, List<ValueTuple<ItemRosterElement, int>> soldItems, bool isTrading)
			{
				this.UpdateToolsAmount();
			}

			private int GetCurrentToolsAmountInPlayerRoster()
			{
				return MobileParty.MainParty.ItemRoster.GetItemNumber(this._requestedTradeGood);
			}

			private void UpdateToolsAmount()
			{
				this._numberOfToolsLog.UpdateCurrentProgress((int)MathF.Clamp((float)this.GetCurrentToolsAmountInPlayerRoster(), 0f, (float)this._numberOfRequestedGood));
			}

			protected override void OnTimedOut()
			{
				base.AddLog(this.QuestTimeOutFailLog, false);
				base.QuestGiver.AddPower(-10f);
				base.QuestGiver.CurrentSettlement.Village.Hearth += -30f;
				ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, -5, true, true);
			}

			private void FinishQuestSuccess1()
			{
				base.AddLog(this.QuestSuccessLog, false);
				base.QuestGiver.AddPower(10f);
				TraitLevelingHelper.OnIssueSolvedThroughQuest(Hero.MainHero, new Tuple<TraitObject, int>[]
				{
					new Tuple<TraitObject, int>(DefaultTraits.Honor, 30)
				});
				PartyBase.MainParty.ItemRoster.AddToCounts(this._requestedTradeGood, -this._numberOfRequestedGood);
				VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest.GiveTradeOrExchangeRewardToMainParty(base.QuestGiver, this.RewardGold, this._exchangeItem, this._numberOfExchangeItem);
				int num;
				if (this._exchangeItem != null)
				{
					ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, 7, true, true);
					foreach (Hero hero in base.QuestGiver.CurrentSettlement.Notables)
					{
						if (hero != base.QuestGiver)
						{
							ChangeRelationAction.ApplyPlayerRelation(hero, 2, true, true);
						}
					}
					num = 40;
				}
				else
				{
					ChangeRelationAction.ApplyPlayerRelation(base.QuestGiver, 5, true, true);
					num = 20;
				}
				base.QuestGiver.CurrentSettlement.Village.Hearth += (float)num;
				base.CompleteQuestWithSuccess();
			}

			public static void GiveTradeOrExchangeRewardToMainParty(Hero questGiver, int gold, ItemObject exchangeItem, int exchangeItemCount)
			{
				if (exchangeItem != null)
				{
					questGiver.CurrentSettlement.ItemRoster.AddToCounts(exchangeItem, exchangeItemCount);
					ItemRosterElement itemRosterElement = new ItemRosterElement(exchangeItem, exchangeItemCount, null);
					GiveItemAction.ApplyForParties(questGiver.CurrentSettlement.Party, PartyBase.MainParty, itemRosterElement);
					return;
				}
				GiveGoldAction.ApplyForQuestBetweenCharacters(questGiver, Hero.MainHero, gold, false);
			}

			private const int VillageHeartChangeOnExchangeSuccess = 40;

			private const int VillageHeartChangeOnTradeSuccess = 20;

			private const int TraitChangeOnSuccess = 30;

			private const int RelationChangeWithQuestGiverOnExchangeSuccess = 7;

			private const int RelationChangeWithNotablesOnExchangeSuccess = 2;

			private const int RelationChangeWithQuestGiverOnTradeSuccess = 5;

			private const int RelationChangeWithQuestGiverOnFail = -5;

			private const int QuestGiverPowerChangeOnFail = -10;

			private const int VillageHeartChangeOnFail = -30;

			[SaveableField(10)]
			private readonly ItemObject _requestedTradeGood;

			[SaveableField(20)]
			private readonly int _numberOfRequestedGood;

			[SaveableField(30)]
			private readonly ItemObject _exchangeItem;

			[SaveableField(40)]
			private readonly int _numberOfExchangeItem;

			[SaveableField(50)]
			private JournalLog _numberOfToolsLog;
		}

		public class VillageNeedsToolsIssueTypeDefiner : SaveableTypeDefiner
		{
			public VillageNeedsToolsIssueTypeDefiner()
				: base(600000)
			{
			}

			protected override void DefineClassTypes()
			{
				base.AddClassDefinition(typeof(VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssue), 1, null);
				base.AddClassDefinition(typeof(VillageNeedsToolsIssueBehavior.VillageNeedsToolsIssueQuest), 2, null);
			}
		}
	}
}
