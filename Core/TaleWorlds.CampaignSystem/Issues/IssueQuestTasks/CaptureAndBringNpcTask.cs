using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Issues.IssueQuestTasks
{
	// Token: 0x02000324 RID: 804
	public class CaptureAndBringNpcTask : QuestTaskBase
	{
		// Token: 0x06002DB2 RID: 11698 RVA: 0x000BF14C File Offset: 0x000BD34C
		internal static void AutoGeneratedStaticCollectObjectsCaptureAndBringNpcTask(object o, List<object> collectedObjects)
		{
			((CaptureAndBringNpcTask)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002DB3 RID: 11699 RVA: 0x000BF15A File Offset: 0x000BD35A
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._targetHero);
		}

		// Token: 0x06002DB4 RID: 11700 RVA: 0x000BF16F File Offset: 0x000BD36F
		internal static object AutoGeneratedGetMemberValue_targetHero(object o)
		{
			return ((CaptureAndBringNpcTask)o)._targetHero;
		}

		// Token: 0x06002DB5 RID: 11701 RVA: 0x000BF17C File Offset: 0x000BD37C
		public CaptureAndBringNpcTask(Hero targetHero, Action onSucceededAction, Action onFailedAction, Action onCanceledAction, DialogFlow dialogFlow = null)
			: base(dialogFlow, onSucceededAction, onFailedAction, onCanceledAction)
		{
			this._targetHero = targetHero;
		}

		// Token: 0x06002DB6 RID: 11702 RVA: 0x000BF194 File Offset: 0x000BD394
		private DialogFlow GetTakePrisonerDialogFlow()
		{
			return DialogFlow.CreateDialogFlow("lord_start", int.MaxValue).NpcLine("{=2vcfifbb}I yield", null, null).Condition(() => Hero.OneToOneConversationHero == this._targetHero && this.isFinishedSuccess)
				.BeginPlayerOptions()
				.PlayerOption("{=cbzJRaDJ}You are my prisoner now!", null)
				.GotoDialogState("lord_start")
				.Consequence(delegate
				{
					TakePrisonerAction.Apply(Hero.MainHero.PartyBelongedTo.Party, this._targetHero);
				})
				.EndPlayerOptions();
		}

		// Token: 0x06002DB7 RID: 11703 RVA: 0x000BF200 File Offset: 0x000BD400
		public void OnPlayerBattleEnd(MapEvent mapEvent)
		{
			if (PartyBase.MainParty.Side == mapEvent.WinningSide)
			{
				using (IEnumerator<PartyBase> enumerator = mapEvent.InvolvedParties.GetEnumerator())
				{
					while (enumerator.MoveNext())
					{
						if (enumerator.Current.Side == mapEvent.DefeatedSide)
						{
							using (IEnumerator<CharacterObject> enumerator2 = PartyBase.MainParty.PrisonerHeroes.GetEnumerator())
							{
								while (enumerator2.MoveNext())
								{
									if (enumerator2.Current == this._targetHero.CharacterObject)
									{
										base.Finish(QuestTaskBase.FinishStates.Success);
										break;
									}
								}
							}
						}
						if (!base.IsActive)
						{
							break;
						}
					}
				}
			}
		}

		// Token: 0x06002DB8 RID: 11704 RVA: 0x000BF2C0 File Offset: 0x000BD4C0
		protected override void OnFinished()
		{
			this._targetHero = null;
		}

		// Token: 0x06002DB9 RID: 11705 RVA: 0x000BF2C9 File Offset: 0x000BD4C9
		public override void SetReferences()
		{
			CampaignEvents.OnPlayerBattleEndEvent.AddNonSerializedListener(this, new Action<MapEvent>(this.OnPlayerBattleEnd));
		}

		// Token: 0x04000DC2 RID: 3522
		[SaveableField(10)]
		private Hero _targetHero;

		// Token: 0x04000DC3 RID: 3523
		public bool isFinishedSuccess;
	}
}
