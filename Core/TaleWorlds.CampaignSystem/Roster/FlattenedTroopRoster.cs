using System;
using System.Collections;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Roster
{
	public class FlattenedTroopRoster : IEnumerable<FlattenedTroopRosterElement>, IEnumerable
	{
		internal static void AutoGeneratedStaticCollectObjectsFlattenedTroopRoster(object o, List<object> collectedObjects)
		{
			((FlattenedTroopRoster)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._elementDictionary);
		}

		internal static object AutoGeneratedGetMemberValue_elementDictionary(object o)
		{
			return ((FlattenedTroopRoster)o)._elementDictionary;
		}

		public FlattenedTroopRoster(int count = 4)
		{
			this._elementDictionary = new Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>(count);
		}

		public FlattenedTroopRoster(TroopRoster roster)
			: this(roster.Count)
		{
			this.Add(roster.GetTroopRoster());
		}

		public FlattenedTroopRoster(FlattenedTroopRoster other)
		{
			this._elementDictionary = new Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>(other._elementDictionary);
		}

		public FlattenedTroopRosterElement this[UniqueTroopDescriptor index]
		{
			get
			{
				return this._elementDictionary[index];
			}
			set
			{
				this._elementDictionary[index] = value;
			}
		}

		public void Add(MBList<TroopRosterElement> roster)
		{
			foreach (TroopRosterElement troopRosterElement in roster)
			{
				if (troopRosterElement.Number > 0)
				{
					int num = troopRosterElement.Xp / troopRosterElement.Number;
					int num2 = troopRosterElement.Xp % troopRosterElement.Number;
					for (int i = 0; i < troopRosterElement.Number; i++)
					{
						bool flag = i < troopRosterElement.WoundedNumber;
						int num3 = num;
						if (i < num2)
						{
							num3++;
						}
						this.Add(troopRosterElement.Character, flag, num3);
					}
				}
			}
		}

		public void Add(TroopRosterElement troop)
		{
			int num = troop.Xp / troop.Number;
			int num2 = troop.Xp % troop.Number;
			for (int i = 0; i < troop.Number; i++)
			{
				bool flag = i < troop.WoundedNumber;
				int num3 = num;
				if (i < num2)
				{
					num3++;
				}
				this.Add(troop.Character, flag, num3);
			}
		}

		public void Add(CharacterObject troop, int number, int woundedNumber = 0)
		{
			for (int i = 0; i < number; i++)
			{
				this.Add(troop, woundedNumber > 0, 0);
				woundedNumber--;
			}
		}

		public UniqueTroopDescriptor Add(CharacterObject troop, bool isWounded = false, int xp = 0)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = new FlattenedTroopRosterElement(troop, isWounded ? RosterTroopState.Wounded : RosterTroopState.Active, xp, default(UniqueTroopDescriptor), 0);
			this._elementDictionary.Add(flattenedTroopRosterElement.Descriptor, flattenedTroopRosterElement);
			return flattenedTroopRosterElement.Descriptor;
		}

		public static int GenerateUniqueNoFromParty(MobileParty party, int troopIndex)
		{
			return (party.Party.Index * 999983 + troopIndex * 100003) % 616841;
		}

		public void Remove(UniqueTroopDescriptor descriptor)
		{
			this._elementDictionary.Remove(descriptor);
		}

		public IEnumerable<CharacterObject> Troops
		{
			get
			{
				foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in this._elementDictionary.Values)
				{
					yield return flattenedTroopRosterElement.Troop;
				}
				Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator enumerator = default(Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator);
				yield break;
				yield break;
			}
		}

		public void Clear()
		{
			this._elementDictionary.Clear();
		}

		public ICollection<FlattenedTroopRosterElement> RemoveIf(Predicate<FlattenedTroopRosterElement> match)
		{
			List<FlattenedTroopRosterElement> list = new List<FlattenedTroopRosterElement>();
			foreach (KeyValuePair<UniqueTroopDescriptor, FlattenedTroopRosterElement> keyValuePair in this._elementDictionary)
			{
				if (match(keyValuePair.Value))
				{
					list.Add(keyValuePair.Value);
				}
			}
			foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in list)
			{
				this._elementDictionary.Remove(flattenedTroopRosterElement.Descriptor);
			}
			return list;
		}

		public UniqueTroopDescriptor FindIndexOfCharacter(CharacterObject character)
		{
			foreach (KeyValuePair<UniqueTroopDescriptor, FlattenedTroopRosterElement> keyValuePair in this._elementDictionary)
			{
				if (keyValuePair.Value.Troop == character)
				{
					return keyValuePair.Value.Descriptor;
				}
			}
			return UniqueTroopDescriptor.Invalid;
		}

		public IEnumerator<FlattenedTroopRosterElement> GetEnumerator()
		{
			foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in this._elementDictionary.Values)
			{
				yield return flattenedTroopRosterElement;
			}
			Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator enumerator = default(Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator);
			yield break;
			yield break;
		}

		IEnumerator IEnumerable.GetEnumerator()
		{
			return this.GetEnumerator();
		}

		public void OnTroopKilled(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.Killed, 0, flattenedTroopRosterElement.Descriptor, 0);
		}

		public void OnTroopWounded(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.WoundedInThisBattle, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, flattenedTroopRosterElement.XpGained);
		}

		public void OnTroopRouted(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.Routed, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, 0);
		}

		public int OnTroopGainXp(UniqueTroopDescriptor troopSeed, int xpAmount)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			int num = flattenedTroopRosterElement.XpGained + xpAmount;
			int num2 = num - flattenedTroopRosterElement.XpGained;
			if (num2 != 0)
			{
				this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, flattenedTroopRosterElement.State, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, num);
			}
			return num2;
		}

		[SaveableField(1)]
		private readonly Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement> _elementDictionary;
	}
}
