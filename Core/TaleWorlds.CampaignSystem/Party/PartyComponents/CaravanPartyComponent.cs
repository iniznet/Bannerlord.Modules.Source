using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents
{
	// Token: 0x020002B8 RID: 696
	public class CaravanPartyComponent : PartyComponent
	{
		// Token: 0x060027CA RID: 10186 RVA: 0x000A9805 File Offset: 0x000A7A05
		internal static void AutoGeneratedStaticCollectObjectsCaravanPartyComponent(object o, List<object> collectedObjects)
		{
			((CaravanPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060027CB RID: 10187 RVA: 0x000A9813 File Offset: 0x000A7A13
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._leader);
			collectedObjects.Add(this.Settlement);
			collectedObjects.Add(this.Owner);
		}

		// Token: 0x060027CC RID: 10188 RVA: 0x000A9840 File Offset: 0x000A7A40
		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((CaravanPartyComponent)o).Settlement;
		}

		// Token: 0x060027CD RID: 10189 RVA: 0x000A984D File Offset: 0x000A7A4D
		internal static object AutoGeneratedGetMemberValueOwner(object o)
		{
			return ((CaravanPartyComponent)o).Owner;
		}

		// Token: 0x060027CE RID: 10190 RVA: 0x000A985A File Offset: 0x000A7A5A
		internal static object AutoGeneratedGetMemberValue_leader(object o)
		{
			return ((CaravanPartyComponent)o)._leader;
		}

		// Token: 0x170009E8 RID: 2536
		// (get) Token: 0x060027CF RID: 10191 RVA: 0x000A9867 File Offset: 0x000A7A67
		// (set) Token: 0x060027D0 RID: 10192 RVA: 0x000A986F File Offset: 0x000A7A6F
		[SaveableProperty(1)]
		public Settlement Settlement { get; private set; }

		// Token: 0x170009E9 RID: 2537
		// (get) Token: 0x060027D1 RID: 10193 RVA: 0x000A9878 File Offset: 0x000A7A78
		// (set) Token: 0x060027D2 RID: 10194 RVA: 0x000A9880 File Offset: 0x000A7A80
		[SaveableProperty(2)]
		public Hero Owner { get; private set; }

		// Token: 0x170009EA RID: 2538
		// (get) Token: 0x060027D3 RID: 10195 RVA: 0x000A9889 File Offset: 0x000A7A89
		public override Hero PartyOwner
		{
			get
			{
				return this.Owner;
			}
		}

		// Token: 0x170009EB RID: 2539
		// (get) Token: 0x060027D4 RID: 10196 RVA: 0x000A9894 File Offset: 0x000A7A94
		public override TextObject Name
		{
			get
			{
				if (this._cachedName == null)
				{
					this._cachedName = GameTexts.FindText("str_caravan_party_name", null);
					TextObject cachedName = this._cachedName;
					string text = "OWNER";
					Hero leaderHero = base.MobileParty.LeaderHero;
					cachedName.SetCharacterProperties(text, ((leaderHero != null) ? leaderHero.CharacterObject : null) ?? this.Owner.CharacterObject, false);
				}
				return this._cachedName;
			}
		}

		// Token: 0x170009EC RID: 2540
		// (get) Token: 0x060027D5 RID: 10197 RVA: 0x000A98F7 File Offset: 0x000A7AF7
		public override Settlement HomeSettlement
		{
			get
			{
				return this.Settlement;
			}
		}

		// Token: 0x170009ED RID: 2541
		// (get) Token: 0x060027D6 RID: 10198 RVA: 0x000A98FF File Offset: 0x000A7AFF
		public override Hero Leader
		{
			get
			{
				return this._leader;
			}
		}

		// Token: 0x060027D7 RID: 10199 RVA: 0x000A9907 File Offset: 0x000A7B07
		protected internal CaravanPartyComponent(Settlement settlement, Hero owner, Hero partyLeader)
		{
			this.Settlement = settlement;
			this.Owner = owner;
			this._leader = partyLeader;
		}

		// Token: 0x060027D8 RID: 10200 RVA: 0x000A9924 File Offset: 0x000A7B24
		protected override void OnInitialize()
		{
			this.Owner.OwnedCaravans.Add(this);
		}

		// Token: 0x060027D9 RID: 10201 RVA: 0x000A9937 File Offset: 0x000A7B37
		protected override void OnFinalize()
		{
			this.Owner.OwnedCaravans.Remove(this);
		}

		// Token: 0x060027DA RID: 10202 RVA: 0x000A994B File Offset: 0x000A7B4B
		public override void ChangePartyLeader(Hero newLeader)
		{
			this._leader = newLeader;
		}

		// Token: 0x060027DB RID: 10203 RVA: 0x000A9954 File Offset: 0x000A7B54
		public override void ClearCachedName()
		{
			this._cachedName = null;
		}

		// Token: 0x060027DC RID: 10204 RVA: 0x000A9960 File Offset: 0x000A7B60
		public static MobileParty CreateCaravanParty(Hero caravanOwner, Settlement spawnSettlement, bool isInitialSpawn = false, Hero caravanLeader = null, ItemRoster caravanItems = null, int troopToBeGiven = 0, bool isElite = false)
		{
			MobileParty mobileParty2 = MobileParty.CreateParty("caravan_template_" + spawnSettlement.Culture.StringId.ToLower() + "_1", new CaravanPartyComponent(spawnSettlement, caravanOwner, caravanLeader), delegate(MobileParty mobileParty)
			{
				(mobileParty.PartyComponent as CaravanPartyComponent).InitializeCaravanOnCreation(mobileParty, caravanLeader, caravanItems, troopToBeGiven, isElite);
			});
			if (spawnSettlement.Party.MapEvent == null && spawnSettlement.SiegeEvent == null)
			{
				mobileParty2.Ai.SetMoveGoToSettlement(spawnSettlement);
				mobileParty2.Ai.RecalculateShortTermAi();
				EnterSettlementAction.ApplyForParty(mobileParty2, spawnSettlement);
			}
			else
			{
				mobileParty2.Ai.SetMoveModeHold();
			}
			if (mobileParty2.LeaderHero != null)
			{
				CampaignEventDispatcher.Instance.OnHeroGetsBusy(mobileParty2.LeaderHero, HeroGetsBusyReasons.BecomeCaravanLeader);
			}
			return mobileParty2;
		}

		// Token: 0x060027DD RID: 10205 RVA: 0x000A9A2C File Offset: 0x000A7C2C
		private void InitializeCaravanOnCreation(MobileParty mobileParty, Hero caravanLeader, ItemRoster caravanItems, int troopToBeGiven, bool isElite)
		{
			this.InitializeCaravanProperties();
			if (troopToBeGiven == 0)
			{
				float num;
				if (MBRandom.RandomFloat < 0.67f)
				{
					num = (1f - MBRandom.RandomFloat * MBRandom.RandomFloat) * 0.5f + 0.5f;
				}
				else
				{
					num = 1f;
				}
				int num2 = (int)((float)mobileParty.Party.PartySizeLimit * num);
				if (num2 >= 10)
				{
					num2--;
				}
				troopToBeGiven = num2;
			}
			PartyTemplateObject partyTemplateObject = (isElite ? this.Settlement.Culture.EliteCaravanPartyTemplate : this.Settlement.Culture.CaravanPartyTemplate);
			mobileParty.InitializeMobilePartyAtPosition(partyTemplateObject, this.Settlement.GatePosition, troopToBeGiven);
			if (caravanLeader != null)
			{
				mobileParty.MemberRoster.AddToCounts(caravanLeader.CharacterObject, 1, true, 0, 0, true, -1);
			}
			else
			{
				CharacterObject characterObject = CharacterObject.All.First((CharacterObject character) => character.Occupation == Occupation.CaravanGuard && character.IsInfantry && character.Level == 26 && character.Culture == mobileParty.Party.Owner.Culture);
				mobileParty.MemberRoster.AddToCounts(characterObject, 1, true, 0, 0, true, -1);
			}
			mobileParty.ActualClan = this.Owner.Clan;
			mobileParty.Party.Visuals.SetMapIconAsDirty();
			mobileParty.InitializePartyTrade(10000 + ((this.Owner.Clan == Clan.PlayerClan) ? 5000 : 0));
			if (caravanItems != null)
			{
				mobileParty.ItemRoster.Add(caravanItems);
				return;
			}
			float num3 = 10000f;
			ItemObject itemObject = null;
			foreach (ItemObject itemObject2 in Items.All)
			{
				if (itemObject2.ItemCategory == DefaultItemCategories.PackAnimal && !itemObject2.NotMerchandise && (float)itemObject2.Value < num3)
				{
					itemObject = itemObject2;
					num3 = (float)itemObject2.Value;
				}
			}
			if (itemObject != null)
			{
				mobileParty.ItemRoster.Add(new ItemRosterElement(itemObject, (int)((float)mobileParty.MemberRoster.TotalManCount * 0.5f), null));
			}
		}

		// Token: 0x060027DE RID: 10206 RVA: 0x000A9C58 File Offset: 0x000A7E58
		private void InitializeCaravanProperties()
		{
			base.MobileParty.Aggressiveness = 0f;
		}

		// Token: 0x060027DF RID: 10207 RVA: 0x000A9C6C File Offset: 0x000A7E6C
		public override void GetMountAndHarnessVisualIdsForPartyIcon(PartyBase party, out string mountStringId, out string harnessStringId)
		{
			IFaction mapFaction = party.MapFaction;
			string text;
			if (mapFaction == null)
			{
				text = null;
			}
			else
			{
				CultureObject culture = mapFaction.Culture;
				text = ((culture != null) ? culture.StringId : null);
			}
			string text2 = text ?? string.Empty;
			if (text2 == "aserai" || text2 == "khuzait")
			{
				mountStringId = "camel";
				if (party.Index % 2 == 0)
				{
					harnessStringId = "camel_saddle_a";
					return;
				}
				harnessStringId = "camel_saddle_b";
				return;
			}
			else
			{
				mountStringId = "mule";
				int num = party.Index % 3;
				if (num == 0)
				{
					harnessStringId = "mule_load_a";
					return;
				}
				if (num != 1)
				{
					harnessStringId = "mule_load_c";
					return;
				}
				harnessStringId = "mule_load_b";
				return;
			}
		}

		// Token: 0x060027E0 RID: 10208 RVA: 0x000A9D10 File Offset: 0x000A7F10
		public static void TransferCaravanOwnership(MobileParty caravan, Hero newOwner, Settlement homeSettlement)
		{
			CaravanPartyComponent caravanPartyComponent = new CaravanPartyComponent(homeSettlement, newOwner, caravan.PartyComponent.Leader);
			caravan.PartyComponent = caravanPartyComponent;
			caravanPartyComponent.InitializeCaravanProperties();
			caravan.Party.Visuals.SetMapIconAsDirty();
		}

		// Token: 0x04000C33 RID: 3123
		public const int DefaultCaravanPartyTradeInitialGold = 10000;

		// Token: 0x04000C36 RID: 3126
		[CachedData]
		private TextObject _cachedName;

		// Token: 0x04000C37 RID: 3127
		[SaveableField(3)]
		private Hero _leader;
	}
}
