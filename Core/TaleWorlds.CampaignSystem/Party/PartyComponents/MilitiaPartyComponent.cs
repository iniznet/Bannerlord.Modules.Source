using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents
{
	// Token: 0x020002B9 RID: 697
	public class MilitiaPartyComponent : PartyComponent
	{
		// Token: 0x060027E1 RID: 10209 RVA: 0x000A9D4D File Offset: 0x000A7F4D
		internal static void AutoGeneratedStaticCollectObjectsMilitiaPartyComponent(object o, List<object> collectedObjects)
		{
			((MilitiaPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060027E2 RID: 10210 RVA: 0x000A9D5B File Offset: 0x000A7F5B
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Settlement);
		}

		// Token: 0x060027E3 RID: 10211 RVA: 0x000A9D70 File Offset: 0x000A7F70
		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((MilitiaPartyComponent)o).Settlement;
		}

		// Token: 0x170009EE RID: 2542
		// (get) Token: 0x060027E4 RID: 10212 RVA: 0x000A9D7D File Offset: 0x000A7F7D
		// (set) Token: 0x060027E5 RID: 10213 RVA: 0x000A9D85 File Offset: 0x000A7F85
		[SaveableProperty(1)]
		public Settlement Settlement { get; private set; }

		// Token: 0x170009EF RID: 2543
		// (get) Token: 0x060027E6 RID: 10214 RVA: 0x000A9D8E File Offset: 0x000A7F8E
		public override Hero PartyOwner
		{
			get
			{
				return this.Settlement.OwnerClan.Leader;
			}
		}

		// Token: 0x170009F0 RID: 2544
		// (get) Token: 0x060027E7 RID: 10215 RVA: 0x000A9DA0 File Offset: 0x000A7FA0
		public override TextObject Name
		{
			get
			{
				if (this._cachedName == null)
				{
					this._cachedName = GameTexts.FindText("str_militia_name", null);
					this._cachedName.SetTextVariable("SETTLEMENT_NAME", this.Settlement.Name);
				}
				return this._cachedName;
			}
		}

		// Token: 0x170009F1 RID: 2545
		// (get) Token: 0x060027E8 RID: 10216 RVA: 0x000A9DDD File Offset: 0x000A7FDD
		public override Settlement HomeSettlement
		{
			get
			{
				return this.Settlement;
			}
		}

		// Token: 0x060027E9 RID: 10217 RVA: 0x000A9DE8 File Offset: 0x000A7FE8
		public static MobileParty CreateMilitiaParty(string stringId, Settlement settlement)
		{
			MobileParty mobileParty2 = MobileParty.CreateParty("militias_of_" + stringId + "_aaa1", new MilitiaPartyComponent(settlement), delegate(MobileParty mobileParty)
			{
				(mobileParty.PartyComponent as MilitiaPartyComponent).InitializeMilitiaPartyProperties(mobileParty, settlement);
			});
			EnterSettlementAction.ApplyForParty(mobileParty2, settlement);
			return mobileParty2;
		}

		// Token: 0x060027EA RID: 10218 RVA: 0x000A9E3A File Offset: 0x000A803A
		protected override void OnInitialize()
		{
			this.Settlement.MilitiaPartyComponent = this;
		}

		// Token: 0x060027EB RID: 10219 RVA: 0x000A9E48 File Offset: 0x000A8048
		protected override void OnFinalize()
		{
			this.Settlement.MilitiaPartyComponent = null;
		}

		// Token: 0x060027EC RID: 10220 RVA: 0x000A9E56 File Offset: 0x000A8056
		public override void ClearCachedName()
		{
			this._cachedName = null;
		}

		// Token: 0x060027ED RID: 10221 RVA: 0x000A9E60 File Offset: 0x000A8060
		private void InitializeMilitiaPartyProperties(MobileParty mobileParty, Settlement settlement)
		{
			PartyTemplateObject militiaPartyTemplate = settlement.Culture.MilitiaPartyTemplate;
			mobileParty.InitializeMobilePartyAtPosition(militiaPartyTemplate, settlement.GatePosition, -1);
			mobileParty.Party.Visuals.SetMapIconAsDirty();
			mobileParty.Ai.DisableAi();
			mobileParty.Aggressiveness = 0f;
		}

		// Token: 0x060027EE RID: 10222 RVA: 0x000A9EAD File Offset: 0x000A80AD
		protected internal MilitiaPartyComponent(Settlement settlement)
		{
			this.Settlement = settlement;
		}

		// Token: 0x04000C39 RID: 3129
		[CachedData]
		private TextObject _cachedName;
	}
}
