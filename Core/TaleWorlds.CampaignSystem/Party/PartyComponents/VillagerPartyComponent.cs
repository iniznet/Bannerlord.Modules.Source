using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents
{
	// Token: 0x020002B6 RID: 694
	public class VillagerPartyComponent : PartyComponent
	{
		// Token: 0x060027AA RID: 10154 RVA: 0x000A9371 File Offset: 0x000A7571
		internal static void AutoGeneratedStaticCollectObjectsVillagerPartyComponent(object o, List<object> collectedObjects)
		{
			((VillagerPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060027AB RID: 10155 RVA: 0x000A937F File Offset: 0x000A757F
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Village);
		}

		// Token: 0x060027AC RID: 10156 RVA: 0x000A9394 File Offset: 0x000A7594
		internal static object AutoGeneratedGetMemberValueVillage(object o)
		{
			return ((VillagerPartyComponent)o).Village;
		}

		// Token: 0x060027AD RID: 10157 RVA: 0x000A93A4 File Offset: 0x000A75A4
		public static MobileParty CreateVillagerParty(string stringId, Village village, int villagerPartySize)
		{
			return MobileParty.CreateParty(stringId, new VillagerPartyComponent(village), delegate(MobileParty mobileParty)
			{
				(mobileParty.PartyComponent as VillagerPartyComponent).InitializeVillagerPartyProperties(villagerPartySize);
			});
		}

		// Token: 0x170009DF RID: 2527
		// (get) Token: 0x060027AE RID: 10158 RVA: 0x000A93D6 File Offset: 0x000A75D6
		// (set) Token: 0x060027AF RID: 10159 RVA: 0x000A93DE File Offset: 0x000A75DE
		[SaveableProperty(1)]
		public Village Village { get; private set; }

		// Token: 0x170009E0 RID: 2528
		// (get) Token: 0x060027B0 RID: 10160 RVA: 0x000A93E7 File Offset: 0x000A75E7
		public override Hero PartyOwner
		{
			get
			{
				return this.Village.Settlement.OwnerClan.Leader;
			}
		}

		// Token: 0x170009E1 RID: 2529
		// (get) Token: 0x060027B1 RID: 10161 RVA: 0x000A93FE File Offset: 0x000A75FE
		public override TextObject Name
		{
			get
			{
				if (this._cachedName == null)
				{
					this._cachedName = GameTexts.FindText("str_villagers_of_VILLAGE_NAME", null);
					this._cachedName.SetTextVariable("VILLAGE_NAME", this.Village.Name);
				}
				return this._cachedName;
			}
		}

		// Token: 0x170009E2 RID: 2530
		// (get) Token: 0x060027B2 RID: 10162 RVA: 0x000A943B File Offset: 0x000A763B
		public override Settlement HomeSettlement
		{
			get
			{
				return this.Village.Settlement;
			}
		}

		// Token: 0x060027B3 RID: 10163 RVA: 0x000A9448 File Offset: 0x000A7648
		protected internal VillagerPartyComponent(Village village)
		{
			this.Village = village;
		}

		// Token: 0x060027B4 RID: 10164 RVA: 0x000A9457 File Offset: 0x000A7657
		protected override void OnInitialize()
		{
			this.Village.VillagerPartyComponent = this;
		}

		// Token: 0x060027B5 RID: 10165 RVA: 0x000A9465 File Offset: 0x000A7665
		protected override void OnFinalize()
		{
			this.Village.VillagerPartyComponent = null;
		}

		// Token: 0x060027B6 RID: 10166 RVA: 0x000A9473 File Offset: 0x000A7673
		public override void ClearCachedName()
		{
			this._cachedName = null;
		}

		// Token: 0x060027B7 RID: 10167 RVA: 0x000A947C File Offset: 0x000A767C
		private void InitializeVillagerPartyProperties(int villagerPartySize)
		{
			PartyTemplateObject villagerPartyTemplate = this.Village.Settlement.Culture.VillagerPartyTemplate;
			base.Party.MobileParty.Aggressiveness = 0f;
			Settlement bound = this.Village.Bound;
			bool flag;
			if (bound == null)
			{
				flag = null != null;
			}
			else
			{
				Town town = bound.Town;
				flag = ((town != null) ? town.Governor : null) != null;
			}
			if (flag && this.Village.Bound.Town.Governor.GetPerkValue(DefaultPerks.Scouting.VillageNetwork))
			{
				villagerPartySize = MathF.Round((float)villagerPartySize * (1f + DefaultPerks.Scouting.VillageNetwork.SecondaryBonus * 0.01f));
			}
			if ((float)villagerPartySize > this.Village.Hearth)
			{
				villagerPartySize = (int)this.Village.Hearth;
			}
			this.Village.Hearth -= (float)((villagerPartySize + 1) / 2);
			base.Party.MobileParty.InitializeMobilePartyAroundPosition(villagerPartyTemplate, this.Village.Owner.Settlement.Position2D, 1f, 0f, villagerPartySize);
			base.Party.Visuals.SetMapIconAsDirty();
			base.Party.MobileParty.InitializePartyTrade(0);
			float num = 10000f;
			ItemObject itemObject = null;
			foreach (ItemObject itemObject2 in Items.All)
			{
				if (itemObject2.ItemCategory == DefaultItemCategories.PackAnimal && (float)itemObject2.Value < num && itemObject2.Value > 40)
				{
					itemObject = itemObject2;
					num = (float)itemObject2.Value;
				}
			}
			if (itemObject != null)
			{
				int num2 = (int)(0.5f * (float)villagerPartySize);
				base.MobileParty.ItemRoster.Add(new ItemRosterElement(itemObject, num2, null));
			}
		}

		// Token: 0x04000C2E RID: 3118
		[CachedData]
		private TextObject _cachedName;
	}
}
