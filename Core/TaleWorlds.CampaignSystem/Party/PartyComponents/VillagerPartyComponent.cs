using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents
{
	public class VillagerPartyComponent : PartyComponent
	{
		internal static void AutoGeneratedStaticCollectObjectsVillagerPartyComponent(object o, List<object> collectedObjects)
		{
			((VillagerPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Village);
		}

		internal static object AutoGeneratedGetMemberValueVillage(object o)
		{
			return ((VillagerPartyComponent)o).Village;
		}

		public static MobileParty CreateVillagerParty(string stringId, Village village, int villagerPartySize)
		{
			return MobileParty.CreateParty(stringId, new VillagerPartyComponent(village), delegate(MobileParty mobileParty)
			{
				(mobileParty.PartyComponent as VillagerPartyComponent).InitializeVillagerPartyProperties(villagerPartySize);
			});
		}

		[SaveableProperty(1)]
		public Village Village { get; private set; }

		public override Hero PartyOwner
		{
			get
			{
				return this.Village.Settlement.OwnerClan.Leader;
			}
		}

		public override TextObject Name
		{
			get
			{
				if (this._cachedName == null)
				{
					this._cachedName = GameTexts.FindText("str_villagers_of_VILLAGE_NAME", null);
					this._cachedName.SetTextVariable("VILLAGE_NAME", this.Village.Name);
				}
				return this._cachedName;
			}
		}

		public override Settlement HomeSettlement
		{
			get
			{
				return this.Village.Settlement;
			}
		}

		protected internal VillagerPartyComponent(Village village)
		{
			this.Village = village;
		}

		protected override void OnInitialize()
		{
			this.Village.VillagerPartyComponent = this;
		}

		protected override void OnFinalize()
		{
			this.Village.VillagerPartyComponent = null;
		}

		public override void ClearCachedName()
		{
			this._cachedName = null;
		}

		private void InitializeVillagerPartyProperties(int villagerPartySize)
		{
			PartyTemplateObject villagerPartyTemplate = this.Village.Settlement.Culture.VillagerPartyTemplate;
			base.Party.MobileParty.Aggressiveness = 0f;
			Settlement bound = this.Village.Bound;
			bool flag;
			if (bound == null)
			{
				flag = null != null;
			}
			else
			{
				Town town = bound.Town;
				flag = ((town != null) ? town.Governor : null) != null;
			}
			if (flag && this.Village.Bound.Town.Governor.GetPerkValue(DefaultPerks.Scouting.VillageNetwork))
			{
				villagerPartySize = MathF.Round((float)villagerPartySize * (1f + DefaultPerks.Scouting.VillageNetwork.SecondaryBonus));
			}
			if ((float)villagerPartySize > this.Village.Hearth)
			{
				villagerPartySize = (int)this.Village.Hearth;
			}
			this.Village.Hearth -= (float)((villagerPartySize + 1) / 2);
			base.Party.MobileParty.InitializeMobilePartyAroundPosition(villagerPartyTemplate, this.Village.Owner.Settlement.Position2D, 1f, 0f, villagerPartySize);
			base.Party.SetVisualAsDirty();
			base.Party.MobileParty.InitializePartyTrade(0);
			float num = 10000f;
			ItemObject itemObject = null;
			foreach (ItemObject itemObject2 in Items.All)
			{
				if (itemObject2.ItemCategory == DefaultItemCategories.PackAnimal && (float)itemObject2.Value < num && itemObject2.Value > 40)
				{
					itemObject = itemObject2;
					num = (float)itemObject2.Value;
				}
			}
			if (itemObject != null)
			{
				int num2 = (int)(0.5f * (float)villagerPartySize);
				base.MobileParty.ItemRoster.Add(new ItemRosterElement(itemObject, num2, null));
			}
		}

		[CachedData]
		private TextObject _cachedName;
	}
}
