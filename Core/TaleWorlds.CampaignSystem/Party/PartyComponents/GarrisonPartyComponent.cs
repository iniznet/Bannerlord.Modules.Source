using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents
{
	// Token: 0x020002B4 RID: 692
	public class GarrisonPartyComponent : PartyComponent
	{
		// Token: 0x06002786 RID: 10118 RVA: 0x000A8E4D File Offset: 0x000A704D
		internal static void AutoGeneratedStaticCollectObjectsGarrisonPartyComponent(object o, List<object> collectedObjects)
		{
			((GarrisonPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002787 RID: 10119 RVA: 0x000A8E5B File Offset: 0x000A705B
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Settlement);
		}

		// Token: 0x06002788 RID: 10120 RVA: 0x000A8E70 File Offset: 0x000A7070
		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((GarrisonPartyComponent)o).Settlement;
		}

		// Token: 0x06002789 RID: 10121 RVA: 0x000A8E80 File Offset: 0x000A7080
		public static MobileParty CreateGarrisonParty(string stringId, Settlement settlement, bool isInitialGarrison)
		{
			return MobileParty.CreateParty(stringId, new GarrisonPartyComponent(settlement), delegate(MobileParty mobileParty)
			{
				(mobileParty.PartyComponent as GarrisonPartyComponent).InitializeGarrisonPartyProperties(mobileParty, isInitialGarrison);
			});
		}

		// Token: 0x170009D4 RID: 2516
		// (get) Token: 0x0600278A RID: 10122 RVA: 0x000A8EB2 File Offset: 0x000A70B2
		public override Hero PartyOwner
		{
			get
			{
				return this.Settlement.OwnerClan.Leader;
			}
		}

		// Token: 0x170009D5 RID: 2517
		// (get) Token: 0x0600278B RID: 10123 RVA: 0x000A8EC4 File Offset: 0x000A70C4
		public override TextObject Name
		{
			get
			{
				if (this._cachedName == null)
				{
					this._cachedName = GameTexts.FindText("str_garrison_party_name", null);
					this._cachedName.SetTextVariable("MAJOR_PARTY_LEADER", this.Settlement.Name);
				}
				return this._cachedName;
			}
		}

		// Token: 0x170009D6 RID: 2518
		// (get) Token: 0x0600278C RID: 10124 RVA: 0x000A8F01 File Offset: 0x000A7101
		public override Settlement HomeSettlement
		{
			get
			{
				return this.Settlement;
			}
		}

		// Token: 0x170009D7 RID: 2519
		// (get) Token: 0x0600278D RID: 10125 RVA: 0x000A8F09 File Offset: 0x000A7109
		public override int WagePaymentLimit
		{
			get
			{
				return this.Settlement.GarrisonWagePaymentLimit;
			}
		}

		// Token: 0x0600278E RID: 10126 RVA: 0x000A8F16 File Offset: 0x000A7116
		public override void SetWagePaymentLimit(int newLimit)
		{
			this.Settlement.SetGarrisonWagePaymentLimit(newLimit);
		}

		// Token: 0x170009D8 RID: 2520
		// (get) Token: 0x0600278F RID: 10127 RVA: 0x000A8F24 File Offset: 0x000A7124
		// (set) Token: 0x06002790 RID: 10128 RVA: 0x000A8F2C File Offset: 0x000A712C
		[SaveableProperty(1)]
		public Settlement Settlement { get; private set; }

		// Token: 0x06002791 RID: 10129 RVA: 0x000A8F35 File Offset: 0x000A7135
		protected internal GarrisonPartyComponent(Settlement settlement)
		{
			this.Settlement = settlement;
		}

		// Token: 0x06002792 RID: 10130 RVA: 0x000A8F44 File Offset: 0x000A7144
		protected override void OnInitialize()
		{
			this.Settlement.Town.GarrisonPartyComponent = this;
		}

		// Token: 0x06002793 RID: 10131 RVA: 0x000A8F57 File Offset: 0x000A7157
		protected override void OnFinalize()
		{
			this.Settlement.Town.GarrisonPartyComponent = null;
		}

		// Token: 0x06002794 RID: 10132 RVA: 0x000A8F6A File Offset: 0x000A716A
		public override void ClearCachedName()
		{
			this._cachedName = null;
		}

		// Token: 0x06002795 RID: 10133 RVA: 0x000A8F74 File Offset: 0x000A7174
		private void InitializeGarrisonPartyProperties(MobileParty mobileParty, bool isInitialGarrison)
		{
			PartyTemplateObject defaultPartyTemplate = this.Settlement.Culture.DefaultPartyTemplate;
			mobileParty.CurrentSettlement = this.Settlement;
			int num = (isInitialGarrison ? ((int)(this.Settlement.Prosperity * 0.04f + (float)(this.Settlement.IsTown ? 40 : 0) + 80f)) : 0);
			mobileParty.InitializeMobilePartyAtPosition(defaultPartyTemplate, this.Settlement.GatePosition, num);
			mobileParty.Party.Visuals.SetMapIconAsDirty();
			mobileParty.InitializePartyTrade(Campaign.Current.Models.ClanFinanceModel.PartyGoldLowerTreshold());
			mobileParty.Ai.DisableAi();
			mobileParty.Aggressiveness = 0f;
		}

		// Token: 0x04000C27 RID: 3111
		[CachedData]
		private TextObject _cachedName;
	}
}
