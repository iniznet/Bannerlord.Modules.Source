using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	public class BesiegeSettlementLogEntry : LogEntry, IEncyclopediaLog, IChatNotification, IWarLog
	{
		internal static void AutoGeneratedStaticCollectObjectsBesiegeSettlementLogEntry(object o, List<object> collectedObjects)
		{
			((BesiegeSettlementLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.BesiegerHero);
			collectedObjects.Add(this.Settlement);
			collectedObjects.Add(this.BesiegerFaction);
		}

		internal static object AutoGeneratedGetMemberValueBesiegerHero(object o)
		{
			return ((BesiegeSettlementLogEntry)o).BesiegerHero;
		}

		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((BesiegeSettlementLogEntry)o).Settlement;
		}

		internal static object AutoGeneratedGetMemberValueBesiegerFaction(object o)
		{
			return ((BesiegeSettlementLogEntry)o).BesiegerFaction;
		}

		internal static object AutoGeneratedGetMemberValue_isBesiegerArmy(object o)
		{
			return ((BesiegeSettlementLogEntry)o)._isBesiegerArmy;
		}

		public bool IsVisibleNotification
		{
			get
			{
				return true;
			}
		}

		public BesiegeSettlementLogEntry(MobileParty besiegerParty, Settlement settlement)
		{
			this.BesiegerHero = besiegerParty.Party.Owner;
			this.Settlement = settlement;
			this._isBesiegerArmy = besiegerParty.Army != null;
			this.BesiegerFaction = besiegerParty.MapFaction;
		}

		public override string ToString()
		{
			return this.GetEncyclopediaText().ToString();
		}

		public bool IsRelatedToWar(StanceLink stance, out IFaction effector, out IFaction effected)
		{
			IFaction faction = stance.Faction1;
			IFaction faction2 = stance.Faction2;
			effector = this.BesiegerFaction;
			effected = this.Settlement.MapFaction;
			return (this.BesiegerFaction == faction && this.Settlement.MapFaction == faction2) || (this.BesiegerFaction == faction2 && this.Settlement.MapFaction == faction);
		}

		public TextObject GetNotificationText()
		{
			TextObject textObject = new TextObject("{=E20BBKYo}{TOWN_NAME} has been besieged by {FACTION_NAME}.", null);
			textObject.SetTextVariable("TOWN_NAME", this.Settlement.EncyclopediaLinkWithName);
			textObject.SetTextVariable("FACTION_NAME", this.BesiegerFaction.EncyclopediaLinkWithName);
			return textObject;
		}

		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return obj == this.BesiegerHero || obj == this.Settlement;
		}

		public TextObject GetEncyclopediaText()
		{
			TextObject textObject;
			if (this._isBesiegerArmy)
			{
				textObject = GameTexts.FindText("str_army_besieging_news_with_link", null);
			}
			else
			{
				textObject = GameTexts.FindText("str_party_besieging_news_with_link", null);
			}
			textObject.SetTextVariable("TOWN_NAME", this.Settlement.EncyclopediaLinkWithName);
			textObject.SetTextVariable("FACTION_NAME", this.BesiegerFaction.EncyclopediaLinkWithName);
			StringHelpers.SetCharacterProperties("LORD", this.BesiegerHero.CharacterObject, textObject, false);
			return textObject;
		}

		[SaveableField(50)]
		public readonly Hero BesiegerHero;

		[SaveableField(51)]
		public readonly Settlement Settlement;

		[SaveableField(53)]
		public readonly IFaction BesiegerFaction;

		[SaveableField(54)]
		private readonly bool _isBesiegerArmy;
	}
}
