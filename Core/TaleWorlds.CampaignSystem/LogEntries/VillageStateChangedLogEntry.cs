using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	// Token: 0x020002EB RID: 747
	public class VillageStateChangedLogEntry : LogEntry, IWarLog
	{
		// Token: 0x06002B31 RID: 11057 RVA: 0x000B6576 File Offset: 0x000B4776
		internal static void AutoGeneratedStaticCollectObjectsVillageStateChangedLogEntry(object o, List<object> collectedObjects)
		{
			((VillageStateChangedLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002B32 RID: 11058 RVA: 0x000B6584 File Offset: 0x000B4784
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Village);
			collectedObjects.Add(this.RaiderPartyMapFaction);
			collectedObjects.Add(this.VillageRealmWhenRaided);
			collectedObjects.Add(this.RaidLeader);
			collectedObjects.Add(this._witnesses);
		}

		// Token: 0x06002B33 RID: 11059 RVA: 0x000B65D4 File Offset: 0x000B47D4
		internal static object AutoGeneratedGetMemberValueVillage(object o)
		{
			return ((VillageStateChangedLogEntry)o).Village;
		}

		// Token: 0x06002B34 RID: 11060 RVA: 0x000B65E1 File Offset: 0x000B47E1
		internal static object AutoGeneratedGetMemberValueOldState(object o)
		{
			return ((VillageStateChangedLogEntry)o).OldState;
		}

		// Token: 0x06002B35 RID: 11061 RVA: 0x000B65F3 File Offset: 0x000B47F3
		internal static object AutoGeneratedGetMemberValueNewState(object o)
		{
			return ((VillageStateChangedLogEntry)o).NewState;
		}

		// Token: 0x06002B36 RID: 11062 RVA: 0x000B6605 File Offset: 0x000B4805
		internal static object AutoGeneratedGetMemberValueRaiderPartyMapFaction(object o)
		{
			return ((VillageStateChangedLogEntry)o).RaiderPartyMapFaction;
		}

		// Token: 0x06002B37 RID: 11063 RVA: 0x000B6612 File Offset: 0x000B4812
		internal static object AutoGeneratedGetMemberValueVillageRealmWhenRaided(object o)
		{
			return ((VillageStateChangedLogEntry)o).VillageRealmWhenRaided;
		}

		// Token: 0x06002B38 RID: 11064 RVA: 0x000B661F File Offset: 0x000B481F
		internal static object AutoGeneratedGetMemberValueRealmsAtWarWhenRaided(object o)
		{
			return ((VillageStateChangedLogEntry)o).RealmsAtWarWhenRaided;
		}

		// Token: 0x06002B39 RID: 11065 RVA: 0x000B6631 File Offset: 0x000B4831
		internal static object AutoGeneratedGetMemberValueRaidLeader(object o)
		{
			return ((VillageStateChangedLogEntry)o).RaidLeader;
		}

		// Token: 0x06002B3A RID: 11066 RVA: 0x000B663E File Offset: 0x000B483E
		internal static object AutoGeneratedGetMemberValue_witnesses(object o)
		{
			return ((VillageStateChangedLogEntry)o)._witnesses;
		}

		// Token: 0x06002B3B RID: 11067 RVA: 0x000B664C File Offset: 0x000B484C
		public VillageStateChangedLogEntry(Village village, Village.VillageStates oldState, Village.VillageStates newState, MobileParty raiderParty)
		{
			this.Village = village;
			this.OldState = oldState;
			this.NewState = newState;
			this.RaiderPartyMapFaction = raiderParty.MapFaction;
			this.VillageRealmWhenRaided = village.Settlement.MapFaction;
			this.RealmsAtWarWhenRaided = this.RaiderPartyMapFaction.IsAtWarWith(this.VillageRealmWhenRaided);
			this.RaidLeader = raiderParty.LeaderHero;
			if (raiderParty.LeaderHero == Hero.MainHero)
			{
				Dictionary<Hero, short> dictionary = new Dictionary<Hero, short>();
				foreach (TroopRosterElement troopRosterElement in MobileParty.MainParty.MemberRoster.GetTroopRoster())
				{
					if (troopRosterElement.Character.HeroObject != null && !dictionary.ContainsKey(troopRosterElement.Character.HeroObject))
					{
						dictionary.Add(troopRosterElement.Character.HeroObject, 1);
					}
				}
				this._witnesses = dictionary.GetReadOnlyDictionary<Hero, short>();
			}
		}

		// Token: 0x06002B3C RID: 11068 RVA: 0x000B6750 File Offset: 0x000B4950
		public bool IsRelatedToWar(StanceLink stance, out IFaction effector, out IFaction effected)
		{
			IFaction faction = stance.Faction1;
			IFaction faction2 = stance.Faction2;
			IFaction raiderPartyMapFaction = this.RaiderPartyMapFaction;
			effector = ((raiderPartyMapFaction != null) ? raiderPartyMapFaction.MapFaction : null);
			IFaction villageRealmWhenRaided = this.VillageRealmWhenRaided;
			effected = ((villageRealmWhenRaided != null) ? villageRealmWhenRaided.MapFaction : null);
			return this.NewState == Village.VillageStates.Looted && ((this.VillageRealmWhenRaided == faction && this.RaiderPartyMapFaction == faction2) || (this.VillageRealmWhenRaided == faction2 && this.RaiderPartyMapFaction == faction));
		}

		// Token: 0x06002B3D RID: 11069 RVA: 0x000B67C8 File Offset: 0x000B49C8
		public override string ToString()
		{
			TextObject textObject = new TextObject("{=!}Village named {SETTLEMENT} state changed from {OLD_STATE} to {NEW_STATE}", null);
			textObject.SetTextVariable("SETTLEMENT", this.Village.Settlement.Name);
			textObject.SetTextVariable("OLD_STATE", this.OldState.ToString());
			textObject.SetTextVariable("NEW_STATE", this.NewState.ToString());
			return textObject.ToString();
		}

		// Token: 0x06002B3E RID: 11070 RVA: 0x000B683C File Offset: 0x000B4A3C
		public override int GetAsRumor(Settlement talkSettlement, ref TextObject comment)
		{
			int num = 0;
			if (this.NewState == Village.VillageStates.Looted && this.Village.Settlement.MapFaction == talkSettlement.MapFaction)
			{
				comment = new TextObject("{=nV1xbbM6}So I hear {ENEMY_NAME} burned and pillaged {VILLAGE_NAME}. Bastards...", null);
				comment.SetTextVariable("ENEMY_NAME", FactionHelper.GetTermUsedByOtherFaction(this.RaiderPartyMapFaction, talkSettlement.MapFaction, false));
				comment.SetTextVariable("VILLAGE_NAME", this.Village.Name);
				num = 10;
			}
			return num;
		}

		// Token: 0x06002B3F RID: 11071 RVA: 0x000B68B4 File Offset: 0x000B4AB4
		public override void GetConversationScoreAndComment(Hero talkTroop, bool findString, out string comment, out ImportanceEnum score)
		{
			short num;
			if (this._witnesses == null || !this._witnesses.TryGetValue(talkTroop, out num))
			{
				num = -2;
			}
			score = ImportanceEnum.Zero;
			comment = "";
			if (talkTroop.MapFaction != Hero.MainHero.MapFaction && talkTroop.MapFaction == this.VillageRealmWhenRaided && this.Village.Settlement.OwnerClan == talkTroop.Clan && talkTroop.Clan.Leader == talkTroop && this.RaidLeader == Hero.MainHero)
			{
				score = ImportanceEnum.Important;
				comment = "str_comment_you_raided_my_village";
				MBTextManager.SetTextVariable("SETTLEMENT_NAME", this.Village.Name, false);
				return;
			}
			if (num == 1 && this.NewState == Village.VillageStates.BeingRaided && this.Village.Settlement.Culture == talkTroop.Culture && this.RaiderPartyMapFaction.Culture != talkTroop.Culture)
			{
				score = ImportanceEnum.QuiteImportant;
				comment = "str_comment_we_raided_my_people";
				MBTextManager.SetTextVariable("VILLAGE_NAME", this.Village.Name, false);
				return;
			}
			if (num == 1 && this.NewState == Village.VillageStates.BeingRaided && this.RaiderPartyMapFaction.MapFaction.IsKingdomFaction && this.RealmsAtWarWhenRaided)
			{
				score = ImportanceEnum.QuiteImportant;
				comment = "str_comment_we_raided_enemy_village";
				MBTextManager.SetTextVariable("VILLAGE_NAME", this.Village.Name, false);
				MBTextManager.SetTextVariable("ENEMY_NAME", this.VillageRealmWhenRaided.InformalName, false);
				return;
			}
			if (num == 1 && this.NewState == Village.VillageStates.BeingRaided && !this.RealmsAtWarWhenRaided)
			{
				score = ImportanceEnum.QuiteImportant;
				comment = "str_comment_we_raided_neutral_village";
				MBTextManager.SetTextVariable("VILLAGE_NAME", this.Village.Name, false);
				MBTextManager.SetTextVariable("VILLAGE_FACTION", this.VillageRealmWhenRaided.InformalName, false);
			}
		}

		// Token: 0x04000D05 RID: 3333
		[SaveableField(340)]
		public readonly Village Village;

		// Token: 0x04000D06 RID: 3334
		[SaveableField(341)]
		public readonly Village.VillageStates OldState;

		// Token: 0x04000D07 RID: 3335
		[SaveableField(342)]
		public readonly Village.VillageStates NewState;

		// Token: 0x04000D08 RID: 3336
		[SaveableField(343)]
		public readonly IFaction RaiderPartyMapFaction;

		// Token: 0x04000D09 RID: 3337
		[SaveableField(344)]
		public readonly IFaction VillageRealmWhenRaided;

		// Token: 0x04000D0A RID: 3338
		[SaveableField(345)]
		public readonly bool RealmsAtWarWhenRaided;

		// Token: 0x04000D0B RID: 3339
		[SaveableField(346)]
		private readonly MBReadOnlyDictionary<Hero, short> _witnesses;

		// Token: 0x04000D0C RID: 3340
		[SaveableField(347)]
		public readonly Hero RaidLeader;
	}
}
