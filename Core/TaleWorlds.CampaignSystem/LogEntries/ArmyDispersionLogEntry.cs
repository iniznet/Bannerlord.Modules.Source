using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	public class ArmyDispersionLogEntry : LogEntry, IEncyclopediaLog, IChatNotification, IWarLog
	{
		internal static void AutoGeneratedStaticCollectObjectsArmyDispersionLogEntry(object o, List<object> collectedObjects)
		{
			((ArmyDispersionLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._armyLeader);
			collectedObjects.Add(this._encyclopediaLinkWithName);
		}

		internal static object AutoGeneratedGetMemberValueDispersionReason(object o)
		{
			return ((ArmyDispersionLogEntry)o).DispersionReason;
		}

		internal static object AutoGeneratedGetMemberValue_notificationTextColor(object o)
		{
			return ((ArmyDispersionLogEntry)o)._notificationTextColor;
		}

		internal static object AutoGeneratedGetMemberValue_isVisibleNotification(object o)
		{
			return ((ArmyDispersionLogEntry)o)._isVisibleNotification;
		}

		internal static object AutoGeneratedGetMemberValue_armyLeader(object o)
		{
			return ((ArmyDispersionLogEntry)o)._armyLeader;
		}

		internal static object AutoGeneratedGetMemberValue_encyclopediaLinkWithName(object o)
		{
			return ((ArmyDispersionLogEntry)o)._encyclopediaLinkWithName;
		}

		public override CampaignTime KeepInHistoryTime
		{
			get
			{
				return CampaignTime.Weeks(1f);
			}
		}

		public override ChatNotificationType NotificationType
		{
			get
			{
				Hero heroObject = this._armyLeader.HeroObject;
				return base.DiplomaticNotification(((heroObject != null) ? heroObject.Clan : null) ?? null, null);
			}
		}

		public bool IsVisibleNotification
		{
			get
			{
				return this._isVisibleNotification;
			}
		}

		public ArmyDispersionLogEntry(Army army, Army.ArmyDispersionReason reason)
		{
			this._armyLeader = army.ArmyOwner.CharacterObject;
			this._encyclopediaLinkWithName = army.EncyclopediaLinkWithName;
			Kingdom kingdom = army.Kingdom;
			this._notificationTextColor = ((kingdom != null) ? kingdom.LabelColor : 0U);
			this.DispersionReason = reason;
			this._isVisibleNotification = army.LeaderParty.MapFaction == Hero.MainHero.MapFaction && army.Parties.IndexOf(MobileParty.MainParty) >= 0;
		}

		public override string ToString()
		{
			return this.GetEncyclopediaText().ToString();
		}

		public bool IsRelatedToWar(StanceLink stance, out IFaction effector, out IFaction effected)
		{
			IFaction faction = stance.Faction1;
			IFaction faction2 = stance.Faction2;
			effector = this._armyLeader.HeroObject.MapFaction;
			effected = null;
			return this._armyLeader.HeroObject.MapFaction == faction || this._armyLeader.HeroObject.MapFaction == faction2;
		}

		public TextObject GetNotificationText()
		{
			return this.GetEncyclopediaText();
		}

		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return this._armyLeader != null && obj == this._armyLeader.HeroObject;
		}

		public TextObject GetEncyclopediaText()
		{
			TextObject textObject;
			switch (this.DispersionReason)
			{
			case Army.ArmyDispersionReason.Unknown:
				textObject = new TextObject("{=5CJOMH90}{ARMY} has been disbanded.", null);
				break;
			case Army.ArmyDispersionReason.DismissalRequestedWithInfluence:
				textObject = new TextObject("{=bAVZloaC}{ARMY} has been disbanded since dismissal is requested.", null);
				break;
			case Army.ArmyDispersionReason.NotEnoughParty:
				textObject = new TextObject("{=s2lKb22C}{ARMY} has been disbanded since other parties has left the army.", null);
				break;
			case Army.ArmyDispersionReason.KingdomChanged:
				textObject = new TextObject("{=6XAvdeEE}{ARMY} has been disbanded since kingdom has been changed.", null);
				break;
			case Army.ArmyDispersionReason.CohesionDepleted:
				textObject = new TextObject("{=ESM0NhLy}{ARMY} has been disbanded since cohesion has been depleted.", null);
				break;
			case Army.ArmyDispersionReason.ObjectiveFinished:
				textObject = new TextObject("{=6XRt8101}{ARMY} has been disbanded since the objective is finished", null);
				break;
			case Army.ArmyDispersionReason.LeaderPartyRemoved:
				textObject = new TextObject("{=A3HdRbqf}{ARMY} has been disbanded since the leader party has left the army.", null);
				break;
			case Army.ArmyDispersionReason.PlayerTakenPrisoner:
				textObject = new TextObject("{=loEI5awS}{ARMY} has been disbanded since the player has taken as a prisoner", null);
				break;
			case Army.ArmyDispersionReason.CannotElectNewLeader:
				textObject = new TextObject("{=7DCzgGNP}{ARMY} has been disbanded since a new leader cannot be selected", null);
				break;
			case Army.ArmyDispersionReason.LeaderCannotArrivePointOnTime:
				textObject = new TextObject("{=t5Y0gTGv}{ARMY} has been disbanded since the leader couldn't arrived to the point on time.", null);
				break;
			case Army.ArmyDispersionReason.ArmyLeaderIsDead:
				textObject = new TextObject("{=t6FNeiOC}{ARMY} has been disbanded since the army leader is dead.", null);
				break;
			default:
				textObject = new TextObject("{=5CJOMH90}{ARMY} has been disbanded.", null);
				break;
			}
			TextObject textObject2 = new TextObject("{=nbmctMLk}{LEADER_NAME}{.o} Army", null);
			textObject2.SetTextVariable("LEADER_NAME", this._armyLeader.Name);
			textObject.SetTextVariable("ARMY", textObject2);
			return textObject;
		}

		[SaveableField(30)]
		public readonly Army.ArmyDispersionReason DispersionReason;

		[SaveableField(31)]
		private readonly uint _notificationTextColor;

		[SaveableField(32)]
		private readonly bool _isVisibleNotification;

		[SaveableField(33)]
		private readonly CharacterObject _armyLeader;

		[SaveableField(34)]
		private readonly TextObject _encyclopediaLinkWithName;
	}
}
