using System;
using System.Collections.Generic;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	// Token: 0x020002C9 RID: 713
	public class LogEntryHistory
	{
		// Token: 0x06002988 RID: 10632 RVA: 0x000B18BC File Offset: 0x000AFABC
		internal static void AutoGeneratedStaticCollectObjectsLogEntryHistory(object o, List<object> collectedObjects)
		{
			((LogEntryHistory)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002989 RID: 10633 RVA: 0x000B18CA File Offset: 0x000AFACA
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._logs);
		}

		// Token: 0x0600298A RID: 10634 RVA: 0x000B18D8 File Offset: 0x000AFAD8
		internal static object AutoGeneratedGetMemberValueLastAddedIndex(object o)
		{
			return ((LogEntryHistory)o).LastAddedIndex;
		}

		// Token: 0x0600298B RID: 10635 RVA: 0x000B18EA File Offset: 0x000AFAEA
		internal static object AutoGeneratedGetMemberValue_logs(object o)
		{
			return ((LogEntryHistory)o)._logs;
		}

		// Token: 0x0600298C RID: 10636 RVA: 0x000B18F8 File Offset: 0x000AFAF8
		internal void AddActionLog(LogEntry actionLog, bool checkSequenceAndInsert = false)
		{
			if (this._logs.Count > 0 && this._logs[this._logs.Count - 1].Id > actionLog.Id)
			{
				Debug.FailedAssert("Log ids should always get bigger", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\LogEntries\\LogEntry.cs", "AddActionLog", 209);
				int num = this._logs.FindIndex((LogEntry l) => l.Id > actionLog.Id);
				if (num >= 0)
				{
					this._logs.Insert(num, actionLog);
				}
			}
			else
			{
				this._logs.Add(actionLog);
			}
			Campaign.Current.CampaignInformationManager.NewLogEntryAdded(actionLog);
		}

		// Token: 0x0600298D RID: 10637 RVA: 0x000B19B9 File Offset: 0x000AFBB9
		internal void DeleteLogAtIndex(int i)
		{
			this._logs.RemoveAt(i);
		}

		// Token: 0x0600298E RID: 10638 RVA: 0x000B19C8 File Offset: 0x000AFBC8
		public void DeleteOutdatedLogs()
		{
			int num = -1;
			for (int i = 0; i < this._logs.Count; i++)
			{
				LogEntry logEntry = this._logs[i];
				if (!(logEntry.KeepInHistoryTime + logEntry.GameTime).IsPast)
				{
					num++;
					if (i != num)
					{
						this._logs[num] = logEntry;
					}
				}
			}
			if (num < this._logs.Count)
			{
				this._logs.RemoveRange(num + 1, this._logs.Count - num - 1);
			}
		}

		// Token: 0x17000A47 RID: 2631
		// (get) Token: 0x0600298F RID: 10639 RVA: 0x000B1A55 File Offset: 0x000AFC55
		public MBReadOnlyList<LogEntry> GameActionLogs
		{
			get
			{
				return this._logs;
			}
		}

		// Token: 0x06002990 RID: 10640 RVA: 0x000B1A5D File Offset: 0x000AFC5D
		public IEnumerable<T> GetGameActionLogs<T>(Func<T, bool> predicate) where T : LogEntry
		{
			using (List<LogEntry>.Enumerator enumerator = this._logs.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					T t;
					if ((t = enumerator.Current as T) != null && predicate(t))
					{
						yield return t;
					}
				}
			}
			List<LogEntry>.Enumerator enumerator = default(List<LogEntry>.Enumerator);
			yield break;
			yield break;
		}

		// Token: 0x06002991 RID: 10641 RVA: 0x000B1A74 File Offset: 0x000AFC74
		public T FindLastGameActionLog<T>(Func<T, bool> predicate) where T : LogEntry
		{
			for (int i = this._logs.Count - 1; i >= 0; i--)
			{
				T t;
				if ((t = this._logs[i] as T) != null && predicate(t))
				{
					return t;
				}
			}
			return default(T);
		}

		// Token: 0x06002992 RID: 10642 RVA: 0x000B1ACC File Offset: 0x000AFCCC
		private int BinarySearchFirst(long target)
		{
			int i = 0;
			int num = this._logs.Count - 1;
			while (i < num)
			{
				int num2 = (i + num + 1) / 2;
				if (this._logs[num2].Id > target)
				{
					num = num2 - 1;
				}
				else
				{
					i = num2;
				}
			}
			return num;
		}

		// Token: 0x06002993 RID: 10643 RVA: 0x000B1B14 File Offset: 0x000AFD14
		private int BinarySearchFirst(CampaignTime target)
		{
			int i = 0;
			int num = this._logs.Count - 1;
			while (i < num)
			{
				int num2 = (i + num + 1) / 2;
				if (this._logs[num2].GameTime > target)
				{
					num = num2 - 1;
				}
				else
				{
					i = num2;
				}
			}
			return num;
		}

		// Token: 0x06002994 RID: 10644 RVA: 0x000B1B64 File Offset: 0x000AFD64
		public int GetStartIndexForComments()
		{
			for (int i = MathF.Max(0, this._logs.Count - 10000); i < this._logs.Count; i++)
			{
				if (this._logs[i].Id > Hero.OneToOneConversationHero.LastExaminedLogEntryID)
				{
					return i;
				}
			}
			return this._logs.Count;
		}

		// Token: 0x06002995 RID: 10645 RVA: 0x000B1BC8 File Offset: 0x000AFDC8
		public LogEntry GetRelevantComment(Hero conversationHero, out int bestScore, out string bestRelatedLogEntryTag)
		{
			int num = -1;
			bestRelatedLogEntryTag = "";
			int startIndexForComments = this.GetStartIndexForComments();
			bestScore = 0;
			if (startIndexForComments < this._logs.Count)
			{
				for (int i = startIndexForComments; i < this._logs.Count; i++)
				{
					string text;
					ImportanceEnum importanceEnum;
					this._logs[i].GetConversationScoreAndComment(conversationHero, false, out text, out importanceEnum);
					int num2 = (int)importanceEnum;
					if (num2 > bestScore)
					{
						bestScore = num2;
						num = i;
					}
				}
				Hero.OneToOneConversationHero.LastExaminedLogEntryID = this._logs[this._logs.Count - 1].Id;
			}
			if (num > -1)
			{
				string text2;
				ImportanceEnum importanceEnum2;
				this._logs[num].GetConversationScoreAndComment(conversationHero, true, out text2, out importanceEnum2);
				bestRelatedLogEntryTag = text2;
				return this._logs[num];
			}
			return null;
		}

		// Token: 0x06002996 RID: 10646 RVA: 0x000B1C88 File Offset: 0x000AFE88
		internal void OnAfterLoad()
		{
			for (int i = this._logs.Count - 1; i >= 0; i--)
			{
				if (this._logs[i] == null)
				{
					this._logs.RemoveAt(i);
				}
			}
		}

		// Token: 0x04000C95 RID: 3221
		[SaveableField(0)]
		internal long LastAddedIndex = -1L;

		// Token: 0x04000C96 RID: 3222
		[SaveableField(1)]
		private readonly MBList<LogEntry> _logs = new MBList<LogEntry>();
	}
}
