using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	public class ChangeSettlementOwnerLogEntry : LogEntry, IEncyclopediaLog, IWarLog
	{
		internal static void AutoGeneratedStaticCollectObjectsChangeSettlementOwnerLogEntry(object o, List<object> collectedObjects)
		{
			((ChangeSettlementOwnerLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Settlement);
			collectedObjects.Add(this.PreviousClan);
			collectedObjects.Add(this.NewClan);
		}

		internal static object AutoGeneratedGetMemberValueSettlement(object o)
		{
			return ((ChangeSettlementOwnerLogEntry)o).Settlement;
		}

		internal static object AutoGeneratedGetMemberValuePreviousClan(object o)
		{
			return ((ChangeSettlementOwnerLogEntry)o).PreviousClan;
		}

		internal static object AutoGeneratedGetMemberValueNewClan(object o)
		{
			return ((ChangeSettlementOwnerLogEntry)o).NewClan;
		}

		internal static object AutoGeneratedGetMemberValue_bySiege(object o)
		{
			return ((ChangeSettlementOwnerLogEntry)o)._bySiege;
		}

		public ChangeSettlementOwnerLogEntry(Settlement settlement, Hero newOwner, Hero previousOwner, bool bySiege)
		{
			this.Settlement = settlement;
			this.PreviousClan = previousOwner.Clan;
			this.NewClan = newOwner.Clan;
			this._bySiege = bySiege;
		}

		public override ImportanceEnum GetImportanceForClan(Clan clan)
		{
			if (this.PreviousClan == this.NewClan)
			{
				return ImportanceEnum.Zero;
			}
			if (this.NewClan != clan)
			{
				return ImportanceEnum.Important;
			}
			return ImportanceEnum.VeryImportant;
		}

		public bool IsRelatedToWar(StanceLink stance, out IFaction effector, out IFaction effected)
		{
			IFaction faction = stance.Faction1;
			IFaction faction2 = stance.Faction2;
			effector = this.NewClan.MapFaction;
			effected = this.PreviousClan.MapFaction;
			return (this.NewClan.MapFaction == faction && this.PreviousClan.MapFaction == faction2) || (this.NewClan.MapFaction == faction2 && this.PreviousClan.MapFaction == faction);
		}

		public override void GetConversationScoreAndComment(Hero talkTroop, bool findString, out string comment, out ImportanceEnum score)
		{
			score = ImportanceEnum.Zero;
			comment = "";
			if (this._bySiege && (this.NewClan == Clan.PlayerClan || this.PreviousClan == Clan.PlayerClan))
			{
				score = ImportanceEnum.Important;
				if (findString)
				{
					comment = "str_comment_changeownerofsettlement_you_captured_castle";
				}
			}
		}

		public override int GetAsRumor(Settlement talkSettlement, ref TextObject comment)
		{
			int num = 0;
			Settlement settlement = this.Settlement;
			float num2;
			if (this.NewClan.IsBanditFaction && settlement.IsHideout && Campaign.Current.Models.MapDistanceModel.GetDistance(talkSettlement, settlement, 60f, out num2))
			{
				comment = new TextObject("{=MXGtQ6YV}I hear {.%}{BANDIT_NAME}{.%} have moved into the old {HIDEOUT_NAME} near here. Travellers better watch themselves.", null);
				comment.SetTextVariable("BANDIT_NAME", this.NewClan.Name);
				comment.SetTextVariable("HIDEOUT_NAME", settlement.Name);
				return 4;
			}
			if (this._bySiege && this.PreviousClan == talkSettlement.MapFaction)
			{
				comment = new TextObject("{=UMn2QMIk}Did you hear {ENEMY_NAME} took {FORTRESS_NAME} by storm? Do you think they'll come here next?", null);
				comment.SetTextVariable("ENEMY_NAME", FactionHelper.GetTermUsedByOtherFaction(this.NewClan, talkSettlement.MapFaction, false));
				comment.SetTextVariable("FORTRESS_NAME", settlement.Name);
				return 10;
			}
			return num;
		}

		public override string ToString()
		{
			return this.GetEncyclopediaText().ToString();
		}

		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return (obj == this.Settlement || obj == this.NewClan || obj == this.NewClan.Leader) && !this._bySiege;
		}

		public TextObject GetEncyclopediaText()
		{
			TextObject textObject = GameTexts.FindText("str_settlement_owner_changed_news", null);
			textObject.SetTextVariable("SETTLEMENT", this.Settlement.IsHideout ? this.Settlement.Name : this.Settlement.EncyclopediaLinkWithName);
			if (this.NewClan == null && this.Settlement.IsHideout)
			{
				return GameTexts.FindText("str_hideout_owner_changed_news", null);
			}
			StringHelpers.SetCharacterProperties("LORD", this.NewClan.Leader.CharacterObject, textObject, false);
			return textObject;
		}

		[SaveableField(80)]
		public readonly Settlement Settlement;

		[SaveableField(81)]
		public readonly Clan PreviousClan;

		[SaveableField(82)]
		public readonly Clan NewClan;

		[SaveableField(83)]
		private readonly bool _bySiege;
	}
}
