using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	public class CharacterKilledLogEntry : LogEntry, IEncyclopediaLog, IChatNotification, IWarLog
	{
		internal static void AutoGeneratedStaticCollectObjectsCharacterKilledLogEntry(object o, List<object> collectedObjects)
		{
			((CharacterKilledLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.Victim);
			collectedObjects.Add(this.Killer);
			collectedObjects.Add(this.VictimMapFaction);
			collectedObjects.Add(this.KillerMapFaction);
		}

		internal static object AutoGeneratedGetMemberValueVictim(object o)
		{
			return ((CharacterKilledLogEntry)o).Victim;
		}

		internal static object AutoGeneratedGetMemberValueKiller(object o)
		{
			return ((CharacterKilledLogEntry)o).Killer;
		}

		internal static object AutoGeneratedGetMemberValue_actionDetail(object o)
		{
			return ((CharacterKilledLogEntry)o)._actionDetail;
		}

		internal static object AutoGeneratedGetMemberValueVictimMapFaction(object o)
		{
			return ((CharacterKilledLogEntry)o).VictimMapFaction;
		}

		internal static object AutoGeneratedGetMemberValueKillerMapFaction(object o)
		{
			return ((CharacterKilledLogEntry)o).KillerMapFaction;
		}

		public bool IsVisibleNotification
		{
			get
			{
				return true;
			}
		}

		public override ChatNotificationType NotificationType
		{
			get
			{
				return base.CivilianNotification(this.Victim.Clan);
			}
		}

		public override CampaignTime KeepInHistoryTime
		{
			get
			{
				return CampaignTime.Never;
			}
		}

		public CharacterKilledLogEntry(Hero victim, Hero killer, KillCharacterAction.KillCharacterActionDetail detail)
		{
			this.Victim = victim;
			this.Killer = killer;
			this.VictimMapFaction = victim.MapFaction;
			this.KillerMapFaction = ((killer != null) ? killer.MapFaction : null);
			this._actionDetail = detail;
		}

		public override int AsReasonForEnmity(Hero potentialKiller, Hero potentialRelative)
		{
			if (this.Killer != null && potentialKiller == this.Killer && !potentialRelative.Clan.IsMapFaction && potentialRelative.Clan == this.Victim.Clan)
			{
				return 10;
			}
			return 0;
		}

		public override string ToString()
		{
			return this.GetEncyclopediaText().ToString();
		}

		public override TextObject GetHistoricComment(Hero talkTroop)
		{
			if (this.Killer == null)
			{
				return TextObject.Empty;
			}
			ConversationHelper.HeroRefersToHero(talkTroop, this.Victim, true);
			MBTextManager.SetTextVariable("HERO_1", this.Killer.Name, false);
			MBTextManager.SetTextVariable("HERO_2", this.Victim.Name, false);
			return GameTexts.FindText("str_responsible_of_death_news", null);
		}

		public TextObject GetNotificationText()
		{
			TextObject textObject = TextObject.Empty;
			if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedOfOldAge)
			{
				textObject = new TextObject("{=5GSrvawr}{VICTIM.NAME} died of old age. {?VICTIM.GENDER}Her{?}His{\\?} family and friends will remember {?VICTIM.GENDER}her{?}him{\\?}.", null);
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Murdered)
			{
				if (this.Killer != null)
				{
					textObject = GameTexts.FindText("str_responsible_of_death_link_news", null);
					StringHelpers.SetCharacterProperties("HERO_1", this.Killer.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("HERO_2", this.Victim.CharacterObject, textObject, false);
				}
				else
				{
					textObject = GameTexts.FindText("str_murdered_passive_news", null);
					StringHelpers.SetCharacterProperties("HERO_2", this.Victim.CharacterObject, textObject, false);
				}
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedInBattle)
			{
				textObject = new TextObject("{=BhDWm78v}{VICTIM.NAME} has died in battle.", null);
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedInLabor)
			{
				textObject = GameTexts.FindText("str_notification_maternal_death", null);
				StringHelpers.SetCharacterProperties("MOTHER", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Executed)
			{
				if (this.Killer != null)
				{
					textObject = new TextObject("{=hB8CU9LP}{VICTIM.NAME} has been executed by {KILLER.NAME}.", null);
					StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("KILLER", this.Killer.CharacterObject, textObject, false);
				}
				else
				{
					textObject = new TextObject("{=mwbYdaJr}{VICTIM.NAME} has been executed.", null);
					StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
				}
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Lost)
			{
				textObject = new TextObject("{=pVkchhqX}{VICTIM.NAME} was lost.", null);
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			return textObject;
		}

		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return obj == this.Victim || obj == this.Killer;
		}

		public TextObject GetEncyclopediaText()
		{
			TextObject textObject = TextObject.Empty;
			if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedOfOldAge)
			{
				textObject = new TextObject("{=KWBwCq1Y}{VICTIM.LINK} died of old age.", null);
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Murdered)
			{
				if (this.Killer != null)
				{
					textObject = GameTexts.FindText("str_responsible_of_death_link_news", null);
					StringHelpers.SetCharacterProperties("HERO_1", this.Killer.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("HERO_2", this.Victim.CharacterObject, textObject, false);
				}
				else
				{
					textObject = GameTexts.FindText("str_murdered_passive_news", null);
					StringHelpers.SetCharacterProperties("HERO_2", this.Victim.CharacterObject, textObject, false);
				}
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedInBattle)
			{
				if (this.KillerMapFaction != null)
				{
					textObject = new TextObject("{=kknvzzcG}{VICTIM.LINK} died in a battle against {FACTION_LINK}.", null);
					textObject.SetTextVariable("FACTION_LINK", this.KillerMapFaction.EncyclopediaLinkWithName);
				}
				else
				{
					textObject = new TextObject("{=mjSauU7P}{VICTIM.LINK} died in battle.", null);
				}
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedInLabor)
			{
				textObject = GameTexts.FindText("str_notification_maternal_death", null);
				StringHelpers.SetCharacterProperties("MOTHER", this.Victim.CharacterObject, textObject, false);
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Executed)
			{
				if (this.Killer != null)
				{
					textObject = new TextObject("{=b6Spbd9O}{VICTIM.LINK} has been executed by {KILLER.LINK}.", null);
					StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
					StringHelpers.SetCharacterProperties("KILLER", this.Killer.CharacterObject, textObject, false);
				}
				else
				{
					textObject = new TextObject("{=NacogXav}{VICTIM.LINK} has been executed.", null);
					StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
				}
			}
			else if (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Lost)
			{
				textObject = new TextObject("{=NKTbhIoi}{VICTIM.LINK} was lost.", null);
				StringHelpers.SetCharacterProperties("VICTIM", this.Victim.CharacterObject, textObject, false);
			}
			return textObject;
		}

		public bool IsRelatedToWar(StanceLink stance, out IFaction effector, out IFaction effected)
		{
			IFaction faction = stance.Faction1;
			IFaction faction2 = stance.Faction2;
			effector = this.VictimMapFaction;
			effected = this.KillerMapFaction;
			return (this._actionDetail == KillCharacterAction.KillCharacterActionDetail.DiedInBattle || this._actionDetail == KillCharacterAction.KillCharacterActionDetail.Executed) && effector != null && effected != null && ((faction == this.VictimMapFaction && faction2 == this.KillerMapFaction) || (faction2 == this.VictimMapFaction && faction == this.KillerMapFaction));
		}

		[SaveableField(120)]
		public readonly Hero Victim;

		[SaveableField(121)]
		public readonly Hero Killer;

		[SaveableField(122)]
		private readonly KillCharacterAction.KillCharacterActionDetail _actionDetail;

		[SaveableField(124)]
		private readonly IFaction VictimMapFaction;

		[SaveableField(125)]
		private readonly IFaction KillerMapFaction;
	}
}
