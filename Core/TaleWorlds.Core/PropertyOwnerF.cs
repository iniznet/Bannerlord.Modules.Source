using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.Core
{
	// Token: 0x02000036 RID: 54
	public class PropertyOwnerF<T> : MBObjectBase where T : MBObjectBase
	{
		// Token: 0x060003E4 RID: 996 RVA: 0x0000F4A4 File Offset: 0x0000D6A4
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._attributes);
		}

		// Token: 0x060003E5 RID: 997 RVA: 0x0000F4B9 File Offset: 0x0000D6B9
		public PropertyOwnerF()
		{
			this._attributes = new Dictionary<T, float>();
		}

		// Token: 0x060003E6 RID: 998 RVA: 0x0000F4CC File Offset: 0x0000D6CC
		public PropertyOwnerF(PropertyOwnerF<T> propertyOwner)
		{
			this._attributes = new Dictionary<T, float>(propertyOwner._attributes);
		}

		// Token: 0x060003E7 RID: 999 RVA: 0x0000F4E5 File Offset: 0x0000D6E5
		public void SetPropertyValue(T attribute, float value)
		{
			if (!value.ApproximatelyEqualsTo(0f, 1E-05f))
			{
				this._attributes[attribute] = value;
				return;
			}
			if (this.HasProperty(attribute))
			{
				this._attributes.Remove(attribute);
			}
		}

		// Token: 0x060003E8 RID: 1000 RVA: 0x0000F520 File Offset: 0x0000D720
		public float GetPropertyValue(T attribute)
		{
			if (attribute == null)
			{
				Debug.FailedAssert("attribute in GetPropertyValue can not be null!", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.Core\\PropertyOwner.cs", "GetPropertyValue", 146);
				return 0f;
			}
			float num;
			if (!this._attributes.TryGetValue(attribute, out num))
			{
				return 0f;
			}
			return num;
		}

		// Token: 0x060003E9 RID: 1001 RVA: 0x0000F56B File Offset: 0x0000D76B
		public bool HasProperty(T attribute)
		{
			return this._attributes.ContainsKey(attribute);
		}

		// Token: 0x060003EA RID: 1002 RVA: 0x0000F579 File Offset: 0x0000D779
		public void ClearAllProperty()
		{
			this._attributes.Clear();
		}

		// Token: 0x060003EB RID: 1003 RVA: 0x0000F588 File Offset: 0x0000D788
		public void Serialize(XmlWriter writer)
		{
			writer.WriteStartElement("attributes");
			foreach (KeyValuePair<T, float> keyValuePair in this._attributes)
			{
				writer.WriteStartElement("attribute");
				writer.WriteAttributeString("id", keyValuePair.Key.StringId);
				writer.WriteAttributeString("value", keyValuePair.Value.ToString());
				writer.WriteEndElement();
			}
			writer.WriteEndElement();
		}

		// Token: 0x060003EC RID: 1004 RVA: 0x0000F62C File Offset: 0x0000D82C
		public override void Deserialize(MBObjectManager objectManager, XmlNode node)
		{
			this.Initialize();
			foreach (object obj in node.ChildNodes)
			{
				XmlNode xmlNode = (XmlNode)obj;
				if (xmlNode.Name == "attributes")
				{
					foreach (object obj2 in xmlNode.ChildNodes)
					{
						XmlNode xmlNode2 = (XmlNode)obj2;
						if (xmlNode2.Name == "attribute")
						{
							string innerText = xmlNode2.Attributes["id"].InnerText;
							if (innerText.Substring(0, innerText.IndexOf('.')).Equals("Attrib"))
							{
								T t = objectManager.ReadObjectReferenceFromXml("id", typeof(T), xmlNode2) as T;
								int num = Convert.ToInt32(xmlNode2.Attributes["value"].Value);
								this.SetPropertyValue(t, (float)num);
							}
						}
					}
				}
			}
		}

		// Token: 0x04000209 RID: 521
		[SaveableField(10)]
		protected Dictionary<T, float> _attributes;
	}
}
